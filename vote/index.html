<!doctype html>
<meta charset="utf-8"><title>Encore! • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1526;--card:#0d1428;--line:#2b3c62;--txt:#eaf2ff;--muted:#a9b6d9;--green:#25d366;--yellow:#f6c945;--red:#ff5e6c}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px system-ui}
  .wrap{max-width:640px;margin:24px auto;padding:16px}
  h1{font-family:"Bebas Neue", system-ui; font-size:44px; margin:0 0 4px}
  .venue{font-family:"Montserrat", system-ui; font-weight:700; font-size:22px; color:#ffd6ff; margin:0 0 16px}
  .sub{font-size:14px;color:var(--muted);margin-top:2px}
  input,button{font:inherit}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--txt)}
  .row{display:flex;gap:10px;align-items:center}
  .btn{flex:1;padding:14px;border:0;border-radius:12px;cursor:pointer}
  .good{background:#25d366;color:#06120a}.warn{background:#f6c945;color:#231a04}.bad{background:#ff5e6c}
  .mini{font-size:12px;color:var(--muted)}
  .nowVoting{font-family:"Montserrat", system-ui; font-weight:700; margin:10px 0 6px; font-size:14px; color:#cfe0ff}
  .who{font-family:"Bebas Neue", system-ui; font-size:36px; margin:0 0 6px}
  .song{font-size:14px;color:#c9d6ff;margin:0 0 12px}
</style>
<div class="wrap">
  <h1>Encore! Vote</h1>
  <div id="venue" class="venue">Welcome to —</div>

  <div id="join">
    <p class="mini">Enter the event PIN from the screen:</p>
    <div class="row"><input id="pin" placeholder="PIN" inputmode="numeric" autocomplete="off"><button class="btn" id="joinBtn">Join</button></div>
    <div id="err" class="mini" style="color:#ff9a9a"></div>
  </div>

  <div id="panel" style="display:none">
    <div class="nowVoting">Now voting:</div>
    <div id="singer" class="who">—</div>
    <div id="song" class="song">—</div>

    <div class="row" style="margin-top:12px">
      <button class="btn good"  id="v_encore">Encore!</button>
      <button class="btn warn"  id="v_another">Another Shot!</button>
      <button class="btn bad"   id="v_maybe">Maybe Next Time</button>
    </div>
    <div id="note" class="mini sub">Voting closed…</div>
  </div>
</div>
<script>
const GET_URL='/assets/get_state.php', VOTE_URL='/assets/vote.php';
const $=s=>document.querySelector(s);
const digitsOnly = s => (s||'').replace(/\D+/g,'');
let state=null, poll=null, eventPin=null;

async function fetchState(){ const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json(); }
function render(){
  if(!state) return;

  const publicVenue = state.event?.venuePublic || state.event?.venue || '—';
  document.getElementById('venue').textContent = `Welcome to ${publicVenue}`;

  const pinHost = digitsOnly(state.event?.pin || '');
  const pinEmpty = pinHost === '';

  if(!eventPin){
    $('#join').style.display='block'; $('#panel').style.display='none';
    $('#err').textContent = pinEmpty ? 'Host has no PIN set (join disabled).' : '';
    return;
  }

  if(digitsOnly(eventPin)!==pinHost){
    $('#err').textContent='Wrong PIN for this event.';
    $('#join').style.display='block'; $('#panel').style.display='none';
    return;
  }

  $('#join').style.display='none'; $('#panel').style.display='block';
  $('#singer').textContent = state.current?.name || '—';
  $('#song').textContent   = state.current?.songArtist || '—';
  const open = !!state.voting?.open;
  ['v_encore','v_another','v_maybe'].forEach(id=>{ const b=$('#'+id); b.disabled=!open; b.style.opacity=open?1:.6; });
  $('#note').textContent = open ? 'Voting is OPEN — make your choice!' : 'Voting closed…';
}

async function vote(kind){
  if(!state?.voting?.open) return;
  const res = await fetch(VOTE_URL, {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({choice:kind, deviceId: deviceId()})});
  await fetchState(); render();
  if(!res.ok){ const e=await res.json().catch(()=>({error:'vote_failed'})); if(e.error==='already_voted'){ alert('You already voted for this singer/song on this device.'); } }
}
function deviceId(){ let id=localStorage.getItem('eyek_device_id'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('eyek_device_id', id);} return id; }

$('#joinBtn').onclick = ()=>{ eventPin = digitsOnly($('#pin').value.trim()); render(); };
$('#pin').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ eventPin = digitsOnly($('#pin').value.trim()); render(); }});
$('#v_encore').onclick = ()=> vote('encore');
$('#v_another').onclick = ()=> vote('another');
$('#v_maybe').onclick  = ()=> vote('maybe');

(async function init(){ await fetchState(); render(); poll=setInterval(async ()=>{ await fetchState(); render(); }, 900); })();
</script>
