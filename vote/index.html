<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0f17;--text:#eaf2ff;--muted:#9db2d1;--green:#26e28b;--yellow:#ffd24d;--red:#ff5a6b;}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{background:#121826;border:1px solid #22314f;border-radius:16px;padding:20px;max-width:520px;width:100%;text-align:center}
  h1{margin:8px 0 4px 0}
  .muted{color:var(--muted)}
  .btn{display:block;width:100%;padding:14px 16px;margin:10px 0;border:none;border-radius:12px;font-size:18px;cursor:pointer}
  .green{background:var(--green);color:#012a19}
  .yellow{background:var(--yellow);color:#332500}
  .red{background:var(--red);color:#33040a}
  .disabled{opacity:0.5;pointer-events:none}
</style>
</head>
<body>
  <div class="card">
    <div class="muted" id="venueLine">—</div>
    <h1 id="title">Voting Closed</h1>
    <div class="muted" id="countdown">—</div>
    <button class="btn green"  id="b1" onclick="vote('encore')">Encore!</button>
    <button class="btn yellow" id="b2" onclick="vote('another')">Another Shot!</button>
    <button class="btn red"    id="b3" onclick="vote('nexttime')">Maybe Next Time</button>
  </div>

<script>
const API='/assets/state.php';
let STATE=null, POLL;

function $(id){return document.getElementById(id)}

async function fetchState(){
  const r = await fetch(API+'?action=get',{cache:'no-store'});
  STATE = await r.json();
  render();
}
function render(){
  $('venueLine').textContent = (STATE.venue||'') + (STATE.kj?(' • KJ '+STATE.kj):'');
  const cur = (STATE.singers||[]).find(x=>x.id===STATE.currentSingerId);
  const open = !!(STATE.voting&&STATE.voting.open);
  $('title').textContent = open && cur? ('Now Voting: '+cur.name) : 'Voting Closed';
  const left = open? Math.max(0,(STATE.voting.endsAt||0) - Date.now()) : 0;
  $('countdown').textContent = open? (Math.ceil(left/1000)+'s left') : 'Wait for host…';
  ['b1','b2','b3'].forEach(id=> $(id).classList.toggle('disabled', !open));
}

async function vote(type){
  if (!STATE?.voting?.open) return;
  const fd = new FormData();
  fd.append('action','vote');
  fd.append('type', type);
  const r = await fetch(API,{method:'POST',body:fd});
  if(r.ok){ ['b1','b2','b3'].forEach(id=>$(id).classList.add('disabled')); }
}

(async ()=>{
  await fetchState();
  POLL=setInterval(fetchState, 2000);
})();
</script>
</body>
</html>
