<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0b0f; --panel:#101424; --card:#141826; --accent:#7bc4ff;
      --text:#f7f8fc; --muted:#b9c0d0; --border:#26304a;
      --encore:#4ade80; --another:#fbbf24; --maybe:#f87171;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100vh; display:grid; place-items:center; background:linear-gradient(180deg,#0b0b0f,#0e1220); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
    .card{ width:min(640px, 96vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; }
    h1{ margin:0 0 4px }
    .muted{ color:var(--muted) }
    .stack{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px }
    .btn{ padding:14px 16px; border:none; border-radius:14px; background:#0f1322; color:#fff; border:1px solid var(--border); font-weight:800; cursor:pointer; flex:1 }
    .btn.encore{ background:var(--encore); color:#052; }
    .btn.another{ background:var(--another); color:#221a00; }
    .btn.maybe{ background:var(--maybe); }
    .count{ font-weight:900 }
  </style>
</head>
<body>
  <main class="card">
    <h1 id="title">Vote for —</h1>
    <div class="muted" id="eventLine">Event: —</div>
    <div class="muted" style="margin-top:4px">Voting window: <span id="countdown" class="count">—</span></div>

    <div class="stack" style="margin-top:16px">
      <button class="btn encore"  id="voteEncore">Encore</button>
      <button class="btn another" id="voteAnother">Another Shot</button>
      <button class="btn maybe"   id="voteMaybe">Maybe Next Time</button>
    </div>

    <div id="msg" class="muted" style="margin-top:14px"></div>
  </main>

  <script type="module">
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db  = getFirestore(app);

    const title = document.getElementById("title");
    const eventLine = document.getElementById("eventLine");
    const countdownEl = document.getElementById("countdown");
    const msg  = document.getElementById("msg");
    const btnE = document.getElementById("voteEncore");
    const btnA = document.getElementById("voteAnother");
    const btnM = document.getElementById("voteMaybe");

    function getParams(){
      const u = new URL(location.href);
      return {
        eventId: u.searchParams.get("eventId") || "",
        performanceId: u.searchParams.get("performanceId") || ""
      };
    }
    function getDeviceId(){
      const KEY = "eyek_device_id";
      let id = localStorage.getItem(KEY);
      if (!id){
        const arr = new Uint8Array(16); crypto.getRandomValues(arr);
        id = Array.from(arr, b => b.toString(16).padStart(2,"0")).join("");
        localStorage.setItem(KEY, id);
      }
      return id;
    }
    const DEVICE_ID = getDeviceId();

    let perf = null; // { singerId, singerName, status, closeAt }
    let countdownTimer = null;

    function renderCountdown(){
      if (!perf || !perf.closeAt || perf.status !== "open"){ countdownEl.textContent = "—"; return; }
      const ms = perf.closeAt.toMillis() - Date.now();
      const s = Math.max(0, Math.ceil(ms/1000));
      countdownEl.textContent = s + "s";
    }
    function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer = setInterval(renderCountdown, 250); }
    function stopCountdown(){ if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } countdownEl.textContent = "—"; }

    function setButtonsEnabled(on){
      for (const b of [btnE, btnA, btnM]) b.disabled = !on;
    }

    async function init(){
      const { eventId, performanceId } = getParams();
      if (!eventId){ msg.textContent = "Missing event id."; setButtonsEnabled(false); return; }
      eventLine.textContent = "Event: " + eventId;

      if (!performanceId){
        msg.textContent = "Waiting for host to open voting… (no performanceId)";
        setButtonsEnabled(false);
        return;
      }

      const pref = doc(db,"events",eventId,"performances",performanceId);
      onSnapshot(pref, (snap)=>{
        if (!snap.exists()){
          msg.textContent = "This vote is no longer available.";
          setButtonsEnabled(false); stopCountdown(); return;
        }
        const d = snap.data()||{};
        perf = { singerId:d.singerId, singerName:d.singerName, status:d.status, closeAt:d.closeAt };
        title.textContent = "Vote for " + (perf.singerName || "(Unknown)");
        if (perf.status === "pending"){
          msg.textContent = "Get ready — voting opens soon.";
          setButtonsEnabled(false); stopCountdown();
        } else if (perf.status === "open"){
          msg.textContent = "";
          setButtonsEnabled(true); startCountdown();
        } else {
          msg.textContent = "Voting for " + (perf.singerName || "") + " is closed. Thanks for participating!";
          setButtonsEnabled(false); stopCountdown();
        }
      }, err=>{ msg.textContent = "Error loading performance: " + (err?.message||err); setButtonsEnabled(false); });

      btnE.addEventListener("click", ()=> cast("encore", eventId, performanceId));
      btnA.addEventListener("click", ()=> cast("another", eventId, performanceId));
      btnM.addEventListener("click", ()=> cast("maybe",  eventId, performanceId));
    }

    async function cast(category, eventId, performanceId){
      if (!perf || perf.status !== "open"){ msg.textContent = "Voting is closed or not open yet."; return; }
      setButtonsEnabled(false);
      const voteId = performanceId + "__" + DEVICE_ID;
      const vref = doc(db,"events",eventId,"votes",voteId);
      try{
        await setDoc(vref, {
          performanceId, singerId: perf.singerId, singerName: perf.singerName || "",
          category, deviceId: DEVICE_ID, ts: Date.now()
        }, { merge:false });
        msg.textContent = "Thanks! You already voted for " + (perf.singerName||"") + ".";
      }catch(e){
        const m = (""+e?.message||"").toLowerCase();
        if (m.includes("permission")) msg.textContent = "Voting is closed or you already voted for this performance.";
        else if (m.includes("already exists")) msg.textContent = "You already voted for " + (perf.singerName||"") + ".";
        else msg.textContent = "Could not record your vote. Please try again.";
      }finally{
        // keep buttons disabled to avoid double taps
      }
    }

    init();
  </script>
</body>
</html>
