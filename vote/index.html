<!doctype html>
<meta charset="utf-8"><title>Encore! • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{margin:0;background:#0f1526;color:#eaf2ff;font:16px system-ui}
  .wrap{max-width:640px;margin:24px auto;padding:16px}
  input,button{font:inherit}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3c62;background:#0d1428;color:#eaf2ff}
  .row{display:flex;gap:10px;align-items:center}
  .btn{flex:1;padding:14px;border:0;border-radius:12px;cursor:pointer}
  .good{background:#25d366;color:#06120a}.warn{background:#f6c945;color:#231a04}.bad{background:#ff5e6c}
  .mini{font-size:12px;color:#a9b6d9}
</style>
<div class="wrap">
  <h1>Encore! Vote</h1>
  <div id="join">
    <p class="mini">Enter the event PIN from the screen:</p>
    <div class="row"><input id="pin" placeholder="PIN"><button class="btn" id="joinBtn">Join</button></div>
    <div id="err" class="mini" style="color:#ff9a9a"></div>
  </div>
  <div id="panel" style="display:none">
    <div class="mini">Now voting for</div>
    <h2 id="singer">—</h2>
    <div id="song" class="mini">—</div>
    <div class="row" style="margin-top:12px">
      <button class="btn good"  id="v_encore">Encore!</button>
      <button class="btn warn"  id="v_another">Another Shot!</button>
      <button class="btn bad"   id="v_maybe">Maybe Next Time</button>
    </div>
    <div id="note" class="mini" style="margin-top:10px">Voting closed…</div>
  </div>
</div>
<script>
const GET_URL='/assets/get_state.php', VOTE_URL='/assets/vote.php';
const $=s=>document.querySelector(s);
let state=null, poll=null, eventPin=null;
function deviceId(){ let id=localStorage.getItem('eyek_device_id'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('eyek_device_id', id);} return id; }
async function fetchState(){ const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json(); }
function render(){
  if(!state) return;
  if(!eventPin){ $('#join').style.display='block'; $('#panel').style.display='none'; return; }
  if(state.event.pin !== eventPin){ $('#err').textContent='Wrong PIN for this event.'; $('#join').style.display='block'; $('#panel').style.display='none'; return; }
  $('#join').style.display='none'; $('#panel').style.display='block';
  $('#singer').textContent = state.current?.name || '—';
  $('#song').textContent   = state.current?.songArtist || '—';
  const open = !!state.voting?.open;
  ['v_encore','v_another','v_maybe'].forEach(id=>{ const b=$('#'+id); b.disabled=!open; b.style.opacity=open?1:.6; });
  $('#note').textContent = open ? 'Voting is OPEN' : 'Voting closed…';
}
async function vote(kind){
  if(!state?.voting?.open) return;
  const res = await fetch(VOTE_URL, {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({choice:kind, deviceId: deviceId()})});
  await fetchState(); render();
  if(!res.ok){ const e=await res.json().catch(()=>({error:'vote_failed'})); if(e.error==='already_voted'){ alert('You already voted for this singer/song on this device.'); } }
}
$('#joinBtn').onclick = ()=>{ eventPin = $('#pin').value.trim(); render(); }
$('#v_encore').onclick = ()=> vote('encore');
$('#v_another').onclick = ()=> vote('another');
$('#v_maybe').onclick  = ()=> vote('maybe');
(async function init(){ await fetchState(); render(); poll=setInterval(async ()=>{ await fetchState(); render(); }, 1000); })();
</script>
