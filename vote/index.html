<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      /* Brand purple theme */
      --bg:#2F0658;
      --card:#401073;
      --border:#7E3CC0;
      --text:#ffffff;
      --muted:#E3D6F4;
      --accent:#D9B6FF;

      /* Category colors */
      --encore:#22c55e; 
      --another:#f59e0b; 
      --maybe:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
        radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size: clamp(18px, 3.2vw, 22px);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(900px, 100%); 
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), var(--card);
      border:2px solid var(--border); border-radius:20px; padding:22px;
      box-shadow:0 14px 48px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)
    }
    h1{margin:.2em 0 .2em; font-size:1.8em}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.18em .7em;
      background:rgba(127,60,192,.18); color:#f5eaff; font-weight:900;
    }

    .grid{display:grid; gap:18px}
    .buttons{display:grid; gap:14px; grid-template-columns:1fr}
    @media (min-width:700px){ .buttons{grid-template-columns:1fr 1fr 1fr} }

    .btn{
      appearance:none; border:2px solid transparent; border-radius:14px; padding:16px;
      font-weight:1000; font-size:1.15em; cursor:pointer; color:#0c1423;
      transition:transform .06s ease, filter .06s ease, box-shadow .15s ease;
      box-shadow:0 6px 22px rgba(0,0,0,.25);
    }
    .btn:active{ transform:scale(.98); filter:brightness(.95) }
    .btn.enc{ background:var(--encore); border-color:#6fe394 }
    .btn.ano{ background:var(--another); border-color:#ffd28a }
    .btn.may{ background:var(--maybe); border-color:#ffb4b4; color:#fff }

    .footer{
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
      margin-top:8px; padding-top:12px; border-top:2px solid var(--border)
    }
    .status{font-weight:800}
    .countdown{font-weight:1000}
    .hidden{display:none}

    .err{background:#3a0f0f; border:2px solid #ef4444; color:#ffe8e8; padding:.6em .8em; border-radius:12px; font-weight:800}
    .ok{background:#0f2b1c; border:2px solid #22c55e; color:#eafff3; padding:.6em .8em; border-radius:12px; font-weight:800}
  </style>
</head>
<body>
  <main class="card">
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">You’re voting on</div>
          <h1 id="singer">—</h1>
        </div>
        <div class="pill" id="eventPill">—</div>
      </div>

      <div id="alert" class="hidden"></div>

      <div class="buttons" id="voteBtns">
        <button class="btn enc" id="btnEnc">Encore!</button>
        <button class="btn ano" id="btnAno">Another Shot!</button>
        <button class="btn may" id="btnMay">Maybe Next Time!</button>
      </div>

      <div class="footer">
        <div class="status" id="status">Getting ready…</div>
        <div class="muted">Time left: <span class="countdown" id="countdown">—</span></div>
      </div>
    </div>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      // Config
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote"
      };
      if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
      firebase.initializeApp(FIREBASE_CONFIG);
      var db=firebase.firestore();

      function $(id){ return document.getElementById(id); }
      var singerEl=$('singer'), eventPill=$('eventPill');
      var statusEl=$('status'), alertEl=$('alert');
      var countdownEl=$('countdown');
      var btnEnc=$('btnEnc'), btnAno=$('btnAno'), btnMay=$('btnMay'), voteBtns=$('voteBtns');

      // URL params
      var u=new URL(location.href);
      var eventId=u.searchParams.get('eventId')||'default';
      var performanceId=u.searchParams.get('performanceId')||null;
      eventPill.textContent = eventId;

      if(!performanceId){
        showErr('Missing performance. Please scan the current QR from the screen.');
        disableVoting();
        return;
      }

      // Device ID for one-vote-per-performance
      function getDeviceId(){
        var KEY='eyek_device_id', id=localStorage.getItem(KEY);
        if(!id){ var arr=new Uint8Array(16); crypto.getRandomValues(arr); id=Array.prototype.map.call(arr,b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem(KEY,id); }
        return id;
      }
      var DEVICE_ID = getDeviceId();
      var VOTE_DOC_ID = performanceId + '__' + DEVICE_ID;

      var unsubPerf=null, countdownTimer=null;
      var PERF={ status:'', closeAt:null, singerName:'—' };

      // Countdown
      function renderCountdown(){
        if(!PERF.closeAt || PERF.status!=='open'){ countdownEl.textContent='—'; return; }
        var ms = PERF.closeAt.toMillis() - Date.now();
        var s = Math.max(0, Math.ceil(ms/1000));
        countdownEl.textContent = s+'s';
        if(s<=0){ setClosed('Voting closed.'); }
      }
      function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer=setInterval(renderCountdown,250); }
      function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }

      function setOpen(){
        enableVoting();
        statusEl.textContent='Vote now!';
        hideAlert();
        startCountdown();
      }
      function setPending(){
        disableVoting();
        statusEl.textContent='Get ready…';
        showInfo('Voting hasn’t opened yet for this performance.');
        stopCountdown();
      }
      function setClosed(msg){
        disableVoting();
        statusEl.textContent= msg || 'Voting closed.';
        showInfo('Thanks for checking in! Voting is not open for this performance.');
        stopCountdown();
      }

      function showErr(msg){ alertEl.className='err'; alertEl.textContent=msg; alertEl.classList.remove('hidden'); }
      function showInfo(msg){ alertEl.className='ok';  alertEl.textContent=msg; alertEl.classList.remove('hidden'); }
      function hideAlert(){ alertEl.className='hidden'; alertEl.textContent=''; }

      function disableVoting(){
        voteBtns.querySelectorAll('button').forEach(function(b){ b.disabled=true; b.style.opacity=.6; b.style.cursor='not-allowed'; });
      }
      function enableVoting(){
        voteBtns.querySelectorAll('button').forEach(function(b){ b.disabled=false; b.style.opacity=1; b.style.cursor='pointer'; });
      }

      // Load performance doc live
      unsubPerf = db.collection('events').doc(eventId).collection('performances').doc(performanceId)
        .onSnapshot(function(snap){
          if(!snap.exists){ setClosed('(performance not found)'); return; }
          var d = snap.data()||{};
          PERF.status = d.status || 'pending';
          PERF.closeAt = d.closeAt || null;
          PERF.singerName = d.singerName || '—';
          singerEl.textContent = PERF.singerName;

          if(PERF.status === 'open'){
            setOpen();
          }else if(PERF.status === 'pending'){
            setPending();
          }else{
            setClosed();
          }
        }, function(err){
          showErr((err && err.message) || String(err));
          disableVoting();
        });

      // Vote handler
      function cast(category){
        if(PERF.status!=='open'){ setClosed(); return; }
        var data={
          performanceId: performanceId,
          singerId: null, // not required by rules; kept null to avoid rule mismatch
          category: category,
          deviceId: DEVICE_ID,
          ts: Date.now()
        };
        db.collection('events').doc(eventId).collection('votes').doc(VOTE_DOC_ID).set(data)
          .then(function(){
            // Lock UI after 1st successful vote (for this performance)
            disableVoting();
            showInfo('Thanks for voting! You can vote again for the next singer.');
          })
          .catch(function(e){
            var msg=(e && e.message) ? e.message.toLowerCase() : '';
            if(msg.includes('permission') || msg.includes('failed precondition') || msg.includes('already exists')){
              showInfo('Looks like you already voted on this one. Thanks!');
              disableVoting();
            }else{
              showErr('Could not submit vote. Please try again.');
            }
          });
      }

      btnEnc.addEventListener('click', function(){ cast('encore'); });
      btnAno.addEventListener('click', function(){ cast('another'); });
      btnMay.addEventListener('click', function(){ cast('maybe'); });

      // Clean up
      window.addEventListener('beforeunload', function(){ try{ if(unsubPerf) unsubPerf(); }catch(_){} });
    })();
  </script>
</body>
</html>
