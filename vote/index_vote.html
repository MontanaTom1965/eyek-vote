<script>
// ... keep everything else above as-is

async function cast(choice) {
  voteMsg.textContent = '';
  if (!eventId || !roundId) {
    voteMsg.innerHTML = '<span class="err">Voting isn’t open yet.</span>';
    return;
  }
  if (!isVotingOpen) {
    voteMsg.innerHTML = '<span class="err">Voting is currently closed.</span>';
    return;
  }

  // 1) Require attendee check-in first
  const attRef = db.collection('events').doc(eventId).collection('attendees').doc(currentUser.uid);
  const attSnap = await attRef.get();
  if (!attSnap.exists || !(attSnap.data()||{}).verified) {
    voteMsg.innerHTML = '<span class="err">Please check in with tonight’s PIN before voting.</span>';
    hide(voteCard); show(pinCard);
    return;
  }

  // 2) Enforce checked-in-before-round-opened
  const evtSnap = await db.collection('events').doc(eventId).get();
  const evt = evtSnap.data() || {};
  const openedAt = evt.roundOpenedAt && evt.roundOpenedAt.toDate ? evt.roundOpenedAt.toDate() : null;
  const verifiedAt = attSnap.data().verifiedAt && attSnap.data().verifiedAt.toDate ? attSnap.data().verifiedAt.toDate() : null;

  if (openedAt && verifiedAt && verifiedAt > openedAt) {
    voteMsg.innerHTML = '<span class="err">You must check in before the round starts. Please wait for the next round.</span>';
    return;
  }

  // 3) Write the vote (one per round per user; rules prevent overwrite)
  const voteRef = db.collection('events').doc(eventId)
                   .collection('rounds').doc(roundId)
                   .collection('votes').doc(currentUser.uid);

  try {
    await voteRef.set({
      choice,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      displayName: currentUser.displayName || ''
    }, { merge: false });

    voteMsg.innerHTML = '✅ Vote received! Thanks for participating.';
  } catch (e) {
    console.error(e);
    voteMsg.innerHTML = '<span class="err">You’ve already voted this round.</span>';
  }
}
// ... keep everything else below as-is
</script>
