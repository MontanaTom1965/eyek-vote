<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke ‚Äì Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Brand colors -->
  <style>
    :root{
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658; --light:#79aec1; --white:#fff; --black:#000;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:#0f0a18;color:#fff;}
    header{padding:18px 16px;background:linear-gradient(90deg,var(--blue),var(--purple));text-align:center;}
    h1{font-size:1.25rem;margin:0;font-weight:700;letter-spacing:.3px}
    .card{max-width:720px;margin:24px auto;background:#1b1430;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
    .btn{display:block;width:100%;padding:14px 16px;margin:10px 0;border:0;border-radius:12px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:transform .05s ease,opacity .15s ease}
    .btn:hover{opacity:.95} .btn:active{transform:scale(.99)}
    .btn-encore{background:linear-gradient(180deg,#ffefc2,var(--gold));color:#2b1a00}
    .btn-one{background:linear-gradient(180deg,#9fd3ff,#4aa3ff);color:#00172e}
    .btn-next{background:linear-gradient(180deg,#ffc2d1,#ff4971);color:#2b0013}
    .muted{opacity:.8;font-size:.92rem}
    .row{display:grid;gap:10px}
    .hidden{display:none!important}
    label{display:block;margin:8px 0 6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#120c22;color:#fff}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#271c44;font-size:.85rem}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:16px 0}
    .ok{color:#c3ffbd}
    .err{color:#ffc5c5}
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- FirebaseUI for Auth -->
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
</head>
<body>
  <header>
    <h1>Earn Your Encore Karaoke ‚Ä¢ Vote</h1>
  </header>

  <div class="card" id="authCard">
    <h2>Sign in</h2>
    <p class="muted">Use Google or Email to create your account. You‚Äôll enter tonight‚Äôs PIN after signing in.</p>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading‚Ä¶</div>
  </div>

  <div class="card hidden" id="pinCard">
    <h2>Verify Attendance</h2>
    <p class="muted">Enter the <span class="pill">Event ID</span> and tonight‚Äôs <span class="pill">PIN</span> shown on the screen.</p>
    <div class="row">
      <label for="eventId">Event ID</label>
      <input id="eventId" placeholder="e.g. KALISPELL-0912" autocomplete="off" />
      <label for="nightPin">Tonight‚Äôs PIN</label>
      <input id="nightPin" placeholder="4‚Äì8 digits" inputmode="numeric" autocomplete="one-time-code" />
      <button class="btn btn-one" id="verifyPinBtn">Verify & Continue</button>
      <div id="pinMsg" class="muted"></div>
    </div>
  </div>

  <div class="card hidden" id="voteCard">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="muted">Signed in as</div>
        <div id="who" class="ok"></div>
      </div>
      <div>
        <span class="pill" id="eventBadge"></span>
        <span class="pill" id="roundBadge"></span>
      </div>
    </div>

    <div class="divider"></div>

    <h2>Cast your vote</h2>
    <button class="btn btn-encore" id="voteEncore">üî• Encore!</button>
    <button class="btn btn-one" id="voteOneMore">ü§î One More Shot</button>
    <button class="btn btn-next" id="voteNext">‚ùå Maybe Next Time</button>

    <div class="divider"></div>
    <div id="voteMsg" class="muted"></div>
  </div>

<script>
/*** 1) Firebase config ‚Äî keep yours here ***/
const firebaseConfig = {
  // YOUR firebase config goes here (unchanged from your current app)
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/*** 2) FirebaseUI ***/
const ui = new firebaseui.auth.AuthUI(auth);
const uiConfig = {
  signInOptions: [
    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
    { provider: firebase.auth.EmailAuthProvider.PROVIDER_ID, requireDisplayName: true }
  ],
  callbacks: {
    signInSuccessWithAuthResult: () => false
  },
  signInFlow: 'popup'
};
ui.start('#firebaseui-auth-container', uiConfig);

/*** 3) UI helpers ***/
const $ = (id)=>document.getElementById(id);
const show = (el)=>el.classList.remove('hidden');
const hide = (el)=>el.classList.add('hidden');

const authCard = $('authCard');
const pinCard  = $('pinCard');
const voteCard = $('voteCard');
const who      = $('who');
const pinMsg   = $('pinMsg');
const voteMsg  = $('voteMsg');
const eventBadge = $('eventBadge');
const roundBadge = $('roundBadge');

/*** 4) App State ***/
let currentUser = null;
let eventId = null;
let activePin = null;
let roundId = null;
let isVotingOpen = false;

/*** 5) After sign-in, ask for Event ID + PIN ***/
auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  if (!user) {
    show(authCard); hide(pinCard); hide(voteCard);
    return;
  }
  // signed in
  hide(authCard);
  show(pinCard);
  who.textContent = user.displayName || user.email || user.uid;

  // If you have a single active event, you could preload it here.
});

/*** 6) Verify attendance against tonight‚Äôs PIN ***/
$('verifyPinBtn').addEventListener('click', async ()=>{
  pinMsg.textContent = '';
  eventId = $('eventId').value.trim();
  const pinInput = $('nightPin').value.trim();

  if (!eventId || !pinInput) {
    pinMsg.innerHTML = '<span class="err">Please enter both Event ID and the PIN.</span>';
    return;
  }

  try {
    const eventRef = db.collection('events').doc(eventId);
    const snap = await eventRef.get();
    if (!snap.exists) {
      pinMsg.innerHTML = '<span class="err">Event not found. Check the Event ID on the screen.</span>';
      return;
    }
    const data = snap.data();
    activePin = data.activePin || null;
    roundId = data.roundId || null;
    isVotingOpen = !!data.isVotingOpen;

    if (!activePin) {
      pinMsg.innerHTML = '<span class="err">Host hasn‚Äôt set tonight‚Äôs PIN yet.</span>';
      return;
    }
    if (pinInput !== String(activePin)) {
      pinMsg.innerHTML = '<span class="err">Incorrect PIN. Try again.</span>';
      return;
    }

    // Mark this user as an attendee (server-enforced in rules)
    const attRef = eventRef.collection('attendees').doc(currentUser.uid);
    await attRef.set({ verified: true, verifiedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

    // Move to voting
    eventBadge.textContent = `Event: ${eventId}`;
    roundBadge.textContent = roundId ? `Round: ${roundId}` : 'Round: pending';
    hide(pinCard);
    show(voteCard);
    refreshRoundBadge(); // start a lightweight listener so round updates live
  } catch (e) {
    console.error(e);
    pinMsg.innerHTML = '<span class="err">Error verifying PIN. Please try again.</span>';
  }
});

/*** 7) Live round listener (optional but useful) ***/
let eventUnsub = null;
function refreshRoundBadge() {
  if (eventUnsub) eventUnsub();
  eventUnsub = db.collection('events').doc(eventId).onSnapshot(snap=>{
    const d = snap.data() || {};
    roundId = d.roundId || roundId;
    isVotingOpen = !!d.isVotingOpen;
    roundBadge.textContent = roundId ? `Round: ${roundId}` : 'Round: pending';
  });
}

/*** 8) Submit a vote (one per user per round, enforced by rules) ***/
async function cast(choice) {
  voteMsg.textContent = '';
  if (!eventId || !roundId) {
    voteMsg.innerHTML = '<span class="err">Voting isn‚Äôt open yet.</span>';
    return;
  }
  if (!isVotingOpen) {
    voteMsg.innerHTML = '<span class="err">Voting is currently closed.</span>';
    return;
  }
  const voteRef = db.collection('events').doc(eventId)
                   .collection('rounds').doc(roundId)
                   .collection('votes').doc(currentUser.uid);

  try {
    await voteRef.set({
      choice,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      displayName: currentUser.displayName || ''
    }, { merge: false }); // merge:false so a second write fails client-side if attempted

    voteMsg.innerHTML = '‚úÖ Vote received! Thanks for participating.';
  } catch (e) {
    console.error(e);
    // If doc exists, this will fail due to rules
    voteMsg.innerHTML = '<span class="err">You‚Äôve already voted this round.</span>';
  }
}

$('voteEncore').addEventListener('click', ()=>cast('encore'));
$('voteOneMore').addEventListener('click', ()=>cast('one_more'));
$('voteNext').addEventListener('click', ()=>cast('next_time'));
</script>
</body>
</html>
