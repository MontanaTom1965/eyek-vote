<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke â€“ Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0f0a18;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;min-height:100dvh;display:flex;flex-direction:column}
    header{background:linear-gradient(90deg,var(--blue),var(--purple));padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-weight:900}
    .right{display:flex;align-items:center;gap:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#271c44}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-gold{background:var(--gold);color:#000}
    .btn-red{background:#ff4c61;color:#fff}
    .btn-ghost{background:#271c44;color:#fff}
    main{flex:1;display:grid;place-items:center;padding:16px}
    .card{width:min(760px,calc(100% - 24px));background:#1b1430;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.45)}
    h1,h2,h3{margin:0 0 8px}
    .muted{opacity:.85}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    .choices{display:grid;gap:12px;margin-top:10px}
    .choice{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:#170f2a}
    .enc{border-color:rgba(39,208,125,.5)}
    .one{border-color:rgba(244,211,94,.5)}
    .may{border-color:rgba(255,89,100,.5)}
    .badge{padding:4px 8px;border-radius:999px;font-weight:900}
    .b-enc{background:var(--green);color:#000}
    .b-one{background:var(--yellow);color:#000}
    .b-may{background:var(--red);color:#fff}
    .hint{margin-top:6px;font-size:.95rem}
    .hidden{display:none !important}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#120c22;color:#fff}
    .toast{margin-top:10px;min-height:1.2em}
    .center{text-align:center}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="brand">ðŸŽ¤ Earn Your Encore Karaoke â€¢ Vote</div>
    <div class="right">
      <span class="pill" id="venueBadge">Venue: â€”</span>
      <span class="pill" id="statusBadge">Status: Loadingâ€¦</span>
      <button class="btn btn-ghost" id="enableSoundBtn" title="If your browser blocked autoplay">Enable Sound</button>
      <button class="btn btn-blue" id="loginBtn">Log in</button>
      <button class="btn btn-gold" id="signupBtn">Sign up</button>
      <button class="btn btn-red hidden" id="logoutBtn">Log out</button>
    </div>
  </header>

  <main>
    <div class="card">
      <h2 id="headline" class="center">Get readyâ€¦ voting will open soon!</h2>
      <div class="center muted" id="subline">Please log in with your email + tonightâ€™s PIN to vote.</div>
      <div class="divider"></div>

      <!-- Voting card -->
      <div id="voteCard" class="hidden">
        <div class="choices">
          <div class="choice enc">
            <div><div class="badge b-enc">Encore!</div></div>
            <button class="btn btn-blue" data-v="Encore!">Vote</button>
          </div>
          <div class="choice one">
            <div><div class="badge b-one">Another Shot!</div></div>
            <button class="btn btn-blue" data-v="Another Shot!">Vote</button>
          </div>
          <div class="choice may">
            <div><div class="badge b-may">Maybe Next Time!</div></div>
            <button class="btn btn-blue" data-v="Maybe Next Time!">Vote</button>
          </div>
        </div>
        <div class="hint muted" id="countdownNote"></div>
      </div>

      <div class="toast muted" id="toast"></div>
    </div>
  </main>

  <!-- AUDIO -->
  <audio id="countdownAudio" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/quiz-countdown.mp3"></audio>

  <!-- LOGIN MODAL -->
  <template id="tplModal">
    <div class="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:60">
      <div class="card" style="width:min(520px,calc(100% - 24px))"></div>
    </div>
  </template>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------- Helpers ---------- */
    const $ = (id)=>document.getElementById(id);
    const toast = $('toast');
    function say(msg){ toast.textContent = msg; }
    const venueBadge=$('venueBadge'), statusBadge=$('statusBadge');
    const headline=$('headline'), subline=$('subline');
    const voteCard=$('voteCard'), countdownNote=$('countdownNote');
    const countdownAudio=$('countdownAudio');
    const enableSoundBtn=$('enableSoundBtn');

    let soundEnabled = false;
    enableSoundBtn.addEventListener('click', async ()=>{
      try{
        countdownAudio.muted=false;
        await countdownAudio.play().then(()=>{ countdownAudio.pause(); countdownAudio.currentTime=0; });
        soundEnabled = true;
        enableSoundBtn.classList.add('hidden');
        say('ðŸ”Š Sound enabled.');
      }catch(e){
        say('âš ï¸ Your browser still blocked audio. Try again.');
      }
    });

    function tsv(d){ return (d && d.toDate) ? d.toDate().getTime() : Date.now(); }

    /* ---------- Session (lightweight) ---------- */
    function saveSession(obj){ localStorage.setItem('eyek-vote-session', JSON.stringify(obj||{})); }
    function getSession(){ try{ return JSON.parse(localStorage.getItem('eyek-vote-session')||'{}'); }catch{return{}} }
    function clearSession(){ localStorage.removeItem('eyek-vote-session'); }

    function setLoggedInUI(email){
      if(email){
        $('loginBtn').classList.add('hidden');
        $('signupBtn').classList.add('hidden');
        $('logoutBtn').classList.remove('hidden');
        $('subline').textContent = `Logged in as ${email}`;
      }else{
        $('loginBtn').classList.remove('hidden');
        $('signupBtn').classList.remove('hidden');
        $('logoutBtn').classList.add('hidden');
        $('subline').textContent = 'Please log in with your email + tonightâ€™s PIN to vote.';
      }
    }

    /* ---------- Current Event ---------- */
    let eventId=null, eventUnsub=null, winnersUnsub=null;
    async function resolveCurrentEvent(){
      try{
        const s = await db.collection('app').doc('state').get();
        eventId = (s.data()||{}).currentEventId || null;
        if(!eventId){
          statusBadge.textContent='Status: No event';
          headline.textContent='No active event right now.';
          return;
        }
        venueBadge.textContent='Venue: '+eventId;
        wireEvent();
      }catch(e){ statusBadge.textContent='Status: Error'; }
    }

    let autoTick=null;
    function stopLocalTimer(){ if(autoTick){ clearInterval(autoTick); autoTick=null; countdownNote.textContent=''; } }

    function startLocalTimer(vw, closeAtOverride){
      stopLocalTimer();
      let closeAt = closeAtOverride;
      if(!closeAt){
        const start = (vw && vw.openedAt) ? tsv(vw.openedAt) : Date.now();
        const durMs = (vw && Number(vw.durationSec)) ? Number(vw.durationSec)*1000 : 30000;
        closeAt = start + durMs;
      }
      autoTick = setInterval(()=>{
        const remain = Math.max(0, Math.round((closeAt - Date.now())/1000));
        countdownNote.textContent = `Voting ends in ${remain}s`;
        if(remain<=0){ stopLocalTimer(); voteCard.classList.add('hidden'); statusBadge.textContent='Status: Voting Closed'; }
      }, 250);
    }

    function wireEvent(){
      if(eventUnsub) eventUnsub();
      eventUnsub = db.collection('events').doc(eventId).onSnapshot(snap=>{
        const d=snap.data()||{};
        const singer = d.currentSingerName || '';
        headline.textContent = d.isVotingOpen ? `Vote now for ${singer || 'the current singer'}!` : (singer ? `Get readyâ€¦ ${singer} is up next!` : 'Get readyâ€¦ voting will open soon!');
        statusBadge.textContent = d.isVotingOpen ? 'Status: Voting Open' : 'Status: Voting Closed';

        if(d.isVotingOpen){
          voteCard.classList.remove('hidden');
          // Prefer authoritative close time
          const closeAt = (typeof d.voteClosesAt === 'number') ? d.voteClosesAt : null;
          startLocalTimer(d.voteWindow, closeAt);

          if(soundEnabled){
            try{ countdownAudio.currentTime=0; countdownAudio.play().catch(()=>{});}catch(e){}
          }else{
            enableSoundBtn.classList.remove('hidden'); // prompt user
          }
        }else{
          voteCard.classList.add('hidden');
          stopLocalTimer();
          try{ countdownAudio.pause(); }catch(e){}
        }
      }, (e)=> say('âš ï¸ Connection error.'));
    }

    /* ---------- Voting ---------- */
    async function submitVote(result){
      const s = getSession();
      if(!s.email || !s.eventId || !s.pinOk){
        say('âš ï¸ Please log in first.');
        return;
      }
      if(s.eventId !== eventId){
        say('âš ï¸ Your login was for a different event. Please log in again.');
        return;
      }
      try{
        const ref = db.collection('events').doc(eventId);
        const ev = (await ref.get()).data()||{};
        if(!ev.isVotingOpen){ say('Voting has closed.'); return; }

        // Deduplicate: one vote per user per performanceId
        const perfId = ev.performanceId || ev.roundId || 'current';
        const voteId = `${(s.email||'').toLowerCase()}__${perfId}`;
        await ref.collection('votes').doc(voteId).set({
          voterEmail:(s.email||'').toLowerCase(),
          performanceId: perfId,
          singerName: ev.currentSingerName||'',
          result,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        say('âœ… Vote recorded. Thanks!');
      }catch(e){
        console.error(e);
        say('âŒ Error submitting vote.');
      }
    }

    document.querySelectorAll('[data-v]').forEach(btn=>{
      btn.addEventListener('click', ()=> submitVote(btn.getAttribute('data-v')));
    });

    /* ---------- Modals ---------- */
    function modal(contentHtml){
      const t = document.getElementById('tplModal');
      const node = t.content.cloneNode(true);
      const card = node.querySelector('.card');
      card.innerHTML = contentHtml;
      document.body.appendChild(node);
      const backdrop = document.querySelector('.backdrop:last-of-type');
      function close(){ backdrop.remove(); }
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });
      return { close, root: backdrop, card };
    }

    /* ---------- Login (Email + PIN only) ---------- */
    $('loginBtn').addEventListener('click', ()=>{
      const m = modal(`
        <h3>Log in to Vote</h3>
        <div class="divider"></div>
        <label>Email</label>
        <input id="liEmail" type="email" placeholder="you@example.com" />
        <label style="margin-top:10px">Tonightâ€™s PIN</label>
        <input id="liPin" type="password" inputmode="numeric" placeholder="4â€“6 digits" />
        <div class="divider"></div>
        <div class="center">
          <button class="btn btn-blue" id="liDo">Log in</button>
          <button class="btn btn-ghost" id="liCancel">Cancel</button>
        </div>
        <div class="hint muted" style="margin-top:8px">No password needed. We verify your email + tonightâ€™s PIN only.</div>
      `);
      m.card.querySelector('#liCancel').addEventListener('click', m.close);
      m.card.querySelector('#liDo').addEventListener('click', async ()=>{
        const email = String(m.card.querySelector('#liEmail').value||'').trim().toLowerCase();
        const pin   = String(m.card.querySelector('#liPin').value||'').trim();
        if(!email || !pin){ say('âš ï¸ Enter email and PIN.'); return; }
        try{
          const ev = (await db.collection('events').doc(eventId).get()).data()||{};
          if(!ev.activePin){ say('âš ï¸ Voting PIN not set by host yet.'); return; }
          if(pin !== String(ev.activePin)){ say('âŒ Incorrect PIN.'); return; }

          saveSession({ email, eventId, pinOk:true });
          setLoggedInUI(email);
          say('âœ… Logged in. You can vote when the host opens voting.');
          m.close();
        }catch(e){ say('âŒ Could not verify PIN.'); }
      });
    });

    /* ---------- Sign up (profile) ---------- */
    $('signupBtn').addEventListener('click', ()=>{
      const m = modal(`
        <h3>Create Your Voter Profile</h3>
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>First name</label>
            <input id="suFirst" />
          </div>
          <div>
            <label>Last name</label>
            <input id="suLast" />
          </div>
        </div>
        <label style="margin-top:10px">Email</label>
        <input id="suEmail" type="email" placeholder="you@example.com" />
        <div class="row" style="margin-top:10px">
          <div>
            <label>ZIP</label>
            <input id="suZip" inputmode="numeric" />
          </div>
          <div>
            <label>Age</label>
            <input id="suAge" inputmode="numeric" />
          </div>
        </div>
        <label style="margin-top:10px">Gender</label>
        <select id="suGender">
          <option value="">Prefer not to say</option>
          <option>Female</option>
          <option>Male</option>
          <option>Non-binary</option>
          <option>Other / Self-describe</option>
        </select>
        <div class="divider"></div>
        <div class="center">
          <button class="btn btn-gold" id="suDo">Save Profile</button>
          <button class="btn btn-ghost" id="suCancel">Cancel</button>
        </div>
        <div class="hint muted" style="margin-top:8px">Tip: After you sign up once, you can just <b>Log in</b> with email + PIN at events.</div>
      `);
      m.card.querySelector('#suCancel').addEventListener('click', m.close);
      m.card.querySelector('#suDo').addEventListener('click', async ()=>{
        const first = String(m.card.querySelector('#suFirst').value||'').trim();
        const last  = String(m.card.querySelector('#suLast').value||'').trim();
        const email = String(m.card.querySelector('#suEmail').value||'').trim().toLowerCase();
        const zip   = String(m.card.querySelector('#suZip').value||'').trim();
        const age   = String(m.card.querySelector('#suAge').value||'').trim();
        const gender= String(m.card.querySelector('#suGender').value||'').trim();

        if(!email){ say('âš ï¸ Email is required.'); return; }

        try{
          await db.collection('guests').doc(email).set({
            email, first, last, zip, age, gender,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
          say('âœ… Profile saved.');
          m.close();
        }catch(e){ say('âŒ Error saving profile.'); }
      });
    });

    /* ---------- Log out ---------- */
    $('logoutBtn').addEventListener('click', ()=>{
      clearSession();
      setLoggedInUI(null);
      say('ðŸ‘‹ Logged out.');
    });

    /* ---------- Init ---------- */
    (function init(){
      // restore session UI
      const s = getSession(); setLoggedInUI(s.email||null);

      // Auto-show sound button on load (many mobile browsers require it)
      enableSoundBtn.classList.remove('hidden');

      resolveCurrentEvent();
    })();

  </script>

  <!-- File: index_vote.html | Earn Your Encore Karaoke -->
</body>
</html>
