<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke – Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0f0a18;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    h1{margin:12px 0}
    .card{background:#1b1430;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 6px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#120c22;color:#fff}
    button{cursor:pointer;font-weight:800}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .voteBtns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .enc{background:#27d07d;color:#000}
    .one{background:#f4d35e;color:#000}
    .maybe{background:#ff5964;color:#fff}
    .muted{opacity:.8}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#271c44;margin-right:8px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Vote</h1>
      <div>
        <span class="pill" id="venuePill">Venue: —</span>
        <span class="pill" id="statusPill">Status: —</span>
      </div>
    </div>

    <div class="card" id="soundCard">
      <h3>Enable Sound</h3>
      <p class="muted">Tap the button so we can play the 30-second voting sound when the host opens voting.</p>
      <button id="enableSoundBtn">Enable Sound</button>
      <audio id="countdown" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/quiz-countdown.mp3"></audio>
    </div>

    <div class="card" id="authCard">
      <h3>Register / Sign In</h3>
      <div class="row">
        <div><label>Email</label><input id="email"></div>
        <div><label>Nightly PIN (from Host)</label><input id="pin"></div>
      </div>
      <div class="row">
        <div><label>First Name</label><input id="firstName"></div>
        <div><label>Last Name</label><input id="lastName"></div>
      </div>
      <div class="row">
        <div><label>ZIP</label><input id="zip"></div>
        <div><label>Age</label><input id="age" type="number" min="13" max="120"></div>
      </div>
      <div>
        <label>Gender</label>
        <select id="gender">
          <option value="">Prefer not to say</option>
          <option>Female</option>
          <option>Male</option>
          <option>Non-binary</option>
          <option>Other</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <button id="saveProfileBtn">Save / Continue</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card" id="voteCard" style="display:none">
      <div class="muted">Now voting for:</div>
      <h2 id="currentSinger">—</h2>
      <div class="muted" id="countdownNote"></div>
      <div class="voteBtns">
        <button class="enc"   data-choice="Encore!">Encore!</button>
        <button class="one"   data-choice="Another Shot!">Another Shot!</button>
        <button class="maybe" data-choice="Maybe Next Time!">Maybe Next Time!</button>
      </div>
      <div id="voteMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    const venuePill=$('venuePill'), statusPill=$('statusPill');
    const currentSinger=$('currentSinger'), voteCard=$('voteCard');
    const authMsg=$('authMsg'), voteMsg=$('voteMsg');
    const countdownAudio=$('countdown'), countdownNote=$('countdownNote');

    let eventId=null, nightlyPin='', myProfile=null, autoTick=null;

    $('enableSoundBtn').addEventListener('click', ()=>{
      countdownAudio.play().then(()=>{ countdownAudio.pause(); countdownAudio.currentTime=0; $('soundCard').style.display='none'; }).catch(()=>{ alert('Tap again if your browser blocked the sound.'); });
    });

    async function boot(){
      const s = await db.collection('app').doc('state').get();
      eventId = (s.data()||{}).currentEventId || null;
      if(!eventId){ authMsg.textContent='No active event yet.'; return; }
      venuePill.textContent='Venue: '+eventId;

      db.collection('events').doc(eventId).onSnapshot(snap=>{
        const d=snap.data()||{};
        nightlyPin = d.activePin || '';
        statusPill.textContent = d.isVotingOpen ? 'Status: Voting Open' : 'Status: Waiting';
        currentSinger.textContent = d.currentSingerName || '—';
        if(d.isVotingOpen){
          voteCard.style.display='block';
          startLocalTimer(d.voteWindow);
          try{ countdownAudio.play().catch(()=>{});}catch(e){}
        }else{
          voteCard.style.display='none';
          stopLocalTimer();
        }
      });
    }

    function startLocalTimer(vw){
      stopLocalTimer();
      if(!vw) { countdownNote.textContent=''; return; }
      autoTick = setInterval(()=>{
        const start = (vw.openedAt && vw.openedAt.toDate) ? vw.openedAt.toDate().getTime() : Date.now();
        const end = start + (Number(vw.durationSec||30)*1000);
        const remain = Math.max(0, Math.round((end - Date.now())/1000));
        countdownNote.textContent = `Voting ends in ${remain}s`;
        if(remain<=0) stopLocalTimer();
      }, 500);
    }
    function stopLocalTimer(){ if(autoTick){ clearInterval(autoTick); autoTick=null; } countdownNote.textContent=''; }

    $('saveProfileBtn').addEventListener('click', async ()=>{
      const email=($('email').value||'').trim().toLowerCase();
      const pin = ($('pin').value||'').trim();
      if(!email){ authMsg.textContent='Enter email.'; return; }
      if(pin!==nightlyPin || !pin){ authMsg.textContent='PIN is incorrect for tonight.'; return; }

      const uid = email.replace(/[^a-z0-9]/g,'_');
      const profile = {
        email,
        firstName: ($('firstName').value||'').trim(),
        lastName:  ($('lastName').value||'').trim(),
        zip:       ($('zip').value||'').trim(),
        age:       Number($('age').value||''),
        gender:    ($('gender').value||''),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try{
        await db.collection('profiles').doc(uid).set(profile, { merge:true });
        myProfile = { uid, ...profile };
        authMsg.textContent='Saved. You can vote when the host opens voting.';
      }catch(e){ authMsg.textContent='Error saving profile.'; }
    });

    // Vote buttons
    document.querySelectorAll('.voteBtns button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if(!myProfile){ voteMsg.textContent='Please register above first.'; return; }
        const choice = btn.getAttribute('data-choice');
        try{
          const roundId = (await db.collection('events').doc(eventId).get()).data().roundId || 'round';
          const vref = db.collection('events').doc(eventId).collection('rounds').doc(roundId).collection('votes').doc(myProfile.uid);
          await vref.set({ userId: myProfile.uid, choice, ts: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          voteMsg.textContent = `Vote recorded: ${choice}`;
        }catch(e){ voteMsg.textContent='Error submitting vote.'; }
      });
    });

    boot();
  </script>

  <!-- File: index_vote.html | Earn Your Encore Karaoke -->
</body>
</html>
