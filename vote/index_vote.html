<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke â€“ Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#003e81;--gold:#eaba54;--purple:#2F0658;--ink:#0f0a18;--card:#1b1430}
    *{box-sizing:border-box}
    body{margin:0;background:var(--ink);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    header{padding:18px 16px;background:linear-gradient(90deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:1.1rem}
    .container{max-width:980px;margin:16px auto;padding:0 12px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
    label{display:block;margin:8px 0 6px}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#120c22;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:900;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-gold{background:var(--gold);color:#000}
    .btn-red{background:#ff4c61;color:#fff}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .center{display:flex;align-items:center;justify-content:center;text-align:center}
    .muted{opacity:.85}
    .choice{font-size:1.25rem}
    .timer{font-size:1.25rem;font-weight:900}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#271c44}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>ðŸ“± Earn Your Encore Karaoke â€¢ Vote</h1>
    <div class="stack">
      <button id="enableSoundBtn" class="btn btn-gold">Enable Sound</button>
      <span id="eventBadge" class="pill">Event: â€”</span>
      <span id="statusBadge" class="pill">Status: â€”</span>
      <span id="timer" class="pill timer">â€”</span>
    </div>
  </header>

  <div class="container">
    <!-- Auth / Session -->
    <div class="card" id="authCard">
      <h3 style="margin:0 0 12px">Sign Up or Log In</h3>
      <div class="stack" style="margin-bottom:10px">
        <button id="showLogin" class="btn btn-blue">Log In</button>
        <button id="showSignup" class="btn btn-gold">Sign Up</button>
        <button id="logoutBtn" class="btn btn-red" style="display:none">Log Out</button>
      </div>

      <!-- LOGIN: email + nightly PIN only -->
      <div id="loginBox" style="display:none">
        <div class="row">
          <div>
            <label>Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" />
          </div>
          <div>
            <label>Tonightâ€™s PIN</label>
            <input id="loginPin" placeholder="Ask the host" />
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button id="loginBtn" class="btn btn-blue">Log In</button>
        </div>
        <div class="muted" id="loginMsg" style="margin-top:6px"></div>
      </div>

      <!-- SIGNUP: full profile -->
      <div id="signupBox" style="display:none">
        <div class="row">
          <div>
            <label>Email</label>
            <input id="suEmail" type="email" placeholder="you@example.com" />
          </div>
          <div>
            <label>Zip Code</label>
            <input id="suZip" placeholder="e.g. 59901" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>First Name</label>
            <input id="suFirst" placeholder="First name" />
          </div>
          <div>
            <label>Last Name</label>
            <input id="suLast" placeholder="Last name" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Age</label>
            <input id="suAge" type="number" min="13" max="120" placeholder="Age" />
          </div>
          <div>
            <label>Gender</label>
            <select id="suGender">
              <option value="">Prefer not to say</option>
              <option>Female</option>
              <option>Male</option>
              <option>Non-binary</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button id="signupBtn" class="btn btn-gold">Create Account</button>
        </div>
        <div class="muted" id="signupMsg" style="margin-top:6px"></div>
      </div>

      <!-- SESSION SUMMARY -->
      <div id="sessionBox" style="display:none; margin-top:8px">
        <div><b>Logged in as:</b> <span id="whoAmI">â€”</span></div>
        <div class="muted small">PIN is validated against tonightâ€™s event before voting.</div>
      </div>
    </div>

    <!-- Voting Card -->
    <div class="card">
      <div class="center" style="margin-bottom:8px">
        <div>
          <div class="muted" id="welcomeLine">Get readyâ€¦ voting opens when the host starts it!</div>
          <div style="font-size:2rem;font-weight:1000;margin-top:6px" id="currentSinger">â€”</div>
        </div>
      </div>

      <div class="center" style="margin-top:10px">
        <div class="stack">
          <button id="btnEncore" class="btn btn-gold choice" disabled>Encore!</button>
          <button id="btnAnother" class="btn btn-blue choice" disabled>Another Shot!</button>
          <button id="btnMaybe"  class="btn btn-red  choice" disabled>Maybe Next Time!</button>
        </div>
      </div>

      <div class="muted" id="voteMsg" style="margin-top:10px;text-align:center"></div>
    </div>

    <!-- Links (handy) -->
    <div class="card">
      <div class="stack">
        <a class="btn btn-gold" href="https://vote.earnyourencorekaraoke.com/vote/index_vote.html">Vote (this)</a>
        <a class="btn btn-blue" href="https://vote.earnyourencorekaraoke.com/screen/index_screen.html" target="_blank" rel="noopener">Open Screen</a>
        <a class="btn btn-blue" href="https://vote.earnyourencorekaraoke.com/board/index_board.html" target="_blank" rel="noopener">Open Board</a>
      </div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="bgCountdown" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/quiz-countdown.mp3"></audio>

  <script>
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    // --- Helpers ---
    const $=id=>document.getElementById(id);
    const eventBadge=$('eventBadge'), statusBadge=$('statusBadge'), timerEl=$('timer');
    const currentSinger=$('currentSinger'), voteMsg=$('voteMsg'), welcomeLine=$('welcomeLine');
    const bgCountdown=$('bgCountdown');

    function toast(el,msg){ el.textContent=msg; }
    function canonicalKey(v){return String(v||'').toLowerCase().trim().replace(/[^\w]+/g,'-').replace(/(^-|-$)/g,'');}

    // --- Session (no Firebase Auth; store profile in Firestore + localStorage) ---
    const session = {
      email: localStorage.getItem('eyek.email') || '',
      name:  localStorage.getItem('eyek.name') || '',
      pinOK: false
    };
    function saveSession(){
      localStorage.setItem('eyek.email', session.email||'');
      localStorage.setItem('eyek.name', session.name||'');
    }
    function showLoggedInUI(){
      $('authCard').style.display='block';
      $('logoutBtn').style.display='inline-block';
      $('showLogin').style.display='inline-block';
      $('showSignup').style.display='inline-block';
      $('loginBox').style.display='none';
      $('signupBox').style.display='none';
      $('sessionBox').style.display='block';
      $('whoAmI').textContent = `${session.name||session.email}`;
    }
    function showLoggedOutUI(){
      session.email=''; session.name=''; session.pinOK=false; saveSession();
      $('logoutBtn').style.display='none';
      $('sessionBox').style.display='none';
      $('loginBox').style.display='none';
      $('signupBox').style.display='none';
      $('showLogin').style.display='inline-block';
      $('showSignup').style.display='inline-block';
    }

    $('showLogin').onclick=()=>{ $('loginBox').style.display='block'; $('signupBox').style.display='none'; };
    $('showSignup').onclick=()=>{ $('signupBox').style.display='block'; $('loginBox').style.display='none'; };
    $('logoutBtn').onclick=()=>{ showLoggedOutUI(); toast(voteMsg,'You are logged out.'); updateButtons(); };

    // Signup
    $('signupBtn').onclick=async ()=>{
      const email=$('suEmail').value.trim();
      const first=$('suFirst').value.trim();
      const last =$('suLast').value.trim();
      const zip  =$('suZip').value.trim();
      const age  =Number($('suAge').value||'');
      const gender=$('suGender').value||'';
      if(!email){ toast($('signupMsg'),'Enter email.'); return; }
      try{
        await db.collection('users').doc(email).set({
          email, first, last, zip, age:isFinite(age)?age:null, gender,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        session.email=email; session.name=`${first||''} ${last||''}`.trim() || email; saveSession();
        toast($('signupMsg'),'âœ… Account saved. Now log in with tonightâ€™s PIN.');
        showLoggedInUI();
      }catch(e){ toast($('signupMsg'),'âŒ Error creating account.'); }
    };

    // Login (email + nightly PIN)
    $('loginBtn').onclick=async ()=>{
      const email=$('loginEmail').value.trim();
      const pin  =$('loginPin').value.trim();
      if(!email||!pin){ toast($('loginMsg'),'Enter email and PIN.'); return; }
      try{
        // ensure profile exists
        const uref=db.collection('users').doc(email);
        const us=await uref.get();
        if(!us.exists){
          await uref.set({ email, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        }
        // validate PIN against current event
        const st=await db.collection('app').doc('state').get();
        const eventId=(st.data()||{}).currentEventId;
        if(!eventId){ toast($('loginMsg'),'Host has not selected an event yet.'); return; }
        const ev=await db.collection('events').doc(eventId).get();
        const expect=(ev.data()||{}).activePin || '';
        if(!expect){ toast($('loginMsg'),'PIN not set by host.'); return; }
        if(String(pin)!==String(expect)){ toast($('loginMsg'),'âŒ Wrong PIN.'); session.pinOK=false; updateButtons(); return; }

        session.email=email; session.name=(us.data()&& ((us.data().first||'')+' '+(us.data().last||'')).trim()) || email;
        session.pinOK=true; saveSession();
        toast($('loginMsg'),'âœ… Logged in for tonight.');
        showLoggedInUI(); updateButtons();
        // mark attendance
        await db.collection('events').doc(eventId).collection('attendees').doc(email).set({
          email, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(e){ toast($('loginMsg'),'âŒ Error logging in.'); }
    };

    // --- Sound enable (mobile requires user gesture) ---
    let soundEnabled=false;
    $('enableSoundBtn').onclick=()=>{
      bgCountdown.currentTime=0;
      bgCountdown.play().then(()=>{
        bgCountdown.pause(); bgCountdown.currentTime=0;
        soundEnabled=true;
        $('enableSoundBtn').textContent='Sound Enabled âœ…';
      }).catch(()=>{ /* user may need to tap again */ });
    };

    // --- Event wiring & vote window ---
    let eventId=null, roundId=null, voteClosesAt=null, isVotingOpen=false, autoTick=null;

    async function initEvent(){
      const s = await db.collection('app').doc('state').get();
      eventId = (s.data()||{}).currentEventId || null;
      if(!eventId){ eventBadge.textContent='Event: â€”'; statusBadge.textContent='Status: â€”'; return; }
      eventBadge.textContent='Event: '+eventId;

      db.collection('events').doc(eventId).onSnapshot(snap=>{
        const d=snap.data()||{};
        statusBadge.textContent = 'Status: ' + (d.isVotingOpen?'Voting Open':'Voting Closed');
        $('welcomeLine').textContent = d.isVotingOpen ? 'Voting is OPEN!' : 'Get readyâ€¦ voting opens when the host starts it!';
        currentSinger.textContent = d.currentSingerName || 'â€”';

        roundId = d.roundId || d.performanceId || null;
        isVotingOpen = !!d.isVotingOpen;
        voteClosesAt = (typeof d.voteClosesAt === 'number') ? d.voteClosesAt : null;

        if(isVotingOpen){
          updateButtons();
          if(soundEnabled){
            // start countdown audio (play once at open)
            try{ bgCountdown.currentTime=0; bgCountdown.play().catch(()=>{});}catch(e){}
          }
          startTick();
        }else{
          stopTick();
          timerEl.textContent='â€”';
          updateButtons();
          try{ bgCountdown.pause(); }catch(e){}
        }
      });
    }

    function startTick(){
      stopTick();
      autoTick=setInterval(()=>{
        if(!isVotingOpen){ stopTick(); return; }
        let remain='â€”';
        if(voteClosesAt){
          const sec=Math.max(0, Math.round((voteClosesAt - Date.now())/1000));
          remain = sec+'s';
          if(sec<=0){ stopTick(); }
        }
        timerEl.textContent = remain;
      }, 250);
    }
    function stopTick(){ if(autoTick){ clearInterval(autoTick); autoTick=null; } }

    function updateButtons(){
      const canVote = isVotingOpen && !!roundId && !!session.email && session.pinOK;
      $('btnEncore').disabled = !canVote;
      $('btnAnother').disabled = !canVote;
      $('btnMaybe').disabled  = !canVote;

      if(!session.email){
        toast(voteMsg,'Log in to vote (email + PIN).');
      }else if(!session.pinOK){
        toast(voteMsg,'Enter the correct PIN to enable voting.');
      }else if(!isVotingOpen){
        toast(voteMsg,'Voting is closed right now.');
      }else{
        toast(voteMsg,'Cast your vote!');
      }
    }

    async function cast(choice){
      if(!$('btnEncore').disabled){ /* allowed */ }
      const canVote = isVotingOpen && !!roundId && !!session.email && session.pinOK;
      if(!canVote){ updateButtons(); return; }
      try{
        const voteId = canonicalKey(session.email)+'-'+roundId;
        await db.collection('events').doc(eventId).collection('votes').doc(voteId).set({
          roundId, voter: session.email, choice,
          at: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        toast(voteMsg,'âœ… Vote received: '+choice);
      }catch(e){ toast(voteMsg,'âŒ Error submitting vote.'); }
    }

    $('btnEncore').onclick = ()=>cast('Encore!');
    $('btnAnother').onclick= ()=>cast('Another Shot!');
    $('btnMaybe').onclick  = ()=>cast('Maybe Next Time!');

    // init
    if(session.email){ showLoggedInUI(); } else { showLoggedOutUI(); }
    initEvent();
  </script>

  <!-- File: index_vote.html | Earn Your Encore Karaoke -->
</body>
</html>
