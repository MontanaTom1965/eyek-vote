<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Your Encore! Karaoke</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --purple: #3a115f;
            --gold: #eaba54;
            --light-blue: #79aec1;
            --background-purple: #2F0658;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-purple);
        }
        .container {
            max-width: 600px;
        }
        .btn {
            background-color: var(--gold);
            color: var(--purple);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.1s;
        }
        .btn:hover {
            transform: scale(1.02);
        }
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--light-blue);
            background-color: #ffffff;
            color: #000000;
        }
        .vote-btn-encore {
            background-color: var(--gold);
            color: var(--purple);
        }
        .vote-btn-shot {
            background-color: var(--light-blue);
            color: var(--purple);
        }
        .vote-btn-next-time {
            background-color: var(--purple);
            color: var(--gold);
            border: 2px solid var(--gold);
        }
    </style>
</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="container mx-auto p-8 rounded-3xl bg-gray-800 shadow-xl space-y-8 text-center">

        <!-- Header -->
        <header>
            <h1 class="text-6xl font-extrabold text-[var(--gold)]">Earn Your Encore!</h1>
            <p class="text-2xl text-[var(--light-blue)] mt-4">Audience Voting</p>
        </header>

        <!-- Dynamic Content Section -->
        <main id="main-content" class="space-y-6">

            <!-- Authentication Section (visible before login) -->
            <section id="auth-section" class="space-y-4">
                <div class="space-y-2">
                    <button id="show-signup-btn" class="btn w-full">Sign Up</button>
                    <button id="show-login-btn" class="btn w-full">Log In</button>
                </div>

                <!-- Sign Up Form -->
                <form id="signup-form" class="hidden space-y-4">
                    <h2 class="text-xl font-bold text-[var(--light-blue)]">Create an Account</h2>
                    <input type="email" id="signup-email" placeholder="Email" class="input-field w-full">
                    <input type="password" id="signup-password" placeholder="Password (6+ chars)" class="input-field w-full">
                    <input type="text" id="signup-name" placeholder="Full Name" class="input-field w-full">
                    <input type="text" id="signup-address" placeholder="Address" class="input-field w-full">
                    <input type="text" id="signup-phone" placeholder="Phone" class="input-field w-full">
                    <input type="text" id="signup-gender" placeholder="Gender" class="input-field w-full">
                    <input type="number" id="signup-age" placeholder="Age" class="input-field w-full">
                    <button type="submit" class="btn w-full">Submit</button>
                    <p id="signup-error" class="text-red-400 text-sm hidden"></p>
                </form>

                <!-- Log In Form -->
                <form id="login-form" class="hidden space-y-4">
                    <h2 class="text-xl font-bold text-[var(--light-blue)]">Log In</h2>
                    <input type="email" id="login-email" placeholder="Email" class="input-field w-full">
                    <input type="password" id="login-password" placeholder="Password" class="input-field w-full">
                    <button type="submit" class="btn w-full">Log In</button>
                    <p id="login-error" class="text-red-400 text-sm hidden"></p>
                </form>
            </section>

            <!-- Voting Section (visible after login) -->
            <section id="voting-section" class="hidden space-y-6">
                <h2 id="user-greeting" class="text-2xl font-bold text-white"></h2>
                
                <!-- Display Area -->
                <div id="singer-display" class="bg-gray-700 p-6 rounded-lg space-y-2">
                    <h3 id="singer-name" class="text-3xl font-bold text-[var(--gold)]">No Singer Active</h3>
                    <p id="singer-song" class="text-xl text-[var(--light-blue)]">Waiting for the next performance...</p>
                </div>
                
                <!-- Voting Buttons -->
                <div id="vote-buttons" class="space-y-4 hidden">
                    <button id="encore-btn" class="btn vote-btn-encore w-full text-2xl">Encore!</button>
                    <button id="shot-btn" class="btn vote-btn-shot w-full text-2xl">Another Shot!</button>
                    <button id="next-time-btn" class="btn vote-btn-next-time w-full text-2xl">Maybe Next Time!</button>
                    <p id="vote-status" class="text-lg font-bold"></p>
                </div>
            </section>
        </main>
        
        <!-- View Board Button -->
        <a id="view-board-btn" href="../screen-app.html" class="inline-block btn mt-8">View Live Display</a>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
            authDomain: "eyek-vote.firebaseapp.com",
            projectId: "eyek-vote",
            storageBucket: "eyek-vote.firebasestorage.app",
            messagingSenderId: "954696683994",
            appId: "1:954696683994:web:21a84298a94648ff0230e3"
        };
        const appId = firebaseConfig.appId;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Elements ---
        const authSection = document.getElementById('auth-section');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupName = document.getElementById('signup-name');
        const signupAddress = document.getElementById('signup-address');
        const signupPhone = document.getElementById('signup-phone');
        const signupGender = document.getElementById('signup-gender');
        const signupAge = document.getElementById('signup-age');
        const signupError = document.getElementById('signup-error');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const votingSection = document.getElementById('voting-section');
        const userGreeting = document.getElementById('user-greeting');
        const singerNameDisplay = document.getElementById('singer-name');
        const singerSongDisplay = document.getElementById('singer-song');
        const voteButtons = document.getElementById('vote-buttons');
        const encoreBtn = document.getElementById('encore-btn');
        const shotBtn = document.getElementById('shot-btn');
        const nextTimeBtn = document.getElementById('next-time-btn');
        const voteStatus = document.getElementById('vote-status');

        // --- Event Listeners ---
        showSignupBtn.addEventListener('click', () => {
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            signupError.classList.add('hidden');
        });
        showLoginBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            loginError.classList.add('hidden');
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupEmail.value;
            const password = signupPassword.value;
            const name = signupName.value;
            const address = signupAddress.value;
            const phone = signupPhone.value;
            const gender = signupGender.value;
            const age = signupAge.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data'), {
                    name, email, address, phone, gender, age
                });
                signupError.classList.add('hidden');
            } catch (error) {
                console.error("Signup error:", error);
                signupError.textContent = `Error: ${error.message}`;
                signupError.classList.remove('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.classList.add('hidden');
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = `Error: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        });

        encoreBtn.addEventListener('click', () => submitVote('Encore!'));
        shotBtn.addEventListener('click', () => submitVote('Another Shot!'));
        nextTimeBtn.addEventListener('click', () => submitVote('Maybe Next Time!'));

        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.classList.add('hidden');
                votingSection.classList.remove('hidden');
                userGreeting.textContent = `Welcome, ${user.displayName || 'Guest'}!`;
                // Start listening for active event
                const eventDocRef = doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent');
                onSnapshot(eventDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().status === 'active' && docSnap.data().votingStatus === 'active') {
                        const currentSinger = docSnap.data().currentSinger;
                        singerNameDisplay.textContent = currentSinger.name;
                        singerSongDisplay.textContent = `"${currentSinger.song}"`;
                        voteButtons.classList.remove('hidden');
                        voteStatus.textContent = '';
                    } else {
                        singerNameDisplay.textContent = "No Singer Active";
                        singerSongDisplay.textContent = "Waiting for the next performance...";
                        voteButtons.classList.add('hidden');
                        voteStatus.textContent = '';
                    }
                });
            } else {
                authSection.classList.remove('hidden');
                votingSection.classList.add('hidden');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        });

        // --- Voting Logic ---
        async function submitVote(vote) {
            const user = auth.currentUser;
            if (!user) {
                console.error("User not logged in.");
                voteStatus.textContent = "You must be logged in to vote.";
                return;
            }

            const eventDocRef = doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent');
            const eventSnap = await getDoc(eventDocRef);
            if (!eventSnap.exists() || eventSnap.data().votingStatus !== 'active') {
                voteStatus.textContent = "Voting is not currently open.";
                return;
            }

            const currentSingerId = eventSnap.data().currentSinger.id;

            try {
                // Save vote to public collection
                await setDoc(doc(db, `artifacts/${appId}/public/data/eventVotes`, `${currentSingerId}_${user.uid}`), {
                    userId: user.uid,
                    singerId: currentSingerId,
                    vote: vote,
                    timestamp: new Date()
                });

                // Update the UI
                voteStatus.textContent = `Your vote for "${vote}" has been cast!`;

                // Update the user's private vote history
                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/votes`, `${currentSingerId}_${new Date().toISOString()}`), {
                    singerId: currentSingerId,
                    vote: vote,
                    timestamp: new Date()
                });

            } catch (error) {
                console.error("Error submitting vote:", error);
                voteStatus.textContent = "An error occurred. Please try again.";
            }
        }
    </script>
</body>
</html>
