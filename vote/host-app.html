<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Your Encore! KJ Host</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --purple: #3a115f;
            --gold: #eaba54;
            --light-blue: #79aec1;
            --background-purple: #2F0658;
            --dark-gray: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-purple);
        }
        .container {
            max-width: 800px;
        }
        .btn {
            transition: transform 0.1s ease-in-out, background-color 0.2s;
            border-radius: 0.5rem;
            padding: 1rem 2rem;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-gold {
            background-color: var(--gold);
            color: var(--background-purple);
        }
        .btn-gold:hover {
            background-color: #ffd76d;
        }
        .btn-light-blue {
            background-color: var(--light-blue);
            color: var(--background-purple);
        }
        .btn-light-blue:hover {
            background-color: #9cd4e6;
        }
        .btn-purple {
            background-color: var(--purple);
            color: var(--gold);
            border-color: var(--gold);
        }
        .btn-purple:hover {
            background-color: #4a1d74;
        }
        .input-field {
            border: 1px solid var(--gold);
            background-color: transparent;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .input-field::placeholder {
            color: var(--light-blue);
        }
    </style>
</head>
<body class="text-white flex flex-col items-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="container mx-auto p-6 rounded-3xl bg-gray-800 shadow-xl mt-8 space-y-6">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-[var(--gold)]">KJ Host Panel</h1>
            <p class="text-[var(--light-blue)] mt-2">Manage your Earn Your Encore! event in real-time.</p>
        </header>

        <!-- KJ Login Section -->
        <section id="login-section" class="bg-[var(--purple)] p-6 rounded-lg space-y-4 text-center">
            <h2 class="text-xl font-bold text-[var(--gold)]">KJ Login</h2>
            <input type="email" id="kj-email" placeholder="KJ Email" class="input-field w-full">
            <input type="password" id="kj-password" placeholder="Password" class="input-field w-full">
            <button id="login-btn" class="btn w-full btn-gold">Log In</button>
            <p id="login-error" class="text-red-400 text-sm hidden"></p>
        </section>

        <!-- Main Host Panel (hidden until logged in) -->
        <main id="host-panel" class="hidden space-y-6">
            
            <!-- Event Management Section -->
            <section class="bg-gray-700 p-6 rounded-lg space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-[var(--light-blue)]">Current Event:</h2>
                    <button id="end-event-btn" class="btn btn-purple">End Event</button>
                </div>
                <div class="flex flex-col space-y-2">
                    <input type="text" id="event-name" placeholder="Enter Event Name" class="input-field">
                    <button id="start-event-btn" class="btn btn-gold">Start Event</button>
                </div>
                <p id="event-status" class="text-center font-bold text-lg text-red-400">No active event. Start one to begin!</p>
            </section>

            <!-- Add Singer Section -->
            <section id="add-singer-section" class="bg-gray-700 p-6 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-[var(--light-blue)]">Add New Singer</h2>
                <input type="text" id="singer-name" placeholder="Singer's Name" class="input-field w-full">
                <input type="text" id="song-name" placeholder="Song & Artist" class="input-field w-full">
                <button id="add-singer-btn" class="btn w-full btn-light-blue">Add to Queue</button>
            </section>

            <!-- Singer Queue & Current Singer Section -->
            <section class="bg-gray-700 p-6 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-[var(--light-blue)]">Singer Queue</h2>
                <ul id="singer-queue-list" class="space-y-2">
                    <!-- Queue items will be dynamically added here -->
                    <li class="text-gray-400">Queue is empty.</li>
                </ul>
            </section>
        </main>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
            authDomain: "eyek-vote.firebaseapp.com",
            projectId: "eyek-vote",
            storageBucket: "eyek-vote.firebasestorage.app",
            messagingSenderId: "954696683994",
            appId: "1:954696683994:web:21a84298a94648ff0230e3"
        };
        const appId = firebaseConfig.appId;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;

        // UI Elements
        const loginSection = document.getElementById('login-section');
        const hostPanel = document.getElementById('host-panel');
        const kjEmailInput = document.getElementById('kj-email');
        const kjPasswordInput = document.getElementById('kj-password');
        const loginBtn = document.getElementById('login-btn');
        const loginErrorEl = document.getElementById('login-error');
        const eventNameInput = document.getElementById('event-name');
        const startEventBtn = document.getElementById('start-event-btn');
        const endEventBtn = document.getElementById('end-event-btn');
        const eventStatusEl = document.getElementById('event-status');
        const singerNameInput = document.getElementById('singer-name');
        const songNameInput = document.getElementById('song-name');
        const addSingerBtn = document.getElementById('add-singer-btn');
        const singerQueueList = document.getElementById('singer-queue-list');
        
        let activeEventId = null;
        let countdownTimer = null;
        let audio = new Audio('https://vote.earnyourencorekaraoke.com/vote/quiz-countdown.mp3');

        // --- Authentication & UI State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                loginSection.classList.add('hidden');
                hostPanel.classList.remove('hidden');
                startRealtimeListeners();
            } else {
                userId = null;
                loginSection.classList.remove('hidden');
                hostPanel.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = kjEmailInput.value;
            const password = kjPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginErrorEl.classList.add('hidden');
            } catch (error) {
                console.error("Login error:", error);
                loginErrorEl.textContent = "Invalid email or password.";
                loginErrorEl.classList.remove('hidden');
            }
        });

        // --- Event Management Logic ---
        startEventBtn.addEventListener('click', async () => {
            const eventName = eventNameInput.value.trim();
            if (!eventName) {
                eventStatusEl.textContent = "Please enter an event name.";
                return;
            }
            try {
                // Check if the currentEvent document exists
                const docRef = doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().status === 'active') {
                    eventStatusEl.textContent = "An event is already active.";
                    return;
                }

                await setDoc(docRef, {
                    name: eventName,
                    status: 'active',
                    currentSinger: null,
                    votingStatus: 'idle',
                    votingStartTime: null,
                    votingEndTime: null,
                    startTime: new Date()
                });
                eventStatusEl.textContent = `Event "${eventName}" is now active.`;
            } catch (error) {
                console.error("Error starting event:", error);
                eventStatusEl.textContent = "Error starting event. Check console for details.";
            }
        });

        endEventBtn.addEventListener('click', async () => {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent');
                await deleteDoc(docRef);
                eventStatusEl.textContent = "Event has ended.";
            } catch (error) {
                console.error("Error ending event:", error);
                eventStatusEl.textContent = "Error ending event. Check console for details.";
            }
        });

        // --- Voting Logic for Host ---
        async function startVoting(singer) {
            const docRef = doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent');
            const votingEndTime = new Date(Date.now() + 30 * 1000);
            await setDoc(docRef, {
                currentSinger: { id: singer.id, name: singer.name, song: singer.song },
                votingStatus: 'active',
                votingStartTime: new Date(),
                votingEndTime: votingEndTime
            }, { merge: true });

            audio.play();

            countdownTimer = setInterval(() => {
                const remainingTime = Math.max(0, votingEndTime.getTime() - Date.now());
                if (remainingTime <= 0) {
                    clearInterval(countdownTimer);
                    endVoting();
                }
            }, 1000);
        }

        async function extendVoting() {
            if (activeEventId) {
                const docRef = doc(db, `artifacts/${appId}/public/data/events`, activeEventId);
                const currentEventSnap = await getDoc(docRef);
                const currentEvent = currentEventSnap.data();
                if (currentEvent.votingStatus === 'active') {
                    const newEndTime = new Date(currentEvent.votingEndTime.toDate().getTime() + 15 * 1000);
                    await setDoc(docRef, { votingEndTime: newEndTime }, { merge: true });
                    audio.play(); // Restart the countdown sound
                }
            }
        }
        
        async function endVoting() {
            if (activeEventId) {
                clearInterval(countdownTimer);
                const docRef = doc(db, `artifacts/${appId}/public/data/events`, activeEventId);
                await setDoc(docRef, { votingStatus: 'completed' }, { merge: true });
                audio.pause();
                audio.currentTime = 0;
            }
        }

        // --- Singer & Queue Management ---
        addSingerBtn.addEventListener('click', async () => {
            const singerName = singerNameInput.value.trim();
            const songName = songNameInput.value.trim();
            if (!singerName || !songName) {
                alert("Please enter both a singer name and a song name.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/singerQueue`), {
                    name: singerName,
                    song: songName,
                    status: 'queued',
                    votes: {},
                    timestamp: new Date()
                });
                singerNameInput.value = '';
                songNameInput.value = '';
            } catch (error) {
                console.error("Error adding singer:", error);
                alert("Error adding singer. Check console for details.");
            }
        });

        singerQueueList.addEventListener('click', async (e) => {
            if (e.target.tagName === 'LI') {
                const singerId = e.target.dataset.id;
                const singerName = e.target.dataset.name;
                const songName = e.target.dataset.song;

                // Set this singer as the current active singer for voting
                startVoting({ id: singerId, name: singerName, song: songName });
            }
        });

        // --- Real-time Listeners ---
        function startRealtimeListeners() {
            // Listen for the active event
            onSnapshot(doc(db, `artifacts/${appId}/public/data/events`, 'currentEvent'), (docSnap) => {
                if (docSnap.exists() && docSnap.data().status === 'active') {
                    const event = docSnap.data();
                    eventNameInput.value = event.name;
                    eventStatusEl.textContent = `Event "${event.name}" is active.`;
                    activeEventId = docSnap.id;
                    if (event.currentSinger) {
                        eventStatusEl.textContent = `Currently Singing: ${event.currentSinger.name}`;
                    }
                } else {
                    activeEventId = null;
                    eventStatusEl.textContent = "No active event. Start one to begin!";
                }
            });

            // Listen for changes to the singer queue
            const q = query(collection(db, `artifacts/${appId}/public/data/singerQueue`), where('status', 'in', ['queued', 'singing']));
            onSnapshot(q, (snapshot) => {
                singerQueueList.innerHTML = '';
                if (snapshot.empty) {
                    const li = document.createElement('li');
                    li.className = "text-gray-400";
                    li.textContent = "Queue is empty.";
                    singerQueueList.appendChild(li);
                    return;
                }
                snapshot.forEach(doc => {
                    const singer = doc.data();
                    const li = document.createElement('li');
                    li.dataset.id = doc.id;
                    li.dataset.name = singer.name;
                    li.dataset.song = singer.song;
                    li.className = `p-2 rounded-md cursor-pointer transition-colors duration-200 ${singer.status === 'singing' ? 'bg-gold text-purple font-bold' : 'bg-gray-600 hover:bg-gray-500'}`;
                    li.textContent = `${singer.name} - "${singer.song}"`;
                    singerQueueList.appendChild(li);
                });
            });
        }
    </script>
</body>
</html>
