<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke – Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
      --ink:#0f0a18; --card:#1b1430; --line:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--ink);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    header{padding:10px 16px; text-align:center; background:linear-gradient(90deg,var(--blue),var(--purple));}
    .welcome{font-size:1.2rem; opacity:.9}
    .venue{font-weight:900}
    .toprow{display:flex;gap:16px;align-items:center;justify-content:center;padding:10px 16px}
    .badge{display:inline-block;padding:8px 14px;border-radius:999px;background:#271c44;border:1px solid var(--line);font-weight:900}
    .timer{font-size:1.6rem}
    .status{opacity:.9}
    .current{display:flex;align-items:center;justify-content:center;text-align:center; height:16vh}
    .current .name{font-size:7.2vw; line-height:1.05; font-weight:1000; letter-spacing:.5px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px; padding:16px; height:62vh}
    .col{border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:12px; background:var(--card); overflow:auto}
    h2{margin:0 0 8px}
    h2.encLabel{color:var(--green)}
    /* Live tally bars */
    .tally{border:1px solid var(--line); border-radius:16px; padding:12px; background:#120c22}
    .bar{height:56px; border-radius:12px; position:relative; overflow:hidden; margin:10px 0; border:1px solid var(--line);}
    .fill{height:100%; width:0%}
    .label{position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; padding:0 16px; font-weight:1000; text-shadow:0 2px 4px rgba(0,0,0,.6); font-size:1.25rem}
    .b-green .fill{background:var(--green)}
    .b-yellow .fill{background:var(--yellow); color:#000}
    .b-red .fill{background:var(--red)}
    .footer{height:6vh;display:flex;align-items:center;justify-content:center;opacity:.85}
    .muted{opacity:.85}
    /* Splash */
    .splash{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:50}
    .splash.show{display:flex}
    .splashCard{border-radius:24px; padding:24px 28px; text-align:center; max-width:90vw}
    .splashTitle{font-size:9vw; font-weight:1000; margin:0}
    .splashSub{font-size:3.2vw; margin-top:12px}
    .green{background:#0b2; box-shadow:0 0 60px rgba(0,255,140,.4) inset;}
    .yellow{background:#aa7c00; box-shadow:0 0 60px rgba(255,234,100,.4) inset;}
    .red{background:#7a0010; box-shadow:0 0 60px rgba(255,90,100,.4) inset;}
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="welcome">Welcome to <span id="venueTitle" class="venue">—</span></div>
  </header>

  <div class="toprow">
    <span id="statusBadge" class="badge status">Status: —</span>
    <span id="timerBadge" class="badge timer">—</span>
  </div>

  <div class="current">
    <div class="name" id="currentSinger">Get ready…</div>
  </div>

  <div class="grid">
    <div class="col">
      <h2 class="encLabel">Live Votes</h2>
      <div class="tally">
        <div class="bar b-green">
          <div id="barEncore" class="fill"></div>
          <div class="label">Encore! <span id="countEncore">0</span></div>
        </div>
        <div class="bar b-yellow">
          <div id="barAnother" class="fill"></div>
          <div class="label">Another Shot! <span id="countAnother">0</span></div>
        </div>
        <div class="bar b-red">
          <div id="barMaybe" class="fill"></div>
          <div class="label">Maybe Next Time! <span id="countMaybe">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="muted" id="statusNote">Waiting for voting…</div>
  </div>

  <canvas id="confetti"></canvas>

  <!-- Splashes -->
  <div id="splashEncore" class="splash" aria-hidden="true">
    <div class="splashCard green">
      <h1 class="splashTitle">Encore!</h1>
      <div class="splashSub" id="splashEncoreName">Great job!</div>
    </div>
  </div>
  <div id="splashAnother" class="splash" aria-hidden="true">
    <div class="splashCard yellow">
      <h1 class="splashTitle">Another Shot!</h1>
      <div class="splashSub" id="splashAnotherName">So close!</div>
    </div>
  </div>
  <div id="splashMaybe" class="splash" aria-hidden="true">
    <div class="splashCard red">
      <h1 class="splashTitle">Maybe Next Time!</h1>
      <div class="splashSub" id="splashMaybeName">Let’s hear it for …</div>
    </div>
  </div>

  <audio id="soundWin" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/you_win_001.mp3"></audio>
  <audio id="soundSad" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/sad_horn.mp3"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    const statusBadge=$('statusBadge'), timerBadge=$('timerBadge');
    const currentSinger=$('currentSinger'), venueTitle=$('venueTitle'), statusNote=$('statusNote');

    // tally elements
    const barEncore=$('barEncore'), barAnother=$('barAnother'), barMaybe=$('barMaybe');
    const countEncore=$('countEncore'), countAnother=$('countAnother'), countMaybe=$('countMaybe');

    // config
    const FAILSAFE_AUTO_CLOSE = true; // will set isVotingOpen=false when timer hits 0s

    let eventId=null, unsubEvent=null, unsubVotes=null, unsubWinners=null, unsubSignal=null;
    let currentRoundId=null, voteEndsAtMs=null, tickHandle=null;
    let lastWinnerDocId=null; // to avoid duplicate splash
    let lastIsVotingOpen=false;
    let didFailSafeClose=false;

    function setBars(e,a,m){
      const total=Math.max(1, e+a+m);
      const pe=Math.round(100*e/total), pa=Math.round(100*a/total), pm=Math.round(100*m/total);
      barEncore.style.width = pe+'%';
      barAnother.style.width = pa+'%';
      barMaybe.style.width = pm+'%';
      countEncore.textContent = e;
      countAnother.textContent = a;
      countMaybe.textContent = m;
    }

    async function failsafeCloseIfNeeded(){
      if(!FAILSAFE_AUTO_CLOSE || didFailSafeClose || !eventId) return;
      try{
        await db.collection('events').doc(eventId).set({
          isVotingOpen: false,
          voteClosedBy: 'screen-failsafe',
          voteClosedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        didFailSafeClose = true;
      }catch(e){
        // swallow; display-only page, but we tried
      }
    }

    function startTimer() {
      stopTimer();
      tickHandle = setInterval(async ()=>{
        if(!voteEndsAtMs){ timerBadge.textContent='—'; return; }
        const ms = voteEndsAtMs - Date.now();
        const s = Math.max(0, Math.ceil(ms/1000));
        timerBadge.textContent = s + 's';
        if(ms <= 0){
          timerBadge.textContent = '0s';
          stopTimer();
          if(lastIsVotingOpen){
            // host didn't extend/close; attempt failsafe close
            await failsafeCloseIfNeeded();
          }
        }
      }, 250);
    }
    function stopTimer(){ if(tickHandle){ clearInterval(tickHandle); tickHandle=null; } }

    async function loadCurrentEvent(){
      try{
        const s = await db.collection('app').doc('state').get();
        eventId = (s.data()||{}).currentEventId || null;
        if(!eventId){ statusNote.textContent='No event selected by Host.'; return; }
        wire();
      }catch(e){ statusNote.textContent='Error loading event.'; }
    }

    function wire(){
      if(unsubEvent) unsubEvent();
      if(unsubVotes) unsubVotes();
      if(unsubWinners) unsubWinners();
      if(unsubSignal) unsubSignal();
      didFailSafeClose = false;

      const ref = db.collection('events').doc(eventId);
      unsubEvent = ref.onSnapshot(snap=>{
        const d=snap.data()||{};
        venueTitle.textContent = d.venueName || eventId || '—';
        currentSinger.textContent = d.currentSingerName || 'Get ready…';
        const open = !!d.isVotingOpen;
        lastIsVotingOpen = open;
        statusBadge.textContent = 'Status: ' + (open ? 'Voting Open' : 'Voting Closed');
        statusNote.textContent = open ? 'Voting Open' : 'Voting Closed';

        // expected timer fields: voteClosesAt (Timestamp), OR voteEndsAt, OR voteStartedAt + 30s
        voteEndsAtMs = null;
        const vc = d.voteClosesAt?.toMillis?.() || (d.voteClosesAt?.seconds? d.voteClosesAt.seconds*1000 : null);
        const ve = d.voteEndsAt?.toMillis?.()   || (d.voteEndsAt?.seconds?   d.voteEndsAt.seconds*1000   : null);
        const vs = d.voteStartedAt?.toMillis?.()|| (d.voteStartedAt?.seconds?d.voteStartedAt.seconds*1000: null);

        if (vc) voteEndsAtMs = vc;
        else if (ve) voteEndsAtMs = ve;
        else if (vs) voteEndsAtMs = vs + 30*1000; // fallback to 30s window

        if (open && voteEndsAtMs) startTimer(); else { timerBadge.textContent='—'; stopTimer(); }

        // wire votes live by roundId (or performanceId)
        const newRoundId = d.roundId || d.performanceId || null;
        if(newRoundId !== currentRoundId){
          currentRoundId = newRoundId;
          wireVotes();
        }
      });

      // winners list watcher just to trigger splashes when a NEW winner doc appears
      unsubWinners = db.collection('events').doc(eventId).collection('winners')
        .orderBy('decidedAt','asc').onSnapshot(qs=>{
          qs.docChanges().forEach(ch=>{
            if(ch.type==='added'){
              const id=ch.doc.id;
              if(id!==lastWinnerDocId){
                lastWinnerDocId=id;
                const w=ch.doc.data()||{};
                if(w.result==='Encore!') showSplash('encore', w.singerName||'');
                else if(w.result==='Another Shot!') showSplash('another', w.singerName||'');
                else if(w.result==='Maybe Next Time!') showSplash('maybe', w.singerName||'');
              }
            }
          });
        });

      // signals doc (host may write here to force a splash)
      unsubSignal = db.collection('events').doc(eventId).collection('signals').doc('result')
        .onSnapshot(s=>{
          const d=s.data()||{};
          if(!d.type||!d.singerName) return;
          showSplash(d.type==='Encore!' ? 'encore' : d.type==='Another Shot!' ? 'another' : 'maybe', d.singerName);
        });
    }

    function wireVotes(){
      // reset bars
      setBars(0,0,0);
      if(unsubVotes) unsubVotes();
      if(!currentRoundId){ return; }

      const vref = db.collection('events').doc(eventId).collection('votes').where('roundId','==',currentRoundId);
      unsubVotes = vref.onSnapshot(qs=>{
        let e=0,a=0,m=0;
        qs.forEach(doc=>{
          const c=(doc.data()||{}).choice;
          if(c==='Encore!') e++;
          else if(c==='Another Shot!') a++;
          else if(c==='Maybe Next Time!') m++;
        });
        setBars(e,a,m);
      });
    }

    function showSplash(kind, name){
      if(kind==='encore'){
        $('splashEncoreName').textContent = name || '';
        $('splashEncore').classList.add('show');
        try{$('soundWin').play().catch(()=>{});}catch(e){}
        confettiBurst();
        setTimeout(()=> $('splashEncore').classList.remove('show'), 3500);
      }else if(kind==='another'){
        $('splashAnotherName').textContent = name || '';
        $('splashAnother').classList.add('show');
        setTimeout(()=> $('splashAnother').classList.remove('show'), 2500);
      }else{
        $('splashMaybeName').textContent = `Let’s hear it for ${name||''}! Thanks for playing along!`;
        $('splashMaybe').classList.add('show');
        try{$('soundSad').play().catch(()=>{});}catch(e){}
        setTimeout(()=> $('splashMaybe').classList.remove('show'), 3500);
      }
    }

    // Lightweight confetti
    const cvs=$('confetti'), ctx=cvs.getContext('2d'); let parts=[];
    function resize(){ cvs.width=innerWidth; cvs.height=innerHeight; }
    addEventListener('resize', resize); resize();
    function confettiBurst(){
      parts=[];
      for(let i=0;i<150;i++){
        parts.push({x:Math.random()*cvs.width,y:Math.random()*cvs.height/2,vx:Math.random()*6-3,vy:Math.random()*-3-2,color:`hsl(${Math.random()*360},100%,50%)`,size:Math.random()*6+2});
      }
      requestAnimationFrame(updateConfetti);
    }
    function updateConfetti(){
      ctx.clearRect(0,0,cvs.width,cvs.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.05;
        ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      });
      parts=parts.filter(p=>p.y<cvs.height);
      if(parts.length>0) requestAnimationFrame(updateConfetti);
    }

    loadCurrentEvent();
  </script>

  <!-- File: index_screen.html | Earn Your Encore Karaoke | includes FAILSAFE auto-close when timer hits 0s -->
</body>
</html>
