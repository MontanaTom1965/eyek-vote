<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke – Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0f0a18;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    header{padding:10px 16px; text-align:center; background:linear-gradient(90deg,var(--blue),var(--purple));}
    .welcome{font-size:1.2rem; opacity:.9}
    .venue{font-weight:900}
    .current{display:flex;align-items:center;justify-content:center;text-align:center; height:22vh}
    .current .name{font-size:7.5vw; line-height:1.05; font-weight:1000; letter-spacing:.5px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:16px; height:62vh}
    .col{border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:12px; background:#1b1430; overflow:auto}
    h2{margin:0 0 8px}
    h2.encLabel{color:var(--green)}
    h2.oneLabel{color:var(--yellow)}
    ul{list-style:none; padding:0; margin:0}
    li{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08)}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-weight:900}
    .enc{color:#000; background:var(--green)}
    .one{color:#000; background:var(--yellow)}
    .footer{height:8vh;display:flex;align-items:center;justify-content:center;opacity:.8}
    .splash{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:50}
    .splash.show{display:flex}
    .splashCard{border-radius:24px; padding:24px 28px; text-align:center; max-width:90vw}
    .splashTitle{font-size:9vw; font-weight:1000; margin:0}
    .splashSub{font-size:3.2vw; margin-top:12px}
    .green{background:#0b2; box-shadow:0 0 60px rgba(0,255,140,.4) inset;}
    .yellow{background:#aa7c00; box-shadow:0 0 60px rgba(255,234,100,.4) inset;}
    .red{background:#7a0010; box-shadow:0 0 60px rgba(255,90,100,.4) inset;}
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
    .muted{opacity:.8}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="welcome">Welcome to <span id="venueTitle" class="venue">—</span></div>
  </header>

  <div class="current">
    <div class="name" id="currentSinger">Get ready…</div>
  </div>

  <div class="grid">
    <div class="col">
      <h2 class="encLabel">Encore!</h2>
      <ul id="encoreList"></ul>
    </div>
    <div class="col">
      <h2 class="oneLabel">Another Shot!</h2>
      <ul id="anotherList"></ul>
    </div>
  </div>

  <div class="footer">
    <div class="muted" id="statusNote">Waiting for voting…</div>
  </div>

  <canvas id="confetti"></canvas>

  <!-- Splashes -->
  <div id="splashEncore" class="splash">
    <div class="splashCard green">
      <h1 class="splashTitle">Encore!</h1>
      <div class="splashSub" id="splashEncoreName">Great job!</div>
    </div>
  </div>
  <div id="splashAnother" class="splash">
    <div class="splashCard yellow">
      <h1 class="splashTitle">Another Shot!</h1>
      <div class="splashSub" id="splashAnotherName">So close!</div>
    </div>
  </div>
  <div id="splashMaybe" class="splash">
    <div class="splashCard red">
      <h1 class="splashTitle">Maybe Next Time!</h1>
      <div class="splashSub" id="splashMaybeName">Let’s hear it for …</div>
    </div>
  </div>

  <audio id="soundWin" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/you_win_001.mp3"></audio>
  <audio id="soundSad" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/sad_horn.mp3"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    const encList=$('encoreList'), anotherList=$('anotherList');
    const currentSinger=$('currentSinger'), venueTitle=$('venueTitle'), statusNote=$('statusNote');

    let eventId=null, unsub=null;

    async function loadCurrentEvent(){
      try{
        const s = await db.collection('app').doc('state').get();
        eventId = (s.data()||{}).currentEventId || null;
        if(!eventId){ statusNote.textContent='No event selected by Host.'; return; }
        wire();
      }catch(e){ statusNote.textContent='Error loading event.'; }
    }

    function wire(){
      if(unsub) unsub();
      const ref = db.collection('events').doc(eventId);
      unsub = ref.onSnapshot(snap=>{
        const d=snap.data()||{};
        venueTitle.textContent = d.venueName || eventId || '—';
        currentSinger.textContent = d.currentSingerName || 'Get ready…';
        statusNote.textContent = d.isVotingOpen ? 'Voting Open' : 'Voting Closed';
      });

      // winners live (Encore! and Another Shot! only)
      db.collection('events').doc(eventId).collection('winners')
        .orderBy('decidedAt','asc').onSnapshot(qs=>{
          encList.innerHTML=''; anotherList.innerHTML='';
          qs.forEach(doc=>{
            const w=doc.data();
            if(w.result==='Encore!'){
              const li=document.createElement('li'); li.innerHTML=`<span class="badge enc">Encore!</span> — ${w.singerName}`;
              encList.appendChild(li);
            }else if(w.result==='Another Shot!'){
              const li=document.createElement('li'); li.innerHTML=`<span class="badge one">Another Shot!</span> — ${w.singerName}`;
              anotherList.appendChild(li);
            }
          });
        });

      // splash triggers
      db.collection('events').doc(eventId).collection('signals').doc('result').onSnapshot(s=>{
        const d=s.data()||{};
        if(!d.type||!d.singerName) return;
        if(d.type==='Encore!') showSplash('encore', d.singerName);
        else if(d.type==='Another Shot!') showSplash('another', d.singerName);
        else if(d.type==='Maybe Next Time!') showSplash('maybe', d.singerName);
      });
    }

    function showSplash(kind, name){
      if(kind==='encore'){
        $('splashEncoreName').textContent = name;
        $('splashEncore').classList.add('show');
        try{$('soundWin').play().catch(()=>{});}catch(e){}
        confettiBurst();
        setTimeout(()=> $('splashEncore').classList.remove('show'), 3500);
      }else if(kind==='another'){
        $('splashAnotherName').textContent = name;
        $('splashAnother').classList.add('show');
        setTimeout(()=> $('splashAnother').classList.remove('show'), 2500);
      }else{
        $('splashMaybeName').textContent = `Let’s hear it for ${name}! Thanks for playing along!`;
        $('splashMaybe').classList.add('show');
        try{$('soundSad').play().catch(()=>{});}catch(e){}
        setTimeout(()=> $('splashMaybe').classList.remove('show'), 3500);
      }
    }

    // Lightweight confetti
    const cvs=$('confetti'), ctx=cvs.getContext('2d'); let parts=[];
    function size(){ cvs.width=innerWidth; cvs.height=innerHeight; }
    window.addEventListener('resize', size); size();
    function confettiBurst(){
      parts=[]; for(let i=0;i<180;i++){ parts.push({x:Math.random()*cvs.width,y:-20,vy:2+Math.random()*4,vx:(Math.random()-.5)*2,size:4+Math.random()*6,rot:Math.random()*6.28}); }
      let t=0; function step(){
        ctx.clearRect(0,0,cvs.width,cvs.height);
        parts.forEach(p=>{
          p.y+=p.vy; p.x+=p.vx; p.rot+=0.1;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle='hsl('+((p.x+p.y)%360)+',80%,60%)';
          ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
          ctx.restore();
        });
        t++; if(t<120) requestAnimationFrame(step); else ctx.clearRect(0,0,cvs.width,cvs.height);
      }
      step();
    }

    loadCurrentEvent();
  </script>

  <!-- File: index_screen.html | Earn Your Encore Karaoke -->
</body>
</html>
