<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke ‚Äì Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --blue:#003e81; --gold:#eaba54; --purple:#2F0658; --light:#79aec1; --white:#fff; --black:#000; }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0715;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    header{padding:16px;background:linear-gradient(90deg,var(--blue),var(--purple));display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:1.2rem}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#271c44;font-size:.9rem;margin-left:8px}
    .main{padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:#1b1430;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .big{font-size:1.1rem;font-weight:800;margin-bottom:10px}
    .tally{display:grid;grid-template-columns:1fr 80px 100px;gap:10px;align-items:center;margin:10px 0}
    .bar{height:16px;border-radius:999px;background:#241a3f;overflow:hidden}
    .fill{height:100%;width:0;transition:width .25s ease}
    .enc{background:linear-gradient(180deg,#ffefc2,var(--gold))}
    .one{background:linear-gradient(180deg,#9fd3ff,#4aa3ff)}
    .neg{background:linear-gradient(180deg,#ffc2d1,#ff4971)}
    .banner{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .banner .result{font-size:1.4rem;font-weight:900}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(ellipse at center, rgba(255,239,194,.2), rgba(0,0,0,.85) 60%);z-index:9999}
    .overlay.show{display:flex;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .countNum{font-size:22vw;line-height:1;font-weight:1000;letter-spacing:.02em;background:linear-gradient(180deg,#fff7d0,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 24px rgba(234,186,84,.35)}
    .countSub{font-size:3vw;opacity:.9;text-align:center;margin-top:1rem}
    .ready{position:fixed;left:0;right:0;top:50%;transform:translateY(-50%);text-align:center;font-size:3vw;opacity:.9;display:none}
    .ready.show{display:block}
    .soundGate{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#201637;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:10px 14px;display:flex;gap:10px;align-items:center;z-index:10000}
    .soundGate button{border:0;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;background:var(--gold);color:#000}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }
  </style>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>üé§ Earn Your Encore Karaoke ‚Ä¢ Live Screen</h1>
    <div>
      <span class="pill" id="eventBadge">‚Äî</span>
      <span class="pill" id="roundBadge">‚Äî</span>
      <span class="pill" id="status">loading‚Ä¶</span>
    </div>
  </header>

  <!-- Sound gate -->
  <div class="soundGate" id="soundGate" style="display:none">
    <div>üîà Enable sound for voting</div>
    <button id="enableSoundBtn">Enable</button>
  </div>

  <div class="main">
    <div class="card" style="margin-bottom:16px">
      <div class="label">Event Override (optional)</div>
      <input id="eventId" placeholder="Auto-selected from Host ¬∑ override if needed" style="width:420px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#120c22;color:#fff;padding:10px" />
      <span class="pill" style="margin-left:8px">Audience: vote.earnyourencorekaraoke.com/vote/index.html</span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="big">üî• Encore!</div>
        <div class="tally">
          <div>Votes</div>
          <div id="encCount" style="text-align:right">0</div>
          <div class="bar"><div class="fill enc" id="encFill"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="big">ü§î One More Shot</div>
        <div class="tally">
          <div>Votes</div>
          <div id="oneCount" style="text-align:right">0</div>
          <div class="bar"><div class="fill one" id="oneFill"></div></div>
        </div>
      </div>
      <div class="card">
        <div class="big">‚ùå Maybe Next Time</div>
        <div class="tally">
          <div>Votes</div>
          <div id="negCount" style="text-align:right">0</div>
          <div class="bar"><div class="fill neg" id="negFill"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="banner">
    <div class="result" id="resultText">Waiting for votes‚Ä¶</div>
    <div class="pill" id="percentages">‚Äî</div>
  </div>

  <!-- Ready banner (pre-start) -->
  <div class="ready" id="readyMsg">Get ready‚Ä¶ voting will open soon!</div>

  <!-- Countdown overlay + audio -->
  <div class="overlay" id="countOverlay">
    <div style="text-align:center">
      <div class="countNum" id="countNum">30</div>
      <div class="countSub">Cast your vote now at vote.earnyourencorekaraoke.com/vote</div>
    </div>
  </div>
  <audio id="countAudio" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/quiz-countdown.mp3" loop></audio>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
  authDomain: "eyek-vote.firebaseapp.com",
  projectId: "eyek-vote",
  storageBucket: "eyek-vote.firebasestorage.app",
  messagingSenderId: "954696683994",
  appId: "1:954696683994:web:21a84298a94648ff0230e3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* DOM */
const $ = id => document.getElementById(id);
const eventInput = $('eventId');
const eventBadge = $('eventBadge');
const roundBadge = $('roundBadge');
const statusEl = $('status');
const encCountEl = $('encCount'), oneCountEl = $('oneCount'), negCountEl = $('negCount');
const encFill = $('encFill'), oneFill = $('oneFill'), negFill = $('negFill');
const percentagesEl = $('percentages'), resultText = $('resultText');
const overlay = $('countOverlay'); const countNum = $('countNum'); const countAudio = $('countAudio');
const readyMsg = $('readyMsg');
const soundGate = $('soundGate'); const enableSoundBtn = $('enableSoundBtn');

let eventUnsub = null, votesUnsub = null, autoEventUnsub = null, countdownTimer = null;
let eventId = null, roundId = null, isVotingOpen = false;
let openedAtMs = null, durationSec = 30;

/* Audio gate */
function showGateIfNeeded(){
  const ok = localStorage.getItem('sound-ok') === '1';
  soundGate.style.display = ok ? 'none' : 'flex';
}
enableSoundBtn.addEventListener('click', async ()=>{
  try{
    await countAudio.play();
    countAudio.pause();
    localStorage.setItem('sound-ok','1');
    showGateIfNeeded();
  }catch(e){
    alert('Please click again to enable sound.');
  }
});
showGateIfNeeded();

eventInput.addEventListener('change', wireUp);
eventInput.addEventListener('keyup', e=>{ if(e.key==='Enter') wireUp(); });

/* Auto-select current event from Host (app/state) */
autoEventUnsub = db.collection('app').doc('state').onSnapshot(s=>{
  const d = s.data() || {};
  if (d.currentEventId && eventInput.value.trim() !== d.currentEventId){
    eventInput.value = d.currentEventId;
    wireUp();
  }
});

function wireUp(){
  const v = eventInput.value.trim();
  if (!v) return;
  eventId = v;
  eventBadge.textContent = eventId;
  if (eventUnsub) eventUnsub();
  if (votesUnsub) votesUnsub();

  eventUnsub = db.collection('events').doc(eventId).onSnapshot(snap=>{
    const d = snap.data()||{};
    const prevOpen = isVotingOpen;

    roundId = d.roundId || null;
    isVotingOpen = !!d.isVotingOpen;
    roundBadge.textContent = roundId || '‚Äî';
    statusEl.textContent = isVotingOpen ? 'Voting Open' : 'Voting Closed';

    // PRE-START UI
    if (roundId && !isVotingOpen){
      readyMsg.classList.add('show');
      stopCountdown();
      clearTally();
      resultText.textContent = 'Waiting for votes‚Ä¶';
    } else {
      readyMsg.classList.remove('show');
    }

    // Timed window (robust to pending serverTimestamp)
    const vw = d.voteWindow || null;
    if (isVotingOpen){
      // derive openedAtMs and duration even if openedAt not yet materialized
      durationSec = Number((vw && vw.durationSec) || 30);
      openedAtMs = (vw && vw.openedAt && vw.openedAt.toDate)
        ? vw.openedAt.toDate().getTime()
        : (Date.now()); // fallback to ‚Äúnow‚Äù so UI starts instantly
      startCountdown(openedAtMs, durationSec);
    } else {
      stopCountdown();
    }

    if (roundId){
      listenVotes(roundId);
    } else {
      clearTally();
      if (votesUnsub) { votesUnsub(); votesUnsub=null; }
    }

    // Show end result when host closes voting
    if (prevOpen && !isVotingOpen && roundId) {
      setTimeout(()=>showCloseOutcome(roundId), 300);
      stopCountdown();
      readyMsg.classList.remove('show');
    }
  }, console.error);
}

function listenVotes(rid){
  if (votesUnsub) votesUnsub();
  votesUnsub = db.collection('events').doc(eventId)
                 .collection('rounds').doc(rid)
                 .collection('votes')
                 .onSnapshot(updateTally, console.error);
}

let lastCounts = {enc:0,one:0,neg:0,total:0};

function updateTally(qs){
  let enc=0, one=0, neg=0;
  qs.forEach(doc=>{
    const v = (doc.data()||{}).choice;
    if (v==='encore') enc++;
    else if (v==='one_more') one++;
    else if (v==='next_time') neg++;
  });
  const total = enc+one+neg;
  lastCounts = {enc,one,neg,total};

  encCountEl.textContent = enc; oneCountEl.textContent = one; negCountEl.textContent = neg;
  const pct = (n)=> total? Math.round(n*100/total):0;
  encFill.style.width = pct(enc)+'%';
  oneFill.style.width = pct(one)+'%';
  negFill.style.width = pct(neg)+'%';
  percentagesEl.textContent = total ? `Encore ${pct(enc)}% ‚Ä¢ One More ${pct(one)}% ‚Ä¢ Maybe ${pct(neg)}%` : '‚Äî';

  if (isVotingOpen){
    resultText.textContent = total ? `Live Leader: ${liveLeaderText(enc, one, neg)}` : 'Waiting for votes‚Ä¶';
  }
}

function liveLeaderText(enc,one,neg){
  const max = Math.max(enc,one,neg);
  const picks = [];
  if (enc===max && max>0) picks.push('Encore!');
  if (one===max && max>0) picks.push('One More Shot');
  if (neg===max && max>0) picks.push('Maybe Next Time');
  if (picks.length===0) return '‚Äî';
  if (picks.length===1) return picks[0];
  return 'Tied: ' + picks.join(' ‚Ä¢ ');
}

function showCloseOutcome(rid){
  const {enc,one,neg,total} = lastCounts;
  if (!total){ resultText.textContent = 'No votes cast.'; return; }
  const max = Math.max(enc,one,neg);
  const winners = [];
  if (enc===max) winners.push('Encore!');
  if (one===max) winners.push('One More Shot');
  if (neg===max) winners.push('Maybe Next Time');
  resultText.textContent = winners.length===1 ? 'Result: ' + winners[0] : 'Result: Tie ‚Äì ' + winners.join(' ‚Ä¢ ');
}

function clearTally(){
  encCountEl.textContent=oneCountEl.textContent=negCountEl.textContent='0';
  encFill.style.width=oneFill.style.width=negFill.style.width='0%';
  percentagesEl.textContent='‚Äî';
  resultText.textContent='Waiting for votes‚Ä¶';
}

/* ===== Countdown & Audio ===== */
function startCountdown(openedMs, duration){
  stopCountdown();
  overlay.classList.add('show');
  const ok = localStorage.getItem('sound-ok') === '1';
  if (ok){
    try{ countAudio.currentTime = 0; countAudio.play().catch(()=>{}); }catch(e){}
  } else {
    showGateIfNeeded();
  }
  countdownTimer = setInterval(()=>{
    const remain = Math.max(0, Math.round((openedMs + duration*1000 - Date.now())/1000));
    countNum.textContent = remain;
    if (remain <= 0){
      stopCountdown();
    }
  }, 250);
}
function stopCountdown(){
  overlay.classList.remove('show');
  if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
  try{ countAudio.pause(); }catch(e){}
}
</script>
</body>
</html>
