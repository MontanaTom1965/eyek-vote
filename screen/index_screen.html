<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke – Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
      --ink:#0f0a18; --card:#1b1430; --line:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--ink);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    header{padding:10px 16px; text-align:center; background:linear-gradient(90deg,var(--blue),var(--purple));}
    .welcome{font-size:1.2rem; opacity:.9}
    .venue{font-weight:900}
    .current{display:flex;align-items:center;justify-content:center;text-align:center; height:18vh}
    .current .name{font-size:7.2vw; line-height:1.05; font-weight:1000; letter-spacing:.5px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:16px; height:60vh}
    .col{border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:12px; background:var(--card); overflow:auto}
    h2{margin:0 0 8px}
    h2.encLabel{color:var(--green)}
    h2.oneLabel{color:var(--yellow)}
    ul{list-style:none; padding:0; margin:0}
    li{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08)}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-weight:900}
    .enc{color:#000; background:var(--green)}
    .one{color:#000; background:var(--yellow)}
    .footer{height:6vh;display:flex;align-items:center;justify-content:center;opacity:.85}
    .muted{opacity:.85}
    /* Splash */
    .splash{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.9);z-index:50}
    .splash.show{display:flex}
    .splashCard{border-radius:24px; padding:24px 28px; text-align:center; max-width:90vw}
    .splashTitle{font-size:9vw; font-weight:1000; margin:0}
    .splashSub{font-size:3.2vw; margin-top:12px}
    .green{background:#0b2; box-shadow:0 0 60px rgba(0,255,140,.4) inset;}
    .yellow{background:#aa7c00; box-shadow:0 0 60px rgba(255,234,100,.4) inset;}
    .red{background:#7a0010; box-shadow:0 0 60px rgba(255,90,100,.4) inset;}
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
    /* Live tally bars */
    .tally{border:1px solid var(--line); border-radius:16px; padding:12px; background:#120c22}
    .bar{height:48px; border-radius:12px; position:relative; overflow:hidden; margin:8px 0; border:1px solid var(--line);}
    .fill{height:100%; width:0%}
    .label{position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; padding:0 12px; font-weight:900; text-shadow:0 2px 4px rgba(0,0,0,.6)}
    .b-green .fill{background:var(--green)}
    .b-yellow .fill{background:var(--yellow); color:#000}
    .b-red .fill{background:var(--red)}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="welcome">Welcome to <span id="venueTitle" class="venue">—</span></div>
  </header>

  <div class="current">
    <div class="name" id="currentSinger">Get ready…</div>
  </div>

  <div class="grid">
    <div class="col">
      <h2 class="encLabel">Live Votes</h2>
      <div class="tally">
        <div class="bar b-green">
          <div id="barEncore" class="fill"></div>
          <div class="label">Encore! <span id="countEncore">0</span></div>
        </div>
        <div class="bar b-yellow">
          <div id="barAnother" class="fill"></div>
          <div class="label">Another Shot! <span id="countAnother">0</span></div>
        </div>
        <div class="bar b-red">
          <div id="barMaybe" class="fill"></div>
          <div class="label">Maybe Next Time! <span id="countMaybe">0</span></div>
        </div>
      </div>
    </div>
    <div class="col">
      <h2 class="oneLabel">Winners Tonight</h2>
      <ul id="encoreList"></ul>
      <ul id="anotherList"></ul>
    </div>
  </div>

  <div class="footer">
    <div class="muted" id="statusNote">Waiting for voting…</div>
  </div>

  <canvas id="confetti"></canvas>

  <!-- Splashes -->
  <div id="splashEncore" class="splash" aria-hidden="true">
    <div class="splashCard green">
      <h1 class="splashTitle">Encore!</h1>
      <div class="splashSub" id="splashEncoreName">Great job!</div>
    </div>
  </div>
  <div id="splashAnother" class="splash" aria-hidden="true">
    <div class="splashCard yellow">
      <h1 class="splashTitle">Another Shot!</h1>
      <div class="splashSub" id="splashAnotherName">So close!</div>
    </div>
  </div>
  <div id="splashMaybe" class="splash" aria-hidden="true">
    <div class="splashCard red">
      <h1 class="splashTitle">Maybe Next Time!</h1>
      <div class="splashSub" id="splashMaybeName">Let’s hear it for …</div>
    </div>
  </div>

  <audio id="soundWin" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/you_win_001.mp3"></audio>
  <audio id="soundSad" preload="auto" src="https://vote.earnyourencorekaraoke.com/vote/sad_horn.mp3"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    const encList=$('encoreList'), anotherList=$('anotherList');
    const currentSinger=$('currentSinger'), venueTitle=$('venueTitle'), statusNote=$('statusNote');

    // tally elements
    const barEncore=$('barEncore'), barAnother=$('barAnother'), barMaybe=$('barMaybe');
    const countEncore=$('countEncore'), countAnother=$('countAnother'), countMaybe=$('countMaybe');

    let eventId=null, unsubEvent=null, unsubVotes=null, currentRoundId=null;

    async function loadCurrentEvent(){
      try{
        const s = await db.collection('app').doc('state').get();
        eventId = (s.data()||{}).currentEventId || null;
        if(!eventId){ statusNote.textContent='No event selected by Host.'; return; }
        wire();
      }catch(e){ statusNote.textContent='Error loading event.'; }
    }

    function wire(){
      if(unsubEvent) unsubEvent();
      const ref = db.collection('events').doc(eventId);
      unsubEvent = ref.onSnapshot(snap=>{
        const d=snap.data()||{};
        venueTitle.textContent = d.venueName || eventId || '—';
        currentSinger.textContent = d.currentSingerName || 'Get ready…';
        statusNote.textContent = d.isVotingOpen ? 'Voting Open' : 'Voting Closed';

        // wire votes live by roundId (or performanceId)
        const newRoundId = d.roundId || d.performanceId || null;
        if(newRoundId !== currentRoundId){
          currentRoundId = newRoundId;
          wireVotes();
        }
      });

      // winners live (Encore! and Another Shot! only — we don't show Maybe Next Time in the list)
      db.collection('events').doc(eventId).collection('winners')
        .orderBy('decidedAt','asc').onSnapshot(qs=>{
          encList.innerHTML=''; anotherList.innerHTML='';
          qs.forEach(doc=>{
            const w=doc.data();
            if(w.result==='Encore!'){
              const li=document.createElement('li'); li.innerHTML=`<span class="badge enc">Encore!</span> — ${w.singerName}`;
              encList.appendChild(li);
            }else if(w.result==='Another Shot!'){
              const li=document.createElement('li'); li.innerHTML=`<span class="badge one">Another Shot!</span> — ${w.singerName}`;
              anotherList.appendChild(li);
            }
          });
        });

      // splash triggers from host result signal
      db.collection('events').doc(eventId).collection('signals').doc('result').onSnapshot(s=>{
        const d=s.data()||{};
        if(!d.type||!d.singerName) return;
        if(d.type==='Encore!') showSplash('encore', d.singerName);
        else if(d.type==='Another Shot!') showSplash('another', d.singerName);
        else if(d.type==='Maybe Next Time!') showSplash('maybe', d.singerName);
      });
    }

    function wireVotes(){
      // reset bars
      setBars(0,0,0);
      if(unsubVotes) unsubVotes();
      if(!currentRoundId){ return; }

      const vref = db.collection('events').doc(eventId).collection('votes').where('roundId','==',currentRoundId);
      unsubVotes = vref.onSnapshot(qs=>{
        let e=0,a=0,m=0;
        qs.forEach(doc=>{
          const c=(doc.data()||{}).choice;
          if(c==='Encore!') e++;
          else if(c==='Another Shot!') a++;
          else if(c==='Maybe Next Time!') m++;
        });
        setBars(e,a,m);
      });
    }

    function setBars(e,a,m){
      const total=Math.max(1, e+a+m);
      const pe=Math.round(100*e/total), pa=Math.round(100*a/total), pm=Math.round(100*m/total);
      barEncore.style.width = pe+'%';
      barAnother.style.width = pa+'%';
      barMaybe.style.width = pm+'%';
      countEncore.textContent = e;
      countAnother.textContent = a;
      countMaybe.textContent = m;
    }

    function showSplash(kind, name){
      if(kind==='encore'){
        $('splashEncoreName').textContent = name;
        $('splashEncore').classList.add('show');
        try{$('soundWin').play().catch(()=>{});}catch(e){}
        confettiBurst();
        setTimeout(()=> $('splashEncore').classList.remove('show'), 3500);
      }else if(kind==='another'){
        $('splashAnotherName').textContent = name;
        $('splashAnother').classList.add('show');
        setTimeout(()=> $('splashAnother').classList.remove('show'), 2500);
      }else{
        $('splashMaybeName').textContent = `Let’s hear it for ${name}! Thanks for playing along!`;
        $('splashMaybe').classList.add('show');
        try{$('soundSad').play().catch(()=>{});}catch(e){}
        setTimeout(()=> $('splashMaybe').classList.remove('show'), 3500);
      }
    }

    // Lightweight confetti
    const cvs=$('confetti'), ctx=cvs.getContext('2d'); let parts=[];
    function resize(){ cvs.width=innerWidth; cvs.height=innerHeight; }
    addEventListener('resize', resize); resize();
    function confettiBurst(){
      parts=[];
      for(let i=0;i<150;i++){
        parts.push({x:Math.random()*cvs.width,y:Math.random()*cvs.height/2,vx:Math.random()*6-3,vy:Math.random()*-3-2,color:`hsl(${Math.random()*360},100%,50%)`,size:Math.random()*6+2});
      }
      requestAnimationFrame(updateConfetti);
    }
    function updateConfetti(){
      ctx.clearRect(0,0,cvs.width,cvs.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.05;
        ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      });
      parts=parts.filter(p=>p.y<cvs.height);
      if(parts.length>0) requestAnimationFrame(updateConfetti);
    }

    loadCurrentEvent();
  </script>
</body>
</html>
