<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="refresh" content="180">
<style>
  :root{--bg:#060913;--txt:#eaf2ff;--muted:#a9b6d9;--green:#25d366;--yellow:#f6c945;--red:#ff5e6c;--cyan:#3ad4ff}
  *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 50% -10%,#132041 0%,#060913 60%);color:var(--txt);font:700 20px/1.2 Inter,system-ui}
  .wrap{min-height:100svh;display:grid;place-items:center;padding:24px}
  .stage{width:min(1100px,92vw);background:rgba(8,14,30,.6);border:1px solid rgba(70,100,160,.35);border-radius:16px;padding:28px;box-shadow:0 20px 80px rgba(0,0,0,.45)}
  h1{margin:0 0 10px;font-size:40px;letter-spacing:.5px}
  .muted{color:var(--muted);font-weight:500}
  .row{display:flex;align-items:end;gap:18px;flex-wrap:wrap}
  .timer{font-size:56px;letter-spacing:1.5px}
  .stack{display:grid;gap:10px;margin-top:12px}
  .ballRow{display:flex;gap:12px;align-items:flex-end}
  .stackCol{flex:1;min-width:220px}
  .count{font-size:40px;text-align:center}
  .pile{display:flex;gap:6px;flex-wrap:wrap;min-height:44px}
  .ball{width:18px;height:18px;border-radius:50%;animation:pop .6s ease-out}
  .g{background:var(--green)} .y{background:var(--yellow)} .r{background:var(--red)}
  @keyframes pop{0%{transform:translateY(12px) scale(.6);opacity:.5}100%{transform:translateY(0) scale(1);opacity:1}}
  .banner{margin-top:20px;padding:16px;border-radius:14px;text-align:center;border:2px solid transparent}
  .b-encore{border-color:rgba(37,211,102,.6);box-shadow:0 0 40px rgba(37,211,102,.25) inset}
  .b-another{border-color:rgba(246,201,69,.6);box-shadow:0 0 40px rgba(246,201,69,.25) inset}
  .b-maybe{border-color:rgba(255,94,108,.6);box-shadow:0 0 40px rgba(255,94,108,.25) inset}
  .big{font-size:60px}
  .sub{font-size:22px;color:var(--muted)}
  canvas{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
  <div class="stage">
    <div class="stack">
      <h1 id="headline">Welcome to <span id="venue">—</span></h1>
      <div class="muted">KJ: <span id="kj">—</span></div>
      <div id="main" class="stack">
        <div class="row">
          <div class="stackCol">
            <div class="muted">Now Singing</div>
            <div id="singer" style="font-size:44px">—</div>
            <div id="song" class="muted" style="margin-top:6px">—</div>
          </div>
          <div class="stackCol" style="text-align:right">
            <div class="muted">Voting ends in</div>
            <div id="timer" class="timer">00:00</div>
          </div>
        </div>

        <div id="voteBlock" class="row" style="margin-top:10px">
          <div class="stackCol">
            <div class="muted">Encore!</div>
            <div id="c_encore" class="count">0</div>
            <div id="pile_encore" class="pile"></div>
          </div>
          <div class="stackCol">
            <div class="muted">Another Shot!</div>
            <div id="c_another" class="count">0</div>
            <div id="pile_another" class="pile"></div>
          </div>
          <div class="stackCol">
            <div class="muted">Maybe Next Time</div>
            <div id="c_maybe" class="count">0</div>
            <div id="pile_maybe" class="pile"></div>
          </div>
        </div>

        <div id="banner" class="banner" style="display:none">
          <div id="bannerText" class="big">—</div>
          <div class="sub">Great job! Next singer up soon…</div>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="sfx_encore" src="/assets/encore.mp3" preload="auto"></audio>
<audio id="sfx_another" src="/assets/another_shot.mp3" preload="auto"></audio>
<audio id="sfx_maybe" src="/assets/loser.wav" preload="auto"></audio>
<audio id="sfx_open" src="/assets/voting_open.mp3" preload="auto"></audio>
<audio id="sfx_over" src="/assets/voting_over.mp3" preload="auto"></audio>

<script>
const GET_URL = '/assets/get_state.php';
const POLL = 1200;

const $=s=>document.querySelector(s);
const venue=$('#venue'), kj=$('#kj'), singer=$('#singer'), song=$('#song'), timer=$('#timer');
const cE=$('#c_encore'), cA=$('#c_another'), cM=$('#c_maybe');
const pE=$('#pile_encore'), pA=$('#pile_another'), pM=$('#pile_maybe');
const banner=$('#banner'), bannerText=$('#bannerText');

let state=null, balls={encore:0,another:0,maybe:0};

function dot(container, cls){
  const b=document.createElement('div'); b.className='ball '+cls; container.prepend(b);
}

function updateBalls(kind,count){
  const containers={encore:pE, another:pA, maybe:pM};
  const cls={encore:'g', another:'y', maybe:'r'}[kind];
  while(containers[kind].children.length < count) dot(containers[kind], cls);
  while(containers[kind].children.length > count) containers[kind].removeChild(containers[kind].lastChild);
}

function setBanner(w){
  banner.style.display = w ? 'block':'none';
  banner.className='banner';
  if(!w) return;
  if(w==='encore'){ banner.classList.add('b-encore'); bannerText.textContent='Encore!'; play('encore'); confetti(); }
  else if(w==='another'){ banner.classList.add('b-another'); bannerText.textContent='Another Shot!'; play('another'); }
  else { banner.classList.add('b-maybe'); bannerText.textContent='Maybe Next Time'; play('maybe'); }
}

function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;}

async function tick(){
  const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json();
  venue.textContent = state.event.venue||'—';
  kj.textContent = state.event.kj||'—';
  singer.textContent = state.current.name||'—';
  song.textContent = state.current.songArtist||'—';

  cE.textContent = state.voting.counts.encore||0;
  cA.textContent = state.voting.counts.another||0;
  cM.textContent = state.voting.counts.maybe||0;

  updateBalls('encore', state.voting.counts.encore||0);
  updateBalls('another', state.voting.counts.another||0);
  updateBalls('maybe',  state.voting.counts.maybe ||0);

  if (state.voting.open){
    play('open');
    banner.style.display='none';
    const ms=Math.max(0, state.voting.endsAt - Date.now());
    timer.textContent = fmt(ms);
  } else {
    timer.textContent='00:00';
    setBanner(state.voting.lastResult);
  }
}

const sfx={
  encore:$('#sfx_encore'), another:$('#sfx_another'), maybe:$('#sfx_maybe'),
  open:$('#sfx_open'), over:$('#sfx_over')
};
function play(k){ sfx[k]?.play().catch(()=>{}); }

setInterval(tick, POLL);
tick();

// simple confetti
function confetti(){
  const c=document.getElementById('confetti'),x=c.getContext('2d');
  c.width=innerWidth; c.height=innerHeight;
  const parts=Array.from({length:160},()=>({
    x:Math.random()*c.width, y:-20-Math.random()*80, r:2+Math.random()*4,
    v:2+Math.random()*4, a:Math.random()*Math.PI, col:`hsl(${Math.random()*360},90%,60%)`
  }));
  let t=0;
  function step(){
    x.clearRect(0,0,c.width,c.height);
    parts.forEach(p=>{
      p.y += p.v; p.x += Math.sin(p.a+t/10);
      x.fillStyle=p.col; x.beginPath(); x.arc(p.x,p.y,p.r,0,Math.PI*2); x.fill();
    });
    t++;
    if (t<120) requestAnimationFrame(step); else x.clearRect(0,0,c.width,c.height);
  }
  step();
}
</script>
</body>
</html>
