<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Encore! • Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bgDeep1:#1B0930; --bgDeep2:#16072A;
    --txt:#ffffff; --muted:#d8c7ff; --line:#6f52a8;
    --green:#25d366; --yellow:#f6c945; --red:#ff5e6c;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bgDeep1),var(--bgDeep2));color:var(--txt);font:18px/1.35 "Montserrat",system-ui}
  .wrap{min-height:100svh;display:flex;flex-direction:column;gap:16px;padding:24px}

  .head{text-align:center}
  .welcome{font-size:28px;margin:0;color:#ffe8ff;opacity:.95}
  .venue{font-family:"Bebas Neue";font-size:66px;letter-spacing:1px;margin:2px 0 0}
  .host{font-size:26px;margin:4px 0 0;color:var(--muted)}

  .now{margin-top:28px;text-align:center}
  .nowLbl{font-family:"Bebas Neue";font-size:42px;margin:0;color:#ffe8ff}
  .nowName{font-family:"Bebas Neue";font-size:64px;margin:10px 0 0}

  .voteTop{display:flex;justify-content:space-between;align-items:flex-start;margin-top:10px}
  .voteNow{font-family:"Bebas Neue";font-size:50px}
  .timer{font-family:"Bebas Neue";font-size:56px}

  .box{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:14px 0}
  .col{background:#140625;border:2px solid rgba(255,255,255,.15);border-radius:18px;min-height:300px;position:relative;overflow:hidden}
  .label{position:absolute;top:10px;left:14px;font-size:20px;color:#cdbff0}
  .ball{position:absolute;width:26px;height:26px;border-radius:50%}
  .g{background:var(--green)} .y{background:var(--yellow)} .r{background:var(--red)}

  .tally{display:flex;justify-content:center;gap:16px;font-size:28px;font-weight:900;margin-bottom:8px}
  .chip{padding:10px 18px;border-radius:999px;border:2px solid rgba(255,255,255,.15)}
  .enc{background:var(--green);color:#072a14}
  .ano{background:var(--yellow);color:#352600}
  .may{background:var(--red);color:#2b0e12}

  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.78);z-index:50}
  .ovCard{width:min(1200px,92vw);text-align:center;border:3px solid rgba(255,255,255,.18);border-radius:22px;padding:30px}
  .ovTitle{font-family:"Bebas Neue";font-size:120px;margin:0}
  .ovSub{font-size:42px;margin:10px 0 0}
  .ov-enc{background:rgba(37,211,102,.1); border-color: rgba(37,211,102,.55)}
  .ov-ano{background:rgba(246,201,69,.1); border-color: rgba(246,201,69,.55)}
  .ov-may{background:rgba(255,94,108,.1); border-color: rgba(255,94,108,.55)}

  #confetti{position:fixed;inset:0;pointer-events:none;display:none}

  #heartbeat{position:fixed;width:1px;height:1px;left:-10px;top:-10px;background:transparent;transform:translateX(0);will-change:transform;animation:hb 2s linear infinite}
  @keyframes hb{0%{transform:translateX(0)}50%{transform:translateX(1px)}100%{transform:translateX(0)}}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div id="heartbeat" aria-hidden="true"></div>

<div class="wrap" id="root">
  <header class="head" id="header">
    <p id="welcome" class="welcome">Welcome to</p>
    <h1 id="venue" class="venue">—</h1>
    <p id="hostBy" class="host">Hosted by —</p>
  </header>

  <section class="now" id="nowBlock">
    <h2 class="nowLbl" id="nowLbl">Now Singing</h2>
    <div id="nowName" class="nowName">—</div>
  </section>

  <section id="votingArea" style="display:none">
    <div class="voteTop">
      <div id="voteNow" class="voteNow">Now Voting For: —</div>
      <div id="timer" class="timer">00:00</div>
    </div>

    <div class="box">
      <div class="col" id="colE"><div class="label">Encore!</div></div>
      <div class="col" id="colA"><div class="label">Another Shot!</div></div>
      <div class="col" id="colM"><div class="label">Maybe Next Time!</div></div>
    </div>

    <div class="tally" id="tally" style="display:none">
      <div class="chip enc">Encore! <b id="cE" style="margin-left:8px">0</b></div>
      <div class="chip ano">Another Shot! <b id="cA" style="margin-left:8px">0</b></div>
      <div class="chip may">Maybe Next Time! <b id="cM" style="margin-left:8px">0</b></div>
    </div>
  </section>
</div>

<div id="overlay" class="overlay">
  <div id="ovCard" class="ovCard">
    <div id="ovTitle" class="ovTitle">Encore!</div>
    <p id="ovSub" class="ovSub">Congratulations, —</p>
  </div>
</div>

<script>
const GET_URL='/assets/get_state.php';
const $=s=>document.querySelector(s);

/* Wake Lock */
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') requestWakeLock(); });
window.addEventListener('focus', requestWakeLock);
requestWakeLock();

/* Tiny RAF nudge */
let rafId; function tick(){ if (performance.now()%3000 < 16){ document.body.style.setProperty('--nudge', String(Math.random())); } rafId=requestAnimationFrame(tick); }
rafId=requestAnimationFrame(tick);

/* Time & state */
let state=null,lastCounts={encore:0,another:0,maybe:0},clockOffset=0;
let overlayHideAt=0, cachedWinnerName='', cachedWinnerKind=null;
let prevPhase='idle', phaseHoldUntil=0;
let lastShownSinger='';
let resultSuppressed=true;      // ← prevents re-show after timeout
let resultShownFor='';          // ← token "kind|name" of the overlay we showed

function nowMs(){return Date.now()+clockOffset}
function smoothOffset(o){if(!isFinite(o))return;clockOffset=0.9*clockOffset+0.1*o}

async function fetchState(){
  const r=await fetch(GET_URL,{cache:'no-store'});
  const fetchedAt=Date.now(); state=await r.json();
  if(state && typeof state.serverNow==='number'){ smoothOffset(state.serverNow - fetchedAt); }
  render();
}
setInterval(fetchState,1000); fetchState();

function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}` }

function setHeader(){
  $('#welcome').textContent = 'Welcome to';
  $('#venue').textContent   = (state?.event?.venuePublic||'').trim() || '—';
  $('#hostBy').textContent  = (state?.event?.kj ? `Hosted by ${state.event.kj}` : 'Hosted by —');
}
function setNow(name){ $('#nowName').textContent = name || '—'; }

/* Balls */
function spawn(col, kind, n=1){
  const el=$(col); const W=el.clientWidth, H=el.clientHeight;
  const cls = kind==='encore'?'g':kind==='another'?'y':'r';
  for(let i=0;i<n;i++){
    const b=document.createElement('div'); b.className='ball '+cls; b.style.left=(Math.random()*W|0)+'px'; b.style.top='-24px';
    el.appendChild(b);
    let x=parseFloat(b.style.left), y=-24, vx=(Math.random()*1.6-0.8), vy=(Math.random()*1.2+0.6);
    const g=0.25, fr=0.82, dt=16;
    const id=setInterval(()=>{
      vy+=g; x+=vx*dt/16; y+=vy*dt/16;
      if(x<13){x=13;vx*=-fr} if(x>W-13){x=W-13;vx*=-fr}
      if(y>H-13){y=H-13; vy*=-fr; if(Math.abs(vy)<0.25){clearInterval(id);} }
      b.style.left=x+'px'; b.style.top=y+'px';
    }, dt);
    if(el.childNodes.length>260){ el.removeChild(el.firstChild); }
  }
}

/* Confetti */
const confettiCanvas = document.getElementById('confetti');
const ctx = confettiCanvas.getContext('2d');
let confettiRunning=false, confettiTs=0, confettiParts=[];
function startConfetti(){
  resize(); confettiCanvas.style.display='block'; confettiRunning=true; confettiTs=Date.now(); confettiParts=[];
  for(let i=0;i<240;i++){
    confettiParts.push({x:Math.random()*innerWidth,y:Math.random()*-innerHeight,vx:(Math.random()*2-1)*2,vy:(Math.random()*3+2),size:Math.random()*6+4,color:['#25d366','#f6c945','#ff5e6c'][Math.floor(Math.random()*3)],rot:Math.random()*Math.PI,vr:(Math.random()*0.1-0.05)});
  }
  requestAnimationFrame(stepConfetti);
}
function stopConfetti(){ confettiRunning=false; confettiCanvas.style.display='none'; }
function stepConfetti(){
  if(!confettiRunning) return;
  const t=Date.now()-confettiTs; if(t>15000) { stopConfetti(); return; }
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  for(const p of confettiParts){
    p.vy+=0.02; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
    if(p.y>innerHeight+20){ p.y=-20; p.x=Math.random()*innerWidth; p.vy=Math.random()*3+2; }
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
    ctx.restore();
  }
  requestAnimationFrame(stepConfetti);
}
function resize(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; }
addEventListener('resize', resize);

/* Overlay */
function showOverlay(kind, name){
  const ov=$('#overlay'), card=$('#ovCard'), title=$('#ovTitle'), sub=$('#ovSub');
  card.className='ovCard '+(kind==='encore'?'ov-enc':kind==='another'?'ov-ano':'ov-may');
  title.textContent = kind==='encore' ? 'Encore!' : (kind==='another' ? 'Another Shot!' : 'Maybe Next Time!');

  const cleanName = String(name||'').replace(/\.\s*$/,'');
  cachedWinnerName = cleanName;
  cachedWinnerKind = kind;

  sub.textContent = (kind==='maybe')
    ? (cleanName ? `Thanks, ${cleanName}!` : 'Thanks for singing!')
    : (cleanName ? `Congratulations, ${cleanName}!` : 'Congratulations!');

  ov.style.display='flex';
  overlayHideAt = Date.now()+15000;
  resultShownFor = `${kind}|${cleanName}`;
  resultSuppressed = false;
  if(kind==='encore') startConfetti();
}
function hideOverlay(){
  $('#overlay').style.display='none';
  stopConfetti();
  overlayHideAt=0;
  // Suppress re-show until next singer or next result
  resultSuppressed = true;
}

/* --- RENDER --- */
function render(){
  setHeader();

  const t = nowMs();
  const curName = (state?.current?.name||'').trim();
  const open = !!state?.voting?.open;
  const prep = (!open && (state?.voting?.prepUntil||0) > t);
  const endsAt = state?.voting?.endsAt || 0;
  const hadResult = !!state?.voting?.lastResult;

  // Anti-flicker phase selection
  let phase='idle';
  if(prep) { phase='prep'; phaseHoldUntil = Math.max(phaseHoldUntil, (state.voting.prepUntil||0) + 1200); }
  else if(open) phase='open';
  else if(hadResult) phase='result';
  else if(t < phaseHoldUntil) phase='prep';

  // If new singer is set, hide any overlay and clear suppression so the next result can show
  if(curName && curName !== lastShownSinger){
    if($('#overlay').style.display==='flex') hideOverlay();
    // Allow next result to show
    resultSuppressed = false;
  }

  // entering open => reset columns once
  if(phase==='open' && prevPhase!=='open'){
    ['#colE','#colA','#colM'].forEach(s=>$(s).innerHTML = '<div class="label">'+(s==='#colE'?'Encore!':s==='#colA'?'Another Shot!':'Maybe Next Time!')+'</div>');
    lastCounts={encore:0,another:0,maybe:0};
  }

  const header=$('#header'), nowBlock=$('#nowBlock'), votingArea=$('#votingArea');
  if(phase==='prep' || phase==='open'){
    header.style.display='none';
    nowBlock.style.display='none';
    votingArea.style.display='block';
  } else {
    header.style.display='';
    nowBlock.style.display='';
    votingArea.style.display='none';
  }

  // Show current singer in idle/result too
  if(phase==='idle' || phase==='result'){
    $('#nowLbl').textContent = 'Now Singing';
    setNow(curName);
  } else {
    $('#nowLbl').textContent = (phase==='prep') ? 'Get Ready' : 'Now Voting';
    setNow(curName);
  }

  if(overlayHideAt && Date.now()>overlayHideAt){ hideOverlay(); }

  if(phase==='prep'){
    $('#voteNow').textContent = curName ? `Get ready to vote for: ${curName}` : 'Get ready to vote…';
    $('#timer').textContent = fmt(Math.max(0,(state.voting.prepUntil||0) - t));
    $('#tally').style.display='none';
    if(prevPhase!=='prep'){
      ['#colE','#colA','#colM'].forEach(s=>$(s).innerHTML = '<div class="label">'+(s==='#colE'?'Encore!':s==='#colA'?'Another Shot!':'Maybe Next Time!')+'</div>');
      lastCounts={encore:0,another:0,maybe:0};
    }
  } else if(phase==='open'){
    $('#voteNow').textContent = curName ? `Now Voting For: ${curName}` : 'Now Voting!';
    $('#timer').textContent = fmt(Math.max(0, endsAt - t));
    $('#tally').style.display='flex';

    const ce=state?.voting?.counts?.encore||0, ca=state?.voting?.counts?.another||0, cm=state?.voting?.counts?.maybe||0;
    $('#cE').textContent=ce; $('#cA').textContent=ca; $('#cM').textContent=cm;

    if(ce>lastCounts.encore)  spawn('#colE','encore',  ce-lastCounts.encore);
    if(ca>lastCounts.another) spawn('#colA','another', ca-lastCounts.another);
    if(cm>lastCounts.maybe)   spawn('#colM','maybe',   cm-lastCounts.maybe);
    lastCounts={encore:ce,another:ca,maybe:cm};
  } else if(phase==='result'){
    const kind = state?.voting?.lastResult;
    const token = `${kind}|${curName}`;
    // Show overlay exactly once per (kind|name) combo; stay hidden after timeout
    if($('#overlay').style.display!=='flex' && !resultSuppressed && token!==resultShownFor){
      const nameForOverlay = curName || cachedWinnerName;
      showOverlay(kind, nameForOverlay);
    }
  }

  prevPhase = phase;
  lastShownSinger = curName;
}
</script>
</body>
</html>
<!-- FILE: /screen/index.html -->
