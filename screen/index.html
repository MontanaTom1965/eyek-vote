<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke ‚Äî Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#070b12; --card:#0e162b; --border:#253659; --text:#fff; --muted:#c9d3ea;
      --encore:#22c55e; --another:#f59e0b; --maybe:#ef4444; --accent:#7bc4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    }
    .wrap{max-width:1400px; margin:0 auto; padding:20px}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; padding-bottom:8px; border-bottom:2px solid var(--border)}
    h1{margin:0; font-size:2.2rem}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.15em .6em; color:#cfe1ff; font-weight:800}
    .sub{color:var(--muted); margin-top:6px}
    .grid{display:grid; gap:18px; grid-template-columns:1fr}
    .card{background:var(--card); border:2px solid var(--border); border-radius:16px; padding:16px}

    /* Now area with QR on the right */
    .now{display:flex; align-items:center; justify-content:space-between; gap:24px; flex-wrap:wrap}
    .leftNow .hint{color:var(--muted)}
    .leftNow h2{margin:.1em 0; font-size:2rem}
    .rightNow{display:flex; align-items:flex-end; gap:16px; flex-wrap:wrap}
    .statusBadge{font-weight:900; padding:.25em .6em; border-radius:10px; border:2px solid var(--border); color:#cfe1ff}
    .statusOpen{border-color:#1a6bff; background:#0b1d42}
    .statusPending{border-color:#7c879e; background:#101a2c}
    .statusClosed{border-color:#7a3a3a; background:#2a1010}
    .countdown{font-size:1.1rem; font-weight:900; text-align:right}
    .qr{width:160px; height:160px; object-fit:contain; border-radius:12px; border:2px solid var(--border); background:#0a1326}

    /* Bars */
    .bars{display:grid; gap:14px; margin-top:8px}
    .row{display:flex; gap:12px; align-items:center}
    .label{min-width:200px; font-weight:900; font-size:1.35rem}
    .barWrap{flex:1; height:48px; border:2px solid var(--border); border-radius:12px; overflow:hidden; background:#0a1326}
    .bar{height:100%; width:0%; transition:width .35s ease}
    .bar.enc{background:linear-gradient(90deg, #1ea854, #22c55e)}
    .bar.ano{background:linear-gradient(90deg, #d08a0a, #f59e0b)}
    .bar.may{background:linear-gradient(90deg, #cc2a2a, #ef4444)}
    .val{min-width:120px; text-align:right; font-weight:900; font-size:1.15rem}

    /* ‚Äúflash‚Äù when a new vote comes in */
    @keyframes flashPulse { 0%{filter:brightness(1)} 40%{filter:brightness(1.8)} 100%{filter:brightness(1)} }
    .flash{ animation: flashPulse .45s ease }

    .totals{margin-top:8px; color:var(--muted); font-weight:700}
    .winner{display:inline-block; margin-top:8px; padding:.25em .6em; border-radius:10px; border:2px solid var(--border); font-weight:900}
    .win-enc{border-color:#3aa66a; background:#0f2b1c}
    .win-ano{border-color:#9c6a14; background:#2b1f08}
    .win-may{border-color:#a83b3b; background:#2b0f10}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Encore Karaoke <span class="pill" id="eventPill">Event: ‚Äî</span></h1>
      <div class="sub" id="topNote">Screens auto-follow the active event when no <code>?eventId=</code> is provided.</div>
    </header>

    <main class="grid" style="margin-top:16px">
      <!-- Now singing + QR -->
      <section class="card">
        <div class="now">
          <div class="leftNow">
            <div class="hint">Now singing</div>
            <h2 id="nowSinger">‚Äî</h2>
            <div class="sub" id="perfMsg">Waiting for the host to start voting‚Ä¶</div>
          </div>
          <div class="rightNow">
            <div style="text-align:right">
              <div id="statusBadge" class="statusBadge statusPending">Getting ready‚Ä¶</div>
              <div class="countdown" id="countdown">‚Äî</div>
            </div>
            <img id="qrImg" class="qr" alt="Scan to vote" />
          </div>
        </div>
      </section>

      <!-- Live vote bars -->
      <section class="card">
        <div class="bars">
          <div class="row">
            <div class="label">Encore üî•</div>
            <div class="barWrap" id="wrapEnc"><div class="bar enc" id="barEnc"></div></div>
            <div class="val" id="valEnc">0</div>
          </div>
          <div class="row">
            <div class="label">Another ‚ûï</div>
            <div class="barWrap" id="wrapAno"><div class="bar ano" id="barAno"></div></div>
            <div class="val" id="valAno">0</div>
          </div>
          <div class="row">
            <div class="label">Maybe üí§</div>
            <div class="barWrap" id="wrapMay"><div class="bar may" id="barMay"></div></div>
            <div class="val" id="valMay">0</div>
          </div>
        </div>
        <div class="totals" id="totals">Total votes: 0</div>
        <div id="winnerBadge" class="winner" style="display:none">‚Äî</div>
      </section>
    </main>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      // --- Setup
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote"
      };
      if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
      firebase.initializeApp(FIREBASE_CONFIG);
      var db=firebase.firestore();

      // --- DOM
      function $(id){ return document.getElementById(id); }
      function urlRoot(){ return location.origin + '/'; }

      var eventPill=$('eventPill'), nowSinger=$('nowSinger'), statusBadge=$('statusBadge'),
          countdownEl=$('countdown'), perfMsg=$('perfMsg'),
          barEnc=$('barEnc'), barAno=$('barAno'), barMay=$('barMay'),
          wrapEnc=$('wrapEnc'), wrapAno=$('wrapAno'), wrapMay=$('wrapMay'),
          valEnc=$('valEnc'), valAno=$('valAno'), valMay=$('valMay'),
          totalsEl=$('totals'), winnerBadge=$('winnerBadge'), qrImg=$('qrImg');

      // --- State
      var unsubMeta=null, unsubState=null, unsubPerf=null, unsubVotes=null;
      var CURRENT={ eventId:null, performanceId:null, status:'', closeAt:null, singerName:'‚Äî' };
      var COUNTS={ encore:0, another:0, maybe:0 };
      var PREV={ encore:0, another:0, maybe:0 };
      var countdownTimer=null;

      // --- Helpers
      function setBadge(status){
        statusBadge.className='statusBadge';
        if(status==='open'){ statusBadge.classList.add('statusOpen'); statusBadge.textContent='Voting OPEN'; }
        else if(status==='closed'){ statusBadge.classList.add('statusClosed'); statusBadge.textContent='Voting CLOSED'; }
        else { statusBadge.classList.add('statusPending'); statusBadge.textContent='Getting ready‚Ä¶'; }
      }
      function fmt(n){ return (n|0).toString(); }
      function pct(part,total){ if(total<=0) return 0; return Math.round(part*100/total); }
      function renderBars(){
        var t = COUNTS.encore + COUNTS.another + COUNTS.maybe;
        var pE=pct(COUNTS.encore,t), pA=pct(COUNTS.another,t), pM=pct(COUNTS.maybe,t);
        barEnc.style.width = pE+'%';
        barAno.style.width = pA+'%';
        barMay.style.width = pM+'%';
        valEnc.textContent = fmt(COUNTS.encore) + (t?(' ¬∑ '+pE+'%'):'');
        valAno.textContent = fmt(COUNTS.another)+ (t?(' ¬∑ '+pA+'%'):'');
        valMay.textContent = fmt(COUNTS.maybe)  + (t?(' ¬∑ '+pM+'%'):'');
        totalsEl.textContent = 'Total votes: ' + fmt(t);

        // Live leader when open / final when closed
        if(CURRENT.status==='open'){
          var lead = decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
          showWinnerBadge(lead, true);
        }else if(CURRENT.status==='closed'){
          var final = decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
          showWinnerBadge(final, false);
        }else{
          winnerBadge.style.display='none';
        }
      }

      function flashIfIncreased(){
        if (COUNTS.encore > PREV.encore){ wrapEnc.classList.add('flash'); setTimeout(()=>wrapEnc.classList.remove('flash'), 450); }
        if (COUNTS.another> PREV.another){wrapAno.classList.add('flash'); setTimeout(()=>wrapAno.classList.remove('flash'), 450); }
        if (COUNTS.maybe > PREV.maybe){  wrapMay.classList.add('flash'); setTimeout(()=>wrapMay.classList.remove('flash'), 450); }
        PREV.encore = COUNTS.encore; PREV.another = COUNTS.another; PREV.maybe = COUNTS.maybe;
      }

      function showWinnerBadge(kind, live){
        if(!kind){ winnerBadge.style.display='none'; return; }
        winnerBadge.className='winner';
        if(kind==='encore') winnerBadge.classList.add('win-enc');
        if(kind==='another') winnerBadge.classList.add('win-ano');
        if(kind==='maybe') winnerBadge.classList.add('win-may');
        winnerBadge.textContent = (live?'Leading: ':'Winner: ') + (kind==='encore'?'Encore':kind==='another'?'Another':'Maybe');
        winnerBadge.style.display='inline-block';
      }

      // Tie-break logic (your exact rules)
      function decideOutcomeStrict(e,a,m){
        e|=0;a|=0;m|=0;
        if(e>a && e>m) return 'encore';
        if(a>e && a>m) return 'another';
        if(m>e && m>a) return 'maybe';
        if(a===m && a>e) return 'another';     // another vs maybe -> another
        if(e===a && e>m) return 'encore';      // encore vs another -> encore
        if(e===m && e>a) return 'another';     // encore vs maybe -> another
        if(e===a && a===m && e>0) return 'another'; // three-way tie -> another
        return null;
      }

      function clearVotes(){
        COUNTS.encore=COUNTS.another=COUNTS.maybe=0;
        PREV.encore=PREV.another=PREV.maybe=0;
        renderBars();
      }

      function renderCountdown(){
        if(!CURRENT.closeAt || CURRENT.status!=='open'){ countdownEl.textContent='‚Äî'; return; }
        var ms = CURRENT.closeAt.toMillis() - Date.now();
        var s = Math.max(0, Math.ceil(ms/1000));
        countdownEl.textContent = s + 's';
      }
      function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer=setInterval(renderCountdown,250); }
      function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } countdownEl.textContent='‚Äî'; }

      // QR: static providers (no library)
      function qrProvider1(d){ return 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(d); }
      function qrProvider2(d){ return 'https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl='+encodeURIComponent(d); }
      function setQrForUrl(url){
        if (!qrImg) return;
        if (!url){ qrImg.removeAttribute('src'); qrImg.alt='QR will appear when a performance is announced'; return; }
        var tried=false;
        qrImg.onerror=function(){ if(!tried){ tried=true; qrImg.src=qrProvider2(url); } else { qrImg.alt='QR unavailable'; } };
        qrImg.src=qrProvider1(url);
        qrImg.alt='Scan to vote';
      }
      function updateQr(){
        if (!CURRENT.performanceId || !CURRENT.eventId){ setQrForUrl(null); return; }
        var url = urlRoot()+'vote/index.html?eventId=' + encodeURIComponent(CURRENT.eventId)
                                + '&performanceId=' + encodeURIComponent(CURRENT.performanceId);
        setQrForUrl(url);
      }

      // --- Wiring
      function followEvent(){
        var u=new URL(location.href), eid=u.searchParams.get('eventId');
        if(eid){ eventPill.textContent='Event: '+eid; startForEvent(eid); }
        else{
          unsubMeta = db.collection('meta').doc('active').onSnapshot(function(snap){
            var d=snap.data()||{}; var ev=d.eventId||'default';
            eventPill.textContent='Event: '+ev;
            startForEvent(ev);
          }, function(err){ console.error(err); });
        }
      }

      function startForEvent(eid){
        if(CURRENT.eventId===eid) return;
        CURRENT.eventId=eid;
        // Reset listeners
        if(unsubState){ unsubState(); unsubState=null; }
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(unsubVotes){ unsubVotes(); unsubVotes=null; }
        nowSinger.textContent='‚Äî';
        setBadge('pending');
        perfMsg.textContent='Waiting for the host to start voting‚Ä¶';
        clearVotes();
        setQrForUrl(null);

        unsubState = db.collection('events').doc(eid).collection('state').doc('current')
          .onSnapshot(function(s){
            var d = s.data()||{};
            var perfId = d.performanceId || null;
            var singer = d.currentSingerName || '‚Äî';
            nowSinger.textContent = singer;
            watchPerformance(perfId);
          }, function(err){ console.error(err); });
      }

      function watchPerformance(perfId){
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(unsubVotes){ unsubVotes(); unsubVotes=null; }
        CURRENT.performanceId = perfId;
        clearVotes();
        if(!perfId){
          setBadge('pending'); perfMsg.textContent='Waiting for the host to start voting‚Ä¶'; stopCountdown(); setQrForUrl(null); return;
        }
        updateQr(); // show QR immediately in pending/open/closed

        unsubPerf = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(perfId)
          .onSnapshot(function(snap){
            if(!snap.exists){ setBadge('pending'); perfMsg.textContent='(performance not found)'; stopCountdown(); return; }
            var d = snap.data()||{};
            CURRENT.status = d.status || 'pending';
            CURRENT.closeAt = d.closeAt || null;

            if(CURRENT.status==='open'){
              setBadge('open');
              perfMsg.textContent='Vote now!';
              if(CURRENT.closeAt) startCountdown(); else stopCountdown();
              if(!unsubVotes) watchVotes(perfId);
              updateQr();
            }else if(CURRENT.status==='closed'){
              setBadge('closed');
              perfMsg.textContent='Voting closed.';
              stopCountdown();
              updateQr();
              // Show final winner using counts we have (or doc.outcome if set)
              var oc = d.outcome || decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
              showWinnerBadge(oc,false);
            }else{
              setBadge('pending');
              perfMsg.textContent='Get ready to vote‚Ä¶';
              stopCountdown();
              updateQr();
            }
          }, function(err){ console.error(err); });
      }

      function watchVotes(perfId){
        unsubVotes = db.collection('events').doc(CURRENT.eventId).collection('votes')
          .where('performanceId','==', perfId)
          .onSnapshot(function(snap){
            // recompute from scratch (simple + robust)
            COUNTS.encore=COUNTS.another=COUNTS.maybe=0;
            snap.forEach(function(d){
              var x=d.data()||{};
              var c=String(x.category||'').toLowerCase();
              if(c==='encore') COUNTS.encore++;
              else if(c==='another') COUNTS.another++;
              else if(c==='maybe') COUNTS.maybe++;
            });
            flashIfIncreased();
            renderBars();
          }, function(err){ console.error(err); });
      }

      // Begin
      followEvent();
    })();
  </script>
</body>
</html>
