<!doctype html>
<meta charset="utf-8"><title>Encore! ‚Ä¢ Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#0f1526; --card:#0d1428; --line:#2b3c62; --txt:#eaf2ff; --muted:#b9c6ff;
         --green:#25d366; --yellow:#f6c945; --red:#ff5e6c; --purple:#2F0658; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:20px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;place-items:center;min-height:100svh;text-align:center;padding:4vmin;position:relative;overflow:hidden}
  .title{font-family:"Bebas Neue"; font-size:9vmin; letter-spacing:.5vmin; margin:0 0 1.2vmin; color:#fff}
  .venue{font-family:"Montserrat"; font-weight:800; font-size:6vmin; color:#ffd6ff; margin:0 0 1vmin; text-shadow:0 6px 24px rgba(47,6,88,.45); max-width:95vw; overflow-wrap:anywhere}
  .kj{font-family:"Montserrat"; font-weight:600; font-size:2.6vmin; color:#c9d6ff; margin:0 0 2.5vmin; opacity:.9; max-width:95vw; overflow-wrap:anywhere}

  /* Now/Prep bar (welcome view only) */
  .nowBar{margin-top:1.5vmin}
  .nowTitle{font-family:"Montserrat"; font-weight:800; font-size:4.8vmin; margin:.6vmin 0 .2vmin; color:#ffffff}
  .nowName{font-family:"Bebas Neue"; font-size:9vmin; margin:0 0 .2vmin}
  .prep{font-family:"Montserrat"; font-size:3.8vmin; color:#cfe0ff; margin:.8vmin 0 0}

  /* Voting fullscreen section */
  .voteView{display:none; position:relative}
  .hud{position:absolute; top:2vmin; left:2vmin; right:2vmin; display:flex; justify-content:space-between; align-items:flex-start; pointer-events:none}
  .hud .left{font-family:"Montserrat"; font-weight:800; font-size:4.6vmin; text-align:left}
  .hud .right{font-family:"Bebas Neue"; font-size:10vmin; letter-spacing:.3vmin}
  .who{font-family:"Bebas Neue"; font-size:9vmin; margin-top:.4vmin}

  .pit{position:relative; width:min(110vmin,92vw); height:44vmin; margin:10vmin auto 1.5vmin;
        border-radius:22px; border:3px solid rgba(255,255,255,.22); background:rgba(0,0,0,.18); overflow:hidden; display:grid; grid-template-columns:1fr 1fr 1fr}
  .lane{position:relative; border-right:2px dashed rgba(255,255,255,.18)}
  .lane:last-child{border-right:none}
  .ball{position:absolute; width:8.4vmin; height:8.4vmin; border-radius:50%; opacity:.95; box-shadow:0 0 12px rgba(0,0,0,.35)}
  .ball.g{background:#25d366} .ball.y{background:#f6c945} .ball.r{background:#ff5e6c}

  .tally{display:none; gap:3vmin; justify-content:center; margin-top:1vmin}
  .chip{padding:1.2vmin 2.8vmin;border-radius:14px;border:2px solid var(--line);background:var(--card); font-size:5vmin}
  .enc{color:var(--green)} .ano{color:var(--yellow)} .may{color:var(--red)}

  /* Result Overlays (15s) */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; z-index:10}
  .panel{text-align:center; padding:2vmin 4vmin}
  .ovTitle{font-family:"Bebas Neue"; font-size:20vmin; margin:0 0 1.2vmin}
  .ovMsg{font-family:"Montserrat"; font-weight:800; font-size:7vmin; margin:0 0 .6vmin; color:#cfe0ff}

  #confetti{position:absolute; inset:0; pointer-events:none}
  .flashEncore{position:absolute; top:3vmin; left:50%; transform:translateX(-50%); background:#10152b; border:2px solid rgba(37,211,102,.5); color:#25d366; padding:1vmin 3vmin; border-radius:999px; font-weight:800; font-size:4vmin; box-shadow:0 10px 40px rgba(37,211,102,.35); display:none}

  /* subtle heartbeat to keep panels ‚Äúactive‚Äù */
  .heartbeat{animation:hb 6s infinite ease-in-out; }
  @keyframes hb{ 0%,100%{opacity:1} 50%{opacity:.995} }
</style>

<div class="wrap heartbeat">
  <canvas id="confetti"></canvas>
  <div id="flash" class="flashEncore">Encore! üéâ</div>

  <!-- Main welcome view (hidden while voting) -->
  <div id="welcome">
    <h1 class="title">Welcome to</h1>
    <div id="venue" class="venue">‚Äî</div>
    <div id="kj" class="kj">Hosted by ‚Äî</div>

    <div id="nowBar" class="nowBar" style="display:none">
      <div class="nowTitle">Now Singing:</div>
      <div id="nowName" class="nowName">‚Äî</div>
      <div id="prep" class="prep" style="display:none">Get ready to vote in 00:05</div>
    </div>
  </div>

  <!-- Voting fullscreen view -->
  <div id="voteView" class="voteView">
    <div class="hud">
      <div class="left">
        <div>Now voting for:</div>
        <div id="who" class="who">‚Äî</div>
      </div>
      <div id="timer" class="right">00:00</div>
    </div>

    <div id="pit" class="pit" aria-label="live vote balls">
      <div id="laneE" class="lane"></div>
      <div id="laneA" class="lane"></div>
      <div id="laneM" class="lane"></div>
    </div>

    <div id="tally" class="tally">
      <div class="chip enc">Encore: <b id="cE">0</b></div>
      <div class="chip ano">Another Shot: <b id="cA">0</b></div>
      <div class="chip may">Maybe Next Time: <b id="cM">0</b></div>
    </div>
  </div>

  <!-- 15s result overlay -->
  <div id="overlay" class="overlay">
    <div class="panel">
      <div id="ovTitle" class="ovTitle">Encore!</div>
      <div id="ovMsg" class="ovMsg">Congratulations, ‚Äî!</div>
    </div>
  </div>
</div>

<script>
const GET_URL='/assets/get_state.php';
const $=s=>document.querySelector(s);

// time sync
let clockOffset=0;
function nowMs(){ return Date.now()+clockOffset; }
function smoothOffset(observed){ if(!isFinite(observed)) return; clockOffset=0.9*clockOffset+0.1*observed; }

let state=null, prevOpen=false, lastCounts={encore:0, another:0, maybe:0};
let overlayTimer=null, overlaySingerId=null;
let tallyUntil=0;

/* Confetti */
const confetti=(function(){
  const cv=document.getElementById('confetti'), cx=cv.getContext('2d');
  let W=0,H=0, parts=[], running=false;
  function resize(){ W=cv.width=window.innerWidth; H=cv.height=window.innerHeight; }
  function rand(a,b){ return a+Math.random()*(b-a); }
  function burst(n=280){
    for(let i=0;i<n;i++){
      parts.push({x: W/2, y: H*0.25, r: rand(2,4), vx: rand(-6,6), vy: rand(-2,8), g: 0.18, life: rand(60,140), color: `hsl(${Math.floor(rand(0,360))} 90% 60%)`});
    }
    if(!running){ running=true; loop(); }
  }
  function loop(){
    if(!running) return;
    cx.clearRect(0,0,W,H);
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i]; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life--;
      cx.fillStyle=p.color; cx.beginPath(); cx.arc(p.x,p.y,p.r,0,Math.PI*2); cx.fill();
      if(p.life<=0 || p.y>H+20) parts.splice(i,1);
    }
    if(parts.length===0){ running=false; return; }
    requestAnimationFrame(loop);
  }
  window.addEventListener('resize', resize); resize();
  return { burst };
})();
function showEncoreFlash(){
  const el=document.getElementById('flash'); el.style.display='inline-block'; el.style.opacity='1';
  el.animate([{transform:'translateX(-50%) scale(0.9)', opacity:.0},{transform:'translateX(-50%) scale(1)',opacity:1}],{duration:200,easing:'ease-out'});
  setTimeout(()=>{ el.animate([{opacity:1},{opacity:0}],{duration:800,easing:'ease-in'}).onfinish=()=>{ el.style.display='none'; }; }, 1300);
}

/* Spawn into lanes */
function spawnBalls(kind, n){
  const lane = kind==='encore' ? $('#laneE') : kind==='another' ? $('#laneA') : $('#laneM');
  const W=lane.clientWidth, H=lane.clientHeight;
  const cls = kind==='encore'?'g':kind==='another'?'y':'r';

  for(let i=0;i<n;i++){
    const b=document.createElement('div'); b.className='ball '+cls;
    let x=16+Math.random()*(W-32), y=16, vx=(Math.random()*2-1)*0.9, vy=(Math.random()*1.5+0.9);
    b.style.left=x+'px'; b.style.top=y+'px'; lane.appendChild(b);
    const g=0.22, fr=0.86, dt=16, R=4.2; // radius half-size
    const id=setInterval(()=>{
      vy+=g; x+=vx*dt/16; y+=vy*dt/16;
      if(x<R*2){x=R*2;vx*=-fr} if(x>W-R*2){x=W-R*2;vx*=-fr}
      if(y>H-R*2){y=H-R*2; vy*=-fr; if(Math.abs(vy)<0.22){clearInterval(id);} }
      b.style.left=x+'px'; b.style.top=y+'px';
    }, dt);
    if(lane.childNodes.length>120){ lane.removeChild(lane.firstChild); }
  }
}

/* Overlay show/hide for ~15s or until singer changes */
function showOverlay(kind){
  const ov=document.getElementById('overlay'),
        t=document.getElementById('ovTitle'),
        msg=document.getElementById('ovMsg');
  const name = state.current?.name || '‚Äî';
  overlaySingerId = state.current?.id || null;

  if(kind==='encore'){
    t.textContent='Encore!';
    t.style.color='#25d366';
    msg.textContent = `Congratulations, ${name}!`;
    confetti.burst(300); showEncoreFlash();
  } else if(kind==='another'){
    t.textContent='Another Shot!';
    t.style.color='#f6c945';
    msg.textContent = `Congratulations, ${name}!`;
  } else {
    t.textContent='Maybe Next Time';
    t.style.color='#ff5e6c';
    msg.textContent = `Sorry, ${name}.`;
  }

  ov.style.display='flex';
  clearTimeout(overlayTimer);
  overlayTimer = setTimeout(()=>{ ov.style.display='none'; overlaySingerId=null; }, 15000);
}
function hideOverlayIfSingerChanged(){
  if(!overlaySingerId) return;
  const curId = state.current?.id || null;
  if(curId && curId !== overlaySingerId){
    document.getElementById('overlay').style.display='none';
    overlaySingerId=null; clearTimeout(overlayTimer);
  }
}

/* Main loop */
async function tick(){
  const r=await fetch(GET_URL,{cache:'no-store'});
  const fetchedAt=Date.now();
  state=await r.json();

  if(state && typeof state.serverNow==='number'){
    const observed = state.serverNow - fetchedAt;
    if(clockOffset===0) clockOffset=observed; else smoothOffset(observed);
  }

  const welcome   = document.getElementById('welcome');
  const voteView  = document.getElementById('voteView');
  const whoEl     = document.getElementById('who');
  const timerEl   = document.getElementById('timer');
  const tally     = document.getElementById('tally');

  // Welcome view basics
  const publicOnly = (state.event?.venuePublic||'').trim();
  document.getElementById('venue').textContent = publicOnly ? publicOnly : '‚Äî';
  const kjName = state.event?.kj || '';
  document.getElementById('kj').textContent    = kjName ? `Hosted by ${kjName}` : 'Hosted by ‚Äî';

  const t = nowMs();
  const open = !!state.voting?.open;
  const prep = (!open && (state.voting?.prepUntil||0) > t);
  const result = state.voting?.lastResult || null;
  const hasCurrent = !!state.current?.id;

  // Now/Prep panel (only in welcome)
  const nowBar = document.getElementById('nowBar');
  const nowName= document.getElementById('nowName');
  const prepEl = document.getElementById('prep');

  if(!open){
    welcome.style.display='block';
    voteView.style.display='none';

    if(hasCurrent){
      nowBar.style.display='block';
      nowName.textContent = state.current?.name || '‚Äî';
      if(prep){
        const ms = Math.max(0, (state.voting?.prepUntil||0) - t);
        prepEl.style.display='block';
        prepEl.textContent = 'Get ready to vote in ' + fmt(ms);
      } else {
        prepEl.style.display='none';
      }
    } else {
      nowBar.style.display='none';
      prepEl.style.display='none';
    }

    // Tally only for 15s after close
    tally.style.display = (t < tallyUntil) ? 'flex' : 'none';

    // clear lanes after close
    ['#laneE','#laneA','#laneM'].forEach(sel=>{ const el=$(sel); if(el) el.innerHTML=''; });
    lastCounts = {encore:0,another:0,maybe:0};
    document.getElementById('cE').textContent = 0;
    document.getElementById('cA').textContent = 0;
    document.getElementById('cM').textContent = 0;
  } else {
    // Voting fullscreen view
    welcome.style.display='none';
    voteView.style.display='block';
    whoEl.textContent = state.current?.name || '‚Äî';

    const ce = state.voting?.counts?.encore  ?? 0;
    const ca = state.voting?.counts?.another ?? 0;
    const cm = state.voting?.counts?.maybe   ?? 0;

    // Spawn new balls as counts rise per lane
    if(ce>lastCounts.encore)  spawnBalls('encore',  ce-lastCounts.encore);
    if(ca>lastCounts.another) spawnBalls('another', ca-lastCounts.another);
    if(cm>lastCounts.maybe)   spawnBalls('maybe',   cm-lastCounts.maybe);
    lastCounts = {encore:ce, another:ca, maybe:cm};

    const ms=Math.max(0,(state.voting.endsAt||0)-t);
    timerEl.textContent=fmt(ms);

    // live tally visible during open
    document.getElementById('cE').textContent = ce;
    document.getElementById('cA').textContent = ca;
    document.getElementById('cM').textContent = cm;
    tally.style.display='flex';
  }

  // Transition: open -> closed
  if(prevOpen && !open){
    tallyUntil = t + 15000; // show tally 15s after close
    if(result){ showOverlay(result); }
  }
  prevOpen = open;

  // Hide overlay early if host sets a new singer
  hideOverlayIfSingerChanged();
}
function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}` }

setInterval(tick, 1000);
tick();

// Wake-lock + heartbeat to keep TVs awake
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });
requestWakeLock();
</script>

<!-- FILE: /screen/index.html -->
