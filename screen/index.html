<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Screen | Earn Your Encore Karaoke</title>
  <style>
    body { margin:0; background:#0e0d2b; color:#fff; font-family:system-ui,sans-serif; }
    .wrap { max-width:1100px; margin:0 auto; padding:28px; }
    h1 { color:#ffd24a; text-align:center; }
    .screen { display:grid; grid-template-columns: 320px 1fr; gap:24px; align-items:center; }
    .panel { background:#1e1d3a; border-radius:14px; padding:16px; }
    .qr img { width:100%; max-width:280px; background:#fff; padding:10px; border-radius:10px; }
    .link { font-size:14px; word-break:break-all; color:#ddd; text-align:center; margin-top:8px; }
    .bar { background:#141335; border-radius:10px; padding:10px; margin:10px 0; }
    .track { width:100%; background:#0f0e2a; border-radius:8px; height:22px; }
    .fill { height:22px; width:0%; transition: width 400ms ease; }
    .fill.ok { background:#27ae60; }
    .fill.maybe { background:#f39c12; }
    .fill.no { background:#c0392b; }
    .pct { font-size:13px; margin-top:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Did this singer earn an Encore?</h1>
    <div class="screen">
      <div class="panel qr">
        <img id="qr" alt="QR">
        <div class="link" id="voteLink"></div>
      </div>
      <div class="panel">
        <div class="bar"><label>üî• Encore</label><div class="track"><div class="fill ok" id="barEncore"></div></div><div class="pct" id="pctEncore">0 votes</div></div>
        <div class="bar"><label>ü§î One More Shot</label><div class="track"><div class="fill maybe" id="barOneMore"></div></div><div class="pct" id="pctOneMore">0 votes</div></div>
        <div class="bar"><label>‚ùå Maybe Next Time</label><div class="track"><div class="fill no" id="barNextTime"></div></div><div class="pct" id="pctNextTime">0 votes</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(location.search);
    const sid = params.get('sid') || "TEST";
    const singer = params.get('singer') || "this singer";
    document.querySelector('h1').textContent = `Did ${singer} earn an Encore?`;

    const BASE = 'https://vote.earnyourencorekaraoke.com';
    const voteURL = `${BASE}/vote/?sid=${encodeURIComponent(sid)}&singer=${encodeURIComponent(singer)}`;
    document.getElementById('voteLink').textContent = voteURL;
    document.getElementById('qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(voteURL)}`;

    let encore=0, one=0, nextt=0;
    function render(){
      const total = encore+one+nextt || 1;
      document.getElementById('barEncore').style.width=(encore/total*100)+'%';
      document.getElementById('barOneMore').style.width=(one/total*100)+'%';
      document.getElementById('barNextTime').style.width=(nextt/total*100)+'%';
      document.getElementById('pctEncore').textContent = `${encore} vote${encore===1?'':'s'}`;
      document.getElementById('pctOneMore').textContent = `${one} vote${one===1?'':'s'}`;
      document.getElementById('pctNextTime').textContent= `${nextt} vote${nextt===1?'':'s'}`;
    }

    db.collection('votes').where('sid','==',sid).onSnapshot(snap=>{
      encore=one=nextt=0;
      snap.forEach(doc=>{
        const v=doc.data().choice;
        if(v==='encore') encore++;
        if(v==='one_more') one++;
        if(v==='next_time') nextt++;
      });
      render();
    });
  </script>
</body>
</html>
