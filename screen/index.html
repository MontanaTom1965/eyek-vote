<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EYEK • Screen</title>
<style>
  :root{ --bg:#050910; --brand:#23c7a2; --text:#e6f0ff; --muted:#9fb3c8; --encore:#22c55e; --another:#f59e0b; --maybe:#ef4444 }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -10%, #1a2a42, #050910);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .stage{height:100%;display:grid;place-items:center;padding:24px}
  .card{width:min(1100px,95vw);border-radius:28px;padding:34px 28px;background:rgba(0,0,0,.28);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.09);box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .venue{font-size:22px;color:var(--muted)}
  .kj{font-size:18px;color:#bcd2e6}
  .now{margin:20px 0 10px 0}
  .name{font-size:60px;line-height:1.05;font-weight:800;letter-spacing:.5px;text-shadow:0 4px 16px rgba(0,0,0,.35)}
  .song{font-size:26px;color:#d1e3f7}
  .timer{font-size:80px;font-weight:900;letter-spacing:2px;margin:10px 0;opacity:.9}
  .hint{font-size:18px;color:var(--muted)}
  .banner{margin-top:18px;border-radius:18px;padding:18px 20px;font-size:46px;font-weight:900;text-align:center}
  .banner.encore{background:linear-gradient(135deg,#0f3,#093);color:#042;box-shadow:0 0 60px rgba(34,197,94,.35) inset, 0 18px 60px rgba(0,0,0,.4)}
  .banner.another{background:linear-gradient(135deg,#f9b522,#915f06);color:#2a1800;box-shadow:0 0 60px rgba(245,158,11,.35) inset, 0 18px 60px rgba(0,0,0,.4)}
  .banner.maybe{background:linear-gradient(135deg,#ff6b6b,#7f1d1d);color:#2b0c0c;box-shadow:0 0 60px rgba(239,68,68,.35) inset, 0 18px 60px rgba(0,0,0,.4)}
  .pulse{animation:pulse 1.8s ease-in-out infinite}
  @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
  /* confetti */
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;top:-10vh;width:8px;height:14px;opacity:.9;animation:fall 3.2s linear forwards;}
  @keyframes fall{to{transform:translateY(120vh) rotate(720deg)}}
  /* gentle keep-alive shimmer */
  .shimmer{background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);background-size:200% 100%;animation:shimmer 18s linear infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>
</head>
<body>
<div class="stage">
  <div class="card shimmer">
    <div class="row">
      <div class="venue" id="venueTxt">Welcome to …</div>
      <div class="kj" id="kjTxt">Hosted by …</div>
    </div>
    <div class="now">
      <div class="name" id="nameTxt">Waiting for next singer…</div>
      <div class="song" id="songTxt"></div>
    </div>
    <div class="timer" id="timer">--</div>
    <div class="hint">Get ready to vote: <strong>ENCORE!</strong> • <strong>Another Shot</strong> • <strong>Maybe Next Time</strong></div>
    <div class="banner" id="banner" style="display:none"></div>
  </div>
</div>
<div class="confetti" id="confetti"></div>

<audio id="sfxEncore" src="/assets/you_win_001.mp3" preload="auto"></audio>
<audio id="sfxAnother" src="/assets/end%20of%20voting.wav" preload="auto"></audio>
<audio id="sfxMaybe" src="/assets/sad_horn.mp3" preload="auto"></audio>

<script>
const LS_KEY='eyek_state_v1';
const bc=('BroadcastChannel' in self)?new BroadcastChannel('eyek_bus'):null;

let state = load();
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }

function render(){
  venueTxt.textContent = state?.event?.venue ? `Welcome to ${state.event.venue}` : 'Welcome!';
  kjTxt.textContent    = state?.event?.kj ? `KJ: ${state.event.kj}` : 'KJ: —';

  const cur = state?.current||{};
  nameTxt.textContent = cur.name || 'Waiting for next singer…';
  songTxt.textContent = (cur.song||cur.artist) ? `${cur.song||''}${cur.artist?` • ${cur.artist}`:''}` : '';

  // timer
  if (state?.voting?.active){
    const remain = Math.max(0, state.voting.endAt - Date.now());
    const s = Math.ceil(remain/1000);
    timer.textContent = s+'s';
  } else {
    timer.textContent = '--';
  }
}
render();

setInterval(()=>{
  state = load();
  render();
}, 300); // light poll so TVs keep “active”

if (bc){
  bc.onmessage = (ev)=>{
    if (ev.data?.type==='state'){
      state = ev.data.state;
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      render();
      if (state.lastOutcome && Date.now()-state.lastOutcome.at<1500){
        fireOutcome(state.lastOutcome.kind);
      }
    }
  }
}

// Outcome splash + sfx + confetti
function fireOutcome(kind){
  const b=banner;
  b.style.display='block';
  b.className='banner '+kind+' pulse';
  b.textContent = (kind==='encore'?'ENCORE! 🎉':kind==='another'?'Another Shot! 🔁':'Maybe Next Time 😬');
  playSfx(kind);
  confettiBurst(kind);
  setTimeout(()=>{ b.style.display='none'; }, 3500);
}

function playSfx(kind){
  try{
    if (kind==='encore') sfxEncore.currentTime=0, sfxEncore.play();
    else if (kind==='another') sfxAnother.currentTime=0, sfxAnother.play();
    else sfxMaybe.currentTime=0, sfxMaybe.play();
  }catch{}
}

function confettiBurst(kind){
  const colors = kind==='encore' ? ['#34d399','#22c55e','#bbf7d0']
               : kind==='another'? ['#fbbf24','#fde68a','#f59e0b']
               : ['#fecaca','#f87171','#ef4444'];
  const container = confetti;
  for (let i=0;i<80;i++){
    const d = document.createElement('div');
    d.className='piece';
    d.style.left = Math.random()*100+'%';
    d.style.background = colors[i%colors.length];
    d.style.animationDelay = (Math.random()*0.6)+'s';
    d.style.transform = `translateY(-10vh) rotate(${Math.random()*360}deg)`;
    container.appendChild(d);
    setTimeout(()=>d.remove(), 4000);
  }
}
</script>
</body>
</html>
