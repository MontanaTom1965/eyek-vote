<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#04060b; --text:#eaf2ff; --muted:#9db2d1;
    --green:#26e28b; --yellow:#ffd24d; --red:#ff5a6b; --brand:#66aaff;
  }
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -200px,#0d1b35,#04060b);color:var(--text)}
  .center{display:flex;align-items:center;justify-content:center;height:100%;}
  .col{display:flex;flex-direction:column;gap:18px;align-items:center;justify-content:center;text-align:center}
  h1{font-size:60px;margin:0}
  h2{font-size:28px;margin:0;color:var(--muted)}
  .card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:24px 32px;backdrop-filter: blur(6px)}
  .stacks{display:flex;gap:28px;margin-top:12px}
  .stack{min-width:220px}
  .stack h3{margin:6px 0 10px 0}
  .count{font-size:48px;font-weight:800}
  .balls{height:200px;border:1px dashed rgba(255,255,255,0.15);border-radius:12px;position:relative;overflow:hidden}
  .ball{width:22px;height:22px;border-radius:50%;position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);animation: rise 1.6s ease-out forwards}
  .ball.green{background:var(--green)} .ball.yellow{background:var(--yellow)} .ball.red{background:var(--red)}
  @keyframes rise{ 0%{bottom:-24px;opacity:0} 10%{opacity:1} 100%{bottom:180px;opacity:1}}
  .timer{font-size:90px;font-weight:900;letter-spacing:1px}
  .banner{font-size:72px;font-weight:1000;padding:24px 36px;border-radius:18px}
  .banner.encore{background:linear-gradient(45deg,#13ef96,#7bffec); color:#021b12; box-shadow:0 0 80px #13ef9699}
  .banner.another{background:linear-gradient(45deg,#ffd24d,#fff2b0); color:#231a00; box-shadow:0 0 80px #ffd24d99}
  .banner.nexttime{background:linear-gradient(45deg,#ff5a6b,#ffc0c7); color:#290006; box-shadow:0 0 80px #ff5a6b99}
  .mini{color:var(--muted);font-size:14px}
</style>
</head>
<body>
<div class="center">
  <div class="col">
    <div id="welcome" class="card">
      <h2 id="vk">Welcome to</h2>
      <h1 id="venue">—</h1>
      <h2 id="kj">with KJ —</h2>
      <div class="mini">Waiting for host to select a singer…</div>
    </div>

    <div id="nowVoting" class="card" style="display:none;max-width:1200px">
      <h2>Now Voting For</h2>
      <h1 id="singerName">—</h1>
      <div class="timer" id="timer">30</div>
      <div class="stacks">
        <div class="stack">
          <h3>Encore!</h3>
          <div class="count" id="enc">0</div>
          <div class="balls" id="encBalls"></div>
        </div>
        <div class="stack">
          <h3>Another Shot!</h3>
          <div class="count" id="ano">0</div>
          <div class="balls" id="anoBalls"></div>
        </div>
        <div class="stack">
          <h3>Maybe Next Time</h3>
          <div class="count" id="nxt">0</div>
          <div class="balls" id="nxtBalls"></div>
        </div>
      </div>
    </div>

    <div id="result" style="display:none">
      <div id="resultBanner" class="banner">—</div>
      <div class="mini">Showing board next…</div>
    </div>

    <audio id="audOpen" src="/assets/voting_open.mp3" preload="auto"></audio>
    <audio id="audOver" src="/assets/voting_over.mp3" preload="auto"></audio>
    <audio id="audEncore" src="/assets/encore.mp3" preload="auto"></audio>
    <audio id="audLoser" src="/assets/loser.wav" preload="auto"></audio>
  </div>
</div>

<script>
const API = '/assets/state.php';
let STATE=null, POLL, lastCounts={encore:0, another:0, nexttime:0}, lastOpen=false, showingResult=false;

function $(id){return document.getElementById(id)}
function show(id){$(id).style.display='block'}
function hide(id){$(id).style.display='none'}

async function fetchState(){
  const r = await fetch(API+'?action=get',{cache:'no-store'});
  STATE = await r.json();
}
function addBalls(which, n) {
  const map = {encore:'encBalls', another:'anoBalls', nexttime:'nxtBalls'};
  const cls = {encore:'green', another:'yellow', nexttime:'red'};
  const box = $(map[which]);
  for(let i=0;i<n;i++){
    const b=document.createElement('div');
    b.className='ball '+cls[which];
    b.style.left = (10 + Math.random()*80)+'%';
    box.appendChild(b);
    setTimeout(()=>{ if(b.parentNode) b.parentNode.removeChild(b); }, 1800);
  }
}
function render(){
  const s=STATE||{};
  $('venue').textContent = s.venue || '—';
  $('kj').textContent = 'with KJ ' + (s.kj || '—');

  const cur = (s.singers||[]).find(x=>x.id===s.currentSingerId);

  if (s.voting?.open && cur && !showingResult) {
    hide('welcome'); hide('result'); show('nowVoting');
    $('singerName').textContent = cur.name;

    // play open sound once on transition
    if (!lastOpen) $('audOpen').play().catch(()=>{});
    lastOpen = true;

    // counts
    const e = s.voting.encore||0, a=s.voting.another||0, n=s.voting.nexttime||0;
    $('enc').textContent=e; $('ano').textContent=a; $('nxt').textContent=n;

    if (e>lastCounts.encore) addBalls('encore', e-lastCounts.encore);
    if (a>lastCounts.another) addBalls('another', a-lastCounts.another);
    if (n>lastCounts.nexttime) addBalls('nexttime', n-lastCounts.nexttime);
    lastCounts={encore:e, another:a, nexttime:n};

    const left = Math.max(0,(s.voting.endsAt||0)-Date.now());
    $('timer').textContent = Math.ceil(left/1000);

  } else if (!s.voting?.open && s.lastResult && !showingResult) {
    // voting just ended -> show result banner briefly
    lastOpen=false;
    $('audOver').play().catch(()=>{});
    showingResult=true;
    hide('welcome'); hide('nowVoting'); show('result');
    const mapText = {encore:'Encore!', another:'Another Shot!', nexttime:'Maybe Next Time'};
    const mapCls  = {encore:'encore', another:'another', nexttime:'nexttime'};
    const res = s.lastResult.result;
    const banner = $('resultBanner');
    banner.className = 'banner ' + mapCls[res];
    banner.textContent = mapText[res];

    if (res==='encore') $('audEncore').play().catch(()=>{});
    if (res==='nexttime') $('audLoser').play().catch(()=>{});

    // after ~15s go to board for ~15s, then back to welcome
    setTimeout(()=>{ window.location.href='/board/'; }, 15000);
    setTimeout(()=>{ showingResult=false; }, 30000);

  } else {
    lastOpen=false;
    hide('nowVoting'); hide('result'); show('welcome');
    const next = (s.singers||[]).find(x=>x.status==='queued');
    $('vk').textContent = next ? 'Next up:' : 'Welcome to';
    $('venue').textContent = next ? next.name : (s.venue || '—');
  }
}

async function loop(){
  await fetchState();
  render();
}

// keep screen awake if supported
(async ()=>{
  try{
    if ('wakeLock' in navigator) { await navigator.wakeLock.request('screen'); }
  }catch(e){}
  await loop();
  POLL=setInterval(loop, 2000);
})();
</script>
</body>
</html>
