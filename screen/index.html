<!doctype html>
<meta charset="utf-8"><title>Encore! â€¢ Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#0f1526; --card:#0d1428; --line:#2b3c62; --txt:#eaf2ff; --muted:#b9c6ff; --green:#25d366; --yellow:#f6c945; --red:#ff5e6c; --purple:#2F0658; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:20px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;place-items:center;min-height:100svh;text-align:center;padding:4vmin;position:relative;overflow:hidden}
  .title{font-family:"Bebas Neue"; font-size:9vmin; letter-spacing:.5vmin; margin:0 0 1.2vmin; color:#fff}
  .venue{font-family:"Montserrat"; font-weight:800; font-size:6.2vmin; color:#ffd6ff; margin:0 0 1vmin; text-shadow:0 6px 24px rgba(47,6,88,.45); max-width:95vw; white-space:normal; overflow-wrap:anywhere}
  .kj{font-family:"Montserrat"; font-weight:600; font-size:2.8vmin; color:#c9d6ff; margin:0 0 4.5vmin; opacity:.9; max-width:95vw; overflow-wrap:anywhere}
  .now{font-family:"Montserrat"; font-weight:800; font-size:4.8vmin; margin:0}
  .who{font-family:"Bebas Neue"; font-size:10.5vmin; letter-spacing:.3vmin; margin:.8vmin 0 3vmin; color:#ffffff; max-width:96vw; overflow-wrap:anywhere}
  .song{font-size:3.2vmin;color:var(--muted);margin:0 0 3vmin; max-width:96vw; overflow-wrap:anywhere}
  .row{display:flex;gap:2vmin;justify-content:center;flex-wrap:wrap}
  .chip{padding:1vmin 2vmin;border-radius:12px;border:1px solid var(--line);background:var(--card)}
  .enc{color:var(--green)} .ano{color:var(--yellow)} .may{color:var(--red)}
  .badge{display:inline-block;padding:.6vmin 2vmin;border:1px solid var(--line);border-radius:999px;background:var(--card);font-weight:800}
  .voteNow{margin:2.5vmin 0 1vmin; display:none}
  .voteTag{font-family:"Montserrat"; font-weight:800; font-size:4.2vmin; color:#fff; padding:1vmin 2.5vmin; border-radius:999px; border:2px solid rgba(255,255,255,.15); background:linear-gradient(135deg, rgba(122,162,255,.2), rgba(47,6,88,.5))}
  .prepTag{font-family:"Montserrat"; font-weight:800; font-size:3.7vmin; color:#fff; padding:1vmin 2.5vmin; border-radius:999px; border:2px solid rgba(255,255,255,.15); background:linear-gradient(135deg, rgba(255,214,102,.25), rgba(47,6,88,.45))}
  .timer{font-family:"Bebas Neue"; font-size:12.5vmin; margin:1vmin 0 1.5vmin; letter-spacing:.3vmin}
  .qrBox{position:absolute; right:3vmin; bottom:3vmin; width:20vmin; height:20vmin; border:2px dashed rgba(255,255,255,.25); border-radius:16px; display:grid; place-items:center; color:#cfe0ff; font-size:2vmin}
  .qrBox::after{content:"QR to vote coming soon"; text-align:center; padding:1vmin}
  #confetti{position:absolute; inset:0; pointer-events:none}
  .flashEncore{position:absolute; top:3vmin; left:50%; transform:translateX(-50%); background:#10152b; border:2px solid rgba(37,211,102,.5); color:var(--green); padding:1vmin 3vmin; border-radius:999px; font-weight:800; font-size:3vmin; box-shadow:0 10px 40px rgba(37,211,102,.35); display:none}
  .heartDot{position:absolute; left:2.5vmin; bottom:2.5vmin; width:1.6vmin; height:1.6vmin; border-radius:50%; background:#8edbff; opacity:.7; box-shadow:0 0 16px rgba(142,219,255,.55)}
  /* vote dots area â€” larger */
  .dots{position:relative; width:min(92vmin,92vw); height:28vmin; margin:1vmin auto 2vmin; border-radius:18px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15); overflow:hidden}
  .dot{position:absolute; width:2.4vmin; height:2.4vmin; border-radius:50%}
  .dot.g{background:var(--green)} .dot.y{background:var(--yellow)} .dot.r{background:var(--red)}
</style>

<div class="wrap">
  <canvas id="confetti"></canvas>
  <div id="flash" class="flashEncore">Encore! ðŸŽ‰</div>

  <h1 class="title">Welcome to</h1>
  <div id="venue" class="venue">â€”</div>
  <div id="kj" class="kj">Hosted by â€”</div>

  <div id="nowBlock" style="display:none">
    <div class="now">Now up:</div>
    <div id="who" class="who">â€”</div>
    <div id="song" class="song">â€”</div>
  </div>

  <div id="prep" style="display:none">
    <div class="prepTag">Get ready to vote!</div>
    <div id="preTimer" class="timer">00:05</div>
  </div>

  <div id="voteNow" class="voteNow">
    <div class="voteTag">VOTE NOW</div>
    <div id="timer" class="timer">00:00</div>
    <div id="dots" class="dots" aria-label="live vote dots"></div>
  </div>

  <div class="row" style="margin-top:1.5vmin">
    <div class="chip enc">Encore: <b id="cE">0</b></div>
    <div class="chip ano">Another Shot: <b id="cA">0</b></div>
    <div class="chip may">Maybe Next Time: <b id="cM">0</b></div>
  </div>

  <div style="margin-top:2.5vmin"><span id="status" class="badge">Waitingâ€¦</span></div>

  <div class="qrBox" aria-label="QR to vote placeholder"></div>
  <div id="heart" class="heartDot" title="anti-sleep heartbeat"></div>
</div>

<script>
const GET_URL='/assets/get_state.php';
const $=s=>document.querySelector(s);
function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}` }
function fmtPre(ms){ return '00:'+String(Math.max(0,Math.ceil(ms/1000))).padStart(2,'0'); }

let state=null;
let prevOpen=false;      // to detect open->closed
let lastCounts={encore:0, another:0, maybe:0};

/* Wake Lock */
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });

function heartbeat(){
  [$('#venue'), $('#kj')].forEach(el=>{
    if(!el) return;
    el.animate([{filter:'brightness(1)', textShadow:'0 6px 24px rgba(47,6,88,.45)'},{filter:'brightness(1.15)', textShadow:'0 10px 36px rgba(122,162,255,.55)'},{filter:'brightness(1)', textShadow:'0 6px 24px rgba(47,6,88,.45)'}],{duration:1200,easing:'ease-in-out'});
  });
  const dot=$('#heart'); if(dot){ dot.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:700,easing:'ease-in-out'}); }
}
setInterval(heartbeat, 30000); setTimeout(heartbeat, 3000);

/* Confetti */
const confetti=(function(){
  const cv=document.getElementById('confetti'), cx=cv.getContext('2d');
  let W=0,H=0, parts=[], running=false;
  function resize(){ W=cv.width=window.innerWidth; H=cv.height=window.innerHeight; }
  function rand(a,b){ return a+Math.random()*(b-a); }
  function burst(n=180){
    for(let i=0;i<n;i++){
      parts.push({x: W/2, y: H*0.2, r: rand(2,4), vx: rand(-6,6), vy: rand(-2,8), g: 0.18, life: rand(60,140), color: `hsl(${Math.floor(rand(0,360))} 90% 60%)`});
    }
    if(!running){ running=true; loop(); }
  }
  function loop(){
    if(!running) return;
    cx.clearRect(0,0,W,H);
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i]; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life--;
      cx.fillStyle=p.color; cx.beginPath(); cx.arc(p.x,p.y,p.r,0,Math.PI*2); cx.fill();
      if(p.life<=0 || p.y>H+20) parts.splice(i,1);
    }
    if(parts.length===0){ running=false; return; }
    requestAnimationFrame(loop);
  }
  window.addEventListener('resize', resize); resize();
  return { burst };
})();

/* Physics dots */
const physics = (function(){
  const dotsWrap = ()=>document.getElementById('dots');
  const actors = new Set(); // active animations
  function add(kind, n){
    const wrap=dotsWrap(); const W=wrap.clientWidth, H=wrap.clientHeight;
    for(let i=0;i<n;i++){
      const d=document.createElement('div'); d.className='dot '+(kind==='encore'?'g':kind==='another'?'y':'r');
      wrap.appendChild(d);
      // initial position near top center with jitter
      let x=W*0.5 + (Math.random()*2-1)*W*0.1;
      let y=H*0.15 + Math.random()*H*0.05;
      // velocity & physics
      let vx=(Math.random()*2-1)*0.45*W/100; // px per frame-ish
      let vy=(Math.random()*-0.8)*H/120;
      const g = H/900;     // gravity
      const fr = 0.995;    // friction
      const bounce=0.65;   // bounce loss
      const stopV=H/1500;  // velocity threshold to settle
      const maxT = 2200;   // ms
      const born = performance.now();

      function step(t){
        const dt=16; // approx
        vy += g*dt;
        x += vx*dt; y += vy*dt;

        // walls
        if(x<12){x=12; vx*=-bounce;}
        if(x>W-12){x=W-12; vx*=-bounce;}
        if(y>H-12){
          y=H-12; vy*=-bounce; vx*=fr;
          // small random kick to keep them lively
          if(Math.abs(vy)<stopV) vy=0;
          if(Math.abs(vx)<stopV) vx=0;
        }
        d.style.transform=`translate(${x}px,${y}px)`;

        const alive = (performance.now()-born) < maxT && (Math.abs(vx)+Math.abs(vy))>stopV*0.2;
        if(alive){ actors.add(handle); requestAnimationFrame(step); }
        else { actors.delete(handle); }
      }
      d.style.transform=`translate(${x}px,${y}px)`;
      function handle(ts){ step(ts); }
      requestAnimationFrame(step);
    }
    // trim DOM children
    while(wrap.childNodes.length>260){ wrap.removeChild(wrap.firstChild); }
  }
  function clear(){ const wrap=dotsWrap(); wrap.innerHTML=''; actors.clear(); }
  return { add, clear };
})();

/* Main loop */
async function tick(){
  const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json();

  const publicVenue = state.event?.venuePublic || state.event?.venue || 'â€”';
  const kjName      = state.event?.kj || '';
  const hasCurrent  = !!state.current?.id;
  const singerName  = state.current?.name || 'â€”';
  const songText    = state.current?.songArtist || '';

  $('#venue').textContent = publicVenue;
  $('#kj').textContent    = kjName ? `Hosted by ${kjName}` : 'Hosted by â€”';

  // "Now up" only when a current singer is set
  $('#nowBlock').style.display = hasCurrent ? 'block' : 'none';
  if(hasCurrent){ $('#who').textContent=singerName; $('#song').textContent=songText; }

  const now = Date.now();
  const open = !!state.voting?.open;
  const prep = (!open && (state.voting?.prepUntil||0) > now);
  const result = state.voting?.lastResult || null;

  // Phases
  $('#prep').style.display    = prep ? 'block' : 'none';
  $('#voteNow').style.display = (!prep && open) ? 'block' : 'none';

  // Counts
  const ce = state.voting?.counts?.encore  ?? 0;
  const ca = state.voting?.counts?.another ?? 0;
  const cm = state.voting?.counts?.maybe   ?? 0;

  if(open){
    if(ce>lastCounts.encore)  physics.add('encore',  ce-lastCounts.encore);
    if(ca>lastCounts.another) physics.add('another', ca-lastCounts.another);
    if(cm>lastCounts.maybe)   physics.add('maybe',   cm-lastCounts.maybe);
  } else {
    physics.clear();
    lastCounts = {encore:0, another:0, maybe:0};
  }
  lastCounts = {encore:ce, another:ca, maybe:cm};

  $('#cE').textContent = ce; $('#cA').textContent = ca; $('#cM').textContent = cm;

  if(prep){
    const ms = state.voting.prepUntil - now;
    $('#preTimer').textContent = fmtPre(ms);
    $('#status').textContent = 'Get readyâ€¦';
  } else if(open){
    const ms=Math.max(0,(state.voting.endsAt||0)-now);
    $('#timer').textContent=fmt(ms);
    $('#status').textContent = 'Voting OPEN';
  } else {
    $('#timer').textContent='00:00';
    $('#status').textContent = result ? (result==='encore'?'Winner: Encore!': result==='another'?'Winner: Another Shot!':'Winner: Maybe Next Time') : 'Waitingâ€¦';
  }

  // Confetti only when voting just closed with Encore
  if(prevOpen && !open && result==='encore'){
    confetti.burst(200);
    const el=$('#flash'); el.style.display='inline-block'; el.style.opacity='1';
    el.animate([{transform:'translateX(-50%) scale(0.9)', opacity:.0},{transform:'translateX(-50%) scale(1)',opacity:1}],{duration:200,easing:'ease-out'});
    setTimeout(()=>{ el.animate([{opacity:1},{opacity:0}],{duration:800,easing:'ease-in'}).onfinish=()=>{ el.style.display='none'; }; }, 1300);
  }
  prevOpen = open;
}

setInterval(tick, 800);
tick();

/* Wake + heartbeat */
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });
function heartbeat(){
  [$('#venue'), $('#kj')].forEach(el=>{
    if(!el) return;
    el.animate([{filter:'brightness(1)', textShadow:'0 6px 24px rgba(47,6,88,.45)'},{filter:'brightness(1.15)', textShadow:'0 10px 36px rgba(122,162,255,.55)'},{filter:'brightness(1)', textShadow:'0 6px 24px rgba(47,6,88,.45)'}],{duration:1200,easing:'ease-in-out'});
  });
  const dot=$('#heart'); if(dot){ dot.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:700,easing:'ease-in-out'}); }
}
setInterval(heartbeat, 30000); setTimeout(heartbeat, 3000);
requestWakeLock();
</script>
