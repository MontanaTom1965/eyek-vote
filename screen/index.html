<script>
const EVENT_KEY = 'eyek:event';
const NOW_KEY   = 'eyek:now';
const CH        = new BroadcastChannel('eyek');

const $ = (s) => document.querySelector(s);
function read(key, def={}) {
  try { return JSON.parse(localStorage.getItem(key)) || def; }
  catch { return def; }
}

function renderAll() {
  const evt = read(EVENT_KEY, {});
  const now = read(NOW_KEY, {});

  // Top banner: Venue / KJ / PIN (PIN optional if you donâ€™t want to show it)
  $('#venueName').textContent = evt.venue || '';
  $('#kjName').textContent    = evt.kj || '';
  $('#pinCode').textContent   = evt.pin || '';

  // Center stage: Now Playing
  $('#nowSinger').textContent = now.singer || '';
  $('#nowSong').textContent   = now.song || '';
  $('#nowArtist').textContent = now.artist || '';
}

// BroadcastChannel: live updates
CH.onmessage = (ev) => {
  const { type } = ev.data || {};
  if (type === 'event:update' || type === 'now:update') renderAll();
};

// Storage events (other browser windows)
window.addEventListener('storage', (e) => {
  if (e.key === EVENT_KEY || e.key === NOW_KEY) renderAll();
});

// Tiny heartbeat (prevents some smart TVs from sleeping)
setInterval(() => {
  const t = new Date();
  $('#ticker').textContent = t.toLocaleTimeString();
}, 20 * 1000);

// Optionally, light confetti / sfx triggers could listen for a flag set by Host.
// Example (leave hooks here):
CH.addEventListener('message', (ev) => {
  const { type, payload } = ev.data || {};
  if (type === 'celebrate' && payload === 'encore') {
    try { window.playEncore && window.playEncore(); } catch {}
  }
  if (type === 'celebrate' && payload === 'another') {
    try { window.playAnother && window.playAnother(); } catch {}
  }
  if (type === 'celebrate' && payload === 'next') {
    try { window.playMaybe && window.playMaybe(); } catch {}
  }
});

document.addEventListener('DOMContentLoaded', renderAll);
</script>
