<!-- EYEK /screen/index.html v2025-09-06.19 (MP3 loop) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke â€” Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#2F0658; --card:#401073; --border:#7E3CC0; --text:#ffffff; --muted:#E3D6F4; --accent:#D9B6FF;
      --encore:#22c55e; --another:#f59e0b; --maybe:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
        radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size: clamp(18px, 2.2vw, 26px);
    }
    .wrap{max-width:1800px; margin:0 auto; padding:24px 24px 96px}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; padding-bottom:12px; border-bottom:2px solid var(--border)}
    h1{margin:0; font-size:clamp(2.2rem, 4.5vw, 4rem)}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.2em .75em; color:#f5eaff; font-weight:900; background:rgba(127,60,192,.18)}

    .grid{display:grid; gap:22px; grid-template-columns:1fr}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) , var(--card); border:2px solid var(--border); border-radius:18px; padding:20px; box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)}

    .now{ display:grid; gap:28px; align-items:center; grid-template-columns: 1fr auto 260px; }
    @media (max-width: 900px){ .now{ grid-template-columns: 1fr; justify-items:center; text-align:center } }
    .leftNow .hint{color:var(--muted)}
    .leftNow h2{margin:.1em 0; font-size:clamp(1.8rem, 3.6vw, 3rem)}
    .centerNow{display:flex; flex-direction:column; align-items:center; gap:10px}

    .statusBadge{
      font-weight:1000; padding:.55em 1.1em; border-radius:14px; text-align:center; min-width: 260px;
      border:2px solid transparent; box-shadow:0 8px 22px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.08);
    }
    .statusOpen{ background:#22c55e; border-color:#16a34a; color:#ffffff }
    .statusPending{ background:rgba(127,60,192,.22); border-color:#9c84c9; color:#f3eaff }
    .statusClosed{ background:#ef4444; border-color:#dc2626; color:#ffffff }

    .countdown{
      margin-top:6px;
      font-weight:1000;
      font-size:clamp(2.8rem, 8.5vw, 6.2rem);
      line-height:1; letter-spacing:.03em; padding:.05em .35em; border-radius:12px; color:#ffffff;
      text-shadow:0 4px 18px rgba(0,0,0,.55), 0 0 2px rgba(0,0,0,.35);
    }
    @keyframes urgentPulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
    .countdownFinal{ color:#fff; background:linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.04)); border:2px solid #dc2626; animation: urgentPulse .8s ease-in-out infinite }

    .qr{width:260px; height:260px; object-fit:contain; border-radius:14px; border:2px solid var(--border); background:rgba(0,0,0,.15)}

    .bars{display:grid; gap:16px; margin-top:10px}
    .row{display:flex; gap:14px; align-items:center}
    .label{min-width:260px; font-weight:900; font-size:clamp(1.4rem, 2.8vw, 2rem)}
    .barWrap{flex:1; height:60px; border:2px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(0,0,0,.18)}
    .bar{height:100%; width:0%; transition:width .35s ease}
    .bar.enc{background:#22c55e}
    .bar.ano{background:#f59e0b}
    .bar.may{background:#ef4444}
    .val{min-width:140px; text-align:right; font-weight:900; font-size:1.2rem}

    @keyframes flashPulse { 0%{filter:brightness(1)} 40%{filter:brightness(1.8)} 100%{filter:brightness(1)} }
    .flash{ animation: flashPulse .45s ease }

    .totals{margin-top:10px; color:var(--muted); font-weight:800}
    .winner{
      display:inline-block; margin-top:12px; padding:.45em 1em; border-radius:12px; border:2px solid var(--border);
      font-weight:1000; background:rgba(255,255,255,.05); text-align:center; min-width: 280px;
    }
    .win-neutral{border-color:#7E3CC0; background:rgba(127,60,192,.14)}
    .win-enc{border-color:#3aa66a; background:#0f2b1c}
    .win-ano{border-color:#9c6a14; background:#2b1f08}
    .win-may{border-color:#a83b3b; background:#2b0f10}

    .flashBanner{
      position:fixed; left:0; right:0; bottom:0; display:none; text-align:center;
      padding:27px 24px; font-weight:1000; letter-spacing:.3px; font-size:clamp(2.4rem, 4.5vw, 3.6rem);
      border-top:6px solid; z-index:50
    }
    @keyframes encPulse { 0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)} }
    @keyframes anoPulse { 0%{filter:brightness(1)} 50%{filter:brightness(1.25)} 100%{filter:brightness(1)} }
    @keyframes mayPulse { 0%{filter:brightness(1)} 50%{filter:brightness(1.15)} 100%{filter:brightness(1)} }
    .banner-enc{background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.05)); border-color:#22c55e; color:#eafff3; animation: encPulse .55s ease-in-out infinite}
    .banner-ano{background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.04)); border-color:#f59e0b; color:#fff6e0; animation: anoPulse 1.1s ease-in-out infinite}
    .banner-may{background:linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.06)); border-color:#ef4444; color:#ffe8e8; animation: mayPulse 1.35s ease-in-out infinite}

    .soundBtn{
      position:fixed; right:16px; bottom:16px; z-index:60;
      border:2px solid var(--border); background:rgba(0,0,0,.25); color:#fff; border-radius:999px;
      padding:.45em .65em; font-size:1.1rem; cursor:pointer; user-select:none;
      box-shadow:0 6px 20px rgba(0,0,0,.25)
    }
    .soundBtn:hover{ background:rgba(0,0,0,.35) }
    .soundHint{
      position:fixed; right:64px; bottom:18px; z-index:60;
      padding:.5em .8em; border-radius:10px; border:2px solid var(--border);
      background:rgba(0,0,0,.35); color:#fff; font-weight:900
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Encore Karaoke <span class="pill" id="eventPill">â€”</span></h1>
    </header>

    <main class="grid" style="margin-top:18px">
      <section class="card">
        <div class="now">
          <div class="leftNow">
            <div class="hint">Now singing</div>
            <h2 id="nowSinger">â€”</h2>
          </div>

          <div class="centerNow">
            <div id="statusBadge" class="statusBadge">Getting readyâ€¦</div>
            <div class="countdown" id="countdown">â€”</div>
          </div>

          <img id="qrImg" class="qr" alt="Scan to vote" />
        </div>
      </section>

      <section class="card">
        <div class="bars">
          <div class="row">
            <div class="label">Encore!</div>
            <div class="barWrap" id="wrapEnc"><div class="bar enc" id="barEnc"></div></div>
            <div class="val" id="valEnc">0</div>
          </div>
          <div class="row">
            <div class="label">Another Shot!</div>
            <div class="barWrap" id="wrapAno"><div class="bar ano" id="barAno"></div></div>
            <div class="val" id="valAno">0</div>
          </div>
          <div class="row">
            <div class="label">Maybe Next Time!</div>
            <div class="barWrap" id="wrapMay"><div class="bar may" id="barMay"></div></div>
            <div class="val" id="valMay">0</div>
          </div>
        </div>

        <div class="totals" id="totals">Total votes: 0</div>
        <div id="winnerBadge" class="winner win-neutral">Loadingâ€¦</div>
      </section>
    </main>
  </div>

  <div id="flashBanner" class="flashBanner">â€”</div>

  <button id="soundBtn" class="soundBtn" title="Toggle sound">ðŸ”‡</button>
  <div id="soundHint" class="soundHint" style="display:none">Click ðŸ”Š to enable sound</div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote"
      };
      if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
      firebase.initializeApp(FIREBASE_CONFIG);
      var db=firebase.firestore();

      function $(id){ return document.getElementById(id); }
      function urlRoot(){ return location.origin + '/'; }

      var eventPill=$('eventPill'), nowSinger=$('nowSinger'), statusBadge=$('statusBadge'),
          countdownEl=$('countdown'),
          barEnc=$('barEnc'), barAno=$('barAno'), barMay=$('barMay'),
          wrapEnc=$('wrapEnc'), wrapAno=$('wrapAno'), wrapMay=$('wrapMay'),
          valEnc=$('valEnc'), valAno=$('valAno'), valMay=$('valMay'),
          totalsEl=$('totals'), winnerBadge=$('winnerBadge'), qrImg=$('qrImg'),
          flashBanner=$('flashBanner'), soundBtn=$('soundBtn'), soundHint=$('soundHint');

      var unsubState=null, unsubPerf=null, unsubVotes=null;
      var CURRENT={ eventId:null, performanceId:null, status:'', closeAt:null, singerName:'â€”' };
      var COUNTS={ encore:0, another:0, maybe:0 };
      var PREV={ encore:0, another:0, maybe:0 };
      var countdownTimer=null;
      var prevLeader=null;
      var lastFanfarePerfId=null;

      function computeCloseAtFrom(docData){
        if(docData && docData.openAt && docData.durationSec){
          var ms = docData.openAt.toMillis() + (docData.durationSec|0)*1000;
          return firebase.firestore.Timestamp.fromDate(new Date(ms));
        }
        return (docData && docData.closeAt) ? docData.closeAt : null;
      }

      /* -------- Sound system -------- */
      // Toggle state (persisted)
      var SOUND_KEY='eyek_sound';
      var soundEnabled = (localStorage.getItem(SOUND_KEY)==='1');
      function updateSoundBtn(){ soundBtn.textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'; }
      function showSoundHint(show){ soundHint.style.display = show ? 'block' : 'none'; }
      updateSoundBtn(); showSoundHint(!soundEnabled);

      // SFX (ticks/fanfares) via WebAudio oscillators + tiny HTML beep fallback
      var audioCtx=null, sfxGain=null;
      const FALLBACK_BEEP = 'data:audio/wav;base64,UklGRuwNAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YcgNAAAAADsWEys4PYpLIlVmWRNYPlFTRRM1gSHWC271r9/2FhJJQ4d7rF1UjYJm9hJ3x0yJH4d/0QY1y8r8BXeCBR6j8eYqk0J3cQvKcM8rQ0NtyPcY3tF7m9duT+38s0Gz8w2u2K5C3I9kWZQ/3rZ5m0C';
      function htmlBeep(delayMs=0, rate=1){
        try{ setTimeout(function(){ var a=new Audio(FALLBACK_BEEP); a.playbackRate=rate; a.play().catch(()=>{}); }, delayMs|0); }catch(_){}
      }
      async function ensureAudio(){
        try{
          if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
          if(!sfxGain){ sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.9; sfxGain.connect(audioCtx.destination); }
          if(audioCtx.state==='suspended'){ await audioCtx.resume(); }
          return true;
        }catch(_){ return false; }
      }
      function sfxBeep(freq, duration, volume){
        if(!soundEnabled || !audioCtx || !sfxGain) return;
        var now = audioCtx.currentTime;
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.type='square';
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(volume, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
        osc.connect(gain).connect(sfxGain);
        osc.start(now); osc.stop(now + duration + 0.05);
      }
      function playTick(){ ensureAudio().then(function(){ sfxBeep(900, 0.12, 0.25); htmlBeep(0, 1.0); }); }
      function playFanfare(kind){
        ensureAudio().then(function(){
          function tone(f,t,vol){ sfxBeep(f, t, vol); }
          if(kind==='encore'){
            setTimeout(()=>tone(523,0.14,0.30), 0);
            setTimeout(()=>tone(659,0.14,0.30), 180);
            setTimeout(()=>tone(784,0.20,0.32), 360);
            htmlBeep(0,1.0); htmlBeep(180,1.2); htmlBeep(360,1.5);
          }else if(kind==='another'){
            setTimeout(()=>tone(440,0.14,0.26), 0);
            setTimeout(()=>tone(392,0.16,0.26), 200);
            htmlBeep(0,1.0); htmlBeep(200,0.9);
          }else if(kind==='maybe'){
            setTimeout(()=>tone(220,0.30,0.30), 0);
            htmlBeep(0,0.8);
          }else{
            setTimeout(()=>tone(600,0.14,0.28), 0);
            htmlBeep(0,1.0);
          }
        });
      }

      // Ambient loop via your MP3 (replaces synthesized loop)
      var loopAudio=null, loopFadeTimer=null;
      var LOOP_URL = location.origin + '/screen/quiz-countdown.mp3'; // your uploaded file
      function ensureLoop(){
        if(!loopAudio){
          loopAudio = new Audio(LOOP_URL);
          loopAudio.loop = true;
          loopAudio.preload = 'auto';
          loopAudio.volume = 0.0;
        }
        return loopAudio;
      }
      function fadeLoop(to, ms){
        if(!loopAudio) return;
        try{ clearInterval(loopFadeTimer); }catch(_){}
        var start = loopAudio.volume;
        var steps = Math.max(1, Math.floor((ms||0)/50));
        var i=0;
        loopFadeTimer = setInterval(function(){
          i++;
          var v = start + (to - start) * (i/steps);
          loopAudio.volume = Math.min(1, Math.max(0, v));
          if(i>=steps){
            clearInterval(loopFadeTimer);
            if(to<=0){
              try{ loopAudio.pause(); }catch(_){}
            }
          }
        }, 50);
      }
      function startVoteLoop(){
        if(!soundEnabled) return;
        var a = ensureLoop();
        try{
          a.currentTime = 0;
          a.play().then(function(){
            fadeLoop(0.55, 200); // fade in to ~55%
          }).catch(function(){
            // Autoplay might be blocked until user clicks ðŸ”Š
            showSoundHint(true);
          });
        }catch(_){}
      }
      function stopVoteLoop(){
        if(!loopAudio) return;
        fadeLoop(0.0, 150); // quick fade out then pause
      }

      // UI hooks for sound
      soundBtn.addEventListener('click', async function(){
        soundEnabled = !soundEnabled;
        localStorage.setItem(SOUND_KEY, soundEnabled ? '1':'0');
        updateSoundBtn(); showSoundHint(!soundEnabled);
        if(soundEnabled){
          await ensureAudio();
          // a little confirmation chirp
          sfxBeep(880,0.14,0.28); htmlBeep(0,1.0);
          setTimeout(()=>{ sfxBeep(988,0.16,0.30); htmlBeep(0,1.1); },200);
          if(CURRENT.status==='open'){ startVoteLoop(); }
        }else{
          stopVoteLoop();
        }
      });
      window.addEventListener('pointerdown', function(){ if(soundEnabled) ensureAudio(); }, { once:true });
      window.addEventListener('keydown',     function(){ if(soundEnabled) ensureAudio(); }, { once:true });

      /* ---------------------------------- */

      function setBadge(status){
        statusBadge.className='statusBadge';
        if(status==='open'){ statusBadge.classList.add('statusOpen'); statusBadge.textContent='Voting OPEN'; }
        else if(status==='closed'){ statusBadge.classList.add('statusClosed'); statusBadge.textContent='Voting CLOSED'; }
        else { statusBadge.classList.add('statusPending'); statusBadge.textContent='Getting readyâ€¦'; }
      }
      function fmt(n){ return (n|0).toString(); }
      function pct(part,total){ if(total<=0) return 0; return Math.round(part*100/total); }

      function labelFromKind(kind){
        if(kind==='encore') return 'Encore!';
        if(kind==='another') return 'Another Shot!';
        if(kind==='maybe')  return 'Maybe Next Time!';
        return 'â€”';
      }
      function decideOutcomeStrict(e,a,m){
        e|=0;a|=0;m|=0;
        if(e>a && e>m) return 'encore';
        if(a>e && a>m) return 'another';
        if(m>e && m>a) return 'maybe';
        if(a===m && a>e) return 'another';
        if(e===a && e>m) return 'encore';
        if(e===m && e>a) return 'another';
        if(e===a && a===m && e>0) return 'another';
        return null;
      }

      function renderBars(){
        var t = COUNTS.encore + COUNTS.another + COUNTS.maybe;
        var pE=pct(COUNTS.encore,t), pA=pct(COUNTS.another,t), pM=pct(COUNTS.maybe,t);
        barEnc.style.width = pE+'%';
        barAno.style.width = pA+'%';
        barMay.style.width = pM+'%';
        valEnc.textContent = fmt(COUNTS.encore) + (t?(' Â· '+pE+'%'):'');
        valAno.textContent = fmt(COUNTS.another)+ (t?(' Â· '+pA+'%'):'');
        valMay.textContent = fmt(COUNTS.maybe)  + (t?(' Â· '+pM+'%'):'');
        totalsEl.textContent = 'Total votes: ' + fmt(t);

        if(CURRENT.status==='open'){
          updateLeaderBadge(t); hideFlashBanner();
        }else if(CURRENT.status==='closed'){
          var final = decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
          showWinnerBadge(final, false, t); showFlashBanner(final);
        }else{
          showWinnerBadge(null, true, t); hideFlashBanner();
        }
      }

      function flashIfIncreased(){
        var inc=false;
        if (COUNTS.encore > PREV.encore){ inc=true; wrapEnc.classList.add('flash'); setTimeout(()=>wrapEnc.classList.remove('flash'), 450); }
        if (COUNTS.another> PREV.another){ inc=true; wrapAno.classList.add('flash'); setTimeout(()=>wrapAno.classList.remove('flash'), 450); }
        if (COUNTS.maybe > PREV.maybe){   inc=true; wrapMay.classList.add('flash'); setTimeout(()=>wrapMay.classList.remove('flash'), 450); }
        PREV.encore = COUNTS.encore; PREV.another = COUNTS.another; PREV.maybe = COUNTS.maybe;
        return inc;
      }

      function showWinnerBadge(kind, live, total){
        winnerBadge.className='winner';
        if(!kind){
          winnerBadge.classList.add('win-neutral');
          winnerBadge.textContent = live ? 'Loadingâ€¦' : 'â€”';
          return;
        }
        if(kind==='encore') winnerBadge.classList.add('win-enc');
        if(kind==='another') winnerBadge.classList.add('win-ano');
        if(kind==='maybe')  winnerBadge.classList.add('win-may');
        winnerBadge.textContent = (live ? 'Leading: ' : 'Winner: ') + labelFromKind(kind);
      }

      function pulseWinner(){
        winnerBadge.classList.remove('flash');
        void winnerBadge.offsetWidth;
        winnerBadge.classList.add('flash');
      }

      function updateLeaderBadge(total){
        if(total<=0){
          prevLeader=null;
          showWinnerBadge(null, true, total);
          return;
        }
        var lead = decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
        showWinnerBadge(lead, true, total);
        if(lead !== prevLeader){ pulseWinner(); prevLeader = lead; } else { pulseWinner(); }
      }

      function hideFlashBanner(){ flashBanner.style.display='none'; flashBanner.className='flashBanner'; }
      function showFlashBanner(kind){
        if(!kind){ hideFlashBanner(); return; }
        flashBanner.className='flashBanner';
        if(kind==='encore'){ flashBanner.classList.add('banner-enc'); }
        else if(kind==='another'){ flashBanner.classList.add('banner-ano'); }
        else if(kind==='maybe'){  flashBanner.classList.add('banner-may'); }
        flashBanner.textContent = labelFromKind(kind);
        flashBanner.style.display='block';
      }

      function renderCountdown(){
        countdownEl.classList.remove('countdownFinal');
        if(!CURRENT.closeAt || CURRENT.status!=='open'){ countdownEl.textContent='â€”'; return; }
        var ms = CURRENT.closeAt.toMillis() - Date.now();
        var s = Math.max(0, Math.ceil(ms/1000));
        countdownEl.textContent = s + 's';
        if(s>0 && s<=10){ countdownEl.classList.add('countdownFinal'); }
      }
      function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer=setInterval(renderCountdown,250); }
      function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); } countdownTimer=null; countdownEl.textContent='â€”'; countdownEl.classList.remove('countdownFinal'); }

      function qrProvider1(d){ return 'https://api.qrserver.com/v1/create-qr-code/?size=260x260&data='+encodeURIComponent(d); }
      function qrProvider2(d){ return 'https://chart.googleapis.com/chart?cht=qr&chs=260x260&chl='+encodeURIComponent(d); }
      function setQrForUrl(url){
        if (!qrImg) return;
        if (!url){ qrImg.removeAttribute('src'); qrImg.alt='QR will appear when a performance is announced'; return; }
        var tried=false;
        qrImg.onerror=function(){ if(!tried){ tried=true; qrImg.src=qrProvider2(url); } else { qrImg.alt='QR unavailable'; } };
        qrImg.src=qrProvider1(url);
        qrImg.alt='Scan to vote';
      }
      function updateQr(){
        if (!CURRENT.performanceId || !CURRENT.eventId){ setQrForUrl(null); return; }
        var url = urlRoot()+'vote/index.html?eventId=' + encodeURIComponent(CURRENT.eventId)
                                + '&performanceId=' + encodeURIComponent(CURRENT.performanceId);
        setQrForUrl(url);
      }

      function followEvent(){
        var u=new URL(location.href), eid=u.searchParams.get('eventId');
        if(eid){ eventPill.textContent=eid; startForEvent(eid); }
        else{
          db.collection('meta').doc('active').onSnapshot(function(snap){
            var d=snap.data()||{}; var ev=d.eventId||'default';
            eventPill.textContent=ev;
            startForEvent(ev);
          });
        }
      }

      function startForEvent(eid){
        if(CURRENT.eventId===eid) return;
        CURRENT.eventId=eid;
        if(unsubState){ unsubState(); unsubState=null; }
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(unsubVotes){ unsubVotes(); unsubVotes=null; }
        nowSinger.textContent='â€”';
        setBadge('pending');
        COUNTS.encore=COUNTS.another=COUNTS.maybe=0; PREV.encore=PREV.another=PREV.maybe=0; prevLeader=null;
        renderBars();
        setQrForUrl(null);
        hideFlashBanner();
        stopVoteLoop();

        unsubState = db.collection('events').doc(eid).collection('state').doc('current')
          .onSnapshot(function(s){
            var d = s.data()||{};
            var perfId = d.performanceId || null;
            var singer = d.currentSingerName || 'â€”';
            nowSinger.textContent = singer;
            watchPerformance(perfId);
          });
      }

      function watchPerformance(perfId){
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(unsubVotes){ unsubVotes(); unsubVotes=null; }
        CURRENT.performanceId = perfId;
        COUNTS.encore=COUNTS.another=COUNTS.maybe=0; PREV.encore=PREV.another=PREV.maybe=0; prevLeader=null;
        renderBars();
        if(!perfId){
          setBadge('pending'); stopCountdown(); setQrForUrl(null); hideFlashBanner(); stopVoteLoop(); return;
        }
        updateQr();

        unsubPerf = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(perfId)
          .onSnapshot(function(snap){
            if(!snap.exists){
              setBadge('pending'); stopCountdown(); hideFlashBanner(); stopVoteLoop(); return;
            }
            var d = snap.data()||{};
            CURRENT.status = d.status || 'pending';
            CURRENT.closeAt = computeCloseAtFrom(d);

            if(CURRENT.status==='open'){
              setBadge('open');
              if(CURRENT.closeAt) startCountdown(); else stopCountdown();
              if(!unsubVotes) watchVotes(perfId);
              updateQr();
              hideFlashBanner();
              startVoteLoop();                // play your MP3 loop
            }else if(CURRENT.status==='closed'){
              setBadge('closed');
              stopCountdown();
              updateQr();
              renderBars();
              stopVoteLoop();                 // stop your MP3 loop
              var final = (d.outcome) || decideOutcomeStrict(COUNTS.encore, COUNTS.another, COUNTS.maybe);
              if(perfId !== lastFanfarePerfId){ playFanfare(final); lastFanfarePerfId = perfId; }
            }else{
              setBadge('pending');
              stopCountdown();
              updateQr();
              hideFlashBanner();
              stopVoteLoop();                 // stop your MP3 loop
            }
          });
      }

      function watchVotes(perfId){
        unsubVotes = db.collection('events').doc(CURRENT.eventId).collection('votes')
          .where('performanceId','==', perfId)
          .onSnapshot(function(snap){
            COUNTS.encore=COUNTS.another=COUNTS.maybe=0;
            snap.forEach(function(d){
              var x=d.data()||{};
              var c=String(x.category||'').toLowerCase();
              if(c==='encore') COUNTS.encore++;
              else if(c==='another') COUNTS.another++;
              else if(c==='maybe')  COUNTS.maybe++;
            });
            var increased = flashIfIncreased();
            renderBars();
            if(CURRENT.status==='open' && increased && soundEnabled){ playTick(); }
          });
      }

      followEvent();
    })();
  </script>
</body>
</html>
