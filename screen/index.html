<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EYEK • Screen</title>
<style>
  :root{--bg:#030915;--ink:#e9f2ff;--sub:#a5b8df;--green:#33e27b;--yellow:#ffd166;--red:#ff6b6b;}
  html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 50% 10%,#0f2046 0%,#030915 60%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
  .wrap{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
  h1{font-size:64px;margin:0 0 10px;letter-spacing:.5px}
  h2{font-size:28px;margin:6px 0;color:var(--sub)}
  .ticker{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-size:14px;color:#7ea2ff;opacity:.7;animation:pulse 3s infinite}
  @keyframes pulse{0%{opacity:.5}50%{opacity:.9}100%{opacity:.5}}
  .countdown{font-size:92px;font-weight:800;letter-spacing:1px}
  .stacks{display:flex;gap:60px;margin-top:24px}
  .stack{display:flex;flex-direction:column;align-items:center;gap:12px}
  .balls{display:flex;align-items:flex-end;gap:6px;min-height:220px}
  .ball{width:22px;height:22px;border-radius:50%;animation:bounce 1.2s infinite}
  .ball.green{background:var(--green)}
  .ball.yellow{background:var(--yellow)}
  .ball.red{background:var(--red)}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
  .score{font-size:28px;color:#cfe0ff}
  .result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px)}
  .result.show{display:flex}
  .banner{padding:28px 48px;border-radius:18px;font-size:72px;font-weight:900;box-shadow:0 12px 40px rgba(0,0,0,.45)}
  .banner.encore{background:linear-gradient(90deg,#1eea66,#39ffa0);color:#022b14}
  .banner.another{background:linear-gradient(90deg,#ffe08a,#ffd166);color:#3b2b00}
  .banner.maybe{background:linear-gradient(90deg,#ffa3a3,#ff6b6b);color:#3b0000}
  canvas#confetti{position:absolute;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
  <div id="main">
    <h1 id="headline">Welcome</h1>
    <h2 id="subline">Waiting for host…</h2>
    <div id="voteBlock" style="display:none; align-items:center; flex-direction:column;">
      <div class="countdown" id="countdown">30</div>
      <div class="stacks">
        <div class="stack">
          <div class="score" id="scoreEncore">0</div>
          <div class="balls" id="ballsEncore"></div>
          <div>Encore!</div>
        </div>
        <div class="stack">
          <div class="score" id="scoreAnother">0</div>
          <div class="balls" id="ballsAnother"></div>
          <div>Another Shot!</div>
        </div>
        <div class="stack">
          <div class="score" id="scoreMaybe">0</div>
          <div class="balls" id="ballsMaybe"></div>
          <div>Maybe Next Time</div>
        </div>
      </div>
    </div>
  </div>
  <div class="ticker">Earn Your Encore Karaoke • vote.earnyourencorekaraoke.com</div>
  <div class="result" id="result">
    <div class="banner" id="resultBanner">Encore!</div>
  </div>
</div>

<audio id="sndOpen"   src="/assets/quiz-countdown.mp3" preload="auto"></audio>
<audio id="sndOver"   src="/assets/end of voting.wav" preload="auto"></audio>
<audio id="sndEncore" src="/assets/you_win_001.mp3" preload="auto"></audio>
<audio id="sndMaybe"  src="/assets/loser.wav" preload="auto"></audio>
<!-- (Add a sound for Another Shot later if you want) -->

<script>
const API='/assets/state.php';
let STATE=null, poll=null, tick=null, lastIsOpen=false, lastResultShownAt=0;

const $=s=>document.querySelector(s);
function apiGet(){
  const u=new URL(API,location.origin);u.searchParams.set('action','get');
  return fetch(u,{cache:'no-store'}).then(r=>r.json());
}
function ms(){return Date.now();}

// Confetti (simple)
const cf = document.getElementById('confetti'); const ctx = cf.getContext('2d');
let confetti = [];
function resize(){cf.width=innerWidth; cf.height=innerHeight}
addEventListener('resize', resize); resize();
function burst(color){
  for(let i=0;i<150;i++){
    confetti.push({x:cf.width/2,y:cf.height/2,dx:(Math.random()-0.5)*6,dy:(Math.random()-1.2)*6,sz:2+Math.random()*4,life:80+Math.random()*60,color});
  }
}
function confettiLoop(){
  ctx.clearRect(0,0,cf.width,cf.height);
  for (const c of confetti){
    c.x+=c.dx; c.y+=c.dy; c.dy+=0.08; c.life--;
    ctx.fillStyle=c.color; ctx.fillRect(c.x,c.y,c.sz,c.sz);
  }
  confetti = confetti.filter(c=>c.life>0 && c.y<cf.height+20);
  requestAnimationFrame(confettiLoop);
}
confettiLoop();

function render(){
  if(!STATE) return;
  const cur=STATE.current||{name:'',song:''};
  const ev=STATE.event||{venue:'',kj:''};
  const voting=STATE.voting||{isOpen:false,endsAt:0};
  const v=STATE.votes||{encore:0,another:0,maybe:0};

  // headline/sub
  if (voting.isOpen){
    $('#headline').textContent = `Now Voting: ${cur.name||'—'}`;
    $('#subline').textContent  = `${cur.song||''} • ${ev.venue||''} — ${ev.kj||''}`;
  } else if (cur.name){
    $('#headline').textContent = `Up Now: ${cur.name}`;
    $('#subline').textContent  = `${cur.song||''} • ${ev.venue||''} — ${ev.kj||''}`;
  } else {
    $('#headline').textContent = ev.venue ? `Welcome to ${ev.venue}` : 'Welcome';
    $('#subline').textContent  = ev.kj ? `Your KJ tonight: ${ev.kj}` : 'Waiting for host…';
  }

  // vote UI
  $('#voteBlock').style.display = voting.isOpen ? 'flex' : 'none';
  if (voting.isOpen){
    const remain = Math.max(0, voting.endsAt - Date.now());
    const s = Math.ceil(remain/1000);
    $('#countdown').textContent = s;

    $('#scoreEncore').textContent=v.encore;
    $('#scoreAnother').textContent=v.another;
    $('#scoreMaybe').textContent=v.maybe;

    // draw balls (cap visible to ~50 for performance)
    function drawBalls(el, count, cls){
      el.innerHTML='';
      const n = Math.min(count, 50);
      for (let i=0;i<n;i++){
        const b=document.createElement('div');
        b.className='ball '+cls;
        b.style.animationDelay=(Math.random()*1).toFixed(2)+'s';
        el.appendChild(b);
      }
    }
    drawBalls($('#ballsEncore'), v.encore, 'green');
    drawBalls($('#ballsAnother'), v.another, 'yellow');
    drawBalls($('#ballsMaybe'), v.maybe, 'red');
  }

  // sounds: start/stop windows
  if (voting.isOpen && !lastIsOpen){
    document.getElementById('sndOpen').play().catch(()=>{});
  }
  if (!voting.isOpen && lastIsOpen){
    document.getElementById('sndOver').play().catch(()=>{});
  }
  lastIsOpen = voting.isOpen;

  // show result banner after close
  if (!voting.isOpen && STATE.lastResult && (ms()-lastResultShownAt>500)){
    const b = $('#resultBanner');
    $('#result').classList.add('show');
    b.className='banner '+STATE.lastResult;
    b.textContent = STATE.lastResult==='encore' ? 'Encore!' :
                    STATE.lastResult==='another'? 'Another Shot!' : 'Maybe Next Time';
    // sound & confetti
    if (STATE.lastResult==='encore'){ document.getElementById('sndEncore').play().catch(()=>{}); burst('#2ef07a'); }
    else if (STATE.lastResult==='maybe'){ document.getElementById('sndMaybe').play().catch(()=>{}); }
    else { burst('#ffd166'); }
    lastResultShownAt = ms();
    // auto hide after 15s
    setTimeout(()=>$('#result').classList.remove('show'), 15000);
  }
}
// gentle movement to avoid TV sleep
setInterval(()=>{document.body.style.backgroundPosition=`${(Date.now()/40)%200}px ${(Date.now()/60)%200}px`;}, 2000);

function tickLoop(){
  if (!STATE?.voting?.isOpen) return;
  const remain = STATE.voting.endsAt - Date.now();
  if (remain<=0){
    // wait for host close; we just stop countdown
    return;
  }
  render();
}
function startPoll(){
  clearInterval(poll);
  poll = setInterval(async ()=>{
    const r = await apiGet();
    if (r.ok){ STATE=r.state; render(); }
  }, 1000);
}

(async function init(){
  const r=await apiGet(); if (r.ok){ STATE=r.state; render(); }
  startPoll();
  clearInterval(tick);
  tick=setInterval(tickLoop, 250);
})();
</script>
</body>
</html>
