<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EYEK • Screen</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap">
<style>
  :root{
    --bg:#02050a; --ink:#eaf2ff; --sub:#a0b3d2;
    --green:#22c55e; --yellow:#facc15; --red:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% 50%, #0b1322, #04070d 60%, #02050a 100%); color:var(--ink); font-family:Outfit,system-ui}
  .stage{width:min(1200px,95vw); height:min(680px,90vh); position:relative; border-radius:24px; border:1px solid rgba(255,255,255,.06); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.2)); box-shadow:0 40px 120px rgba(0,0,0,.55); overflow:hidden; padding:28px;}
  .title{font-size:42px; font-weight:900; letter-spacing:.4px}
  .sub{font-size:22px; opacity:.85}
  .muted{color:var(--sub)}
  .center{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; text-align:center; padding:24px}
  .badge{display:inline-block; padding:8px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); font-weight:700; letter-spacing:.3px}
  .timer{font-size:72px; font-weight:900}
  .stacks{display:flex; gap:28px; align-items:flex-end; margin-top:8px}
  .stack{width:240px; height:260px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:16px; display:flex; align-items:flex-end; justify-content:center; padding:12px; position:relative}
  .count{position:absolute; top:12px; left:12px; font-weight:900; font-size:28px}
  .ball{width:22px; height:22px; border-radius:999px; margin:4px; animation:bounce 1.2s infinite ease-in-out}
  .ball.green{background:var(--green)}
  .ball.yellow{background:var(--yellow)}
  .ball.red{background:var(--red)}
  @keyframes bounce{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-10px)}
  }
  /* Result banners */
  .result{position:absolute; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px}
  .result.show{display:flex}
  .res-title{font-size:90px; font-weight:900; text-shadow:0 10px 40px rgba(0,0,0,.6)}
  .res-encore{color:#d1fadf}
  .res-another{color:#fef3c7}
  .res-maybe{color:#fecaca}
  .confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .dot{position:absolute; width:10px; height:10px; border-radius:50%; animation:fall 2.5s linear infinite}
  @keyframes fall{
    0%{transform:translateY(-10vh) rotate(0)}
    100%{transform:translateY(110vh) rotate(720deg)}
  }
  .footer{position:absolute; bottom:12px; left:0; right:0; text-align:center; color:#9fb3cf; font-size:14px; opacity:.9}
  .hide{display:none}
  iframe{border:none; width:100%; height:100%}
</style>
</head>
<body>
<div class="stage">
  <div id="idle" class="center">
    <div class="badge" id="venueKj">Welcome</div>
    <div class="title" id="mainLine">Earn Your Encore Karaoke</div>
    <div class="sub muted" id="subLine">Next up: —</div>
  </div>

  <div id="voting" class="center hide">
    <div class="badge">Now Voting For</div>
    <div class="title" id="voteSinger">—</div>
    <div class="timer" id="timer">00:30</div>
    <div class="stacks">
      <div class="stack">
        <div class="count" id="cEncore">0</div>
        <div id="bEncore"></div>
      </div>
      <div class="stack">
        <div class="count" id="cAnother">0</div>
        <div id="bAnother"></div>
      </div>
      <div class="stack">
        <div class="count" id="cMaybe">0</div>
        <div id="bMaybe"></div>
      </div>
    </div>
  </div>

  <div id="result" class="result">
    <div class="res-title" id="resText">Encore!</div>
    <div class="confetti" id="confetti"></div>
  </div>

  <div id="boardWrap" class="center hide">
    <iframe id="boardFrame" src="/board/index.html"></iframe>
  </div>

  <div class="footer" id="foot">vote.earnyourencorekaraoke.com</div>
</div>

<audio id="sndOpen"  src="/assets/voting_open.mp3" preload="auto"></audio>
<audio id="sndOver"  src="/assets/voting_over.mp3" preload="auto"></audio>
<audio id="sndEncore" src="/assets/encore.mp3" preload="auto"></audio>
<audio id="sndLose"   src="/assets/loser.wav" preload="auto"></audio>

<script>
const API='/assets/api.php';
const $ = s=>document.querySelector(s);
let STATE=null, prev=null, poll=null, mode='idle', lastSeenResultAt=0;

function balls(parent, n, cls){
  parent.innerHTML='';
  for(let i=0;i<n;i++){
    const d=document.createElement('div');
    d.className='ball '+cls;
    d.style.animationDelay=(Math.random()*1.2)+'s';
    parent.appendChild(d);
  }
}

function confetti(){
  const c = $('#confetti'); c.innerHTML='';
  for(let i=0;i<120;i++){
    const d=document.createElement('div'); d.className='dot';
    const colors=['#22c55e','#facc15','#38bdf8','#ef4444','#a78bfa'];
    d.style.background = colors[Math.floor(Math.random()*colors.length)];
    d.style.left = (Math.random()*100)+'%';
    d.style.animationDelay = (Math.random()*1.5)+'s';
    d.style.width = d.style.height = (6+Math.random()*8)+'px';
    c.appendChild(d);
  }
}

function show(id){
  ['idle','voting','result','boardWrap'].forEach(x=>$('#'+x).classList.add('hide'));
  $('#'+id).classList.remove('hide');
  mode = id;
}

function updateScreen(){
  if(!STATE) return;
  const venue = STATE.event.venue || 'Your Venue';
  const kj = STATE.event.kj || 'Your KJ';
  $('#venueKj').textContent = `${venue} • ${kj}`;

  // Next up
  const current = STATE.singers.find(s=>s.id===STATE.currentSingerId);
  const idx = current ? STATE.singers.findIndex(s=>s.id===current.id) : -1;
  const next = (idx>=0 && STATE.singers[idx+1]) ? STATE.singers[idx+1].name : '—';
  $('#subLine').textContent = `Next up: ${next}`;

  // Voting block
  if (STATE.voting.open) {
    $('#voteSinger').textContent = current ? current.name : '—';
    const v = STATE.voting.votes;
    $('#cEncore').textContent = v.encore;
    $('#cAnother').textContent = v.another;
    $('#cMaybe').textContent = v.maybe;
    balls($('#bEncore'), v.encore, 'green');
    balls($('#bAnother'), v.another, 'yellow');
    balls($('#bMaybe'), v.maybe, 'red');
    const remain = STATE.voting.endsAt - Date.now();
    $('#timer').textContent = remain>0 ? fmt(remain) : '00:00';
    if (mode!=='voting') {
      show('voting');
      $('#sndOpen').currentTime=0; $('#sndOpen').play().catch(()=>{});
    }
  } else {
    // If a fresh result exists, show flashy screen 15s, then board 15s, then idle
    if (STATE.lastResult && STATE.lastResult.at !== lastSeenResultAt) {
      lastSeenResultAt = STATE.lastResult.at;
      const outcome = STATE.lastResult.outcome; // encore|another|maybe
      const text = outcome==='encore'?'Encore!': outcome==='another'?'Another Shot!':'Maybe Next Time';
      const cls  = outcome==='encore'?'res-encore': outcome==='another'?'res-another':'res-maybe';
      const sound= outcome==='encore'?'sndEncore': (outcome==='maybe'?'sndLose':null);
      $('#resText').textContent = text;
      $('#resText').className = 'res-title '+cls;
      confetti();
      show('result');
      if (sound){ $('#'+sound).currentTime=0; $('#'+sound).play().catch(()=>{}); }
      setTimeout(()=>{ show('boardWrap'); }, 15000);
      setTimeout(()=>{ show('idle'); }, 30000);
    } else if (mode!=='idle' && mode!=='boardWrap') {
      show('idle');
    }
  }
}

function fmt(ms){ if (ms<0) ms=0; const s=Math.ceil(ms/1000), m=(s/60)|0, r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }

async function refresh(){
  const r = await fetch(API+'?cmd=get&ts='+Date.now(), {cache:'no-store'});
  const j = await r.json();
  if (j.ok){ prev=STATE; STATE=j.state; updateScreen(); }
}

// tiny periodic “nudge” to avoid TV sleep (layout change)
setInterval(()=>{ $('#foot').style.opacity = (0.7 + Math.random()*0.3).toFixed(2); }, 5000);

refresh();
poll = setInterval(refresh, 1500);
</script>
</body>
</html>
