name: Deploy to SiteGround

on:
  push:
    branches: [ main ]       # change if your default branch differs
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SG_HOST: ${{ secrets.SG_HOST }}
      SG_PORT: ${{ secrets.SG_PORT }}
      SG_USER: ${{ secrets.SG_USER }}
      SG_REMOTE_PATH: ${{ secrets.SG_REMOTE_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Load your private key into an ssh-agent (handles passphrase too)
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SG_SSH_KEY }}
          ssh-passphrase: ${{ secrets.SG_SSH_PASSPHRASE }}

      # Quick debug so you can see the agent has a key loaded
      - name: Debug SSH agent & config
        shell: bash
        run: |
          ssh-add -l || true
          mkdir -p ~/.ssh
          # simple host-key policy; you can replace with a known_hosts secret later
          printf "Host *\n  StrictHostKeyChecking no\n  IdentitiesOnly yes\n" > ~/.ssh/config
          echo "Repo tree (top-level):"
          find . -maxdepth 2 -type d -print

      - name: Smoke test SSH (verbose)
        shell: bash
        run: |
          ssh -vvv -p "$SG_PORT" "$SG_USER@$SG_HOST" 'echo "SSH OK on $(hostname)"; whoami; pwd'

      - name: Ensure remote path exists
        shell: bash
        run: |
          ssh -p "$SG_PORT" "$SG_USER@$SG_HOST" "
            mkdir -p '$SG_REMOTE_PATH'
            echo 'Remote path ensured: $SG_REMOTE_PATH'
          "

      - name: Ensure subfolders (optional)
        shell: bash
        run: |
          ssh -p "$SG_PORT" "$SG_USER@$SG_HOST" "
            mkdir -p '$SG_REMOTE_PATH/screen' \
                     '$SG_REMOTE_PATH/board'  \
                     '$SG_REMOTE_PATH/host'   \
                     '$SG_REMOTE_PATH/vote'   \
                     '$SG_REMOTE_PATH/admin'
          "

      - name: Deploy via rsync (screen/board/host/vote/admin)
        shell: bash
        run: |
          set -e
          for d in screen board host vote admin; do
            if [ -d "$d" ]; then
              echo "== Deploying $d -> $SG_REMOTE_PATH/$d =="
              rsync -az --delete \
                -e "ssh -p $SG_PORT" \
                --exclude ".DS_Store" \
                "$d/" "$SG_USER@$SG_HOST:$SG_REMOTE_PATH/$d/"
            fi
          done
