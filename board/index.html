<!-- EYEK /board/index.html v2025-09-06.16 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#2F0658; --card:#401073; --border:#7E3CC0; --text:#ffffff; --muted:#E3D6F4;
      --enc:#22c55e;  /* Encore header green */
      --ano:#f59e0b;  /* Another Shot header yellow */
      --nameCard:#2b1250;            /* tile background */
      --nameBorder:#7a52b7;          /* tile border */
      --nameGlow:rgba(217,182,255,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
        radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size: clamp(18px, 2.2vw, 26px);
    }
    .wrap{max-width:1800px; margin:0 auto; padding:28px}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; padding-bottom:14px; border-bottom:2px solid var(--border)}
    h1{margin:0; font-size:clamp(2.2rem, 4.5vw, 4rem)}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.2em .75em; color:#f5eaff; font-weight:900; background:rgba(127,60,192,.18)}
    .small{ font-size:.9rem; font-weight:800; color:var(--muted) }

    .grid{
      margin-top:22px;
      display:grid; gap:24px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr } }

    .col{
      border:2px solid var(--border); border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), #3a146a;
      overflow:hidden;
      box-shadow:0 16px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)
    }
    .colHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; font-weight:1000; letter-spacing:.2px;
      color:#101010
    }
    .hEncore{ background:var(--enc) }
    .hAnother{ background:var(--ano) }
    .count{ font-weight:1000; font-size: .95em; color:#111; }

    .list{ display:grid; gap:14px; padding:16px }
    .empty{ opacity:.75; color:var(--muted); font-weight:800; padding:16px }

    /* Name tiles: subtle glow, clean contrast */
    .name{
      padding:14px 16px;
      border-radius:14px;
      background:
        radial-gradient(200% 140% at 120% -20%, var(--nameGlow), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)),
        var(--nameCard);
      border:2px solid var(--nameBorder);
      box-shadow:
        0 12px 28px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      font-weight:900;
    }
    .name .tag{
      font-size:.9em; opacity:.85; color:#e7d9ff; font-weight:800;
    }

    .footerNote{
      margin-top:18px; color:var(--muted); font-weight:700; text-align:center; opacity:.85;
      font-size: clamp(.9rem, 1.6vw, 1.1rem);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Encore Karaoke <span class="pill" id="eventPill">—</span></h1>
      <div class="small" id="followNote">Following current event…</div>
    </header>

    <main class="grid" id="grid">
      <section class="col" id="colEncore">
        <div class="colHeader hEncore">
          <div>Encore!</div>
          <div class="count" id="encCount">0</div>
        </div>
        <div class="list" id="encList"><div class="empty">— none yet —</div></div>
      </section>

      <section class="col" id="colAnother">
        <div class="colHeader hAnother">
          <div>Another Shot!</div>
          <div class="count" id="anoCount">0</div>
        </div>
        <div class="list" id="anoList"><div class="empty">— none yet —</div></div>
      </section>
    </main>

    <div class="footerNote">Board updates live when a vote closes. “Maybe Next Time!” is hidden from this view.</div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    var FIREBASE_CONFIG = { apiKey:"AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk", authDomain:"eyek-vote.firebaseapp.com", projectId:"eyek-vote" };
    if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
    firebase.initializeApp(FIREBASE_CONFIG);
    var db=firebase.firestore();

    function $(id){ return document.getElementById(id); }
    function getParam(n){ return (new URL(location.href)).searchParams.get(n); }
    function tsMillis(x){ try{ return x && x.toMillis ? x.toMillis() : (typeof x==='number' ? x : 0); }catch(_){ return 0; } }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function computeCloseAtFrom(d){
      if(d && d.openAt && d.durationSec){ return firebase.firestore.Timestamp.fromDate(new Date(d.openAt.toMillis() + (d.durationSec|0)*1000)); }
      return d && d.closeAt ? d.closeAt : null;
    }

    var eventPill=$('eventPill'), followNote=$('followNote'),
        encList=$('encList'), anoList=$('anoList'), encCount=$('encCount'), anoCount=$('anoCount');

    // Memory maps
    var singerMeta = new Map();      // key -> {removed:boolean, hidden:boolean}
    var latestBySinger = new Map();  // key -> { outcome:'encore'|'another'|'maybe', name, atMs, singerId? }

    // Your tie rules
    function decideOutcomeStrict(e,a,m){
      e|=0;a|=0;m|=0;
      if(e>a && e>m) return 'encore';
      if(a>e && a>m) return 'another';
      if(m>e && m>a) return 'maybe';
      if(a===m && a>e) return 'another';   // another vs maybe -> another
      if(e===a && e>m) return 'encore';    // encore vs another -> encore
      if(e===m && e>a) return 'another';   // encore vs maybe  -> another
      if(e===a && a===m && e>0) return 'another'; // 3-way tie -> another
      return null;
    }

    function singerKeyFrom(d){
      if(d.singerId) return 'id:'+String(d.singerId);
      return 'name:'+String(d.singerName||'').trim().toLowerCase();
    }

    function render(){
      var encore=[], another=[];
      latestBySinger.forEach(function(v, key){
        var meta = singerMeta.get(key) || {};
        if(meta.removed || meta.hidden) return; // honor manual removes/hide
        if(v.outcome==='encore') encore.push(v);
        else if(v.outcome==='another') another.push(v);
      });

      encore.sort((a,b)=>b.atMs-a.atMs);
      another.sort((a,b)=>b.atMs-a.atMs);

      function fill(listEl, arr){
        listEl.innerHTML='';
        if(!arr.length){ listEl.innerHTML='<div class="empty">— none yet —</div>'; return; }
        arr.forEach(function(x){
          var div=document.createElement('div');
          div.className='name';
          div.innerHTML = '<div>'+escapeHtml(x.name)+'</div>' +
                          '<div class="tag">'+(new Date(x.atMs)).toLocaleTimeString()+ '</div>';
          listEl.appendChild(div);
        });
      }

      fill(encList, encore);
      fill(anoList, another);
      encCount.textContent = encore.length;
      anoCount.textContent = another.length;
    }

    function applyOutcome(key, name, atMs, outcome, singerId){
      var prev = latestBySinger.get(key);
      if(!prev || atMs > prev.atMs){
        latestBySinger.set(key, { name, outcome, atMs, singerId });
        render();
      }
    }

    function computeOutcomeFromVotesOnce(eventId, performanceId){
      return db.collection('events').doc(eventId).collection('votes')
        .where('performanceId','==', performanceId)
        .get()
        .then(function(qs){
          var e=0,a=0,m=0;
          qs.forEach(d=>{
            var c=String((d.data()||{}).category||'').toLowerCase();
            if(c==='encore') e++; else if(c==='another') a++; else if(c==='maybe') m++;
          });
          return decideOutcomeStrict(e,a,m);
        })
        .catch(function(){ return null; });
    }

    function upsertFromPerformance(eid, id, d){
      var at = computeCloseAtFrom(d);
      var atMs = tsMillis(at) || tsMillis(d.openAt) || Date.now();
      var name = d.singerName || '(Unknown)';
      var key = singerKeyFrom(d);
      var out = d.outcome;

      // Only show closed outcomes on the board
      if(d.status !== 'closed'){ return; }

      if(out){
        applyOutcome(key, name, atMs, out, d.singerId);
      }else{
        // Compute once from votes if outcome missing
        computeOutcomeFromVotesOnce(eid, id).then(function(res){
          if(!res) return;
          applyOutcome(key, name, atMs, res, d.singerId);
        });
      }
    }

    var unsubPerf=null, unsubSingers=null, unsubActive=null;
    var currentEvent=null;

    function startForEvent(eid){
      if(currentEvent===eid) return;
      currentEvent=eid;
      eventPill.textContent=eid;
      followNote.textContent='Following event: '+eid;

      latestBySinger.clear();
      singerMeta.clear();
      render();

      if(unsubPerf){ unsubPerf(); unsubPerf=null; }
      if(unsubSingers){ unsubSingers(); unsubSingers=null; }

      // Singer meta (for manual remove/hide)
      unsubSingers = db.collection('events').doc(eid).collection('singers')
        .onSnapshot(function(snap){
          snap.docChanges().forEach(function(ch){
            var d=ch.doc.data()||{};
            var key = d.singerId ? ('id:'+d.singerId) : ('name:'+String(d.name||'').trim().toLowerCase());
            singerMeta.set(key, { removed: !!d.removed, hidden: !!d.hidden });
          });
          render();
        });

      // Watch recent performances (order by openAt desc) and process closed ones
      // Using orderBy ensures we see updates when status flips to 'closed'
      unsubPerf = db.collection('events').doc(eid).collection('performances')
        .orderBy('openAt','desc').limit(200)
        .onSnapshot(function(snap){
          snap.docChanges().forEach(function(ch){
            var id=ch.doc.id;
            var d=ch.doc.data()||{};
            upsertFromPerformance(eid, id, d);
          });
        });
    }

    function followEvent(){
      var param = getParam('eventId');
      if(param){ startForEvent(param); return; }

      // Fallback: follow meta/active
      if(unsubActive){ unsubActive(); unsubActive=null; }
      unsubActive = db.collection('meta').doc('active')
        .onSnapshot(function(snap){
          var d=snap.data()||{};
          var ev=d.eventId || 'default';
          startForEvent(ev);
        });
    }

    followEvent();

    // ---- Optional: quick rule guard (dev hint in console)
    console.log('[Board] If this page does not update, confirm Firestore rules allow read on: /events/{eventId}/performances/{performanceId}');
  })();
  </script>
</body>
</html>
