<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      /* Brand purple theme */
      --bg:#2F0658;
      --card:#401073;
      --border:#7E3CC0;
      --text:#ffffff;
      --muted:#E3D6F4;
      --accent:#D9B6FF;

      /* Category colors */
      --encore:#22c55e;
      --another:#f59e0b;
      --maybe:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
        radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size: clamp(18px, 2.2vw, 26px);
    }
    .wrap{max-width:1600px; margin:0 auto; padding:24px}
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
      padding-bottom:12px; border-bottom:2px solid var(--border)
    }
    h1{margin:0; font-size:clamp(2.2rem, 4.2vw, 3.6rem)}
    .pill{
      display:inline-block; border:2px solid var(--border); border-radius:999px;
      padding:.2em .75em; color:#f5eaff; font-weight:900; background:rgba(127,60,192,.18)
    }
    .sub{color:var(--muted); margin-top:6px}

    .grid{display:grid; gap:18px; grid-template-columns:1fr}
    @media (min-width:1100px){ .grid{grid-template-columns:1fr 1fr 1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--card);
      border:2px solid var(--border); border-radius:18px; padding:18px;
      box-shadow:0 10px 34px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)
    }
    .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px
    }
    .hlabel{font-weight:1000; letter-spacing:.3px; font-size:clamp(1.3rem, 2.6vw, 1.8rem)}
    .badge{
      border:2px solid var(--border); border-radius:999px; padding:.2em .7em; font-weight:900; color:#f5eaff;
      background:rgba(127,60,192,.18)
    }
    .list{display:grid; gap:8px; min-height:120px}
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:rgba(0,0,0,.18); border:2px solid var(--border); border-radius:12px; padding:.55em .7em
    }
    .name{font-weight:1000; font-size:1.1em}
    .meta{color:var(--muted); font-weight:700; font-size:.9em}
    .empty{color:var(--muted); border:2px dashed var(--border); border-radius:12px; padding:.7em .9em; text-align:center}
    .encCol .hlabel{color:#d7ffe6}
    .anoCol .hlabel{color:#fff2d6}
    .mayCol .hlabel{color:#ffe1e1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Encore Karaoke <span class="pill" id="eventPill">—</span></h1>
      <div class="sub">Shows each singer’s latest result. Removed singers are hidden automatically.</div>
    </header>

    <main class="grid" style="margin-top:18px">
      <section class="card encCol">
        <div class="head">
          <div class="hlabel">Encore!</div>
          <div class="badge" id="encCount">0</div>
        </div>
        <div class="list" id="encList"><div class="empty">No Encore yet.</div></div>
      </section>

      <section class="card anoCol">
        <div class="head">
          <div class="hlabel">Another Shot!</div>
          <div class="badge" id="anoCount">0</div>
        </div>
        <div class="list" id="anoList"><div class="empty">No “Another Shot” yet.</div></div>
      </section>

      <section class="card mayCol">
        <div class="head">
          <div class="hlabel">Maybe Next Time!</div>
          <div class="badge" id="mayCount">0</div>
        </div>
        <div class="list" id="mayList"><div class="empty">No “Maybe Next Time” yet.</div></div>
      </section>
    </main>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      // Config
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote"
      };
      if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
      firebase.initializeApp(FIREBASE_CONFIG);
      var db=firebase.firestore();

      // DOM helpers
      function $(id){ return document.getElementById(id); }
      var eventPill=$('eventPill');
      var encList=$('encList'), anoList=$('anoList'), mayList=$('mayList');
      var encCount=$('encCount'), anoCount=$('anoCount'), mayCount=$('mayCount');

      // URL or follow meta.active
      var unsubMeta=null, unsubSingers=null;
      var EVENT_ID=null;

      // Data caches
      var singers={};// singerId -> {name, removed, latestPerformanceId}
      var perfOutcomeCache={}; // perfId -> { outcome, closedAt, counts? }

      function labelOutcome(o){
        if(o==='encore') return 'Encore!';
        if(o==='another') return 'Another Shot!';
        if(o==='maybe') return 'Maybe Next Time!';
        return '—';
      }
      function decideOutcomeStrict(e,a,m){
        e|=0;a|=0;m|=0;
        if(e>a && e>m) return 'encore';
        if(a>e && a>m) return 'another';
        if(m>e && m>a) return 'maybe';
        if(a===m && a>e) return 'another';
        if(e===a && e>m) return 'encore';
        if(e===m && e>a) return 'another';
        if(e===a && a===m && e>0) return 'another';
        return null;
      }

      function start(){
        var u=new URL(location.href), eid=u.searchParams.get('eventId');
        if(eid){ eventPill.textContent=eid; attachToEvent(eid); }
        else{
          unsubMeta = db.collection('meta').doc('active').onSnapshot(function(snap){
            var d=snap.data()||{}; var ev=d.eventId||'default';
            eventPill.textContent=ev; attachToEvent(ev);
          }, function(err){ console.error(err); });
        }
      }

      function attachToEvent(eid){
        if(EVENT_ID===eid) return;
        EVENT_ID=eid;
        singers={}; perfOutcomeCache={};
        if(unsubSingers){ unsubSingers(); unsubSingers=null; }
        render(); // clear

        // Live singers (per-singer removal respected)
        unsubSingers = db.collection('events').doc(eid).collection('singers')
          .onSnapshot(function(snap){
            var warms=[];
            snap.docChanges().forEach(function(ch){
              var id=ch.doc.id, x=ch.doc.data()||{};
              if(ch.type==='removed'){ delete singers[id]; return; }
              singers[id] = {
                name: x.name || '',
                removed: !!x.removed,
                latestPerformanceId: x.latestPerformanceId || null
              };
              if(x.latestPerformanceId && perfOutcomeCache[x.latestPerformanceId]===undefined){
                warms.push(warmOutcome(x.latestPerformanceId));
              }
            });
            Promise.all(warms).then(render).catch(render);
          }, function(err){ console.error('singers error', err); });
      }

      function warmOutcome(perfId){
        return db.collection('events').doc(EVENT_ID).collection('performances').doc(perfId).get()
          .then(function(s){
            if(!s.exists){ perfOutcomeCache[perfId]=null; return null; }
            var d=s.data()||{};
            var out=d.outcome || null;
            if(!out && d.counts){
              out = decideOutcomeStrict((d.counts.encore|0),(d.counts.another|0),(d.counts.maybe|0));
            }
            perfOutcomeCache[perfId] = out || null;
            return perfOutcomeCache[perfId];
          })
          .catch(function(){ perfOutcomeCache[perfId]=null; return null; });
      }

      function render(){
        // Buckets
        var enc=[], ano=[], may=[];
        Object.keys(singers).forEach(function(sid){
          var s = singers[sid];
          // Respect per-singer removed flag ONLY
          if(s.removed) return;

          var out=null;
          if(s.latestPerformanceId){ out = perfOutcomeCache[s.latestPerformanceId]; }
          if(!out) return; // has not performed yet or outcome unknown

          var item={ id:sid, name:s.name, out:out };
          if(out==='encore') enc.push(item);
          else if(out==='another') ano.push(item);
          else if(out==='maybe') may.push(item);
        });

        // Sort alphabetically (or could sort by time if you prefer)
        var cmp=function(a,b){ return a.name.localeCompare(b.name, undefined, {sensitivity:'base'}); };
        enc.sort(cmp); ano.sort(cmp); may.sort(cmp);

        fillList(encList, enc);
        fillList(anoList, ano);
        fillList(mayList, may);

        encCount.textContent = enc.length;
        anoCount.textContent = ano.length;
        mayCount.textContent = may.length;
      }

      function fillList(container, arr){
        container.innerHTML='';
        if(!arr.length){
          var d=document.createElement('div'); d.className='empty'; d.textContent='—';
          container.appendChild(d); return;
        }
        arr.forEach(function(it){
          var row=document.createElement('div'); row.className='row';
          var left=document.createElement('div');
          left.innerHTML='<div class="name">'+escapeHtml(it.name)+'</div>'
                        +'<div class="meta">'+labelOutcome(it.out)+'</div>';
          row.appendChild(left);
          container.appendChild(row);
        });
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, function(m){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
        });
      }

      start();
    })();
  </script>
</body>
</html>
