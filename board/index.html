<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#070b12; --card:#0e162b; --border:#253659; --text:#fff; --muted:#c9d3ea;
      --encore:#22c55e; --another:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1400px; margin:0 auto; padding:20px}
    h1{margin:0 0 16px; font-size:2rem}
    .grid{display:grid; gap:20px; grid-template-columns:1fr 1fr}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
    .col{background:var(--card); border:2px solid var(--border); border-radius:16px; padding:16px}
    .col h2{margin:.1em 0 .5em}
    ul{list-style:none; margin:0; padding:0}
    li{padding:.6em .8em; border:2px solid var(--border); border-radius:12px; background:#0d1630; margin:.5em 0; font-weight:800}
    .enc{border-color:#256f44; background:#0d2617}
    .ano{border-color:#7a520c; background:#261a08}
    .fatal{position:sticky; top:0; z-index:999; padding:.6em .8em; background:#b91c1c; color:#fff; font-weight:900; display:none}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.15em .5em; color:#cfe1ff; font-weight:800}
    .sub{color:var(--muted)}
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>
  <div class="wrap">
    <h1>Encore Karaoke <span class="pill" id="eventPill">Event: —</span></h1>
    <div class="sub" id="subNote">Showing latest status. Removed singers are hidden.</div>
    <div class="grid" style="margin-top:16px">
      <div class="col">
        <h2>Encore</h2>
        <ul id="encoreList"></ul>
      </div>
      <div class="col">
        <h2>Another Shot</h2>
        <ul id="anotherList"></ul>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      var fatal = document.getElementById('fatal');
      function die(msg){ fatal.textContent='Error: '+msg; fatal.style.display='block'; }

      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote"
      };

      if(!firebase || !firebase.initializeApp){ return die('Firebase failed to load.'); }
      firebase.initializeApp(FIREBASE_CONFIG);
      var db=firebase.firestore();

      var eventPill = document.getElementById('eventPill');
      var encoreList = document.getElementById('encoreList');
      var anotherList = document.getElementById('anotherList');

      // Choose event: ?eventId=… or meta/active
      var u=new URL(location.href), eid=u.searchParams.get('eventId'), unsubMeta=null;
      if (eid){ eventPill.textContent='Event: '+eid; start(eid); }
      else {
        unsubMeta = db.collection('meta').doc('active').onSnapshot(function(s){
          var d=s.data()||{}; var ev=d.eventId||'default';
          eventPill.textContent='Event: '+ev;
          start(ev);
        }, function(err){ die('meta/active: '+((err&&err.message)||err)); });
      }

      var unsubPerf=null, unsubSingers=null, singerRemovedMap={}; // singerId -> removed bool

      function start(eventId){
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(unsubSingers){ unsubSingers(); unsubSingers=null; singerRemovedMap={}; }

        // Load + watch removed flags
        unsubSingers = db.collection('events').doc(eventId).collection('singers').onSnapshot(function(snap){
          snap.forEach(function(d){
            var x=d.data()||{};
            singerRemovedMap[d.id] = !!x.removed;
          });
          rebuild(); // refresh lists when flags change
        }, function(err){ die('singers: '+((err&&err.message)||err)); });

        // Listen to latest performances and compute each singer's latest outcome
        unsubPerf = db.collection('events').doc(eventId).collection('performances')
          .orderBy('closeAt','desc')
          .onSnapshot(function(snap){
            var latestBySinger = {};
            snap.forEach(function(d){
              var x=d.data()||{};
              var sid=x.singerId; if(!sid) return;
              // only first seen (latest closeAt due to desc order)
              if (latestBySinger[sid] === undefined){
                latestBySinger[sid] = (x.outcome || null);
              }
            });
            rebuild(latestBySinger);
          }, function(err){ die('performances: '+((err&&err.message)||err)); });

        function rebuild(latestBySinger){
          latestBySinger = latestBySinger || {};
          // Build Encore / Another lists, skipping removed singers
          var enc = [], ano = [];
          Object.keys(latestBySinger).forEach(function(sid){
            if (singerRemovedMap[sid]) return;         // hide removed
            var outcome = latestBySinger[sid];
            if (outcome === 'encore') enc.push(sid);
            else if (outcome === 'another') ano.push(sid);
          });

          // We need names; fetch once
          // (We already maintain singerRemovedMap; reuse same query)
          db.collection('events').doc(eventId).collection('singers').get().then(function(snap){
            var names={}; snap.forEach(function(d){ names[d.id]=(d.data()||{}).name||'(Unknown)'; });

            encoreList.innerHTML = '';
            anotherList.innerHTML = '';

            enc.sort(function(a,b){ return (names[a]||'').localeCompare(names[b]||''); })
               .forEach(function(sid){
                 var li=document.createElement('li'); li.className='enc';
                 li.textContent = names[sid] || '(Unknown)';
                 encoreList.appendChild(li);
               });

            ano.sort(function(a,b){ return (names[a]||'').localeCompare(names[b]||''); })
               .forEach(function(sid){
                 var li=document.createElement('li'); li.className='ano';
                 li.textContent = names[sid] || '(Unknown)';
                 anotherList.appendChild(li);
               });

            if (!enc.length){ var li=document.createElement('li'); li.textContent='—'; encoreList.appendChild(li); }
            if (!ano.length){ var li=document.createElement('li'); li.textContent='—'; anotherList.appendChild(li); }
          });
        }
      }
    })();
  </script>
</body>
</html>
