<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0b0f; --card:#141826; --accent:#7bc4ff; --border:#26304a;
      --text:#f7f8fc; --muted:#b9c0d0; --encore:#4ade80; --another:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; min-height:100vh; background:linear-gradient(180deg,#0b0b0f,#0e1220); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
    header{ padding:16px 18px; border-bottom:1px solid var(--border); background:rgba(0,0,0,.25) }
    .title{ font-size:22px; font-weight:900 }
    .muted{ color:var(--muted) }
    main{ padding:24px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    @media (max-width:1100px){ .grid{ grid-template-columns:1fr } }
    .col{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .col h2{ margin:0 0 12px; font-size:20px }
    ul{ list-style:none; margin:0; padding:0 }
    li{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#0f1322; margin-bottom:10px; }
    .pill{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:6px 10px; color:var(--muted); font-size:12px }
    footer{ padding:8px 16px; color:var(--muted); font-size:12px; border-top:1px solid var(--border) }
  </style>
</head>
<body>
  <header>
    <div class="title">Encore Karaoke — Live Board</div>
    <div class="muted" id="eventName">Event: —</div>
  </header>

  <main>
    <div class="grid">
      <section class="col">
        <h2 style="color:var(--encore)">Encore Winners</h2>
        <ul id="encoreList"></ul>
      </section>
      <section class="col">
        <h2 style="color:var(--another)">Another Shot</h2>
        <ul id="anotherList"></ul>
      </section>
    </div>
  </main>

  <footer id="debug" class="muted"></footer>

  <script type="module">
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, query, onSnapshot as onColSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db  = getFirestore(app);

    const encoreList = document.getElementById("encoreList");
    const anotherList= document.getElementById("anotherList");
    const debug      = document.getElementById("debug");
    const eventName  = document.getElementById("eventName");

    function resolveEventId(cb){
      const u = new URL(location.href);
      const explicit = u.searchParams.get("eventId");
      if (explicit){ cb(explicit, null); return; }
      const unsub = onSnapshot(doc(db,"meta","active"), (snap)=>{
        if (!snap.exists()){ cb(null, unsub); return; }
        const d = snap.data()||{};
        cb(d.eventId || null, unsub);
      });
    }

    function decideBucket(c){
      const e = c.encore|0, a = c.another|0, m = c.maybe|0;
      if (e===0 && a===0 && m===0) return null;
      if (e>a && e>m) return "encore";
      if (a>e && a>m) return "another";
      if (m>e && m>a) return null; // "Maybe" not shown
      if (a===m && a>e) return "another";
      if (e===a && e>m) return "encore";
      if (e===m && e>a) return "another";
      if (e===a && a===m && e>0) return "another";
      return null;
    }

    function renderList(el, arr){
      el.innerHTML = "";
      if (!arr.length){ const li=document.createElement("li"); li.textContent="—"; el.appendChild(li); return; }
      for (const {name,count} of arr){
        const li = document.createElement("li");
        li.innerHTML = `<span>${name}</span><span class="pill">${count}</span>`;
        el.appendChild(li);
      }
    }

    function followEvent(eid){
      if (!eid){ eventName.textContent = "Event: (no active)"; return; }
      eventName.textContent = "Event: " + eid;

      let singers = {}; // singerId -> {name, latestPerformanceId}
      onColSnapshot(query(collection(db,"events",eid,"singers")), (snap)=>{
        singers = {};
        snap.forEach(d=>{
          const x = d.data()||{};
          singers[d.id] = { name: x.name || "(Unknown)", latestPerformanceId: x.latestPerformanceId || null };
        });
        computeBoard(); // recompute when singers change
      }, err=>{ debug.textContent = "Singers error: " + (err?.message||err); });

      // Aggregate votes by performanceId
      let byPerf = {}; // perfId -> {encore:a, another:b, maybe:c}
      onColSnapshot(query(collection(db,"events",eid,"votes")), (snap)=>{
        byPerf = {};
        snap.forEach(d=>{
          const v = d.data()||{};
          const perfId = v.performanceId;
          const cat = (v.category||"").toLowerCase();
          if (!perfId || !['encore','another','maybe'].includes(cat)) return;
          byPerf[perfId] = byPerf[perfId] || {encore:0, another:0, maybe:0};
          byPerf[perfId][cat] += 1;
        });
        computeBoard();
      }, err=>{ debug.textContent = "Votes error: " + (err?.message||err); });

      function computeBoard(){
        const encoreArr = [];
        const anotherArr= [];
        Object.entries(singers).forEach(([sid, info])=>{
          const perf = info.latestPerformanceId;
          if (!perf) return;
          const counts = byPerf[perf] || {encore:0, another:0, maybe:0};
          const bucket = decideBucket(counts);
          if (!bucket) return;
          const total = (counts.encore|0)+(counts.another|0)+(counts.maybe|0);
          if (bucket === "encore") encoreArr.push({name: info.name, count: total});
          if (bucket === "another") anotherArr.push({name: info.name, count: total});
        });
        // Sort by total desc, then name
        encoreArr.sort((a,b)=>b.count-a.count || a.name.localeCompare(b.name));
        anotherArr.sort((a,b)=>b.count-a.count || a.name.localeCompare(b.name));

        renderList(encoreList, encoreArr);
        renderList(anotherList, anotherArr);
      }
    }

    resolveEventId((eid, unsub)=>{ followEvent(eid); });
  </script>
</body>
</html>
