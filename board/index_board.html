<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke ‚Äì Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#19d36b; --gold-deep:#a8892c;
      --bg:#0b0715; --card:#1b1430; --ink:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    header{padding:16px;background:linear-gradient(90deg,var(--blue),var(--purple));display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:1.1rem}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#271c44;font-size:.9rem;margin-left:8px}

    .main{padding:18px}
    .nowHero{font-size:7vw;font-weight:1000;letter-spacing:.01em;text-align:center;margin:4px 0 18px}
    .nowHint{opacity:.9;text-align:center;margin-top:-8px;margin-bottom:18px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .col{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45);min-height:50vh}
    .colHead{padding:14px 18px;font-weight:1000;letter-spacing:.02em}
    .encHead{background:linear-gradient(180deg,rgba(187,255,216,.2),rgba(25,211,107,.25));border-bottom:1px solid rgba(25,211,107,.35)}
    .oneHead{background:linear-gradient(180deg,rgba(255,239,194,.2),rgba(234,186,84,.25));border-bottom:1px solid rgba(234,186,84,.35)}
    .list{padding:12px 14px}
    .chip{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 14px;margin:10px 0;border-radius:12px;background:#170f2a;border:1px solid rgba(255,255,255,.08);font-weight:800}
    .chip small{opacity:.8;font-weight:600}
    .empty{opacity:.6;text-align:center;padding:18px}

    .footer{margin-top:18px;display:flex;gap:10px;justify-content:flex-end;opacity:.8}
    .btn{padding:10px 14px;border:0;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-gold{background:var(--gold);color:#000}
    .btn-red{background:#ff4c61;color:#fff}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} .nowHero{font-size:12vw} }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>üé§ Earn Your Encore Karaoke ‚Ä¢ Board</h1>
    <div>
      <span class="pill" id="roundBadge">‚Äî</span>
      <span class="pill" id="status">loading‚Ä¶</span>
    </div>
  </header>

  <div class="main">
    <div class="nowHero" id="nowHero">Next up soon‚Ä¶</div>
    <div class="nowHint" id="nowHint">This page updates automatically when results are in.</div>

    <div class="grid">
      <section class="col" id="encCol">
        <div class="colHead encHead">‚úÖ Encore!</div>
        <div class="list" id="encList">
          <div class="empty">No Encores yet.</div>
        </div>
      </section>

      <section class="col" id="oneCol">
        <div class="colHead oneHead">ü§î Another Shot!</div>
        <div class="list" id="oneList">
          <div class="empty">No ‚ÄúAnother Shot!‚Äù yet.</div>
        </div>
      </section>
    </div>

    <div class="footer">
      <button class="btn btn-blue" id="refreshBtn">Refresh</button>
      <button class="btn btn-red" id="clearBtn" title="Clears tonight‚Äôs local display (does not delete anything in Firestore)">Clear Tonight (Local)</button>
    </div>
  </div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
  authDomain: "eyek-vote.firebaseapp.com",
  projectId: "eyek-vote",
  storageBucket: "eyek-vote.firebasestorage.app",
  messagingSenderId: "954696683994",
  appId: "1:954696683994:web:21a84298a94648ff0230e3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* DOM helpers */
const $ = id => document.getElementById(id);
const roundBadge=$('roundBadge'), statusEl=$('status');
const nowHero=$('nowHero');
const encList=$('encList'), oneList=$('oneList');

/* Local session state (kept only while this page is open) */
let eventId=null, eventUnsub=null, autoEventUnsub=null;
let encoreSet = new Set();     // names that achieved Encore
let oneMoreSet = new Set();    // names that achieved Another Shot
let lastIsVotingOpen=false, lastRoundId=null;

/* Render helpers */
function renderLists(){
  const renderSet = (container, set, emptyText) => {
    container.innerHTML = '';
    if(set.size===0){
      const d=document.createElement('div'); d.className='empty'; d.textContent=emptyText; container.appendChild(d); return;
    }
    [...set].sort((a,b)=>a.localeCompare(b)).forEach(name=>{
      const row=document.createElement('div'); row.className='chip';
      row.innerHTML = `<div>${name}</div><small></small>`;
      container.appendChild(row);
    });
  };
  renderSet(encList, encoreSet, 'No Encores yet.');
  renderSet(oneList, oneMoreSet, 'No ‚ÄúAnother Shot!‚Äù yet.');
}

/* Follow host's current event */
autoEventUnsub = db.collection('app').doc('state').onSnapshot(s=>{
  const d=s.data()||{};
  if(d.currentEventId && eventId!==d.currentEventId){
    eventId=d.currentEventId;
    startEventWire();
  }
});

/* Wire-up live event doc */
function startEventWire(){
  if(eventUnsub) eventUnsub();
  encoreSet.clear(); oneMoreSet.clear(); renderLists();

  eventUnsub = db.collection('events').doc(eventId).onSnapshot(async snap=>{
    const d=snap.data()||{};
    const curSinger = (d.currentSingerName||'').trim();
    nowHero.textContent = curSinger ? curSinger : 'Next up soon‚Ä¶';

    const isOpen = !!d.isVotingOpen;
    const roundId = d.roundId || null;

    roundBadge.textContent = roundId || '‚Äî';
    statusEl.textContent = isOpen ? 'Voting Open' : 'Voting Closed';

    // When voting flips from open -> closed, compute that round‚Äôs result and update columns
    if (lastIsVotingOpen && !isOpen && roundId) {
      await tallyRoundAndApply(roundId, curSinger);
    }

    lastIsVotingOpen = isOpen;
    lastRoundId = roundId;
  }, console.error);
}

/* Tally one round from votes and update columns */
async function tallyRoundAndApply(roundId, singerNameFromEvent){
  try{
    const votesSnap = await db.collection('events').doc(eventId)
      .collection('rounds').doc(roundId).collection('votes').get();

    let enc=0, one=0, neg=0;
    votesSnap.forEach(doc=>{
      const v=(doc.data()||{}).choice;
      if(v==='encore') enc++;
      else if(v==='one_more') one++;
      else if(v==='next_time') neg++;
    });

    // winner (strict max; ties do nothing)
    const max = Math.max(enc,one,neg);
    const encWin = (enc===max && enc>one && enc>neg);
    const oneWin = (one===max && one>enc && one>neg);
    const negWin = (neg===max && neg>enc && neg>one);

    // Prefer name from event doc (host sets the current singer there)
    const name = (singerNameFromEvent||'').trim();
    if(!name) { renderLists(); return; }

    if (encWin){
      // Move into Encore set
      oneMoreSet.delete(name);
      encoreSet.add(name);
    } else if (oneWin){
      // Add to Another Shot only if not already Encore
      if (!encoreSet.has(name)) oneMoreSet.add(name);
    } else if (negWin){
      // Remove from both columns
      encoreSet.delete(name); oneMoreSet.delete(name);
    }
    renderLists();
  }catch(e){
    // best-effort; keep page alive
    console.error('Board tally error', e);
  }
}

/* Buttons */
$('refreshBtn').addEventListener('click', renderLists);
$('clearBtn').addEventListener('click', ()=>{
  encoreSet.clear(); oneMoreSet.clear(); renderLists();
});
</script>
</body>
</html>
