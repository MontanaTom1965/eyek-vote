<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke â€“ Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --blue:#003e81; --gold:#eaba54; --purple:#2F0658; --bg:#0f0a18; --card:#1b1430; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    header{padding:22px 16px;background:linear-gradient(90deg,var(--blue),var(--purple));text-align:center}
    .now{font-size:clamp(28px,5.2vw,72px);font-weight:1000;letter-spacing:.02em;margin:0}
    .sub{opacity:.9;margin:6px 0 0;font-size:clamp(14px,2.3vw,24px)}
    .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 12px 32px rgba(0,0,0,.4)}
    .title{font-size:1.3rem;font-weight:900;margin-bottom:8px}
    ul{list-style:none;margin:0;padding:0;min-height:200px}
    li{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#140f25;margin-bottom:10px}
    .who{font-weight:800}
    .song{opacity:.9;font-size:.95rem}
    .muted{opacity:.8}
    @media (max-width:900px){ .cols{grid-template-columns:1fr} }
  </style>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1 class="now" id="nowSinger">Waiting for singerâ€¦</h1>
    <p class="sub" id="nowSong"></p>
  </header>

  <div class="wrap">
    <div class="cols">
      <div class="card">
        <div class="title">ðŸ”¥ Encore!</div>
        <ul id="encoreList"></ul>
      </div>
      <div class="card">
        <div class="title">ðŸ¤” Another Shot!</div>
        <ul id="anotherList"></ul>
      </div>
    </div>
    <p class="muted" style="margin-top:14px">Lists update automatically whenever the host closes voting.</p>
  </div>

<script>
/* Firebase init (your config) */
const firebaseConfig = {
  apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
  authDomain: "eyek-vote.firebaseapp.com",
  projectId: "eyek-vote",
  storageBucket: "eyek-vote.firebasestorage.app",
  messagingSenderId: "954696683994",
  appId: "1:954696683994:web:21a84298a94648ff0230e3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* DOM */
const $ = id => document.getElementById(id);
const nowSingerEl = $('nowSinger');
const nowSongEl   = $('nowSong');
const encoreList  = $('encoreList');
const anotherList = $('anotherList');

/* State */
let eventId=null, roundId=null, isVotingOpen=false;
let appUnsub=null, eventUnsub=null, votesUnsub=null;
const encoreMap = new Map(); // key = canonical singer -> <li>
const anotherMap = new Map();
const processedRounds = new Set();

/* Auto-select current event from Host (app/state) */
appUnsub = db.collection('app').doc('state').onSnapshot(s=>{
  const d = s.data()||{};
  if (d.currentEventId && d.currentEventId !== eventId){
    eventId = d.currentEventId;
    connectEvent();
  }
});

/* Wire event listeners */
function connectEvent(){
  if (eventUnsub) eventUnsub();
  if (votesUnsub) votesUnsub();

  eventUnsub = db.collection('events').doc(eventId).onSnapshot(snap=>{
    const d = snap.data()||{};
    const prevOpen = isVotingOpen;
    const prevRound = roundId;

    roundId = d.roundId || null;
    isVotingOpen = !!d.isVotingOpen;

    // Show current singer while voting is open
    nowSingerEl.textContent = d.currentSingerName || 'Waiting for singerâ€¦';
    nowSongEl.textContent   = d.currentSong ? String(d.currentSong) : '';

    // When a round transitions from open -> closed, decide and update columns
    if (prevOpen && !isVotingOpen && roundId){
      onRoundClosed(eventId, roundId, d.currentSingerName || '', d.currentSong || '');
    }

    // Live voter count not shown here; no need to listen if you donâ€™t want it.
    if (roundId){
      // optional: keep a votes listener if you later want live stats
      if (votesUnsub) { votesUnsub(); votesUnsub=null; }
    } else {
      if (votesUnsub) { votesUnsub(); votesUnsub=null; }
    }
  }, console.error);
}

/* When a round closes â†’ compute outcome and place/move/remove entry */
async function onRoundClosed(eventId, rid, singerName, song){
  if (processedRounds.has(rid)) return; // avoid double-processing
  processedRounds.add(rid);

  try{
    const votesSnap = await db.collection('events').doc(eventId)
                              .collection('rounds').doc(rid)
                              .collection('votes').get();
    let enc=0, one=0, neg=0;
    votesSnap.forEach(doc=>{
      const c = (doc.data()||{}).choice;
      if (c==='encore') enc++;
      else if (c==='one_more') one++;
      else if (c==='next_time') neg++;
    });

    const canonical = canonicalKey(singerName);
    const outcome = decide(enc, one, neg); // 'encore' | 'another' | 'maybe'

    if (outcome === 'encore'){
      moveTo(encoreList, encoreMap, canonical, singerName, song);
      removeFrom(anotherMap);
    } else if (outcome === 'another'){
      moveTo(anotherList, anotherMap, canonical, singerName, song);
      removeFrom(encoreMap);
    } else {
      // maybe another time â†’ remove from both
      removeFrom(encoreMap);
      removeFrom(anotherMap);
    }

  } catch(e){
    console.error('onRoundClosed error:', e);
  }

  // Clear the header when voting has closed and result is placed.
  nowSingerEl.textContent = 'Waiting for singerâ€¦';
  nowSongEl.textContent = '';
}

/* Helpers */
function canonicalKey(name){
  return String(name||'').toLowerCase().trim().replace(/[^\w]+/g,'-').replace(/(^-|-$)/g,'');
}
function decide(enc, one, neg){
  // If Encore ties (or beats) One More and Maybe â†’ Encore wins
  // If One More beats (strictly) Encore and >= Maybe â†’ Another Shot
  // If Maybe is strictly top â†’ treat as "maybe" (remove)
  const max = Math.max(enc,one,neg);
  if (enc === max && enc >= one) return 'encore';
  if (one === max && one > enc) return 'another';
  if (neg === max) return 'maybe';
  // default fallbacks
  if (enc >= one) return 'encore';
  if (one > enc) return 'another';
  return 'maybe';
}
function moveTo(listEl, map, key, name, song){
  // If already exists in the target, just update its text
  let li = map.get(key);
  if (!li){
    li = document.createElement('li');
    li.innerHTML = `
      <div style="min-width:0">
        <div class="who"></div>
        <div class="song"></div>
      </div>
    `;
    map.set(key, li);
    listEl.appendChild(li);
  } else {
    // Ensure it sits at the end (latest results at bottom)
    listEl.appendChild(li);
  }
  li.querySelector('.who').textContent  = name || '(unknown singer)';
  li.querySelector('.song').textContent = song || '';
}
function removeFrom(map){
  return (key)=>{
    const li = map.get(key);
    if (li && li.parentNode) li.parentNode.removeChild(li);
    map.delete(key);
  }
}
</script>
</body>
</html>
