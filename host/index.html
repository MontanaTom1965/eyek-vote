<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EYEK • Host</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c0c12;
    --panel:#12121b;
    --panel-2:#171728;
    --accent:#2F0658;           /* your purple */
    --accent-2:#7a2fd1;
    --text:#f7f7fb;
    --muted:#9aa1b6;
    --ok:#20c997;
    --warn:#ffd24d;
    --err:#ff6b6b;
    --card:#11111a;
    --line:#23233a;
    --chip:#1b1b2c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: radial-gradient(1200px 800px at 10% -10%, #1a0d2c 0%, transparent 60%),
                radial-gradient(1200px 800px at 110% 0%, #130d2c 0%, transparent 55%),
                var(--bg);
    color:var(--text);
    font-family:Montserrat, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  }
  a{color:inherit}
  .wrap{display:grid; grid-template-columns: 290px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto;}
  .sidebar{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:14px; position:sticky; top:12px; height:calc(100dvh - 24px); overflow:auto;}
  .main{display:grid; gap:18px;}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px;}
  .card h2{font-size:18px; margin:0 0 10px; letter-spacing:.2px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .grid-2{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:14px}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="text"], input[type="number"]{
    width:100%; background:var(--card); color:var(--text);
    border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none;
  }
  input:focus{border-color:var(--accent-2); box-shadow:0 0 0 2px #2f065855}
  .btn{
    background:linear-gradient(180deg, var(--accent), #220443);
    padding:10px 14px; border-radius:12px; border:1px solid #3e1781;
    color:#f5eaff; font-weight:700; letter-spacing:.2px; cursor:pointer;
  }
  .btn.secondary{background:var(--chip); border-color:var(--line); color:#e8e8ff}
  .btn.ghost{background:transparent; border:1px solid var(--line); color:#dcdcf3}
  .btn.warn{background:linear-gradient(180deg, #76510b, #4d3708); border-color:#8b680f}
  .btn.ok{background:linear-gradient(180deg, #0b6d4d, #084c37); border-color:#12996e}
  .section-title{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); color:#eaeaff; border:1px solid var(--line); font-size:12px}
  .switch{display:flex; align-items:center; gap:10px}
  .switch input{appearance:none; width:44px; height:24px; background:#3b3b56; border-radius:999px; position:relative; outline:none; cursor:pointer}
  .switch input:checked{background:#3e1781}
  .switch input:before{content:""; width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.2s}
  .switch input:checked:before{left:23px}
  .singers{display:flex; flex-direction:column; gap:8px}
  .singer{
    display:grid; grid-template-columns: 20px 1fr auto; gap:10px; align-items:center;
    padding:10px; border:1px solid var(--line); border-radius:12px; background:var(--panel-2);
  }
  .bullet{width:10px; height:10px; border-radius:50%}
  .bullet.green{background:var(--ok)}
  .bullet.yellow{background:var(--warn)}
  .singer-name{font-weight:700}
  .singer-actions{display:flex; gap:8px}
  .collapsible{border-radius:14px; overflow:hidden; border:1px solid var(--line)}
  .collapsible summary{
    list-style:none; cursor:pointer; padding:14px 16px; background:linear-gradient(180deg, #1a1430, #121226);
    border-bottom:1px solid var(--line); font-weight:700; display:flex; justify-content:space-between; align-items:center;
  }
  .collapsible summary::marker{display:none}
  .collapsible .content{padding:16px; background:var(--panel)}
  .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .timer{font-size:28px; font-weight:800; letter-spacing:.5px}
  .readout{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .readout .box{
    background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; min-width:120px; text-align:center;
  }
  .muted{color:var(--muted)}
  .mini{font-size:12px}
  .success{color:var(--ok)}
  .warn-txt{color:var(--warn)}
  .err-txt{color:var(--err)}
  .divider{height:1px; background:var(--line); margin:8px 0}
  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr}
    .sidebar{position:relative; height:auto}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Singer queue -->
    <aside class="sidebar">
      <div class="section-title">
        <h2 style="margin:0">Singers</h2>
        <span class="chip">Queue</span>
      </div>

      <div id="singers" class="singers"></div>

      <div class="divider"></div>

      <div class="label">Add singer (name only)</div>
      <div class="row">
        <input id="newSingerName" type="text" placeholder="Singer name…" />
        <button class="btn secondary" id="addSingerBtn">Add Singer</button>
      </div>

      <p class="mini muted" style="margin-top:10px">
        • Bullet left of name: <span class="success">green</span>=Encore! indicator, <span class="warn-txt">yellow</span>=Another Shot! indicator (visual only).<br/>
        • Use <b>Set</b> to make them current. <b>Remove</b> deletes from the queue.
      </p>
    </aside>

    <!-- RIGHT: Main panels -->
    <main class="main">

      <!-- Top bar -->
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip">Host Console</span>
          <a class="chip" href="/screen/" target="_blank">Open Screen</a>
          <a class="chip" href="/vote/" target="_blank">Open Voter Page</a>
          <a class="chip" href="/board/" target="_blank">Open Board</a>
        </div>
        <label class="switch">
          <input type="checkbox" id="soundToggle">
          <span class="mini">Enable sound</span>
        </label>
      </div>

      <!-- Collapsible: Event Setup -->
      <details id="eventSetup" class="collapsible" open>
        <summary>
          <span>Event Setup</span>
          <span class="mini muted">click to collapse</span>
        </summary>
        <div class="content">
          <div class="grid-2">
            <div>
              <div class="label">Venue</div>
              <input id="venue" type="text" placeholder="Venue name…" />
            </div>
            <div>
              <div class="label">KJ / Host</div>
              <input id="kj" type="text" placeholder="KJ name…" />
            </div>
          </div>
          <div class="row" style="margin-top:12px; justify-content:flex-end">
            <button class="btn" id="saveEventBtn">Save Event</button>
          </div>
        </div>
      </details>

      <!-- Singer Section -->
      <section class="card">
        <div class="section-title">
          <h2>Singer</h2>
          <span class="chip">Current & Add</span>
        </div>

        <div class="grid-2">
          <div>
            <div class="label">Singer</div>
            <input id="currentSingerName" type="text" placeholder="(Set from sidebar or type here…)" />
          </div>
          <div>
            <div class="label">Song / Artist</div>
            <input id="currentSong" type="text" placeholder="e.g., “Tennessee Whiskey – Chris Stapleton”" />
          </div>
        </div>

        <div class="row" style="margin-top:12px; justify-content:flex-end">
          <button class="btn secondary" id="clearCurrentBtn">Clear Current</button>
          <button class="btn ok" id="pushCurrentToQueueBtn">Add to Queue</button>
          <button class="btn" id="setCurrentBtn">Set As Current</button>
        </div>
      </section>

      <!-- Voting Section -->
      <section class="card">
        <div class="section-title">
          <h2>Voting</h2>
          <span class="chip">Control</span>
        </div>

        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="readout">
            <div class="box">
              <div class="mini muted">Timer</div>
              <div class="timer" id="timer">00:30</div>
            </div>
            <div class="box">
              <div class="mini muted">Votes</div>
              <div id="voteCounts">Encore 0 • Shot 0 • Next 0</div>
            </div>
            <div class="box" id="voteResultBox" style="display:none">
              <div class="mini muted">Result</div>
              <div id="voteResultText" style="font-weight:800">—</div>
            </div>
          </div>

          <div class="bar">
            <button class="btn" id="startVoteBtn">Start (30s)</button>
            <button class="btn secondary" id="extendVoteBtn">+15s</button>
            <button class="btn warn" id="endVoteBtn">End Now</button>
            <button class="btn ghost" id="resetVoteBtn">Reset</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="margin-top:6px">
          <h2>Host Vote</h2>
          <span class="chip">Optional</span>
        </div>

        <div class="row">
          <button class="btn ok" id="hostEncoreBtn">Encore!</button>
          <button class="btn" style="background:linear-gradient(180deg,#6f5c1b,#4b3f13);border-color:#9a8227" id="hostShotBtn">Another Shot!</button>
          <button class="btn" style="background:linear-gradient(180deg,#5e1f1f,#3f1515);border-color:#8a2f2f" id="hostNextBtn">Maybe Next Time</button>
        </div>

      </section>

      <!-- Footer tools -->
      <section class="card">
        <div class="section-title">
          <h2>Tools</h2>
          <span class="chip">Maintenance</span>
        </div>
        <div class="row">
          <button class="btn warn" id="resetEventBtn">Reset Event (venue, KJ, queue, tallies)</button>
        </div>
      </section>
    </main>
  </div>

<script>
/* ---------- State (localStorage-first; your screen/vote pages can keep polling your shared JSON if you have that wired) ---------- */
const LS_KEY = "eyek_state_v3";
const el = id => document.getElementById(id);

const state = {
  venue: "",
  kj: "",
  current: { singer:"", song:"" },
  queue: [], // [{id, name, color:'green'|'yellow'}]
  voting: {
    open:false,
    // seconds remaining on timer
    remaining: 30,
    // tallies
    encore:0, shot:0, next:0,
    ended:false, result:null  // "Encore" | "Another Shot" | "Maybe Next Time" | null
  },
  soundEnabled:false
};

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    Object.assign(state, s);
  }catch(_){}
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* ---------- Render helpers ---------- */
function renderEvent(){
  el("venue").value = state.venue || "";
  el("kj").value    = state.kj || "";
}

function renderCurrent(){
  el("currentSingerName").value = state.current.singer || "";
  el("currentSong").value       = state.current.song || "";
}

function bullet(color){
  const span = document.createElement("span");
  span.className = "bullet " + (color || "green");
  return span;
}

function singerRow(item){
  const row = document.createElement("div");
  row.className = "singer";
  row.dataset.id = item.id;

  const b = bullet(item.color || "green");
  const name = document.createElement("div");
  name.className = "singer-name";
  name.textContent = item.name;

  const actions = document.createElement("div");
  actions.className = "singer-actions";

  const setBtn = document.createElement("button");
  setBtn.className = "btn secondary";
  setBtn.textContent = "Set";
  setBtn.onclick = () => {
    state.current.singer = item.name;
    renderCurrent();
    save();
    // optional: broadcastCurrent();
  };

  const remBtn = document.createElement("button");
  remBtn.className = "btn ghost";
  remBtn.textContent = "Remove";
  remBtn.onclick = () => {
    state.queue = state.queue.filter(q => q.id !== item.id);
    renderQueue();
    save();
  };

  actions.append(setBtn, remBtn);
  row.append(b, name, actions);
  return row;
}

function renderQueue(){
  const box = el("singers");
  box.innerHTML = "";
  if(!state.queue.length){
    const p = document.createElement("p");
    p.className = "mini muted";
    p.textContent = "No singers yet. Add one below.";
    box.append(p);
    return;
  }
  state.queue.forEach(item => box.append(singerRow(item)));
}

function renderVoting(){
  // timer
  const m = Math.floor(state.voting.remaining/60).toString().padStart(2,"0");
  const s = (state.voting.remaining%60).toString().padStart(2,"0");
  el("timer").textContent = `${m}:${s}`;

  // tallies
  el("voteCounts").textContent = `Encore ${state.voting.encore} • Shot ${state.voting.shot} • Next ${state.voting.next}`;

  // result box
  if(state.voting.ended && state.voting.result){
    el("voteResultBox").style.display = "";
    el("voteResultText").textContent = state.voting.result;
    el("voteResultText").style.color =
      state.voting.result === "Encore!" ? "var(--ok)" :
      state.voting.result === "Another Shot!" ? "var(--warn)" :
      "var(--err)";
  }else{
    el("voteResultBox").style.display = "none";
    el("voteResultText").textContent = "—";
  }

  // buttons enabling
  el("startVoteBtn").disabled = state.voting.open;
  el("extendVoteBtn").disabled = !state.voting.open;
  el("endVoteBtn").disabled = !state.voting.open;
}

function renderSound(){
  el("soundToggle").checked = !!state.soundEnabled;
}

/* ---------- Timer + voting logic (host vote buttons just add to tallies; they NEVER auto-end voting) ---------- */
let timerHandle = null;

function startVoting(){
  state.voting.open = true;
  state.voting.ended = false;
  state.voting.result = null;
  state.voting.remaining = 30;
  renderVoting(); save();
  tick();
  playIfEnabled('/assets/voting_open.mp3');
}

function extendVoting(){
  if(!state.voting.open) return;
  state.voting.remaining += 15;
  renderVoting(); save();
}

function endVoting(){
  if(!state.voting.open) return;
  state.voting.open = false;
  state.voting.ended = true;
  // Decide winner
  const {encore, shot, next} = state.voting;
  let result = "Encore!";
  if(shot >= encore && shot >= next) result = "Another Shot!";
  if(next >  encore && next >= shot) result = "Maybe Next Time!";
  state.voting.result = result;
  renderVoting(); save();

  // Sounds when voting over and result
  playIfEnabled('/assets/voting_over.mp3');
  setTimeout(()=> {
    if(result === "Encore!") playIfEnabled('/assets/encore.mp3');
    else if(result === "Maybe Next Time!") playIfEnabled('/assets/loser.wav');
    // (You said you’ll add a sound later for “Another Shot!”)
  }, 600);
}

function resetVoting(){
  state.voting = {open:false, remaining:30, encore:0, shot:0, next:0, ended:false, result:null};
  clearInterval(timerHandle); timerHandle=null;
  renderVoting(); save();
}

function tick(){
  clearInterval(timerHandle);
  timerHandle = setInterval(()=>{
    if(!state.voting.open) { clearInterval(timerHandle); timerHandle=null; return; }
    if(state.voting.remaining <= 0){
      clearInterval(timerHandle); timerHandle=null;
      endVoting();
      return;
    }
    state.voting.remaining -= 1;
    renderVoting(); save();
  }, 1000);
}

/* ---------- Sound ---------- */
let audioCache = {};
function playIfEnabled(src){
  if(!state.soundEnabled) return;
  if(!audioCache[src]){
    const a = new Audio(src);
    audioCache[src] = a;
  }
  audioCache[src].currentTime = 0;
  audioCache[src].play().catch(()=>{ /* ignore autoplay issues if toggle wasn’t clicked */ });
}

/* ---------- Event handlers ---------- */
function wire(){
  // Event setup save
  el("saveEventBtn").onclick = () => {
    state.venue = el("venue").value.trim();
    state.kj    = el("kj").value.trim();
    save(); renderEvent();
    // collapse after save
    el("eventSetup").open = false;
  };

  // Add singer (sidebar)
  el("addSingerBtn").onclick = () => {
    const name = el("newSingerName").value.trim();
    if(!name) return;
    state.queue.push({ id:crypto.randomUUID(), name, color:"green" });
    el("newSingerName").value = "";
    renderQueue(); save();
  };

  // Current singer controls
  el("setCurrentBtn").onclick = () => {
    state.current.singer = el("currentSingerName").value.trim();
    state.current.song   = el("currentSong").value.trim();
    save(); renderCurrent();
  };
  el("pushCurrentToQueueBtn").onclick = () => {
    const name = el("currentSingerName").value.trim();
    if(!name) return;
    state.queue.push({ id:crypto.randomUUID(), name, color:"green" });
    renderQueue(); save();
  };
  el("clearCurrentBtn").onclick = () => {
    state.current = {singer:"", song:""}; save(); renderCurrent();
  };

  // Voting control
  el("startVoteBtn").onclick  = startVoting;
  el("extendVoteBtn").onclick = extendVoting;
  el("endVoteBtn").onclick    = endVoting;
  el("resetVoteBtn").onclick  = resetVoting;

  // Host vote (adds to tallies only; does NOT auto-end)
  el("hostEncoreBtn").onclick = () => { state.voting.encore++; renderVoting(); save(); };
  el("hostShotBtn").onclick   = () => { state.voting.shot++;   renderVoting(); save(); };
  el("hostNextBtn").onclick   = () => { state.voting.next++;   renderVoting(); save(); };

  // Reset event
  el("resetEventBtn").onclick = () => {
    if(!confirm("Reset entire event (venue, KJ, queue, current, votes)?")) return;
    state.venue=""; state.kj="";
    state.current = {singer:"", song:""};
    state.queue = [];
    resetVoting();
    save(); renderEvent(); renderCurrent(); renderQueue();
    el("eventSetup").open = true;
  };

  // Sound toggle
  el("soundToggle").onchange = (e)=> {
    state.soundEnabled = !!e.target.checked; save();
    // Try to unlock autoplay policies by playing a tiny blip (muted) after user gesture
    if(state.soundEnabled){
      const test = new Audio('/assets/voting_open.mp3');
      test.volume = 0.0;
      test.play().catch(()=>{});
      setTimeout(()=>{ test.pause(); }, 200);
    }
  };
}

/* ---------- Init ---------- */
load();
wire();
renderEvent();
renderCurrent();
renderQueue();
renderVoting();
renderSound();
</script>
</body>
</html>
