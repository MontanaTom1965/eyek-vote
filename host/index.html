<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EYEK • Host</title>
<style>
  :root{
    --bg:#0f031a; --ink:#f7f2ff; --muted:#cbb3ff; --brand:#2F0658;
    --card:#12141a; --card2:#171a22;
    --ok:#19c37d; --warn:#f6c34a; --bad:#ff5c5c; --link:#7fd1ff;
    --outline:rgba(255,255,255,.12); --outline2:rgba(255,255,255,.22);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
    min-height:100dvh;
    background:
      radial-gradient(1200px 800px at 10% -10%,#3c1181 0%,#2F0658 22%,#1b0930 52%,#0f031a 100%),
      #0f031a;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 18px; background:#1a0f2b; border-bottom:1px solid var(--outline2);
    position:sticky; top:0; z-index:10;
  }
  h1{margin:0;font-size:18px;letter-spacing:.4px}
  .links a{color:var(--link);text-decoration:none;margin-left:10px}

  .wrap{display:grid;grid-template-columns:240px 1fr;gap:12px;padding:12px}
  .card{background:var(--card); border:1px solid var(--outline); border-radius:14px; padding:12px}
  .card2{background:var(--card2); border:1px solid var(--outline); border-radius:14px; padding:12px}
  .card h2,.card2 h2{margin:0 0 8px; font-size:15px; color:#eadaff}
  label{font-size:12px;color:var(--muted)}
  input,button,textarea{
    font-size:14px; color:var(--ink);
    background:#0f1116; border:1px solid var(--outline); border-radius:10px; padding:9px 10px;
  }
  input[readonly]{opacity:.85}

  /* compact inline buttons (not full width) */
  .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;border:1px solid var(--outline);background:#13151c;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .right{margin-left:auto}
  .muted{font-size:12px;color:var(--muted)}

  /* Sidebar rotation (names only) */
  .singers{display:flex;flex-direction:column;gap:8px;max-height:66dvh;overflow:auto}
  .singer{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid var(--outline);background:#141821}
  .singer .name{font-weight:600}
  .badge{margin-left:auto;border-radius:999px;padding:3px 8px;font-size:12px;border:1px solid var(--outline)}
  .b-encore{background:rgba(25,195,125,.16);border-color:rgba(25,195,125,.45)}
  .b-another{background:rgba(246,195,74,.16);border-color:rgba(246,195,74,.45)}

  /* Voting section */
  .timer{font-size:32px;font-weight:900}
  .voteBtns{display:flex;gap:10px;flex-wrap:wrap}
  .v{display:inline-flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.3px;
     padding:14px 18px;border-radius:12px;border:2px solid rgba(0,0,0,.25);cursor:pointer;min-width:170px}
  .v:active{transform:translateY(1px)}
  .v.green{background:var(--ok); color:#052817}
  .v.yellow{background:var(--warn); color:#3b2a00}
  .v.red{background:var(--bad); color:#2d0000}

  /* Inline counters + mini dots */
  .counters{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .ctr{background:#0f1116;border:1px solid var(--outline);border-radius:10px;padding:10px}
  .ctr h3{margin:0 0 4px;font-size:12px;color:#eadaff}
  .ctr .num{font-size:28px;font-weight:900}
  .dots{position:relative;height:26px;margin-top:6px;background:#0b0d12;border:1px dashed rgba(255,255,255,.1);border-radius:999px;overflow:hidden}
  .dot{position:absolute;width:8px;height:8px;border-radius:50%;opacity:.9;animation:bounce .8s ease-out}
  @keyframes bounce{0%{transform:translateY(-16px)}60%{transform:translateY(18px)}100%{transform:translateY(8px)}}

  /* Collapsible Setup (compact) */
  details.setup summary{
    list-style:none; cursor:pointer; padding:8px 10px; border:1px solid var(--outline);
    background:#141821; border-radius:10px; display:flex; align-items:center; gap:8px;
  }
  details.setup[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
  details.setup .content{border:1px solid var(--outline); border-top:none; border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding:10px;background:#0f1116}
</style>
</head>
<body>
  <header>
    <h1>EYEK • Host</h1>
    <div class="links">
      <a href="/host/" target="_blank">Host</a>
      <a href="/screen/" target="_blank">Screen</a>
      <a href="/board/" target="_blank">Board</a>
      <a href="/vote/" target="_blank">Vote</a>
    </div>
  </header>

  <div class="wrap">
    <!-- Sidebar: Rotation (names only) -->
    <aside class="card2">
      <h2>Rotation</h2>
      <div id="singerList" class="singers"></div>
    </aside>

    <!-- Main -->
    <main class="stack">
      <!-- Collapsible, compact setup -->
      <section class="card2">
        <details class="setup" open>
          <summary>
            <strong>Event & KJ Setup</strong>
            <span class="muted" style="margin-left:auto">compact controls</span>
          </summary>
          <div class="content">
            <div class="grid2">
              <div>
                <label>Venue (internal)</label>
                <input id="venue" list="venues" placeholder="e.g., The Blue Ox"/>
                <datalist id="venues"></datalist>
              </div>
              <div>
                <label>Public Venue Name (screen)</label>
                <input id="venuePublic" placeholder="Shown on Screen/Vote"/>
              </div>
            </div>
            <div class="grid2" style="margin-top:8px">
              <div>
                <label>Date</label>
                <input id="eventDate" type="date"/>
              </div>
              <div>
                <label>KJ Company</label>
                <input id="kjCompany" list="kjcos" placeholder="Company"/>
                <datalist id="kjcos"></datalist>
              </div>
            </div>
            <div class="grid2" style="margin-top:8px">
              <div>
                <label>Karaoke Host Name</label>
                <input id="hostName" placeholder="Your name"/>
              </div>
              <div>
                <label>Event PIN</label>
                <div class="row">
                  <input id="pin" inputmode="numeric" pattern="\\d*" placeholder="4–6 digits" style="width:140px"/>
                  <button id="togglePin" class="btn">Show</button>
                  <button id="lockEvent" class="btn">Lock</button>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="saveEvent" class="btn">Save</button>
              <button id="resetAll" class="btn" title="Clear singers & votes">Reset</button>
              <span class="muted right">Sound: <a href="#" id="enableSound">Enable</a></span>
            </div>
          </div>
        </details>
      </section>

      <!-- Add Singer (single field for Song/Artist) -->
      <section class="card">
        <h2>Add Singer</h2>
        <div class="grid2">
          <input id="newSinger" placeholder="Singer name"/>
          <button id="addSingerBtn" class="btn">Add</button>
        </div>
        <div style="margin-top:8px">
          <input id="songLine" placeholder="Song / Artist (single field, optional)"/>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="setCurrent" class="btn">Set current singer</button>
          <button id="removeSinger" class="btn">Remove selected</button>
        </div>
      </section>

      <!-- Voting (big color buttons, countdown, inline counters) -->
      <section class="card">
        <h2>Voting</h2>
        <div class="row" style="align-items:center">
          <div class="muted">Now up: <span id="nowUp">—</span></div>
          <div class="right timer" id="timer">00:00</div>
        </div>

        <div class="voteBtns" style="margin-top:8px">
          <button class="v green"  id="btnEncore"  title="E key">Encore</button>
          <button class="v yellow" id="btnAnother" title="A key">Another Shot</button>
          <button class="v red"    id="btnMaybe"   title="M key">Maybe Next Time</button>
        </div>

        <div class="counters">
          <div class="ctr"><h3>Encore</h3><div class="num" id="encoreNum">0</div><div class="dots" id="encoreDots"></div></div>
          <div class="ctr"><h3>Another Shot</h3><div class="num" id="anotherNum">0</div><div class="dots" id="anotherDots"></div></div>
          <div class="ctr"><h3>Maybe Next Time</h3><div class="num" id="maybeNum">0</div><div class="dots" id="maybeDots"></div></div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="startBtn"  class="btn">Start (5s prep → 30s)</button>
          <button id="extendBtn" class="btn">Extend +15s</button>
          <button id="endBtn"    class="btn">End</button>
          <span id="voteState" class="muted right">Closed</span>
        </div>
      </section>
    </main>
  </div>

  <!-- HOST-ONLY AUDIO -->
  <audio id="aLoop" loop preload="auto"></audio>
  <audio id="aWin" preload="auto"></audio>
  <audio id="aLose" preload="auto"></audio>

<script>
const S = {
  device:(localStorage.getItem('eyek_device')||crypto.randomUUID()).slice(0,18),
  state:{phase:'closed',endsAt:0,prepUntil:0,singer:null,counts:{encore:0,another:0,maybe:0}},
  singers:[], selIndex:-1, pinVisible:false,
  ep:{get:'/assets/get_state.php', set:'/assets/state.php', vote:'/assets/vote.php', perf:'/assets/submit_performance.php'}
};
localStorage.setItem('eyek_device', S.device);
const $=id=>document.getElementById(id);

// datalists mirrors
function loadDL(){
  const venues=JSON.parse(localStorage.getItem('eyek_venues')||'[]');
  const kjcos =JSON.parse(localStorage.getItem('eyek_kjcos' )||'[]');
  $('venues').innerHTML=venues.map(v=>`<option value="${v}">`).join('');
  $('kjcos').innerHTML  =kjcos .map(v=>`<option value="${v}">`).join('');
}
loadDL();

// Save (compact)
$('saveEvent').onclick = async ()=>{
  const v=$('venue').value.trim(), vp=$('venuePublic').value.trim(), d=$('eventDate').value;
  const kc=$('kjCompany').value.trim(), hn=$('hostName').value.trim(), pin=$('pin').value.trim();
  if(!/^[0-9]{4,6}$/.test(pin)){ alert('PIN must be 4–6 digits'); return; }
  const pushU=(k,val)=>{const arr=JSON.parse(localStorage.getItem(k)||'[]'); if(val && !arr.includes(val)){arr.push(val); localStorage.setItem(k,JSON.stringify(arr));}};
  pushU('eyek_venues',v); pushU('eyek_kjcos',kc); loadDL();
  await fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({venue:v,venuePublic:vp,date:d,kjCompany:kc,hostName:hn,pin})});
};

// PIN show/hide + Lock (UI only)
$('togglePin').onclick = ()=>{ S.pinVisible=!S.pinVisible; $('togglePin').textContent=S.pinVisible?'Hide':'Show'; $('pin').type=S.pinVisible?'text':'password'; };
$('lockEvent').onclick  = ()=>{ $('lockEvent').textContent = $('lockEvent').textContent==='Lock'?'Unlock':'Lock'; };

// Reset (compact)
$('resetAll').onclick = async ()=>{
  if(!confirm('Reset all singers and votes?')) return;
  S.singers=[]; S.selIndex=-1; renderSingers();
  await fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reset:true})});
  setCounts(0,0,0);
};

// Sound (host only)
const aLoop=$('aLoop'), aWin=$('aWin'), aLose=$('aLose');
const ext = (document.createElement('audio').canPlayType('audio/mpeg')?'mp3':'wav');
aLoop.src=`/assets/voting_open.${ext}`; aWin.src=`/assets/encore.${ext}`; aLose.src=`/assets/loser.${ext}`;
$('enableSound').onclick = async e=>{ e.preventDefault(); try{ await aLoop.play(); aLoop.pause(); alert('Sound enabled on this laptop.'); }catch{} };

// Rotation (names only)
const list=$('singerList');
function renderSingers(){
  list.innerHTML=S.singers.map((s,i)=>{
    const badge=s.badge?`<span class="badge ${s.badge==='encore'?'b-encore':'b-another'}">${s.badge==='encore'?'Encore':'Another'}</span>`:'';
    return `<label class="singer" data-i="${i}"><input type="radio" name="sel" ${i===S.selIndex?'checked':''} style="accent-color:#7fd1ff"/><div class="name">${s.name}</div>${badge}</label>`;
  }).join('');
  list.querySelectorAll('.singer').forEach(el=>el.onclick=()=>{S.selIndex=+el.dataset.i; renderSingers();});
}
$('addSingerBtn').onclick=()=>{ const nm=$('newSinger').value.trim(); if(!nm) return; S.singers.push({name:nm,badge:null}); $('newSinger').value=''; renderSingers(); };
$('removeSinger').onclick =()=>{ if(S.selIndex<0) return; S.singers.splice(S.selIndex,1); S.selIndex=-1; renderSingers(); };

$('setCurrent').onclick = async ()=>{
  if(S.selIndex<0){alert('Select a singer from the list.');return}
  const s=S.singers[S.selIndex];
  const songLine=$('songLine').value.trim(); // single field
  setCounts(0,0,0);
  await fetch(S.ep.perf,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current:s.name, songLine})});
  await fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current:s.name})});
};

// Timer sync helpers
let serverOffsetMs=0;
function updateOffsetFrom(st){
  if(typeof st.serverNow==='number'){ if(!window.__serverOffsetMs) window.__serverOffsetMs = st.serverNow - Date.now(); serverOffsetMs = window.__serverOffsetMs; }
}
const nowMs=()=>Date.now()+(serverOffsetMs||0);

// Mini dots
const dots={encore:$('encoreDots'), another:$('anotherDots'), maybe:$('maybeDots')};
function addMiniDot(which){
  const d=document.createElement('div'); d.className='dot';
  d.style.left=(Math.random()*96)+'%';
  d.style.background = which==='encore'? '#0d5' : which==='another'? '#e9b400' : '#ff6b6b';
  dots[which].appendChild(d); setTimeout(()=>d.remove(),1100);
}

const encoreNum=$('encoreNum'), anotherNum=$('anotherNum'), maybeNum=$('maybeNum');
function setCounts(e,a,m){encoreNum.textContent=e; anotherNum.textContent=a; maybeNum.textContent=m}

// Polling
let prev={encore:0,another:0,maybe:0,winner:null};
setInterval(async()=>{
  try{
    const r=await fetch(S.ep.get); const st=await r.json(); S.state=st; updateOffsetFrom(st);
    $('voteState').textContent = st.phase==='open'?'Open':(st.phase==='prep'?'Get ready…':'Closed');
    $('nowUp').textContent = st.singer||'—';

    const left = st.phase==='prep'
      ? Math.max(0, Math.ceil((st.prepUntil - nowMs())/1000))
      : st.phase==='open'
      ? Math.max(0, Math.ceil((st.endsAt   - nowMs())/1000))
      : 0;
    $('timer').textContent = new Date(left*1000).toISOString().substring(14,19);

    const c=st.counts||{encore:0,another:0,maybe:0};
    setCounts(c.encore||0,c.another||0,c.maybe||0);
    ['encore','another','maybe'].forEach(k=>{
      const cur=c[k]||0; const old=prev[k]||0; if(cur>old){ for(let i=0;i<cur-old;i++) addMiniDot(k); } prev[k]=cur;
    });

    if(st.winner && st.winType && st.winner!==prev.winner){
      prev.winner=st.winner;
      if(st.winType==='encore'){ aWin.currentTime=0; aWin.play().catch(()=>{}); }
      else { aLose.currentTime=0; aLose.play().catch(()=>{}); }
    }
  }catch(e){}
},700);

// Start/Extend/End
$('startBtn').onclick = async ()=>{
  const current=S.singers[S.selIndex]?.name || S.state.singer;
  const songLine=$('songLine').value.trim();
  if(current){ await fetch(S.ep.perf,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current,songLine,ts:Date.now()})}); }
  fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'start',prep:5,open:30})});
};
$('extendBtn').onclick=()=>fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'extend',add:15})});
$('endBtn').onclick   =()=>fetch(S.ep.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'end'})});

// Host quick-vote buttons + keyboard shortcuts
function hostVote(pick){ fetch(S.ep.vote,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pick,device:S.device,host:true})}); }
$('btnEncore').onclick = ()=>hostVote('encore');
$('btnAnother').onclick= ()=>hostVote('another');
$('btnMaybe').onclick  = ()=>hostVote('maybe');
addEventListener('keydown',e=>{
  if(e.key==='e' || e.key==='E') hostVote('encore');
  if(e.key==='a' || e.key==='A') hostVote('another');
  if(e.key==='m' || e.key==='M') hostVote('maybe');
});

// Loop sound strictly on open/closed
let loopOn=false;
setInterval(()=>{
  const p=S.state.phase;
  if(p==='open' && !loopOn){ aLoop.currentTime=0; aLoop.play().catch(()=>{}); loopOn=true; }
  if(p!=='open' && loopOn){ aLoop.pause(); loopOn=false; }
},300);

renderSingers();
</script>
<!-- filename: /host/index.html -->
</body>
</html>
