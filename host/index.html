<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EYEK ‚Ä¢ Host</title>
<link rel="icon" href="../assets/eyek-icon.png" />
<style>
  :root{
    --bg:#0b1120; --panel:#111827; --muted:#9ca3af; --fg:#e5e7eb;
    --accent:#22d3ee; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:16px 16px 48px}
  .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);margin-bottom:16px}
  h1{margin:8px 0 12px;font-size:24px}
  h2{margin:0 0 12px;font-size:18px;color:var(--muted)}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:14px}
  input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:#0f172a;color:var(--fg)}
  .row{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .col6{grid-column:span 6}
  .col4{grid-column:span 4}
  .col8{grid-column:span 8}
  .col12{grid-column:span 12}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #1f2937;background:#0f172a;color:var(--fg);cursor:pointer}
  .btn:hover{background:#111827}
  .btn.primary{background:linear-gradient(90deg,#22d3ee,#60a5fa);color:#001018;border:none}
  .btn.good{background:#10b981;color:#00140f;border:none}
  .btn.warn{background:#f59e0b;color:#1b1000;border:none}
  .btn.bad{background:#ef4444;color:#220405;border:none}
  .stack{display:flex;flex-wrap:wrap;gap:10px}
  details{border:1px solid #1f2937;border-radius:12px;overflow:hidden}
  summary{cursor:pointer;list-style:none;padding:14px 16px;background:#0f172a;color:var(--fg);font-weight:600}
  summary::-webkit-details-marker{display:none}
  details .inner{padding:16px;background:var(--panel)}
  .line{height:1px;background:#1f2937;margin:8px 0 16px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;font-size:12px;color:var(--muted)}
  .live{color:#10b981}
</style>
</head>
<body>
<div class="wrap">
  <h1>Host Controls</h1>

  <div class="card">
    <details id="eventBox" open>
      <summary>
        Event Setup
        <span id="lockPill" class="pill" style="margin-left:10px">Unlocked</span>
      </summary>
      <div class="inner">
        <div class="row">
          <div class="col6">
            <label>Venue</label>
            <input id="venue" placeholder="Venue name">
          </div>
          <div class="col6">
            <label>KJ</label>
            <input id="kj" placeholder="Host/KJ name">
          </div>
          <div class="col4">
            <label>PIN (current)</label>
            <input id="pin" placeholder="Enter PIN to control" type="password">
          </div>
          <div class="col4">
            <label>Set/Change PIN (new)</label>
            <input id="newPin" placeholder="New PIN (optional)" type="password">
          </div>
          <div class="col4" style="display:flex;align-items:end">
            <button class="btn primary" id="saveConfig">Save / Update</button>
          </div>
        </div>

        <div class="line"></div>

        <div class="stack">
          <button class="btn" id="lockBtn">üîí Lock</button>
          <button class="btn warn" id="unlockBtn">üîì Unlock</button>
          <button class="btn bad" id="resetBtn">üóëÔ∏è Reset Event</button>
          <span class="pill">Phase: <span id="phaseLabel" class="live">welcome</span></span>
        </div>
      </div>
    </details>
  </div>

  <div class="card">
    <h2>Current Singer</h2>
    <div class="row">
      <div class="col6">
        <label>Singer</label>
        <input id="singer" placeholder="Singer name">
      </div>
      <div class="col6">
        <label>Song ‚Ä¢ Artist</label>
        <input id="song" placeholder="Song ‚Äì Artist">
      </div>
      <div class="col12" style="margin-top:10px">
        <div class="stack">
          <button class="btn primary" id="showWelcome">Show Welcome</button>
          <button class="btn" id="startSong">Start / Show Performing</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Results</h2>
    <div class="stack">
      <button class="btn good" id="resEncore">Encore!</button>
      <button class="btn warn" id="resAnother">Another Shot</button>
      <button class="btn bad"  id="resMaybe">Maybe Next Time</button>
    </div>
  </div>

  <div class="card">
    <h2>Status</h2>
    <div class="row">
      <div class="col4"><label>Venue</label><div id="liveVenue" class="pill"></div></div>
      <div class="col4"><label>KJ</label><div id="liveKJ" class="pill"></div></div>
      <div class="col4"><label>Locked</label><div id="liveLocked" class="pill"></div></div>
      <div class="col6"><label>Current Singer</label><div id="liveSinger" class="pill"></div></div>
      <div class="col6"><label>Song</label><div id="liveSong" class="pill"></div></div>
    </div>
  </div>
</div>

<script>
const API = '../assets/api/state.php';

async function getState() {
  const r = await fetch(API + '?t=' + Date.now());
  return r.json();
}
async function post(action, payload={}) {
  const r = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, ...payload})
  });
  if(!r.ok){ const t = await r.text(); throw new Error(t || r.statusText); }
  return r.json();
}

// UI els
const els = {
  venue: qs('#venue'), kj: qs('#kj'), pin: qs('#pin'), newPin: qs('#newPin'),
  singer: qs('#singer'), song: qs('#song'),
  saveConfig: qs('#saveConfig'), lockBtn: qs('#lockBtn'), unlockBtn: qs('#unlockBtn'), resetBtn: qs('#resetBtn'),
  showWelcome: qs('#showWelcome'), startSong: qs('#startSong'),
  resEncore: qs('#resEncore'), resAnother: qs('#resAnother'), resMaybe: qs('#resMaybe'),
  liveVenue: qs('#liveVenue'), liveKJ: qs('#liveKJ'), liveLocked: qs('#liveLocked'),
  liveSinger: qs('#liveSinger'), liveSong: qs('#liveSong'), phaseLabel: qs('#phaseLabel'),
  lockPill: qs('#lockPill')
};

function qs(s){return document.querySelector(s);}

function pinPayload() {
  const pin = (els.pin.value || '').trim();
  return { pin };
}

function applyState(s){
  els.liveVenue.textContent = s.venue || '‚Äî';
  els.liveKJ.textContent    = s.kj || '‚Äî';
  els.liveLocked.textContent= s.locked ? 'Locked' : 'Unlocked';
  els.phaseLabel.textContent= s.phase;
  els.lockPill.textContent  = s.locked ? 'Locked' : 'Unlocked';
  els.liveSinger.textContent= s.current?.singer || '‚Äî';
  els.liveSong.textContent  = s.current?.song || '‚Äî';

  // Pre-fill inputs if empty
  if (!els.venue.value) els.venue.value = s.venue || '';
  if (!els.kj.value)    els.kj.value    = s.kj || '';
}

async function refresh(){
  try{ applyState(await getState()); }catch(e){ console.error(e); }
}
setInterval(refresh, 2500);
refresh();

// Actions
els.saveConfig.onclick = async () => {
  try{
    const payload = {
      ...pinPayload(),
      venue: els.venue.value.trim(),
      kj: els.kj.value.trim()
    };
    const newPin = els.newPin.value.trim();
    if (newPin) payload.newPin = newPin;
    const res = await post('set_config', payload);
    els.newPin.value = '';
    applyState(res.state);
    alert('Saved.');
  }catch(e){ alert(parseErr(e)); }
};

els.lockBtn.onclick   = async()=> actionWrap('lock');
els.unlockBtn.onclick = async()=> actionWrap('unlock');

els.resetBtn.onclick  = async()=>{
  if(!confirm('This will wipe venue, KJ, PIN, current singer & status. Continue?')) return;
  try{
    const res = await post('reset_event', pinPayload());
    // clear inputs too
    els.venue.value=''; els.kj.value=''; els.pin.value=''; els.newPin.value='';
    els.singer.value=''; els.song.value='';
    applyState(res.state);
    alert('Event reset.');
  }catch(e){ alert(parseErr(e)); }
};

els.showWelcome.onclick = async()=> {
  try{
    const res = await post('show_welcome', pinPayload());
    applyState(res.state);
  }catch(e){ alert(parseErr(e)); }
};

els.startSong.onclick = async()=> {
  try{
    const res = await post('set_current', {
      ...pinPayload(),
      singer: els.singer.value.trim(),
      song:   els.song.value.trim()
    });
    applyState(res.state);
  }catch(e){ alert(parseErr(e)); }
};

els.resEncore.onclick = ()=> showResult('encore');
els.resAnother.onclick= ()=> showResult('another');
els.resMaybe.onclick  = ()=> showResult('maybe');

async function showResult(which){
  try{
    const res = await post('show_result', { ...pinPayload(), result: which });
    applyState(res.state);
  }catch(e){ alert(parseErr(e)); }
}

function parseErr(e){
  try{
    const j = JSON.parse(e.message);
    return j.error || e.message;
  }catch{ return e.message; }
}
</script>
</body>
</html>
