<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EYEK ‚Ä¢ Host</title>
<link rel="icon" href="/assets/favicon.ico">
<style>
  :root{--bg:#0b1220;--card:#111a2b;--ink:#e8f0ff;--muted:#9bb1d9;--accent:#33e27b;--warn:#ffd166;--danger:#ff6b6b;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px; padding:16px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  h2{margin:0 0 8px 0;font-size:18px}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px}
  input,button,select{border-radius:10px;border:1px solid #223559;background:#0d1524;color:var(--ink);padding:10px 12px;font-size:14px}
  input:disabled{opacity:.6}
  .row{display:flex;gap:8px;align-items:center}
  .row > *{flex:1}
  .stack{display:flex;flex-direction:column;gap:10px}
  .btn{cursor:pointer;user-select:none}
  .btn.accent{background:linear-gradient(90deg,#2bd56f,#44ffa1);color:#04120b;border:none}
  .btn.warn{background:linear-gradient(90deg,#ffe08a,#ffd166);border:none;color:#3b2b00}
  .btn.danger{background:linear-gradient(90deg,#ff8a8a,#ff6b6b);border:none;color:#3b0000}
  .btn.ghost{background:transparent;border:1px solid #2b3c5c}
  .muted{color:var(--muted);font-size:12px}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;background:#132036;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:6px;max-height:60vh;overflow:auto}
  .item{display:flex;align-items:center;gap:8px;background:#0d1524;padding:8px 10px;border-radius:10px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.green{background:#33e27b}
  .dot.yellow{background:#ffd166}
  .side-actions button{margin-left:6px}
  .divider{height:1px;background:#1b2944;margin:12px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: Queue -->
  <div class="card">
    <h2>Tonight‚Äôs Queue</h2>
    <div class="muted" id="queueHint">Add singers on the right. Click ‚ÄúSet Current‚Äù to put someone on.</div>
    <div class="divider"></div>
    <div class="list" id="queueList"></div>
  </div>

  <!-- RIGHT: Controls -->
  <div class="card">
    <h2>Event Setup</h2>
    <div class="grid2">
      <div>
        <label>Venue</label>
        <input id="venue" autocomplete="off" placeholder="Venue name">
      </div>
      <div>
        <label>KJ</label>
        <input id="kj" autocomplete="off" placeholder="Your name">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Tonight‚Äôs PIN</label>
        <input id="pin" autocomplete="off" placeholder="4-8 digits" inputmode="numeric" pattern="\d*">
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <button id="saveEvent" class="btn accent">Save</button>
        <button id="toggleLock" class="btn ghost" title="Lock/Unlock event fields">üîí Lock</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn warn" id="resetEvent">Reset Event</button>
      <span class="muted">Keeps current PIN. Wipes queue, current singer, votes.</span>
    </div>

    <div class="divider"></div>

    <h2>Current Singer</h2>
    <div class="grid2">
      <div>
        <label>Singer</label>
        <input id="curName" placeholder="Singer name">
      </div>
      <div>
        <label>Song / Artist</label>
        <input id="curSong" placeholder="Title ‚Äî Artist">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn accent" id="setCurrent">Set Current</button>
      <span class="muted">Updates Screen & Vote pages instantly.</span>
    </div>

    <div class="divider"></div>

    <h2>Add Singer to Queue</h2>
    <div class="grid2">
      <div>
        <label>Singer</label>
        <input id="addName" placeholder="Singer name">
      </div>
      <div>
        <label>Song / Artist (optional)</label>
        <input id="addSong" placeholder="Title ‚Äî Artist">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn ghost" id="addSinger">Add to Queue</button>
      <span class="muted">Only the name appears in the sidebar.</span>
    </div>

    <div class="divider"></div>

    <h2>Voting</h2>
    <div class="row">
      <button class="btn accent" id="openVoting">Open 30s</button>
      <button class="btn warn" id="extendVoting">+15s</button>
      <button class="btn ghost" id="closeVoting">Close Now</button>
      <span class="badge" id="timer">Closed</span>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Host Vote:</span>
      <button class="btn ghost" data-hostvote="encore">Encore!</button>
      <button class="btn ghost" data-hostvote="another">Another Shot!</button>
      <button class="btn ghost" data-hostvote="maybe">Maybe Next Time</button>
      <span class="muted" id="voteTotals">E:0 ‚Ä¢ A:0 ‚Ä¢ M:0</span>
    </div>
  </div>
</div>

<script>
const API = '/assets/state.php';
let STATE = null;
let pollTimer = null;
let countdownTimer = null;

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function ms() { return Date.now(); }
function fmt(n){ return String(n).padStart(2,'0'); }

async function api(action, payload={}, qs={}) {
  const u = new URL(API, location.origin);
  u.searchParams.set('action', action);
  if (qs) for (const k in qs) u.searchParams.set(k, qs[k]);
  const res = await fetch(u.toString(), {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  return res.json();
}
async function apiGet() {
  const u = new URL(API, location.origin);
  u.searchParams.set('action','get');
  const res = await fetch(u.toString(), {cache:'no-store'});
  return res.json();
}

function render() {
  if (!STATE) return;
  // Event fields
  $('#venue').value = STATE.event.venue || '';
  $('#kj').value    = STATE.event.kj    || '';
  $('#pin').value   = STATE.event.pin   || '';
  const locked = !!STATE.event.locked;
  $('#venue').disabled = locked;
  $('#kj').disabled    = locked;
  $('#pin').disabled   = locked;
  $('#toggleLock').textContent = locked ? 'üîì Unlock' : 'üîí Lock';

  // Current
  $('#curName').value = STATE.current.name || '';
  $('#curSong').value = STATE.current.song || '';

  // Queue list
  const q = STATE.queue || [];
  const list = $('#queueList');
  list.innerHTML = '';
  q.forEach(s => {
    const row = document.createElement('div');
    row.className = 'item';
    const dot = document.createElement('span');
    dot.className = 'dot ' + (STATE.lastResult === 'encore' ? 'green' :
                              STATE.lastResult === 'another' ? 'yellow' : '');
    const name = document.createElement('div');
    name.style.flex = '1';
    name.textContent = s.name;
    const actions = document.createElement('div');
    actions.className = 'side-actions';
    const setBtn = document.createElement('button');
    setBtn.className = 'btn ghost';
    setBtn.textContent = 'Set Current';
    setBtn.onclick = () => setCurrent(s.name, '');
    const delBtn = document.createElement('button');
    delBtn.className = 'btn danger';
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => removeSinger(s.name);
    actions.append(setBtn, delBtn);
    row.append(dot, name, actions);
    list.appendChild(row);
  });

  // Voting
  const vt = STATE.votes || {encore:0,another:0,maybe:0};
  $('#voteTotals').textContent = `E:${vt.encore} ‚Ä¢ A:${vt.another} ‚Ä¢ M:${vt.maybe}`;

  const v = STATE.voting || {isOpen:false, endsAt:0};
  clearInterval(countdownTimer);
  if (v.isOpen) {
    countdownTimer = setInterval(() => {
      const remain = Math.max(0, v.endsAt - ms());
      const s = Math.ceil(remain/1000);
      $('#timer').textContent = `Open ‚Äî ${s}s`;
      if (remain <= 0) {
        clearInterval(countdownTimer);
        $('#timer').textContent = 'Closing‚Ä¶';
      }
    }, 200);
  } else {
    $('#timer').textContent = 'Closed';
  }
}

async function loadAndRender() {
  const r = await apiGet();
  if (r.ok) { STATE = r.state; render(); }
}
function startPolling() {
  clearInterval(pollTimer);
  pollTimer = setInterval(loadAndRender, 1500);
}

// Actions
$('#saveEvent').onclick = async () => {
  const payload = {
    venue: $('#venue').value.trim(),
    kj:    $('#kj').value.trim(),
    pin:   $('#pin').value.trim(),
    locked: STATE?.event?.locked ?? false
  };
  const r = await api('save_event', payload);
  if (!r.ok) { alert(r.error||'Save failed'); return; }
  STATE = r.state; render();
};

$('#toggleLock').onclick = async () => {
  const pin = prompt('Enter PIN to toggle lock:');
  if (!pin) return;
  const r = await fetch(`${API}?action=toggle_lock&pin=${encodeURIComponent(pin)}`, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
};

$('#resetEvent').onclick = async () => {
  const pin = prompt('PIN to reset event (keeps same PIN):');
  if (!pin) return;
  if (!confirm('Reset event? This clears queue, current singer, and votes.')) return;
  const r = await fetch(`${API}?action=reset_event&pin=${encodeURIComponent(pin)}`, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
};

async function setCurrent(name, song) {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const u = `${API}?action=set_current&pin=${encodeURIComponent(pin)}&name=${encodeURIComponent(name)}&song=${encodeURIComponent(song||'')}`;
  const r = await fetch(u, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
}
$('#setCurrent').onclick = () => setCurrent($('#curName').value.trim(), $('#curSong').value.trim());

$('#addSinger').onclick = async () => {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const payload = { name: $('#addName').value.trim(), song: $('#addSong').value.trim() };
  if (!payload.name) { alert('Singer name required'); return; }
  const u = `${API}?action=add_singer&pin=${encodeURIComponent(pin)}`;
  const r = await fetch(u, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  $('#addName').value=''; $('#addSong').value='';
  STATE = j.state; render();
};

async function removeSinger(name) {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const u = `${API}?action=remove_singer&pin=${encodeURIComponent(pin)}&name=${encodeURIComponent(name)}`;
  const r = await fetch(u, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
}

// Voting controls
$('#openVoting').onclick = async () => {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const r = await fetch(`${API}?action=open_voting&pin=${encodeURIComponent(pin)}&ms=30000`, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  // play open sound on host too (non-blocking)
  new Audio('/assets/quiz-countdown.mp3').play().catch(()=>{});
  STATE = j.state; render();
};
$('#extendVoting').onclick = async () => {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const r = await fetch(`${API}?action=extend_voting&pin=${encodeURIComponent(pin)}`, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
};
$('#closeVoting').onclick = async () => {
  const pin = $('#pin').value.trim() || prompt('Enter PIN:');
  if (!pin) return;
  const r = await fetch(`${API}?action=close_voting&pin=${encodeURIComponent(pin)}`, {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert(j.error||'Failed'); return; }
  STATE = j.state; render();
};

// Host vote adds to totals but does NOT decide winner (that happens on close)
$$('[data-hostvote]').forEach(b=>{
  b.addEventListener('click', async ()=>{
    const choice = b.getAttribute('data-hostvote');
    const u = `${API}?action=vote&choice=${encodeURIComponent(choice)}`;
    const r = await fetch(u, {method:'POST'});
    const j = await r.json();
    if (!j.ok) { alert(j.error||'Voting closed'); return; }
    STATE = j.state; render();
  });
});

// init
loadAndRender().then(startPolling);
</script>
</body>
</html>
