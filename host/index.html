<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;background:#2F0658;color:#fff;font-family:sans-serif}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:#7aa2ff;color:#000}
  .btn.ghost{background:transparent;border:1px solid #ccc;color:#fff}
  .card{background:#1b1b2e;border-radius:8px;padding:16px;margin:12px}
  .err{color:#ff8b8b;font-size:12px}
</style>
</head>
<body>
<div class="card" id="gate">
  <h2>Host Access</h2>
  <div id="loginPane">
    <input id="loginEmail" type="email" placeholder="host@yourkj.com">
    <input id="loginPass" type="password" placeholder="Password">
    <button class="btn primary" id="loginBtn">Enter Host Panel</button>
    <button class="btn ghost" id="demoEnter">Skip (Demo)</button>
    <div id="loginErr" class="err"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="card">
    <h2>Show Control</h2>
    <input id="singerName" placeholder="Singer name">
    <input id="songArtist" placeholder="Song - Artist">
    <button class="btn primary" id="addSinger">Add Singer</button>
    <div id="singerList"></div>
  </div>
</div>

<script>
function $(s){return document.querySelector(s)}
function hideGate(){ $('#gate').style.display='none'; $('#app').style.display='block'; }

// Session stub
function setSession(sess){ localStorage.setItem('eyek_host_session', JSON.stringify(sess)); }
function getSession(){ try{return JSON.parse(localStorage.getItem('eyek_host_session'))}catch{return null} }

// Auth
$('#loginBtn').addEventListener('click', ()=>{
  const email=$('#loginEmail').value.trim();
  const pass=$('#loginPass').value;
  if(!email||!pass){ $('#loginErr').textContent='Enter email and password'; return; }
  setSession({email}); hideGate();
});
$('#demoEnter').addEventListener('click', ()=>{ setSession({email:'demo@local'}); hideGate(); });

// Add singer
$('#addSinger').addEventListener('click', async ()=>{
  try{
    if(!state){ await fetchState(); }
    const name = singerName.value.trim();
    const firstNote = songArtist.value.trim();
    if(!name){ alert('Enter a singer name.'); return; }
    const id = 's_'+Math.random().toString(36).slice(2,9);
    state.event = state.event || {venue:'',venuePublic:'',date:new Date().toISOString().slice(0,10),kj:'',pin:'',locked:false};
    state.singers = state.singers || [];
    state.current = state.current || {id:null,name:'',songArtist:''};
    state.voting = state.voting || {open:false,endsAt:0,extendCount:0,counts:{encore:0,another:0,maybe:0}, lastResult:null};
    state.singers.push({id, name, _color:''});
    if(!state.current.id){ state.current = {id, name, songArtist: ''}; }
    const btn=$('#addSinger'); const old=btn.textContent; btn.textContent='Added ✓'; btn.disabled=true;
    await postState();
    singerName.value=''; songArtist.value='';
    setTimeout(()=>{ btn.textContent=old; btn.disabled=false; }, 600);
  }catch(e){ console.error('addSinger error', e); alert('Could not add singer.'); }
});
  const song=$('#songArtist').value.trim();
  if(!name) return;
  const div=document.createElement('div');
  div.textContent=name+(song?` — ${song}`:'');
  $('#singerList').appendChild(div);
  $('#singerName').value='';
  $('#songArtist').value='';
});

// Auto login if session exists
if(getSession()){ hideGate(); }
</script>
<script id="ops_failsafe2">
// Ensure only one Skip button and visible clickability
(function(){
  try{
    const skips=document.querySelectorAll('#demoEnter');
    if(skips.length>1){ for(let i=1;i<skips.length;i++){ skips[i].remove(); } }
  }catch(e){ console.error('ops_failsafe2', e); }
})();
</script>
</body>
</html>
