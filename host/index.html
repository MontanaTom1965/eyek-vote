<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EYEK • Host</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<style>
  :root{
    --bg:#0b0f14; --card:#121821; --muted:#1a2230; --ink:#e8f0ff; --sub:#a8b4c9;
    --green:#22c55e; --yellow:#facc15; --red:#ef4444; --eyek:#7dd3fc;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#0b0f14,#081019 60%,#070d16);color:var(--ink);}
  h1,h2,h3{margin:0 0 .5rem}
  .wrap{display:grid;grid-template-columns: 300px 1fr; gap:16px; padding:16px; max-width:1400px; margin:0 auto;}
  .card{background:var(--card); border:1px solid #0f1520; border-radius:16px; padding:16px; box-shadow:0 6px 30px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  .row{display:flex; gap:8px; align-items:center}
  label{font-size:.9rem; color:var(--sub); min-width:90px}
  input,button,details{font:inherit}
  input[type=text], input[type=password]{width:100%; background:var(--muted); border:1px solid #20293a; color:var(--ink); padding:10px 12px; border-radius:10px; outline:none}
  button{background:#1f2836; color:var(--ink); border:1px solid #263146; padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s; font-weight:600}
  button:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.25)}
  .primary{background:linear-gradient(180deg,#1f8bfd,#1360e2); border-color:#0c4fc5}
  .success{background:linear-gradient(180deg,#1ea85e,#128c4d); border-color:#0f6f3f}
  .warn{background:linear-gradient(180deg,#f0b429,#d79400); border-color:#b37500; color:#151515}
  .danger{background:linear-gradient(180deg,#ef4444,#c02626); border-color:#991b1b}
  .pill{padding:6px 10px; border-radius:999px; font-size:.85rem}
  .muted{color:var(--sub)}
  .cols-2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .section-title{font-weight:800; letter-spacing:.3px}
  .sidebar{display:flex; flex-direction:column; gap:12px}
  .singer{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; background:#0f1420; border:1px solid #1a2538; border-radius:12px}
  .singer .name{font-weight:700}
  .dots{display:flex; gap:6px; align-items:center}
  .dot{width:10px; height:10px; border-radius:999px; opacity:.6}
  .dot.green{background:var(--green)}
  .dot.yellow{background:var(--yellow)}
  .dot.red{background:var(--red)}
  .actions{display:flex; gap:6px}
  .kicker{font-size:.9rem; color:var(--sub)}
  details summary{cursor:pointer; padding:10px 12px; background:#0f1420; border:1px solid #1a2538; border-radius:10px; font-weight:700}
  details[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
  details .content{border:1px solid #1a2538; border-top:none; border-bottom-left-radius:10px;border-bottom-right-radius:10px; padding:12px; background:#0b111b}
  .split{display:grid; grid-template-columns: 1fr auto; align-items:end; gap:8px}
  .section{display:grid; gap:10px}
  .tiny{font-size:.8rem}
  .note{font-size:.85rem; color:var(--sub)}
</style>
</head>
<body>
<div class="wrap">

  <!-- Sidebar: rotation -->
  <div class="sidebar">
    <div class="card">
      <h2 class="section-title">Rotation</h2>
      <div id="rotation" class="grid" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="section">
        <div class="section-title">Utilities</div>
        <button class="danger" id="resetEventBtn">Reset Event (keeps venue/KJ/PIN)</button>
        <div class="note tiny">Resets singers, current singer, voting, results.</div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="grid">

    <!-- Event (collapsible) -->
    <div class="card">
      <details id="eventDetails" open>
        <summary>Event • Venue / KJ / PIN</summary>
        <div class="content grid" style="margin-top:10px">
          <div class="cols-2">
            <div class="row"><label>Venue</label><input id="venue" type="text" placeholder="Venue name"></div>
            <div class="row"><label>KJ</label><input id="kj" type="text" placeholder="KJ name"></div>
          </div>
          <div class="cols-2">
            <div class="row"><label>PIN</label><input id="pin" type="password" placeholder="Event PIN (for changes)"></div>
            <div class="row"><label>Status</label>
              <span id="lockStatus" class="pill" style="background:#263146">Unlocked</span>
            </div>
          </div>
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <button class="primary" id="saveEventBtn">Save Event</button>
            <button id="toggleLockBtn">Lock / Unlock</button>
          </div>
        </div>
      </details>
      <div class="kicker" id="eventSummary" style="margin-top:8px"></div>
    </div>

    <!-- Singer -->
    <div class="card">
      <div class="section-title">Singer</div>
      <div class="grid" style="margin-top:8px">
        <div class="row"><label style="min-width:70px">Singer</label><input id="singerName" type="text" placeholder="Singer name"></div>
        <div class="row"><label style="min-width:70px">Song/Artist</label><input id="songTitle" type="text" placeholder="Song / Artist (optional)"></div>
        <div class="row" style="gap:8px">
          <button class="success" id="addSingerBtn">Add Singer</button>
        </div>
      </div>
    </div>

    <!-- Current & Voting -->
    <div class="card">
      <div class="section">
        <div class="section-title">Current & Voting</div>
        <div id="currentInfo" class="kicker">No singer selected.</div>
        <div class="row" style="gap:8px; margin-top:8px">
          <button class="primary" id="startBtn">Start 30s</button>
          <button class="warn" id="extendBtn">Extend +15s</button>
          <button class="danger" id="endBtn">End Now</button>
          <div class="pill" id="timer" style="background:#0f1420; border:1px solid #1a2538">00:00</div>
        </div>
        <div class="kicker tiny">Voting totals: <span id="totals">E:0 • A:0 • M:0</span></div>
      </div>
    </div>

    <!-- Host Vote (separate section) -->
    <div class="card">
      <div class="section-title">Host Vote</div>
      <div class="row" style="gap:8px; margin-top:8px">
        <button class="success" id="hvEncore">Encore!</button>
        <button class="warn" id="hvAnother">Another Shot!</button>
        <button class="danger" id="hvMaybe">Maybe Next Time</button>
        <span class="note">Host vote increments totals; it doesn't decide the winner early.</span>
      </div>
    </div>

  </div>
</div>

<script>
const API = '/assets/api.php';
let STATE = null;
let pollTimer = null;
let countdownTimer = null;

const qs = sel => document.querySelector(sel);
const $venue = qs('#venue');
const $kj = qs('#kj');
const $pin = qs('#pin');
const $lockStatus = qs('#lockStatus');
const $eventSummary = qs('#eventSummary');
const $rotation = qs('#rotation');
const $currentInfo = qs('#currentInfo');
const $timer = qs('#timer');
const $totals = qs('#totals');

async function api(cmd, data={}, method='POST'){
  const form = new FormData();
  form.append('cmd', cmd);
  Object.entries(data).forEach(([k,v])=>form.append(k, v));
  const res = await fetch(API, { method, body: form, cache:'no-store' });
  return res.json();
}

function fmtMinSec(ms){
  if (ms < 0) ms = 0;
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60), r = s%60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function render(){
  if (!STATE) return;
  // Event summary + lock pill
  $eventSummary.textContent = `Venue: ${STATE.event.venue || '—'}  •  KJ: ${STATE.event.kj || '—'}  •  PIN: ${STATE.event.pin ? '••••' : '—'}`;
  $lockStatus.textContent = STATE.event.locked ? 'Locked' : 'Unlocked';
  $lockStatus.style.background = STATE.event.locked ? '#3a1d1d' : '#263146';

  // Keep inputs in sync only if empty (so typing doesn’t get blown away)
  if (!$venue.value) $venue.value = STATE.event.venue;
  if (!$kj.value)    $kj.value = STATE.event.kj;

  // Rotation
  $rotation.innerHTML = '';
  STATE.singers.forEach(s=>{
    const resDot = (STATE.lastResult && STATE.lastResult.singerId===s.id)
      ? (STATE.lastResult.outcome) : null;
    const el = document.createElement('div');
    el.className='singer';
    el.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px">
        <div class="dots">
          <span class="dot green"  style="opacity:${resDot==='encore'?1:.25}"></span>
          <span class="dot yellow" style="opacity:${resDot==='another'?1:.25}"></span>
          <span class="dot red"    style="opacity:${resDot==='maybe'?1:.25}"></span>
        </div>
        <div class="name">${s.name}</div>
      </div>
      <div class="actions">
        <button class="pill primary" data-set="${s.id}">Set</button>
        <button class="pill danger" data-del="${s.id}">Remove</button>
      </div>`;
    $rotation.appendChild(el);
  });

  // Current & Voting
  const current = STATE.singers.find(s=>s.id===STATE.currentSingerId);
  $currentInfo.textContent = current ? `Current: ${current.name}` : 'No singer selected.';
  const v = STATE.voting;
  $totals.textContent = `E:${v.votes.encore} • A:${v.votes.another} • M:${v.votes.maybe}`;
}

async function refresh(){
  const res = await fetch(API + '?cmd=get&ts=' + Date.now(), {cache:'no-store'});
  const js = await res.json();
  if (js.ok) {
    const prev = STATE;
    STATE = js.state;
    render();
    // Start/refresh countdown if open
    if (STATE.voting.open) {
      startCountdown(STATE.voting.endsAt);
    } else {
      stopCountdown();
      $timer.textContent = '00:00';
    }
  }
}

function startCountdown(endsAt){
  stopCountdown();
  countdownTimer = setInterval(()=>{
    const remain = endsAt - Date.now();
    $timer.textContent = fmtMinSec(remain);
    if (remain <= 0) stopCountdown();
  }, 250);
}
function stopCountdown(){ if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }

// Events
qs('#saveEventBtn').onclick = async ()=>{
  const r = await api('set_event', {
    venue:$venue.value, kj:$kj.value, pin:$pin.value, locked: STATE?.event?.locked ? 'true':'false', 
    // PIN in this call is used to *change* values when locked
    // (we also send it as 'pin' for set_event data; that same field updates the stored PIN if non-empty)
  });
  if (!r.ok) return alert(r.msg||'Save failed');
  STATE = r.state; render();
  alert('Event saved');
};

qs('#toggleLockBtn').onclick = async ()=>{
  const want = !(STATE?.event?.locked);
  const r = await api('lock', { locked: want ? 'true':'false', pin:$pin.value });
  if (!r.ok) return alert(r.msg||'Lock change failed');
  STATE = r.state; render();
};

qs('#addSingerBtn').onclick = async ()=>{
  const name = qs('#singerName').value.trim();
  const song = qs('#songTitle').value.trim();
  if (!name) return alert('Enter a singer name');
  const r = await api('add_singer', { name, song, pin:$pin.value });
  if (!r.ok) return alert('Add failed');
  qs('#singerName').value=''; qs('#songTitle').value='';
  STATE = r.state; render();
};

$rotation.addEventListener('click', async (e)=>{
  const setId = e.target.getAttribute('data-set');
  const delId = e.target.getAttribute('data-del');
  if (setId){
    const r = await api('set_current', { id:setId, pin:$pin.value });
    if (r.ok){ STATE=r.state; render(); }
  }
  if (delId){
    const r = await api('remove_singer', { id:delId, pin:$pin.value });
    if (r.ok){ STATE=r.state; render(); }
  }
});

qs('#startBtn').onclick = async ()=>{
  if (!STATE.currentSingerId) return alert('Select a current singer first.');
  const r = await api('start_vote', { duration:30, pin:$pin.value });
  if (r.ok){ STATE=r.state; render(); startCountdown(STATE.voting.endsAt); }
};

qs('#extendBtn').onclick = async ()=>{
  const r = await api('extend_vote', { seconds:15, pin:$pin.value });
  if (r.ok){ STATE=r.state; render(); startCountdown(STATE.voting.endsAt); }
};

qs('#endBtn').onclick = async ()=>{
  const r = await api('end_vote', { pin:$pin.value });
  if (r.ok){ STATE=r.state; render(); }
};

qs('#hvEncore').onclick = ()=> api('host_vote', { choice:'encore', pin:$pin.value }).then(()=>refresh());
qs('#hvAnother').onclick = ()=> api('host_vote', { choice:'another', pin:$pin.value }).then(()=>refresh());
qs('#hvMaybe').onclick   = ()=> api('host_vote', { choice:'maybe',   pin:$pin.value }).then(()=>refresh());

qs('#resetEventBtn').onclick = async ()=>{
  if (!confirm('Reset event (keeps venue/KJ/PIN)?')) return;
  const r = await api('reset_event', { pin:$pin.value });
  if (r.ok){ STATE=r.state; render(); }
};

// Poll
refresh();
pollTimer = setInterval(refresh, 2500);
</script>
</body>
</html>
