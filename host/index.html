<!-- EYEK /host/index.html v2025-09-06.18 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encore Karaoke — Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#2F0658; --card:#401073; --border:#7E3CC0; --text:#ffffff; --muted:#E3D6F4; --accent:#D9B6FF;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#38bdf8;
      --tile:#2b1250; --tileBorder:#7a52b7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
        radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size: clamp(17px, 2.0vw, 22px);
    }
    .wrap{max-width:1450px; margin:0 auto; padding:22px}
    header{padding-bottom:10px; border-bottom:2px solid var(--border)}
    h1{margin:.1em 0 .2em; font-size:clamp(2.0rem, 4.7vw, 3.4rem)}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.15em .7em; background:rgba(127,60,192,.18); font-weight:1000}

    .layout{
      display:grid; gap:22px; margin-top:18px;
      grid-template-columns: 320px 1fr;
    }
    @media (max-width: 1100px){ .layout{ grid-template-columns: 1fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) , var(--card);
      border:2px solid var(--border); border-radius:18px; padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)
    }

    /* Buttons */
    .btn{
      appearance:none; cursor:pointer; user-select:none;
      border-radius:12px; padding:.7em 1em; font-weight:1000; border:2px solid transparent;
      transition:transform .06s ease, filter .12s ease, opacity .2s ease;
      color:#0b1220; background:#e5e7eb; /* neutral */
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05) }
    .btn:active{ transform:translateY(0); filter:brightness(.98) }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-row{ display:flex; gap:10px; flex-wrap:wrap }
    .btn.good{ background:var(--good); border-color:#16a34a; color:#fff }
    .btn.warn{ background:var(--warn); border-color:#d97706; color:#111 }
    .btn.bad{  background:var(--bad); border-color:#dc2626; color:#fff }
    .btn.info{ background:var(--info); border-color:#0891b2; color:#061b2a }

    /* Event box */
    .eventBox h2{ margin:.1em 0 .6em; font-size:clamp(1.3rem, 2.5vw, 1.8rem) }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .field{ flex:1; min-width:200px }
    input[type=text]{ width:100%; font:inherit; padding:.6em .7em; border-radius:12px; border:2px solid var(--border); background:rgba(0,0,0,.18); color:#fff }
    label{ font-weight:900 }

    /* Singer input 50% width on desktop */
    .singer-field{ width:100%; max-width:100% }
    @media (min-width:900px){ .singer-field{ width:50% } }

    /* Sidebar singer list */
    .side h3{ margin:.2em 0 .6em }
    .singers{ list-style:disc; padding-left:1.2em; margin:0 }
    .singers li{
      margin:.45em 0; display:flex; align-items:center; gap:8px; flex-wrap:wrap
    }
    .singerNameBtn{
      background:none; border:none; color:#fff; font-weight:1000; cursor:pointer; padding:0;
      text-decoration:underline; text-underline-offset:3px;
    }
    .tag{ font-size:.85em; color:var(--muted); font-weight:800 }
    .removeBtn, .restoreBtn{
      margin-left:auto;
      font-size:.9em; padding:.3em .55em; border-radius:10px; line-height:1;
      border:2px solid var(--border); background:rgba(0,0,0,.15); color:#fff; cursor:pointer;
    }
    .removeBtn{ border-color:#dc2626 }
    .restoreBtn{ border-color:#22c55e }

    /* Now performing tile */
    .nowTile{
      display:grid; grid-template-columns: 1fr auto; gap:16px; align-items:center;
      background:
        radial-gradient(180% 140% at 120% -20%, rgba(217,182,255,.22), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)),
        var(--tile);
      border:2px solid var(--tileBorder); border-radius:14px; padding:14px;
    }
    .qr{ width:120px; height:120px; object-fit:contain; border-radius:10px; border:2px solid var(--border); background:rgba(0,0,0,.18) }

    .divider{ height:2px; background:var(--border); margin:12px 0 }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px;
      padding:.6em .9em; border-radius:10px; border:2px solid var(--border);
      background:rgba(0,0,0,.45); color:#fff; font-weight:1000; z-index:80; display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="eventHeading">Encore Karaoke — <span class="pill" id="eventPill">Set Event</span></h1>
    </header>

    <div class="layout">
      <!-- Sidebar: Singers -->
      <aside class="side card">
        <h3>Singers <span class="tag">(still in it)</span></h3>
        <ul id="singerList" class="singers"><li class="tag">— none yet —</li></ul>
        <div class="divider"></div>
        <label><input type="checkbox" id="showRemovedChk" /> Show Removed!</label>
      </aside>

      <!-- Main column -->
      <main class="mainCol">
        <!-- Event box -->
        <section class="card eventBox">
          <h2 id="eventTitle">Event</h2>
          <div class="row">
            <div class="field"><input id="eventIdInput" type="text" placeholder="Enter event id (e.g., MyHouse)" /></div>
            <button id="setEventBtn" class="btn info" type="button">CHANGE</button>
            <label><input type="checkbox" id="lockEventChk" /> Lock Event</label>
          </div>
        </section>

        <!-- Displays box -->
        <section class="card">
          <h2>Displays & Links</h2>
          <div class="btn-row" style="margin-bottom:10px">
            <button id="openAllDisplaysBtn" class="btn info">Open All Displays</button>
            <button id="openVoteBtn"   class="btn">Vote</button>
            <button id="openScreenBtn" class="btn">Screen</button>
            <button id="openBoardBtn"  class="btn">Board</button>
          </div>
          <div class="btn-row">
            <button id="broadcastBtn" class="btn good" title="Set this event as active for screens that follow meta/active">Broadcast Active Event</button>
          </div>
        </section>

        <!-- Singer entry -->
        <section class="card">
          <h2>Add / Announce Singer</h2>
          <div class="row">
            <input id="singerNameInput" class="singer-field" type="text" placeholder="Singer name" />
            <button id="addSingerBtn" class="btn good" type="button" aria-label="Enter singer">Enter</button>
          </div>
          <div class="tag" style="margin-top:8px">Tip: Click a singer’s name in the sidebar to announce them again.</div>
        </section>

        <!-- Now performing + vote controls -->
        <section class="card">
          <h2>Now Performing</h2>
          <div class="nowTile">
            <div>
              <div class="tag">Singer</div>
              <div style="font-weight:1000; font-size:1.4em" id="nowSinger">—</div>
              <div class="tag" id="perfIdTag" style="margin-top:4px">—</div>
            </div>
            <img id="qrImg" class="qr" alt="QR" />
          </div>

          <div class="divider"></div>

          <h2>Voting Controls</h2>
          <div class="btn-row">
            <button id="voteNowBtn"    class="btn good">Vote Now (30s)</button>
            <button id="extendBtn"     class="btn warn">Extend +15s</button>
            <button id="endNowBtn"     class="btn bad">End Now</button>
          </div>
          <div style="margin-top:8px" class="tag">Status: <span id="statusText">pending</span> · Time left: <span id="timeLeft">—</span></div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast">—</div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
  (function(){
    /* --- Firebase --- */
    var FIREBASE_CONFIG = {
      apiKey:"AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain:"eyek-vote.firebaseapp.com",
      projectId:"eyek-vote"
    };
    if(!firebase || !firebase.initializeApp){ alert('Firebase failed to load.'); return; }
    firebase.initializeApp(FIREBASE_CONFIG);
    var db=firebase.firestore();
    var auth=firebase.auth();

    /* --- Elements --- */
    function $(id){ return document.getElementById(id); }
    var eventHeading=$('eventHeading'), eventPill=$('eventPill'), eventTitle=$('eventTitle'),
        eventIdInput=$('eventIdInput'), setEventBtn=$('setEventBtn'), lockEventChk=$('lockEventChk'),
        openAllDisplaysBtn=$('openAllDisplaysBtn'), openVoteBtn=$('openVoteBtn'), openScreenBtn=$('openScreenBtn'), openBoardBtn=$('openBoardBtn'),
        broadcastBtn=$('broadcastBtn'),
        singerNameInput=$('singerNameInput'), addSingerBtn=$('addSingerBtn'),
        singerList=$('singerList'), showRemovedChk=$('showRemovedChk'),
        nowSinger=$('nowSinger'), perfIdTag=$('perfIdTag'), qrImg=$('qrImg'),
        voteNowBtn=$('voteNowBtn'), extendBtn=$('extendBtn'), endNowBtn=$('endNowBtn'),
        statusText=$('statusText'), timeLeft=$('timeLeft'),
        toast=$('toast');

    /* --- State --- */
    var CURRENT={ eventId:null, performanceId:null, status:'pending', openAt:null, durationSec:0, closeAt:null, singerName:'—' };
    var unsubState=null, unsubPerf=null, unsubSingers=null;
    var countdownTimer=null;

    /* --- Utils --- */
    function showToast(msg){ toast.textContent=msg||'Done'; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 1800); }
    function urlRoot(){ return location.origin + '/'; }
    function getDeviceId(){ try{ var k='eyek_device_id', id=localStorage.getItem(k); if(!id){ var a=new Uint8Array(16); crypto.getRandomValues(a); id=Array.from(a,b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem(k,id); } return id; }catch(_){ return 'dev'; } }
    function saveEventId(eid){ try{ localStorage.setItem('eyek_event_id', eid); }catch(_){} }
    function loadEventId(){ try{ return localStorage.getItem('eyek_event_id')||''; }catch(_){ return ''; } }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function computeCloseAtFrom(d){
      if(d && d.openAt && d.durationSec){ return firebase.firestore.Timestamp.fromDate(new Date(d.openAt.toMillis() + (d.durationSec|0)*1000)); }
      return d && d.closeAt ? d.closeAt : null;
    }
    function msLeft(){ if(!CURRENT.closeAt) return 0; return Math.max(0, CURRENT.closeAt.toMillis() - Date.now()); }

    function qrProvider1(d){ return 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data='+encodeURIComponent(d); }
    function qrProvider2(d){ return 'https://chart.googleapis.com/chart?cht=qr&chs=120x120&chl='+encodeURIComponent(d); }
    function setQrForUrl(url){
      if(!qrImg) return;
      if(!url){ qrImg.removeAttribute('src'); qrImg.alt=''; return; }
      var tried=false;
      qrImg.onerror=function(){ if(!tried){ tried=true; qrImg.src=qrProvider2(url); } else { qrImg.alt='QR unavailable'; } };
      qrImg.src=qrProvider1(url);
      qrImg.alt='QR';
    }
    function updateQr(){
      if(!CURRENT.eventId || !CURRENT.performanceId){ setQrForUrl(null); return; }
      var url = urlRoot() + 'vote/index.html?eventId=' + encodeURIComponent(CURRENT.eventId) + '&performanceId=' + encodeURIComponent(CURRENT.performanceId);
      setQrForUrl(url);
    }

    function renderHeader(){
      var eid = CURRENT.eventId || 'Set Event';
      eventPill.textContent = eid;
      eventTitle.textContent = 'Event';
      eventHeading.querySelector('#eventPill').textContent = eid;
    }

    function renderStatus(){
      statusText.textContent = CURRENT.status;
      if(CURRENT.status==='open'){ var ms = msLeft(); var s = Math.max(0, Math.ceil(ms/1000)); timeLeft.textContent = s+'s'; }
      else{ timeLeft.textContent = '—'; }
    }

    function startCountdown(){
      stopCountdown();
      countdownTimer=setInterval(function(){
        if(CURRENT.status!=='open'){ stopCountdown(); return; }
        renderStatus();
      }, 250);
    }
    function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); } countdownTimer=null; }

    /* --- Auth (anon) --- */
    function ensureAuth(){
      return auth.signInAnonymously().catch(function(e){
        console.warn('Anon auth failed', e);
      });
    }

    /* --- Event handling --- */
    function setEventFromInput(){
      var eid = (eventIdInput.value||'').trim();
      if(!eid){ alert('Please enter an event id.'); return; }
      setEvent(eid);
    }
    function setEvent(eid){
      CURRENT.eventId = eid;
      saveEventId(eid);
      renderHeader();
      wireEvent(eid);
      showToast('Event set to: '+eid);
    }
    function lockEventUI(applyLock){
      var locked = !!applyLock;
      eventIdInput.disabled = locked;
      setEventBtn.disabled = locked;
      lockEventChk.checked = locked;
      if(locked){ showToast('Event locked'); }
    }

    function wireEvent(eid){
      // Unsubscribe previous
      if(unsubState){ unsubState(); unsubState=null; }
      if(unsubPerf){ unsubPerf(); unsubPerf=null; }
      if(unsubSingers){ unsubSingers(); unsubSingers=null; }

      // State/current
      unsubState = db.collection('events').doc(eid).collection('state').doc('current')
        .onSnapshot(function(snap){
          var d=snap.data()||{};
          CURRENT.performanceId = d.performanceId || null;
          CURRENT.singerName = d.currentSingerName || '—';
          nowSinger.textContent = CURRENT.singerName;
          perfIdTag.textContent = CURRENT.performanceId ? ('#'+CURRENT.performanceId) : '—';
          updateQr();
          watchPerfDoc();
        });

      // Singers (list)
      unsubSingers = db.collection('events').doc(eid).collection('singers')
        .orderBy('createdAt','asc')
        .onSnapshot(function(qs){
          var showRemoved = !!showRemovedChk.checked;
          var any=false;
          singerList.innerHTML='';
          qs.forEach(function(doc){
            var s = doc.data()||{};
            var removed = !!s.removed;
            if(removed && !showRemoved) return;

            any=true;
            var li=document.createElement('li');

            var nameBtn=document.createElement('button');
            nameBtn.className='singerNameBtn';
            nameBtn.textContent = s.name || '(Unknown)';
            nameBtn.title = 'Announce now';
            nameBtn.onclick = function(){ announceSinger(doc.id, s.name||'(Unknown)'); };

            var tag=document.createElement('span');
            tag.className='tag';
            tag.textContent = removed ? 'removed' : 'ready';

            var act=document.createElement('button');
            if(removed){
              act.className='restoreBtn'; act.textContent='Restore';
              act.onclick=function(){ restoreSinger(doc.id); };
            }else{
              act.className='removeBtn'; act.textContent='× Remove';
              act.onclick=function(){ removeSinger(doc.id); };
            }

            li.appendChild(nameBtn);
            li.appendChild(tag);
            li.appendChild(act);
            singerList.appendChild(li);
          });
          if(!any){ singerList.innerHTML='<li class="tag">— none yet —</li>'; }
        });
    }

    function watchPerfDoc(){
      if(unsubPerf){ unsubPerf(); unsubPerf=null; }
      if(!CURRENT.eventId || !CURRENT.performanceId){
        CURRENT.status='pending'; CURRENT.openAt=null; CURRENT.durationSec=0; CURRENT.closeAt=null;
        renderStatus();
        return;
      }
      unsubPerf = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(CURRENT.performanceId)
        .onSnapshot(function(snap){
          if(!snap.exists){
            CURRENT.status='pending'; CURRENT.openAt=null; CURRENT.durationSec=0; CURRENT.closeAt=null;
            renderStatus(); updateQr(); stopCountdown();
            return;
          }
          var d=snap.data()||{};
          CURRENT.status = d.status || 'pending';
          CURRENT.openAt = d.openAt || null;
          CURRENT.durationSec = d.durationSec|0;
          CURRENT.closeAt = computeCloseAtFrom(d);
          renderStatus();
          if(CURRENT.status==='open' && CURRENT.closeAt){ startCountdown(); } else{ stopCountdown(); }
        });
    }

    /* --- Singer ops --- */
    function addSinger(){
      var name = (singerNameInput.value||'').trim();
      if(!name){ alert('Enter a singer name.'); return; }
      if(!CURRENT.eventId){ alert('Set the event first.'); return; }
      var eid = CURRENT.eventId;

      // Create singer doc (if we want to avoid dupes by name we could search; keep it simple)
      var singerRef = db.collection('events').doc(eid).collection('singers').doc();
      singerRef.set({
        singerId: singerRef.id,
        name: name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        removed: false
      }).then(function(){
        singerNameInput.value='';
        announceSinger(singerRef.id, name);
      }).catch(function(e){
        alert('Error adding singer: ' + (e && e.message ? e.message : e));
      });
    }

    function announceSinger(singerId, name){
      if(!CURRENT.eventId){ alert('Set the event first.'); return; }
      var eid=CURRENT.eventId;

      var perfRef = db.collection('events').doc(eid).collection('performances').doc();
      perfRef.set({
        performanceId: perfRef.id,
        eventId: eid,
        singerId: singerId || null,
        singerName: name || '(Unknown)',
        status: 'pending',
        openAt: null,
        durationSec: 0,
        closeAt: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function(){
        // Point state/current to this performance
        return db.collection('events').doc(eid).collection('state').doc('current').set({
          performanceId: perfRef.id,
          currentSingerName: name || '(Unknown)',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }).then(function(){
        showToast('Announced: ' + (name||'(Unknown)'));
      }).catch(function(e){
        alert('Error announcing: ' + (e && e.message ? e.message : e));
      });
    }

    function removeSinger(singerId){
      if(!CURRENT.eventId) return;
      if(!confirm('Remove this singer from the list? (They will be hidden from the board as well.)')) return;
      db.collection('events').doc(CURRENT.eventId).collection('singers').doc(singerId)
        .set({ removed:true }, { merge:true })
        .catch(function(e){ alert('Error removing: '+(e && e.message?e.message:e)); });
    }
    function restoreSinger(singerId){
      if(!CURRENT.eventId) return;
      db.collection('events').doc(CURRENT.eventId).collection('singers').doc(singerId)
        .set({ removed:false }, { merge:true })
        .catch(function(e){ alert('Error restoring: '+(e && e.message?e.message:e)); });
    }

    /* --- Voting controls --- */
    function voteNow(){
      if(!CURRENT.eventId || !CURRENT.performanceId){ alert('No performance selected.'); return; }
      var ref = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(CURRENT.performanceId);
      ref.set({
        status:'open',
        openAt: firebase.firestore.FieldValue.serverTimestamp(),
        durationSec: 30,
        closeAt: null
      }, { merge:true }).then(function(){
        showToast('Voting opened (30s)');
      }).catch(function(e){ alert('Error starting voting: ' + (e && e.message ? e.message : e)); });
    }
    function extendVote(){
      if(!CURRENT.eventId || !CURRENT.performanceId){ alert('No performance selected.'); return; }
      var ref = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(CURRENT.performanceId);
      ref.set({
        // increment duration by +15s relative to openAt start
        durationSec: firebase.firestore.FieldValue.increment(15)
      }, { merge:true }).then(function(){
        showToast('Extended +15s');
      }).catch(function(e){ alert('Error extending: ' + (e && e.message ? e.message : e)); });
    }
    function endNow(){
      if(!CURRENT.eventId || !CURRENT.performanceId){ alert('No performance selected.'); return; }
      var ref = db.collection('events').doc(CURRENT.eventId).collection('performances').doc(CURRENT.performanceId);
      ref.set({
        status:'closed',
        closeAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true }).then(function(){
        showToast('Voting closed');
      }).catch(function(e){ alert('Error closing: ' + (e && e.message ? e.message : e)); });
    }

    /* --- Displays --- */
    function getCurrentEventId(){
      if (eventIdInput && eventIdInput.value.trim()) return eventIdInput.value.trim();
      if (eventPill && eventPill.textContent && eventPill.textContent.trim() && eventPill.textContent.trim()!=='Set Event') return eventPill.textContent.trim();
      try{ var ls = localStorage.getItem('eyek_event_id'); if(ls && ls.trim()) return ls.trim(); }catch(_){}
      return '';
    }
    function openVote(){ var eid=getCurrentEventId(); if(!eid){ alert('Set event first.'); return; } window.open(urlRoot()+'vote/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener'); }
    function openScreen(){ var eid=getCurrentEventId(); if(!eid){ alert('Set event first.'); return; } window.open(urlRoot()+'screen/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener'); }
    function openBoard(){ var eid=getCurrentEventId(); if(!eid){ alert('Set event first.'); return; } window.open(urlRoot()+'board/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener'); }
    function openAllDisplays(){
      var eid=getCurrentEventId(); if(!eid){ alert('Set event first.'); return; }
      var w1=window.open(urlRoot()+'vote/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener');
      var w2=window.open(urlRoot()+'screen/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener');
      var w3=window.open(urlRoot()+'board/index.html?eventId='+encodeURIComponent(eid), '_blank', 'noopener');
      if(!w1 || !w2 || !w3){ alert('Popup blocked. Please allow pop-ups for this site or use the buttons individually.'); }
    }
    function broadcastActive(){
      var eid=getCurrentEventId(); if(!eid){ alert('Set event first.'); return; }
      db.collection('meta').doc('active').set({ eventId:eid, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
        .then(function(){ showToast('Broadcasting event: '+eid); })
        .catch(function(e){ alert('Error broadcasting: ' + (e && e.message ? e.message : e)); });
    }

    /* --- Wire up --- */
    document.addEventListener('DOMContentLoaded', function(){
      // Force button to say “Enter”
      if(addSingerBtn) addSingerBtn.textContent='Enter';

      // Load saved event id
      var saved = loadEventId();
      if(saved){ eventIdInput.value = saved; setEvent(saved); }

      // Listeners
      setEventBtn.addEventListener('click', setEventFromInput);
      lockEventChk.addEventListener('change', function(){
        var lock = !!lockEventChk.checked;
        lockEventUI(lock);
        try{ localStorage.setItem('eyek_event_locked', lock ? '1':'0'); }catch(_){}
      });

      addSingerBtn.addEventListener('click', addSinger);
      singerNameInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ addSinger(); } });

      showRemovedChk.addEventListener('change', function(){ /* list re-renders via snapshot next tick */ });

      voteNowBtn.addEventListener('click', voteNow);
      extendBtn.addEventListener('click', extendVote);
      endNowBtn.addEventListener('click', endNow);

      openAllDisplaysBtn.addEventListener('click', openAllDisplays);
      openVoteBtn.addEventListener('click', openVote);
      openScreenBtn.addEventListener('click', openScreen);
      openBoardBtn.addEventListener('click', openBoard);
      broadcastBtn.addEventListener('click', broadcastActive);

      // Restore lock
      try{ var L = localStorage.getItem('eyek_event_locked'); if(L==='1'){ lockEventUI(true); } }catch(_){}

      // Auth then ready
      ensureAuth().then(function(){
        // If we already had a saved event but state/current hasn’t been wired yet, re-wire
        if(saved){ wireEvent(saved); }
      });
    });

  })();
  </script>
</body>
</html>
