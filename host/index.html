<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EYEK • Host</title>
<link rel="icon" href="/assets/icon.png" />
<style>
  :root{
    --bg:#0b0b16;           /* dark indigo */
    --card:#16162a;
    --accent:#2F0658;       /* your purple */
    --accent-2:#8a2be2;     /* bright accent for focus */
    --text:#f4f4ff;
    --muted:#9aa0b4;
    --ok:#2ecc71;           /* green */
    --warn:#f1c40f;         /* yellow */
    --bad:#e74c3c;          /* red */
    --btn:#22223b;
    --btn-h:#2a2a4e;
    --shadow:0 10px 25px rgba(0,0,0,.35);
    --radius:20px;
  }
  html,body{height:100%;}
  body{
    margin:0;background:linear-gradient(135deg,var(--bg),#120921 40%, var(--accent) 110%);
    color:var(--text); font:400 16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  a{color:#c3a9ff;text-decoration:none}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:16px;
    padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.25);backdrop-filter: blur(6px);
    position:sticky;top:0;z-index:10;
  }
  .nav{display:flex;gap:12px;flex-wrap:wrap}
  .nav a{
    padding:8px 12px;background:var(--btn);border-radius:999px;border:1px solid rgba(255,255,255,.08);
  }
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:18px; padding:18px; max-width:1400px; margin:0 auto;}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
  }
  h2{margin:0 0 10px 0;font-size:18px; letter-spacing:.3px}
  .muted{color:var(--muted)}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  input,select{
    background:#0f0f21;color:var(--text); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:10px 12px; outline:none; width:100%;
  }
  input:focus,select:focus{border-color:var(--accent-2)}
  button{
    background:var(--btn); color:var(--text); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:10px 14px; cursor:pointer;
  }
  button:hover{background:var(--btn-h)}
  .primary{ background: radial-gradient(100% 100% at 50% 0%, #5b2a9e, #2F0658 70%); border-color:#6a35ba }
  .danger{ background:linear-gradient(180deg,#5e1d1d,#3b1111); border-color:#7a2c2c }
  .ok{ background:linear-gradient(180deg,#194d2e,#0e2f1c); border-color:#2b8f57 }
  .warn{ background:linear-gradient(180deg,#5c4a10,#3a2f0a); border-color:#b08a12 }
  .side{display:flex;flex-direction:column; gap:12px}
  .list{ display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; padding-right:4px}
  .singer{
    display:grid; grid-template-columns:20px 1fr auto auto; gap:8px; align-items:center;
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; background:#3a3a52; }
  .dot.ok{ background:var(--ok)}
  .dot.warn{ background:var(--warn)}
  details{border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
  summary{
    cursor:pointer; list-style:none; padding:12px 14px; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    font-weight:600;
  }
  summary::-webkit-details-marker{display:none}
  .section{padding:14px}
  .cols-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .panel{background:rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px}
  .timer{font-size:38px; font-weight:800; letter-spacing:1px}
  .counts{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25)}
  .resultBox{min-height:44px; display:flex; align-items:center; justify-content:center; font-weight:800; border-radius:12px; border:1px solid rgba(255,255,255,.14)}
  .resultBox.encore{background:rgba(46,204,113,.15); border-color:rgba(46,204,113,.45)}
  .resultBox.another{background:rgba(241,196,15,.15); border-color:rgba(241,196,15,.45)}
  .resultBox.maybe{background:rgba(231,76,60,.15); border-color:rgba(231,76,60,.45)}
  .footnote{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="row">
      <strong>EYEK • Host</strong>
    </div>
    <nav class="nav">
      <a href="/">Home</a>
      <a href="/host/">Host</a>
      <a href="/screen/" target="_blank">Screen</a>
      <a href="/vote/" target="_blank">Vote</a>
      <a href="/board/" target="_blank">Board</a>
    </nav>
  </header>

  <div class="wrap">
    <!-- LEFT: Queue -->
    <aside class="side">
      <div class="card">
        <h2>Singers</h2>
        <div class="footnote">Click “Set” to make someone current. “Remove” deletes from list.</div>
        <div id="queueList" class="list"></div>
      </div>

      <div class="card">
        <h2>Add Singer</h2>
        <div class="grid2">
          <input id="newSinger" placeholder="Singer name" />
          <input id="newSong" placeholder="Song • Artist (optional)" />
        </div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnAddSinger">Add to List</button>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Controls -->
    <main class="side">
      <details id="eventSect" class="card" open>
        <summary>Event Setup</summary>
        <div class="section">
          <div class="grid2">
            <div>
              <label class="footnote">Venue</label>
              <input id="venue" placeholder="Venue" list="venuesList" />
              <datalist id="venuesList"></datalist>
            </div>
            <div>
              <label class="footnote">KJ / Company</label>
              <input id="kj" placeholder="KJ / Company" list="kjsList" />
              <datalist id="kjsList"></datalist>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <label class="row"><input type="checkbox" id="lockEvent" /> Lock after save</label>
            <button id="btnSaveEvent" class="primary">Save Event</button>
            <button id="btnResetEvent" class="danger">Reset Event</button>
          </div>
        </div>
      </details>

      <div class="card">
        <h2>Singer</h2>
        <div class="grid2">
          <input id="currSingerName" placeholder="Current singer" />
          <input id="currSong" placeholder="Song • Artist (optional)" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSetCurrent" class="ok">Set Current</button>
          <button id="btnEnableSounds" class="warn">Enable Sounds</button>
        </div>
      </div>

      <div class="card">
        <h2>Voting</h2>
        <div class="grid2" style="align-items:stretch">
          <div class="panel">
            <div class="footnote">Timer</div>
            <div id="timer" class="timer">00:00</div>
            <div class="counts" style="margin-top:8px">
              <span class="pill">Encore: <b id="cEncore">0</b></span>
              <span class="pill">Another: <b id="cAnother">0</b></span>
              <span class="pill">Maybe: <b id="cMaybe">0</b></span>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="btnStart" class="primary">Start (30s)</button>
              <button id="btnExtend" class="warn">Extend (+15s)</button>
              <button id="btnEnd" class="danger">End Now</button>
            </div>
          </div>
          <div class="panel">
            <div class="footnote">Result</div>
            <div id="resultBox" class="resultBox muted">—</div>
            <div class="footnote" style="margin-top:8px">
              Result appears automatically after voting ends.
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Host Vote</h2>
        <div class="row">
          <button class="ok" id="hvEncore">Encore!</button>
          <button class="warn" id="hvAnother">Another Shot!</button>
          <button class="danger" id="hvMaybe">Maybe Next Time</button>
        </div>
        <div class="footnote" style="margin-top:8px">
          Host vote counts toward the totals while voting is open. Winner is decided only when the window closes.
        </div>
      </div>
    </main>
  </div>

<script>
const API = '/assets/api.php';
let soundsOn = false;
const S = {
  open: new Audio('/assets/voting_open.mp3'),
  over: new Audio('/assets/voting_over.mp3')
};
function safePlay(a){ if(!soundsOn) return; a.currentTime=0; a.play().catch(()=>{}); }

const els = {
  venuesList: document.getElementById('venuesList'),
  kjsList: document.getElementById('kjsList'),
  venue: document.getElementById('venue'),
  kj: document.getElementById('kj'),
  lockEvent: document.getElementById('lockEvent'),
  btnSaveEvent: document.getElementById('btnSaveEvent'),
  btnResetEvent: document.getElementById('btnResetEvent'),
  btnEnableSounds: document.getElementById('btnEnableSounds'),
  newSinger: document.getElementById('newSinger'),
  newSong: document.getElementById('newSong'),
  btnAddSinger: document.getElementById('btnAddSinger'),
  queueList: document.getElementById('queueList'),
  currSingerName: document.getElementById('currSingerName'),
  currSong: document.getElementById('currSong'),
  btnSetCurrent: document.getElementById('btnSetCurrent'),
  timer: document.getElementById('timer'),
  cEncore: document.getElementById('cEncore'),
  cAnother: document.getElementById('cAnother'),
  cMaybe: document.getElementById('cMaybe'),
  btnStart: document.getElementById('btnStart'),
  btnExtend: document.getElementById('btnExtend'),
  btnEnd: document.getElementById('btnEnd'),
  resultBox: document.getElementById('resultBox'),
};

const LS_VENUES = 'eyek_venues';
const LS_KJS = 'eyek_kjs';

let state = null;      // server state
let tickInt = null;

function loadLocalLists() {
  const venues = JSON.parse(localStorage.getItem(LS_VENUES)||'[]');
  const kjs = JSON.parse(localStorage.getItem(LS_KJS)||'[]');
  els.venuesList.innerHTML = venues.map(v=>`<option value="${escapeHtml(v)}">`).join('');
  els.kjsList.innerHTML = kjs.map(v=>`<option value="${escapeHtml(v)}">`).join('');
}
function saveLocalLists(venue,kj){
  if(venue){
    const v = new Set(JSON.parse(localStorage.getItem(LS_VENUES)||'[]')); v.add(venue);
    localStorage.setItem(LS_VENUES, JSON.stringify([...v].slice(-50)));
  }
  if(kj){
    const k = new Set(JSON.parse(localStorage.getItem(LS_KJS)||'[]')); k.add(kj);
    localStorage.setItem(LS_KJS, JSON.stringify([...k].slice(-50)));
  }
  loadLocalLists();
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

async function fetchState(){
  const res = await fetch(API); return res.json();
}
async function post(payload){
  const res = await fetch(API,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  return res.json();
}

function renderQueue(){
  const q = state.queue||[];
  els.queueList.innerHTML = q.map(s => `
    <div class="singer" data-id="${s.id}">
      <span class="dot"></span>
      <div>${escapeHtml(s.name)}</div>
      <button class="ok act-set" title="Set current">Set</button>
      <button class="danger act-del" title="Remove">Remove</button>
    </div>
  `).join('');
  els.queueList.querySelectorAll('.act-set').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.currentTarget.closest('.singer').dataset.id;
      const s = (state.queue||[]).find(x=>x.id===id);
      if(!s) return;
      await post({action:'set_current', singer:{id:s.id, name:s.name, songArtist:''}});
      state.currentSinger = {id:s.id, name:s.name, songArtist:''};
      els.currSingerName.value = s.name;
      els.currSong.value = '';
      // keep in queue (or remove? you can decide) — we’ll keep them for now
    };
  });
  els.queueList.querySelectorAll('.act-del').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.currentTarget.closest('.singer').dataset.id;
      const q2 = (state.queue||[]).filter(x=>x.id!==id);
      const r = await post({action:'set_queue', queue:q2});
      state.queue = r.queue;
      renderQueue();
    };
  });
}

function renderVoting(){
  const v = state.voting||{};
  els.cEncore.textContent = v.encore||0;
  els.cAnother.textContent = v.another||0;
  els.cMaybe.textContent = v.maybe||0;

  let rem = 0;
  if (v.isOpen && v.endsAt) rem = Math.max(0, v.endsAt - Math.floor(Date.now()/1000));
  els.timer.textContent = secs(rem);
  if (!v.isOpen && rem===0) {
    // show result if we have one
    const r = state.lastResult||"";
    const rb = els.resultBox;
    rb.className = 'resultBox ' + (r||'');
    rb.textContent = r ? (r==='encore'?'Encore!': r==='another'?'Another Shot!':'Maybe Next Time') : '—';
  }
}

function secs(s){
  const m = Math.floor(s/60), ss=("0"+(s%60)).slice(-2);
  return `${("0"+m).slice(-2)}:${ss}`;
}

async function loadAndRender(){
  state = await fetchState();
  // fill event fields (respect lock)
  els.venue.value = state.event?.venue || '';
  els.kj.value = state.event?.kj || '';
  els.lockEvent.checked = !!state.event?.locked;
  if (state.event?.locked) {
    els.venue.disabled = true; els.kj.disabled = true; els.lockEvent.disabled = true;
  } else {
    els.venue.disabled = false; els.kj.disabled = false; els.lockEvent.disabled = false;
  }

  // current singer into inputs
  els.currSingerName.value = state.currentSinger?.name || '';
  els.currSong.value = state.currentSinger?.songArtist || '';

  renderQueue();
  renderVoting();
}

function startTicker(){
  if (tickInt) clearInterval(tickInt);
  tickInt = setInterval(async ()=>{
    try{
      const s = await fetchState();
      // only re-render counters/timer/result to avoid clobbering input as you type
      state.voting = s.voting;
      state.lastResult = s.lastResult;
      renderVoting();
    }catch(e){}
  }, 1000);
}

// ————— EVENTS —————
els.btnEnableSounds.onclick = ()=>{ soundsOn = true; els.btnEnableSounds.textContent = 'Sounds Enabled'; };

els.btnSaveEvent.onclick = async ()=>{
  const evt = {
    venue: els.venue.value.trim(),
    kj: els.kj.value.trim(),
    locked: els.lockEvent.checked
  };
  saveLocalLists(evt.venue, evt.kj);
  state.event = evt;
  const r = await post({action:'event', event:evt});
  if (evt.locked) document.getElementById('eventSect').open = false;
};

els.btnResetEvent.onclick = async ()=>{
  // wipe singers and voting too
  state = {
    event: {venue:'', kj:'', locked:false},
    currentSinger: {id:'', name:'', songArtist:''},
    queue: [],
    voting: {isOpen:false, endsAt:0, encore:0, another:0, maybe:0},
    lastResult: "", version: 0
  };
  await post({action:'save_state', state});
  await loadAndRender();
  document.getElementById('eventSect').open = true;
};

els.btnAddSinger.onclick = async ()=>{
  const name = els.newSinger.value.trim();
  const song = els.newSong.value.trim();
  if(!name) return;
  const id = 's_'+Math.random().toString(36).slice(2,9);
  const q = state.queue || [];
  q.push({id, name});
  state.queue = q;
  await post({action:'set_queue', queue:q});
  // if you want to copy new singer into "current" inputs automatically, comment next two lines
  els.newSinger.value = ''; els.newSong.value = '';
  renderQueue();
};

els.btnSetCurrent.onclick = async ()=>{
  const s = {
    id: state.currentSinger?.id || ('s_'+Math.random().toString(36).slice(2,9)),
    name: els.currSingerName.value.trim(),
    songArtist: els.currSong.value.trim()
  };
  await post({action:'set_current', singer:s});
  state.currentSinger = s;
};

els.btnStart.onclick = async ()=>{
  const r = await post({action:'voting', cmd:'start', seconds:30});
  state = r.state; renderVoting(); safePlay(S.open);
};

els.btnExtend.onclick = async ()=>{
  const r = await post({action:'voting', cmd:'extend', seconds:15});
  state = r.state; renderVoting();
};

els.btnEnd.onclick = async ()=>{
  const r = await post({action:'voting', cmd:'end'});
  state = r.state; renderVoting(); safePlay(S.over);
};

document.getElementById('hvEncore').onclick = ()=> post({action:'vote', choice:'encore'}).then(loadAndRender);
document.getElementById('hvAnother').onclick = ()=> post({action:'vote', choice:'another'}).then(loadAndRender);
document.getElementById('hvMaybe').onclick = ()=> post({action:'vote', choice:'maybe'}).then(loadAndRender);

// init
loadLocalLists();
loadAndRender().then(startTicker);
</script>
</body>
</html>
