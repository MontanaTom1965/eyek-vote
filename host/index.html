<!doctype html>
<meta charset="utf-8" />
<title>Encore! • Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--purple:#2F0658;--card:#151429;--soft:#1f2040;--txt:#eef2ff;--muted:#aab2d6;--green:#25d366;--yellow:#f6c945;--red:#ff5e6c;--accent:#7aa2ff}
  *{box-sizing:border-box} body{margin:0;background:var(--purple);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  .card{background:linear-gradient(180deg,var(--card),#0e0e22);border:1px solid #2a2f56;border-radius:14px;padding:14px;box-shadow:0 6px 26px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:20px} h2{margin:0 0 10px;font-size:16px;color:var(--muted)}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
  input,button,select{font:inherit}
  input[type=text],input[type=password],input[type=date],select{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3c62;background:#0d1428;color:var(--txt)}
  select{cursor:pointer}
  input[disabled]{opacity:.7}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:grid;gap:12px} .side{display:grid;gap:12px}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--soft);color:var(--txt);cursor:pointer;transition:transform .04s ease,filter .12s ease}
  .btn:hover{filter:brightness(1.1)} .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent);color:#061028} .btn.good{background:var(--green);color:#03140b}
  .btn.warn{background:var(--yellow);color:#2a2105} .btn.bad{background:var(--red)}
  .list{display:grid;gap:8px;max-height:62vh;overflow:auto;padding-right:6px}
  .pill{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;background:#0d1428;border:1px solid #203153;border-radius:12px;padding:8px 10px}
  .dot{width:10px;height:10px;border-radius:50%;background:#6f7a98;border:1px solid #5b678a}
  .dot.green{background:var(--green);border-color:#2b8f57} .dot.yellow{background:var(--yellow);border-color:#9c7b1d}
  .bar{height:1px;background:#203153;margin:10px 0}
  .counts{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .bubble{min-width:72px;text-align:center;padding:10px 12px;border-radius:12px;font-weight:800;font-size:16px}
  .b-green{background:rgba(37,211,102,.15);border:1px solid rgba(37,211,102,.35);color:var(--green)}
  .b-yellow{background:rgba(246,201,69,.15);border:1px solid rgba(246,201,69,.35);color:var(--yellow)}
  .b-red{background:rgba(255,94,108,.15);border:1px solid rgba(255,94,108,.35);color:var(--red)}
  .timer{font-size:38px;font-weight:900}
  .resultTag{padding:8px 12px;border-radius:999px;border:1px solid #2b3c62;background:#0d1428;min-width:180px;text-align:center;font-weight:800}
  .r-encore{color:var(--green)} .r-another{color:var(--yellow)} .r-maybe{color:var(--red)}
  details{border:1px solid #243459;border-radius:12px} details[open] summary{border-bottom:1px solid #243459}
  summary{list-style:none;cursor:pointer;padding:10px 14px;background:#0f1526;border-radius:12px} summary::-webkit-details-marker{display:none}
  .links a{color:#8edbff;text-decoration:none} .links a:hover{text-decoration:underline}
  .micro{font-size:12px;color:#aab2d6}
  .soundLink{font-size:12px;margin-top:6px}
  .soundLink a{color:#cfe0ff;text-decoration:underline;cursor:pointer}
  .soundLink a:hover{text-decoration:none}
  /* mini vote dots next to bubbles */
  .miniDots{display:flex;gap:5px;align-items:center;min-height:12px}
  .miniDots .d{width:10px;height:10px;border-radius:50%}
  .d.g{background:var(--green)} .d.y{background:var(--yellow)} .d.r{background:var(--red)}
  .miniDots .d{animation:miniBounce .7s ease-out}
  @keyframes miniBounce{
    0%{transform:translateY(-10px);opacity:0}
    60%{transform:translateY(3px);opacity:1}
    100%{transform:translateY(0)}
  }
  /* Bigger Current Singer block for visibility */
  .bigCurrent{font-size:24px;font-weight:900}
  .bigSong input{font-size:17px;padding:12px}
  /* small dropdown next to inputs */
  .shrink{min-width:180px}
</style>

<div class="wrap">
  <!-- LEFT -->
  <div class="side">
    <div class="card">
      <h1>Rotation</h1>
      <div class="micro" style="margin:-4px 0 6px">• gray=new • green=Encore • yellow=Another Shot</div>
      <div id="singerList" class="list"></div>
    </div>
    <div class="card links">
      <h2>Quick Links</h2>
      <a target="_blank" href="/host/index.html">Open Host</a><br>
      <a target="_blank" href="/screen/index.html">Open Screen</a><br>
      <a target="_blank" href="/vote/index.html">Open Vote</a><br>
      <a target="_blank" href="/board/index.html">Open Board</a>
      <div class="soundLink">
        <span id="soundStatus">Sound: <b>off</b></span> • <a id="enableSound">Enable sound</a>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="stack">
    <details id="eventBox" class="card" open>
      <summary><h1 style="display:inline">Event / KJ Setup</h1> <span id="eventSavedMsg" class="micro" style="margin-left:8px"></span></summary>
      <div class="stack" style="padding-top:10px">
        <div class="row">
          <div style="flex:1">
            <label>Venue (internal)</label>
            <div class="row" style="gap:8px">
              <input list="venuesList" id="venue" type="text" placeholder="venue - city" autocomplete="off" spellcheck="false">
              <select id="venueSel" class="shrink"></select>
            </div>
            <datalist id="venuesList"></datalist>
          </div>
          <div style="flex:1">
            <label>Public Venue Name (Screen)</label>
            <input id="venuePublic" type="text" placeholder="the Venue!" autocomplete="off" spellcheck="false">
          </div>
          <div style="width:200px">
            <label>Date</label>
            <input id="eventDate" type="date">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>KJ Company</label>
            <div class="row" style="gap:8px">
              <input list="kjsList" id="kj" type="text" placeholder="Karaoke Company" autocomplete="off" spellcheck="false">
              <select id="kjSel" class="shrink"></select>
            </div>
            <datalist id="kjsList"></datalist>
          </div>
          <div style="flex:1">
            <label>Karaoke Host Name</label>
            <input id="hostName" type="text" placeholder="Your name (e.g., Angel)" autocomplete="off" spellcheck="false">
          </div>
          <div style="width:240px">
            <label>Event PIN</label>
            <div class="row" style="gap:8px">
              <input id="pin" type="password" placeholder="4–8 digits" autocomplete="off" inputmode="numeric" style="flex:1">
              <button class="btn" id="togglePin" type="button" style="padding:8px 10px">Show</button>
            </div>
            <div id="pinSaved" class="micro" style="margin-top:4px;color:#8edbff"></div>
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="saveEvent">Save</button>
          <button class="btn" id="lockEvent">Lock</button>
          <button class="btn" id="resetEvent">Reset</button>
        </div>
        <div class="micro">Lock prevents edits (panel does not auto-collapse). Reset clears singers & votes (only when unlocked).</div>
      </div>
    </details>

    <div class="card">
      <h1>Show Control</h1>
      <div style="font-weight:800;color:#cfe0ff">Add Singer</div>
      <div class="row">
        <input id="singerName" type="text" placeholder="Singer name (e.g., Lisa H.)" autocomplete="off" spellcheck="false">
        <input id="songArtist" type="text" placeholder="(Optional) First song — artist (notes)" autocomplete="off" spellcheck="false">
        <button class="btn primary" id="addSinger" type="button">Add Singer</button>
      </div>

      <div class="bar"></div>

      <div style="font-weight:800;color:#cfe0ff">Current & Voting</div>
      <div class="row">
        <div style="flex:1">
          <div class="micro">Current Singer</div>
          <div id="currentName" class="bigCurrent">—</div>
          <div class="micro">Now Singing — Song/Artist</div>
          <div class="bigSong"><input id="currentSongArtist" type="text" placeholder="Type song — artist…" disabled autocomplete="off" spellcheck="false"></div>
        </div>
        <div style="text-align:right">
          <div class="micro">Timer</div>
          <div id="timer" class="timer">00:00</div>
        </div>
      </div>
      <div class="counts" style="margin-top:6px">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="bubble b-green" id="c_encore">0</div>
          <div id="miniE" class="miniDots"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="bubble b-yellow" id="c_another">0</div>
          <div id="miniA" class="miniDots"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="bubble b-red" id="c_maybe">0</div>
          <div id="miniM" class="miniDots"></div>
        </div>
        <div id="resultTag" class="resultTag">—</div>
      </div>
      <div class="row" style="gap:10px;margin-top:10px">
        <button class="btn good" id="startVote">Start (30s + 5s prep)</button>
        <button class="btn warn" id="extendVote">Extend (+15s)</button>
        <button class="btn bad" id="endVote">End</button>
      </div>

      <div class="bar"></div>
      <div style="font-weight:800;color:#cfe0ff">Host Vote</div>
      <div class="row" style="gap:10px">
        <button class="btn good" id="hv_encore">Encore!</button>
        <button class="btn warn" id="hv_another">Another Shot!</button>
        <button class="btn bad" id="hv_maybe">Maybe Next Time</button>
      </div>
      <div class="micro" style="margin-top:6px">One vote per device per singer/song. Results announced when timer ends or you press <b>End</b>.</div>
    </div>
  </div>
</div>

<script>
const GET_URL  = '/assets/get_state.php';
const POST_URL = '/assets/state.php';
const VOTE_URL = '/assets/vote.php';
const PERF_URL = '/assets/submit_performance.php';

function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
const $=s=>document.querySelector(s);
const digitsOnly = s => (s||'').replace(/\D+/g,'');

let state=null, poll=null;
let suppressEventRenderUntil = 0;
function suppressEventRender(ms=1000){ suppressEventRenderUntil = Date.now() + ms; }
function mayRenderEventInputs(){ return Date.now() > suppressEventRenderUntil; }

const venue=$('#venue'), venuePublic=$('#venuePublic'), eventDate=$('#eventDate'), kj=$('#kj'), hostName=$('#hostName'), pin=$('#pin');
const venuesList=document.getElementById('venuesList'), kjsList=document.getElementById('kjsList');
const venueSel=$('#venueSel'), kjSel=$('#kjSel');
const singerName=$('#singerName'), songArtist=$('#songArtist');
const singerList=$('#singerList');
const currentName=$('#currentName'), currentSongArtist=$('#currentSongArtist');
const timerEl=$('#timer'), cE=$('#c_encore'), cA=$('#c_another'), cM=$('#c_maybe'), resultTag=$('#resultTag');
const eventBox=$('#eventBox'), lockBtn=document.getElementById('lockEvent');
const pinSaved=$('#pinSaved'); const togglePin=$('#togglePin');

// For host mini dots
let lastCounts = { encore:0, another:0, maybe:0 };

async function fetchState(){ const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json();
  state.event   ||= {venue:'',venuePublic:'',date:new Date().toISOString().slice(0,10),kj:'',hostName:'',pin:'',locked:false};
  state.saved   ||= {venues:[], kjs:[]};
  state.singers ||= []; state.current ||= {id:null,name:'',songArtist:''};
  state.voting  ||= {open:false,prepUntil:0,endsAt:0,extendCount:0,counts:{encore:0,another:0,maybe:0},lastResult:null,voters:{}};
  state.winners ||= {encore:[],another:[]};
}
async function postState(){ await fetch(POST_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(state)}); await fetchState(); }
const postStateDebounced = debounce(async ()=>{ await fetch(POST_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(state)}); await fetchState(); render(); }, 250);

function fillSavedControls(){
  // datalists
  venuesList.innerHTML = (state.saved.venues||[]).map(v=>`<option value="${v.replace(/"/g,'&quot;')}">`).join('');
  kjsList.innerHTML    = (state.saved.kjs||[]).map(v=>`<option value="${v.replace(/"/g,'&quot;')}">`).join('');
  // selects
  function fillSelect(sel, arr){ sel.innerHTML = `<option value="">Recent…</option>` + (arr||[]).map(v=>`<option>${v.replace(/</g,'&lt;')}</option>`).join(''); }
  fillSelect(venueSel, state.saved.venues); fillSelect(kjSel, state.saved.kjs);
}

function render(){
  if(!state) return;

  fillSavedControls();

  const canPaint = mayRenderEventInputs();
  if (canPaint && document.activeElement !== venue)        venue.value       = state.event.venue || '';
  if (canPaint && document.activeElement !== venuePublic)  venuePublic.value = state.event.venuePublic || '';
  if (canPaint && document.activeElement !== eventDate)    eventDate.value   = state.event.date || new Date().toISOString().slice(0,10);
  if (canPaint && document.activeElement !== kj)           kj.value          = state.event.kj || '';
  if (canPaint && document.activeElement !== hostName)     hostName.value    = state.event.hostName || '';
  if (canPaint && document.activeElement !== pin)          pin.value         = state.event.pin || '';
  [venue,venuePublic,eventDate,kj,hostName,pin].forEach(el=>el.disabled=state.event.locked);

  lockBtn.textContent = state.event.locked ? 'Unlock' : 'Lock';

  // rotation list
  singerList.innerHTML='';
  (state.singers||[]).forEach(s=>{
    const row=document.createElement('div'); row.className='pill';
    const dot=document.createElement('div'); dot.className='dot '+(s._color||'');
    const name=document.createElement('div'); name.textContent=s.name; name.style.fontWeight='600'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis'; name.style.whiteSpace='nowrap';
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const setB=document.createElement('button'); setB.className='btn'; setB.textContent='Set'; setB.onclick=()=>setCurrent(s.id);
    const rmB=document.createElement('button'); rmB.className='btn'; rmB.textContent='Remove'; rmB.onclick=()=>removeSinger(s.id);
    actions.append(setB,rmB); row.append(dot,name,actions); singerList.append(row);
  });

  currentName.textContent=state.current.name||'—';
  currentSongArtist.disabled=!state.current.id;
  if(document.activeElement!==currentSongArtist){ currentSongArtist.value=state.current.songArtist||''; }

  const ce=state.voting.counts.encore||0, ca=state.voting.counts.another||0, cm=state.voting.counts.maybe||0;
  cE.textContent=ce; cA.textContent=ca; cM.textContent=cm;

  // mini dots (bigger + bounce)
  if(state.voting.open){
    if(ce>lastCounts.encore)  addMiniDots('#miniE','g', ce-lastCounts.encore);
    if(ca>lastCounts.another) addMiniDots('#miniA','y', ca-lastCounts.another);
    if(cm>lastCounts.maybe)   addMiniDots('#miniM','r', cm-lastCounts.maybe);
  } else {
    ['#miniE','#miniA','#miniM'].forEach(sel=>$(sel).innerHTML='');
  }
  lastCounts = {encore:ce, another:ca, maybe:cm};

  // timer + result
  const now=Date.now();
  if(!state.voting.open && (state.voting.prepUntil||0) > now){
    const ms = state.voting.prepUntil - now;
    timerEl.textContent = 'Get ready: '+fmt(ms);
    resultTag.textContent='—'; resultTag.className='resultTag';
  } else if(state.voting.open){
    const ms=Math.max(0, (state.voting.endsAt||0)-now);
    timerEl.textContent=fmt(ms);
    resultTag.textContent='Voting…'; resultTag.className='resultTag';
  } else {
    timerEl.textContent='00:00'; announce(state.voting.lastResult);
  }
}
function addMiniDots(sel, cls, n){
  const c=$(sel);
  for(let i=0;i<n;i++){
    const d=document.createElement('div'); d.className='d '+cls;
    c.appendChild(d);
    if(c.childNodes.length>40) c.removeChild(c.firstChild);
  }
}
function fmt(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}` }
function announce(w){ if(!w){ resultTag.textContent='—'; resultTag.className='resultTag'; return;}
  if(w==='encore'){ resultTag.textContent='Encore!'; resultTag.className='resultTag r-encore'; }
  else if(w==='another'){ resultTag.textContent='Another Shot!'; resultTag.className='resultTag r-another'; }
  else { resultTag.textContent='Maybe Next Time'; resultTag.className='resultTag r-maybe'; }
}

/* Live bindings */
function bindLive(el, key, transform=(x)=>x, immediate=false){
  const handler = async ()=>{
    if(!state?.event) return;
    const val = transform(el.value);
    el.value = val;
    state.event[key] = val;
    suppressEventRender(600);
    if(immediate){ await postState(); showPinSaved(key); } else { postStateDebounced(); }
  };
  el.addEventListener('input', handler);
  el.addEventListener('change', handler);
}
bindLive(venue,       'venue');
bindLive(venuePublic, 'venuePublic');
bindLive(eventDate,   'date');
bindLive(kj,          'kj');
bindLive(hostName,    'hostName');
bindLive(pin,         'pin', digitsOnly, true); // PIN saves instantly

function showPinSaved(key){ if(key!=='pin') return; pinSaved.textContent='PIN saved'; setTimeout(()=>pinSaved.textContent='',1200); }
togglePin.onclick = ()=>{ pin.type = (pin.type==='password'?'text':'password'); togglePin.textContent = (pin.type==='password'?'Show':'Hide'); };

/* quick-select dropdowns */
venueSel.addEventListener('change', ()=>{ if(!venueSel.value) return; venue.value=venueSel.value; venue.dispatchEvent(new Event('change')); });
kjSel.addEventListener('change', ()=>{ if(!kjSel.value) return; kj.value=kjSel.value; kj.dispatchEvent(new Event('change')); });

/* Event actions */
document.getElementById('saveEvent').onclick = async ()=>{
  await postState(); const m=document.getElementById('eventSavedMsg');
  m.textContent='Saved!'; setTimeout(()=>m.textContent='',1400);
};
lockBtn.onclick = async ()=>{ state.event.locked = !state.event.locked; await postState(); };
document.getElementById('resetEvent').onclick = async ()=>{
  if(state.event.locked){ alert('Unlock to reset.'); return;}
  if(!confirm('Reset this event? This clears singers & votes.')) return;
  state={ serverUpdatedAt: Date.now()/1000|0,
    event:{venue:'',venuePublic:'',date:new Date().toISOString().slice(0,10),kj:'',hostName:'',pin:'',locked:false},
    saved:{venues: state.saved?.venues ?? [], kjs: state.saved?.kjs ?? []},
    singers:[], current:{id:null,name:'',songArtist:''},
    voting:{open:false,prepUntil:0,endsAt:0,extendCount:0,counts:{encore:0,another:0,maybe:0},lastResult:null,voters:{}},
    winners:{encore:[], another:[]}
  };
  await postState();
};

/* Singer actions */
document.getElementById('addSinger').onclick = async ()=>{
  const name=singerName.value.trim(); if(!name){ alert('Enter a singer name.'); return;}
  const id='s_'+Math.random().toString(36).slice(2,9);
  state.singers.push({id,name,_color:''});
  singerName.value=''; songArtist.value='';
  await postState();
};
function setCurrent(id){
  const s = state.singers.find(x=>x.id===id); if(!s) return;
  state.voting = { open:false, prepUntil:0, endsAt:0, extendCount:0,
                   counts:{encore:0,another:0,maybe:0}, lastResult:null, voters:{} };
  lastCounts = {encore:0,another:0,maybe:0};
  state.current = { id:s.id, name:s.name, songArtist:'' };
  postState();
}
function removeSinger(id){ state.singers=state.singers.filter(x=>x.id!==id); if(state.current.id===id){ state.current={id:null,name:'',songArtist:''}; } postState(); }

/* Now Singing */
currentSongArtist.addEventListener('input', async ()=>{ if(!state.current.id) return; state.current.songArtist=currentSongArtist.value.trim(); await postState(); });

/* Voting with 5s prep */
document.getElementById('startVote').onclick = async ()=>{
  if(!state.current.id){ alert('Set a current singer first.'); return; }
  try{ await fetch(PERF_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ singer: state.current.name || '', song: state.current.songArtist || '' })}); }catch{}
  const now=Date.now();
  state.voting={ open:false, prepUntil: now+5000, endsAt:0, extendCount:0, counts:{encore:0,another:0,maybe:0}, lastResult:null, voters:{} };
  lastCounts = {encore:0,another:0,maybe:0};
  await postState();
  // If sound isn't enabled, nudge the host
  if(!audio.enabled()){
    alert('Tap "Enable sound" (left panel) to allow voting sounds.');
  }
};
document.getElementById('extendVote').onclick = async ()=>{ if(!state.voting.open) return; state.voting.endsAt+=15000; state.voting.extendCount++; await postState(); };
document.getElementById('endVote').onclick = async ()=>{ await concludeVoting(); };

/* Host vote -> server */
function deviceId(){ let id=localStorage.getItem('eyek_device_id'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('eyek_device_id', id);} return id; }
async function hostVote(kind){
  if(!state?.voting?.open) return;
  const res=await fetch(VOTE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({choice:kind, deviceId:deviceId()})});
  await fetchState(); render();
  if(!res.ok){ const e=await res.json().catch(()=>({error:'vote_failed'})); if(e.error==='already_voted'){ alert('Only one vote per device per singer/song on this device.'); } }
}
document.getElementById('hv_encore').onclick = ()=>hostVote('encore');
document.getElementById('hv_another').onclick = ()=>hostVote('another');
document.getElementById('hv_maybe').onclick  = ()=>hostVote('maybe');

async function concludeVoting(){
  if(!state.voting.open){ announce(state.voting.lastResult); return; }
  state.voting.open=false; state.voting.endsAt=0;
  const {encore,another,maybe}=state.voting.counts; let winner='maybe';
  if(encore>=another && encore>=maybe) winner='encore';
  else if(another>=encore && another>=maybe) winner='another';
  state.voting.lastResult=winner;

  const cur=state.singers.find(s=>s.id===state.current.id);
  if(cur){
    if(winner==='maybe'){ state.singers=state.singers.filter(s=>s.id!==cur.id); }
    else { cur._color=(winner==='encore'?'green':'yellow'); }
  }
  state.winners = state.winners || {encore:[], another:[]};
  if(winner==='encore' || winner==='another'){
    state.winners[winner].unshift({when:new Date().toISOString(), name:state.current.name, song:state.current.songArtist||''});
    state.winners[winner]=state.winners[winner].slice(0,50);
  }
  await postState(); announce(winner);
  audio.stopOpen();
  if (winner === 'encore')       setTimeout(()=>audio.playEncore(), 150);
  else if (winner === 'maybe')   setTimeout(()=>audio.playLoser(),  150);
}

/* Loop: handle prep->open transition and end-on-time */
function loop(){
  if(poll) clearInterval(poll);
  poll=setInterval(async ()=>{
    await fetchState();
    const now=Date.now();

    if(!state.voting.open && (state.voting.prepUntil||0) > 0 && now >= state.voting.prepUntil){
      state.voting.open = true;
      state.voting.prepUntil = 0;
      state.voting.endsAt = now + 30000;
      await postState();
      audio.playOpen(); // start loop when voting actually opens
    }

    if(state?.voting?.open && now>=state.voting.endsAt){
      await concludeVoting();
    } else {
      render();
      if(!state.voting.open) audio.stopOpen();
    }
  }, 800);
}

/* Audio: warmup + fallback + status */
function mkAudio(paths){ const a=new Audio(); for(const p of paths){ const el=new Audio(p); el.preload='auto'; return el; } }
const audio=(function(){
  let enabled=false;
  const aOpen   = mkAudio(['/assets/voting_open.mp3','/assets/voting_open.wav']); aOpen.loop=true;
  const aEncore = mkAudio(['/assets/encore.mp3','/assets/encore.wav']);
  const aLoser  = mkAudio(['/assets/loser.wav','/assets/loser.mp3']);
  const statusEl=document.getElementById('soundStatus');

  function setStatus(){ statusEl.innerHTML = 'Sound: <b>'+(enabled?'on':'off')+'</b>'; }

  let ctx=null;
  function waPing(){ try{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.02); return true; }catch{ return false; } }
  async function warm(el){ try{ el.muted=true; await el.play(); el.pause(); el.currentTime=0; el.muted=false; return true; }catch{ return false; } }

  document.getElementById('enableSound').addEventListener('click', async ()=>{
    const ok = waPing() | await warm(aEncore) | await warm(aLoser) | await warm(aOpen);
    enabled = !!ok; setStatus(); if(!enabled) alert('Could not enable audio. Browser blocked playback.');
  });

  function play(a){ if(!enabled) return; a.currentTime=0; a.play().catch(()=>{}); }
  function stop(a){ try{ a.pause(); a.currentTime=0; }catch{} }

  return {
    enabled:()=>enabled,
    playOpen(){ if(!enabled) return; stop(aEncore); stop(aLoser); stop(aOpen); aOpen.play().catch(()=>{}); },
    stopOpen(){ stop(aOpen); },
    playEncore(){ play(aEncore); },
    playLoser(){ play(aLoser); }
  };
})();

(async function init(){ await fetchState(); render(); loop(); })();
</script>
