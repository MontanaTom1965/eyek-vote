<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Earn Your Encore Karaoke — Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --scale:1;
      --bg:#0a0d14; --card:#111a30; --border:#2a3a60;
      --text:#fff; --muted:#c9d3ea; --accent:#7bc4ff;
      --encore:#22c55e; --another:#f59e0b; --maybe:#ef4444;
      --btn:#132046; --btnBorder:#3b4c7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{background:var(--bg)}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size:calc(20px * var(--scale)); line-height:1.35;
      display:flex; flex-direction:column;
    }
    .fatal{position:sticky; top:0; z-index:9999; background:#b91c1c; color:#fff; padding:.5em .8em; font-weight:900; display:none}
    header{position:sticky; top:0; z-index:10; border-bottom:2px solid var(--border); background:linear-gradient(180deg,rgba(10,13,20,.92),rgba(10,13,20,.65)); backdrop-filter:blur(6px)}
    .wrap{max-width:1250px; margin:0 auto; width:100%}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px}
    .title{font-size:1.4em; font-weight:900}
    .pill{display:inline-block; border:2px solid var(--border); border-radius:999px; padding:.25em .6em; color:var(--muted); font-weight:800}
    main{padding:18px}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:var(--card); border:2px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h2{margin:.1em 0 .5em; font-size:1.2em}
    label{display:block; margin:.55em 0 .25em; font-weight:800}
    input{
      width:100%; padding:.65em .8em; border-radius:12px;
      border:2px solid var(--border); background:#0f1732; color:#fff; font-size:1.02em;
    }
    input:focus{outline:none; box-shadow:0 0 0 4px rgba(123,196,255,.25)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; padding:.75em 1em; border:2px solid var(--btnBorder); border-radius:12px;
      background:var(--btn); color:#fff; font-weight:900; cursor:pointer; font-size:1.02em; letter-spacing:.2px;
      min-height:52px;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.primary{background:var(--accent); color:#06111e; border-color:#a9d9ff}
    .btn.good{background:var(--encore); color:#062; border-color:#6fe394}
    .btn.warn{background:var(--another); color:#231b00; border-color:#ffd28a}
    .btn.danger{background:var(--maybe); color:#2b0000; border-color:#ffb4b4}
    .btn.ghost{background:#0f1732}
    .hint{color:var(--muted); font-weight:600}
    ul{list-style:none; margin:0; padding:0}
    li{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:.6em .7em; border:2px solid var(--border); border-radius:12px; background:#0f1732; margin:.45em 0;
    }
    .smallQR{
      display:flex; align-items:center; gap:12px; border:2px dashed var(--border);
      border-radius:12px; padding:10px; background:#0d142b;
    }
    .smallQR img{width:140px; height:140px; object-fit:contain; border-radius:10px}
    .controls .btn{min-width:200px}
    footer{margin:10px 0 20px}
    .status{position:sticky; bottom:0; background:linear-gradient(180deg,rgba(10,13,20,.5),rgba(10,13,20,.95)); border-top:2px solid var(--border); padding:10px 16px; font-weight:800}
    .zoomBar{display:flex; gap:10px; align-items:center; justify-content:center}
    .zoomBar .btn{min-width:0; padding:.45em .7em}
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>

  <header>
    <div class="wrap bar">
      <div class="title">Host Control</div>
      <div class="pill" id="eventPill">Event: —</div>
    </div>
  </header>

  <main class="wrap">
    <!-- Event -->
    <section class="card">
      <h2>Event</h2>
      <div class="row">
        <div style="flex:1 1 380px; min-width:280px">
          <label for="eventId">Event name (venue)</label>
          <input id="eventId" placeholder="e.g. Eagles Nest" />
        </div>
        <div class="stack">
          <label class="row" style="font-weight:800"><input type="checkbox" id="lockEvent" /> Lock Event</label>
          <label class="row" style="font-weight:800"><input type="checkbox" id="broadcastActive" /> Broadcast Active Event</label>
        </div>
        <div>
          <button class="btn primary" id="setEventBtn" title="Apply event">Event</button>
        </div>
      </div>
      <div class="hint" id="eventNote" style="margin-top:.45em">
        Broadcast Active Event: when ON, TVs at <code>/screen</code> and <code>/board</code> (no URL params) auto-follow this event.
      </div>
    </section>

    <!-- Singer Add -->
    <section class="card">
      <h2>Add singer</h2>
      <div class="row">
        <div style="flex:1 1 480px; min-width:280px">
          <label for="singerName">Singer name</label>
          <input id="singerName" placeholder="Type a name, press Enter" />
        </div>
        <div>
          <button class="btn primary" id="addSingerBtn">Add</button>
        </div>
      </div>
      <div class="hint" id="addSingerStatus" style="margin-top:.35em">Ready.</div>
    </section>

    <!-- Current Singers + Links -->
    <div class="grid grid-2">
      <section class="card">
        <h2>Current singers</h2>
        <div class="row" style="margin:.25em 0 .5em">
          <label class="row"><input type="checkbox" id="showHidden" /> Show hidden (Maybe) singers</label>
        </div>
        <ul id="singerList"></ul>
        <div class="hint" id="singerReadNote"></div>
      </section>

      <!-- Now Performing with small QR + controls -->
      <section class="card">
        <h2>Now Performing</h2>
        <div class="smallQR" style="margin:.4em 0 1em">
          <img id="qrImg" alt="QR" />
          <div>
            <div style="font-weight:900; font-size:1.2em" id="nowPerfLabel">None</div>
            <div class="hint" id="perfStatus">No performance yet</div>
            <div class="hint" style="margin-top:.25em">Countdown: <span id="countdown" style="font-weight:900">—</span></div>
          </div>
        </div>
        <div class="controls stack">
          <button class="btn warn" id="btnVoteNow">Vote now (30s)</button>
          <button class="btn ghost" id="btnExtend15">Extend +15s</button>
          <button class="btn danger" id="btnEndNow">End now</button>
        </div>
      </section>
    </div>

    <!-- Links -->
    <section class="card">
      <h2>Links (open in new tabs)</h2>
      <div class="stack">
        <button class="btn ghost" id="openVote">Vote</button>
        <button class="btn ghost" id="openScreen">Screen</button>
        <button class="btn ghost" id="openBoard">Board</button>
      </div>
    </section>

    <!-- Host vote -->
    <section class="card">
      <h2>Host vote (optional)</h2>
      <div class="stack">
        <button class="btn" id="hostVoteEncore"  style="background:var(--encore);color:#062">Encore</button>
        <button class="btn" id="hostVoteAnother" style="background:var(--another);color:#231b00">Another</button>
        <button class="btn" id="hostVoteMaybe"   style="background:var(--maybe)">Maybe Next Time</button>
      </div>
      <div class="hint" style="margin-top:.4em">One vote per device per performance (same as audience).</div>
    </section>
  </main>

  <div class="status">
    <div id="statusBar">Status: Idle…</div>
  </div>

  <footer class="wrap">
    <div class="zoomBar">
      <button class="btn ghost" id="zoomDown" title="Smaller text">A−</button>
      <span class="pill" id="zoomLabel">Text: 100%</span>
      <button class="btn ghost" id="zoomUp" title="Larger text">A+</button>
    </div>
  </footer>

  <!-- ========= CORE (no-module, compat builds) ========= -->
  <script>
    // Error banner (always on)
    (function(){
      var fatalEl = document.getElementById('fatal');
      function showFatal(msg){ if(!msg) return; fatalEl.style.display='block'; fatalEl.textContent='Error: '+msg; }
      window.__showFatal = showFatal;
      window.addEventListener('error', e=> showFatal((e.error && e.error.message) || e.message));
      window.addEventListener('unhandledrejection', e=> showFatal((e.reason && (e.reason.message||e.reason)) || 'Unhandled rejection'));

      // A-/A+ available regardless of Firebase
      var Z_KEY='eyek_zoom', zoomLabel=document.getElementById('zoomLabel');
      function setZoom(v){ v=Math.min(1.8,Math.max(0.7,v)); document.documentElement.style.setProperty('--scale',v); try{localStorage.setItem(Z_KEY,String(v))}catch(_){}
        zoomLabel.textContent='Text: '+Math.round(v*100)+'%'; }
      document.getElementById('zoomDown').addEventListener('click', ()=> setZoom((+localStorage.getItem(Z_KEY)||1)-0.1));
      document.getElementById('zoomUp').addEventListener('click',   ()=> setZoom((+localStorage.getItem(Z_KEY)||1)+0.1));
      setZoom(+localStorage.getItem(Z_KEY)||1);
    })();
  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      // Config
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote",
        storageBucket: "eyek-vote.firebasestorage.app",
        messagingSenderId: "954696683994",
        appId: "1:954696683994:web:21a84298a94648ff0230e3"
      };

      // Guard if firebase failed to load
      if (!window.firebase || !firebase.initializeApp){
        return window.__showFatal('Firebase libraries failed to load.');
      }

      // Init
      firebase.initializeApp(FIREBASE_CONFIG);
      var db = firebase.firestore();
      var auth = firebase.auth();

      // DOM helpers
      function $(id){ return document.getElementById(id); }
      function setStatus(t){ $('statusBar').textContent='Status: '+t; }
      function urlRoot(){ return location.origin + '/'; }

      // Elements
      var eventIdInput=$('eventId'), eventPill=$('eventPill'), setBtn=$('setEventBtn');
      var broadcastEl=$('broadcastActive'), lockEventEl=$('lockEvent'), eventNote=$('eventNote');

      var singerNameInput=$('singerName'), addSingerBtn=$('addSingerBtn'), addSingerStatus=$('addSingerStatus');
      var showHiddenEl=$('showHidden'), singerListEl=$('singerList'), singerReadNote=$('singerReadNote');

      var nowPerfLabel=$('nowPerfLabel'), perfStatus=$('perfStatus'), countdownEl=$('countdown');
      var qrImg=$('qrImg');

      var openVote=$('openVote'), openScreen=$('openScreen'), openBoard=$('openBoard');

      // Auth (anon)
      auth.signInAnonymously().catch(function(e){ setStatus('Auth error: ' + ((e&&e.message)||e)); });

      // State
      var LS_EVENT='eyek_last_event';
      var STATE={ currentSingerId:null, currentSingerName:null, performanceId:null, performanceCloseAt:null, performanceStatus:'' };
      var unsubSingers=null, unsubState=null, unsubPerf=null;
      var countdownTimer=null, autoCloseTimer=null;
      var perfOutcomeCache={}; // perfId -> outcome
      var cachedSingers=[];

      // Prompt once for event if missing
      (function(){
        var u=new URL(location.href), q=u.searchParams.get('eventId'), mem=localStorage.getItem(LS_EVENT);
        if(!q && !mem){
          var typed=(prompt('Enter event name:')||'').trim();
          if(typed){ u.searchParams.set('eventId',typed); history.replaceState({},'',u.toString()); localStorage.setItem(LS_EVENT,typed); }
        }
      })();

      // Restore toggles
      broadcastEl.checked=localStorage.getItem('eyek_broadcast_event')==='1';
      lockEventEl.checked=localStorage.getItem('eyek_lock_event')==='1';
      syncSetBtnDisabled(); if(lockEventEl.checked) eventNote.textContent='Event locked — switching disabled.';

      // Start event
      var START_EVENT=(new URL(location.href)).searchParams.get('eventId') || localStorage.getItem(LS_EVENT) || 'default';
      eventIdInput.value=START_EVENT;
      applyEvent(START_EVENT);

      // Listeners
      setBtn.addEventListener('click', onClickSetEvent);
      eventIdInput.addEventListener('keydown', function(e){ if(e.key==='Enter') onClickSetEvent(); });
      lockEventEl.addEventListener('change', function(){
        localStorage.setItem('eyek_lock_event',lockEventEl.checked?'1':'0');
        eventNote.textContent=lockEventEl.checked?'Event locked — switching disabled.':'';
        syncSetBtnDisabled();
      });
      broadcastEl.addEventListener('change', function(){
        localStorage.setItem('eyek_broadcast_event',broadcastEl.checked?'1':'0');
        if(broadcastEl.checked) broadcastActiveEvent(getCurrentEventId());
      });

      addSingerBtn.addEventListener('click', addSinger);
      singerNameInput.addEventListener('keydown', function(e){ if(e.key==='Enter') addSinger(); });

      $('btnVoteNow').addEventListener('click', function(){ openVoting(30); });
      $('btnExtend15').addEventListener('click', function(){ extendVoting(15); });
      $('btnEndNow').addEventListener('click', endVotingNow);

      $('hostVoteEncore').addEventListener('click', function(){ hostCastVote('encore'); });
      $('hostVoteAnother').addEventListener('click', function(){ hostCastVote('another'); });
      $('hostVoteMaybe').addEventListener('click', function(){ hostCastVote('maybe'); });

      showHiddenEl.addEventListener('change', function(){ renderSingerList(cachedSingers); });

      openVote.addEventListener('click', function(){
        var eid=getCurrentEventId();
        var base=urlRoot()+'vote/index.html?eventId='+encodeURIComponent(eid);
        // If a performance exists, include it so you can test quickly
        if(STATE.performanceId) base+='&performanceId='+encodeURIComponent(STATE.performanceId);
        window.open(base,'_blank','noopener');
      });
      openScreen.addEventListener('click', function(){
        window.open(urlRoot()+'screen/index.html?eventId='+encodeURIComponent(getCurrentEventId()),'_blank','noopener');
      });
      openBoard.addEventListener('click', function(){
        window.open(urlRoot()+'board/index.html?eventId='+encodeURIComponent(getCurrentEventId()),'_blank','noopener');
      });

      function syncSetBtnDisabled(){ setBtn.disabled = !!lockEventEl.checked; }
      function getCurrentEventId(){
        var u=new URL(window.location.href), q=u.searchParams.get('eventId');
        if(q && q.trim()) return q.trim();
        var mem=localStorage.getItem(LS_EVENT);
        return (mem && mem.trim()) ? mem.trim() : 'default';
      }

      function onClickSetEvent(){
        var typed=(eventIdInput.value||'').trim();
        var current=getCurrentEventId();
        if(lockEventEl.checked) return setStatus('Event is locked. Uncheck “Lock Event” to switch.');
        if(!typed) return setStatus('Enter an event name.');
        if(typed===current) return setStatus('Already on “'+current+'”.');

        var ok=true;
        try{
          ok=confirm('Switch event from “'+current+'” to “'+typed+'”?\n\nThis will NOT delete singers or votes. TVs with Broadcast ON will follow the new event.');
        }catch(_){ ok=true; }
        if(!ok) return setStatus('Event switch cancelled.');
        applyEvent(typed);
      }

      function applyEvent(eid){
        var u=new URL(window.location.href); u.searchParams.set('eventId',eid); history.replaceState({},'',u.toString());
        try{ localStorage.setItem(LS_EVENT,eid); }catch(_){}
        eventPill.textContent='Event: '+eid;

        watchSingers(eid);
        watchState(eid);

        if(broadcastEl.checked) broadcastActiveEvent(eid);
        setStatus('Event set to: '+eid);
      }

      function broadcastActiveEvent(eid){
        db.collection('meta').doc('active').set({
          eventId:eid, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(){ eventNote.textContent='Broadcasting Active Event: '+eid; })
          .catch(function(e){ eventNote.textContent='Error broadcasting: '+((e&&e.message)||e); });
      }

      // QR helpers (small)
      function qrProvider1(d){ return 'https://api.qrserver.com/v1/create-qr-code/?size=280x280&data='+encodeURIComponent(d); }
      function qrProvider2(d){ return 'https://chart.googleapis.com/chart?cht=qr&chs=240x240&chl='+encodeURIComponent(d); }
      function setQrImageForUrl(url){
        var tried=false;
        qrImg.onerror=function(){ if(!tried){ tried=true; qrImg.src=qrProvider2(url); } else { qrImg.alt='QR unavailable'; } };
        qrImg.src=qrProvider1(url);
      }
      function updatePerfQr(){
        if(!STATE.performanceId){ qrImg.removeAttribute('src'); qrImg.alt='No performance'; return; }
        var url = urlRoot()+'vote/index.html?eventId='+encodeURIComponent(getCurrentEventId())+'&performanceId='+encodeURIComponent(STATE.performanceId);
        setQrImageForUrl(url);
      }

      // Countdown
      function renderCountdown(){
        if(!STATE.performanceCloseAt || STATE.performanceStatus!=='open'){ countdownEl.textContent='—'; return; }
        var ms=STATE.performanceCloseAt.toMillis()-Date.now();
        var s=Math.max(0,Math.ceil(ms/1000));
        countdownEl.textContent=s+'s';
      }
      function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer=setInterval(renderCountdown,250); }
      function stopCountdown(){ if(countdownTimer){ clearInterval(countownTimer); } countdownTimer=null; countdownEl.textContent='—'; }
      function armAutoClose(){
        if(autoCloseTimer){ clearTimeout(autoCloseTimer); autoCloseTimer=null; }
        if(!STATE.performanceCloseAt) return;
        var ms=Math.max(0,STATE.performanceCloseAt.toMillis()-Date.now());
        autoCloseTimer=setTimeout(function(){ endVotingNow(); }, ms+300);
      }

      // Watch performance
      function watchPerformance(eid, perfId){
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(!perfId){
          STATE.performanceId=null; STATE.performanceCloseAt=null; STATE.performanceStatus='';
          stopCountdown(); updatePerfQr(); perfStatus.textContent='No performance yet';
          return;
        }
        unsubPerf = db.collection('events').doc(eid).collection('performances').doc(perfId).onSnapshot(function(snap){
          if(!snap.exists){ STATE.performanceCloseAt=null; STATE.performanceStatus=''; stopCountdown(); perfStatus.textContent='(performance not found)'; return; }
          var d=snap.data()||{};
          STATE.performanceId=snap.id;
          STATE.performanceStatus=d.status||'pending';
          STATE.performanceCloseAt=d.closeAt||null;
          updatePerfQr();
          if(STATE.performanceStatus==='open'){ perfStatus.textContent='Voting OPEN'; startCountdown(); armAutoClose(); }
          else if(STATE.performanceStatus==='pending'){ perfStatus.textContent='Now singing (get ready)'; stopCountdown(); }
          else { perfStatus.textContent='Voting CLOSED'; stopCountdown(); }
        }, function(err){ setStatus('Performance listener error: '+((err&&err.message)||err)); });
      }

      // Watch state
      function watchState(eid){
        if(unsubState){ unsubState(); unsubState=null; }
        unsubState = db.collection('events').doc(eid).collection('state').doc('current').onSnapshot(function(snap){
          if(!snap.exists){ STATE.currentSingerId=null; STATE.currentSingerName=null; nowPerfLabel.textContent='None'; watchPerformance(eid,null); return; }
          var d=snap.data()||{};
          STATE.currentSingerId=d.currentSingerId||null;
          STATE.currentSingerName=d.currentSingerName||'(Unknown)';
          nowPerfLabel.textContent=STATE.currentSingerName||'None';
          watchPerformance(eid, d.performanceId || null);
        }, function(err){ setStatus('State listener error: '+((err&&err.message)||err)); });
      }

      // Singers list
      function renderSingerList(items){
        cachedSingers=items.slice(); singerListEl.innerHTML='';
        var showHidden=showHiddenEl.checked;
        items.sort(function(a,b){ return a.name.localeCompare(b.name,undefined,{sensitivity:'base'}); });

        var shown=0;
        function appendRow(it,outcome){
          if(!showHidden && outcome==='maybe') return;
          var li=document.createElement('li');

          var left=document.createElement('div');
          left.innerHTML='<div style="font-weight:900">'+it.name+'</div><div class="hint">Latest: '+(it.latestPerformanceId||'—')+(outcome?(' ('+outcome+')'):'')+'</div>';

          var right=document.createElement('div'); right.className='stack';
          var bVote=document.createElement('button'); bVote.className='btn warn'; bVote.textContent='Vote now (30s)';
          bVote.addEventListener('click', function(){
            if(STATE.currentSingerId!==it.id){
              if(!confirm('Switch to “'+it.name+'” and open a 30s vote?')) return;
            }
            if(!STATE.performanceId || STATE.currentSingerId!==it.id){
              announceExisting(it.id,it.name).then(function(){ openVoting(30); });
            }else{
              openVoting(30);
            }
          });

          right.appendChild(bVote);
          li.appendChild(left); li.appendChild(right);
          singerListEl.appendChild(li);
          shown++;
        }

        items.forEach(function(it){
          var pid=it.latestPerformanceId||null;
          var cached=pid ? perfOutcomeCache[pid] : undefined;
          if(!pid){ appendRow(it,null); }
          else if(cached!==undefined){ appendRow(it,cached); }
          else{
            db.collection('events').doc(getCurrentEventId()).collection('performances').doc(pid).get()
            .then(function(s){ perfOutcomeCache[pid]=s.exists?(s.data().outcome||null):null; renderSingerList(cachedSingers); })
            .catch(function(){ perfOutcomeCache[pid]=null; renderSingerList(cachedSingers); });
          }
        });

        if(!shown){ var li=document.createElement('li'); li.textContent=showHidden?'No singers.':'No singers (Maybe singers hidden).'; singerListEl.appendChild(li); }
      }

      function loadSingersOnce(eid){
        db.collection('events').doc(eid).collection('singers').get()
          .then(function(snap){ var items=[]; snap.forEach(function(d){ var x=d.data()||{}; items.push({id:d.id, name:x.name||'', latestPerformanceId:x.latestPerformanceId||null}); }); renderSingerList(items); singerReadNote.textContent=''; })
          .catch(function(){ renderSingerList([]); singerReadNote.textContent='Could not read singers (check rules).'; });
      }
      function watchSingers(eid){
        if(unsubSingers){ unsubSingers(); unsubSingers=null; }
        loadSingersOnce(eid);
        unsubSingers = db.collection('events').doc(eid).collection('singers').onSnapshot(function(snap){
          var items=[]; snap.forEach(function(d){ var x=d.data()||{}; items.push({id:d.id, name:x.name||'', latestPerformanceId:x.latestPerformanceId||null}); });
          renderSingerList(items); singerReadNote.textContent='';
        }, function(err){ singerReadNote.textContent='Realtime singers error: '+((err&&err.message)||err); });
      }

      // Add singer (auto-announce + show QR)
      function addSinger(){
        var name=(singerNameInput.value||'').trim();
        if(!name){ addSingerStatus.textContent='Please enter a singer name.'; return; }
        var eid=getCurrentEventId();
        addSingerBtn.disabled=true; addSingerStatus.textContent='Adding…';
        auth.signInAnonymously().catch(function(){}).finally(function(){
          db.collection('events').doc(eid).collection('singers').add({ name:name, ts:Date.now() })
          .then(function(ref){
            singerNameInput.value=''; addSingerStatus.textContent='Singer added. Announcing…';
            announceExisting(ref.id,name).then(function(){ addSingerStatus.textContent='Singer added & announced.'; });
          })
          .catch(function(e){
            var msg=(e&&e.message)||String(e);
            addSingerStatus.textContent = String(msg).toLowerCase().indexOf('permission')>=0
              ? 'Permissions error adding singer (check rules).'
              : 'Error adding singer: '+msg;
          })
          .finally(function(){ addSingerBtn.disabled=false; });
        });
      }

      // Flow
      function announceExisting(singerId,singerName){
        var eid=getCurrentEventId();
        return db.collection('events').doc(eid).collection('performances').add({
          singerId:singerId, singerName:singerName, status:'pending',
          openAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(perfRef){
          return Promise.all([
            db.collection('events').doc(eid).collection('singers').doc(singerId).set({ latestPerformanceId: perfRef.id }, { merge:true }),
            db.collection('events').doc(eid).collection('state').doc('current').set({
              currentSingerId:singerId, currentSingerName:singerName, performanceId:perfRef.id, ts:Date.now()
            })
          ]).then(function(){
            setStatus('Announced: '+singerName+'. (QR shown; voting not open yet)');
          });
        }).catch(function(e){ setStatus('Announce failed: '+((e&&e.message)||e)); });
      }

      function openVoting(seconds){
        seconds=seconds||30;
        var eid=getCurrentEventId();
        var ensure=Promise.resolve();
        if(!STATE.performanceId){
          ensure = db.collection('events').doc(eid).collection('performances').add({
            singerId:STATE.currentSingerId, singerName:STATE.currentSingerName, status:'pending',
            openAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(function(perfRef){
            return Promise.all([
              db.collection('events').doc(eid).collection('singers').doc(STATE.currentSingerId).set({ latestPerformanceId: perfRef.id }, { merge:true }),
              db.collection('events').doc(eid).collection('state').doc('current').set({
                currentSingerId:STATE.currentSingerId, currentSingerName:STATE.currentSingerName, performanceId:perfRef.id, ts:Date.now()
              })
            ]);
          });
        }
        ensure.then(function(){
          var closeAt=firebase.firestore.Timestamp.fromMillis(Date.now()+seconds*1000);
          return db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
            status:'open', openAt: firebase.firestore.FieldValue.serverTimestamp(), closeAt:closeAt
          }).then(function(){ setStatus('Voting opened for '+(STATE.currentSingerName||'')+' ('+seconds+'s).'); });
        }).catch(function(e){ setStatus('Open voting error: '+((e&&e.message)||e)); });
      }

      function extendVoting(extra){
        extra=extra||15;
        if(!STATE.performanceId) return setStatus('No performance.');
        var eid=getCurrentEventId();
        var base=Date.now(); if(STATE.performanceCloseAt) base=Math.max(base, STATE.performanceCloseAt.toMillis());
        var newClose=new Date(base + extra*1000);
        db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
          closeAt: firebase.firestore.Timestamp.fromDate(newClose)
        }).then(function(){ setStatus('Extended by '+extra+'s.'); }).catch(function(e){ setStatus('Extend failed: '+((e&&e.message)||e)); });
      }

      function decideOutcome(e,a,m){
        e|=0;a|=0;m|=0;
        if(e>a && e>m) return 'encore';
        if(a>e && a>m) return 'another';
        if(m>e && m>a) return 'maybe';
        if(a===m && a>e) return 'another';
        if(e===a && e>m) return 'encore';
        if(e===m && e>a) return 'another';
        if(e===a && a===m && e>0) return 'another';
        return null;
      }
      function finalizePerformance(eid, perfId){
        var q=db.collection('events').doc(eid).collection('votes').where('performanceId','==',perfId);
        q.get().then(function(snap){
          var e=0,a=0,m=0;
          snap.forEach(function(d){
            var cat=String((d.data()||{}).category||'').toLowerCase();
            if(cat==='encore') e++; else if(cat==='another') a++; else if(cat==='maybe') m++;
          });
          var outcome=decideOutcome(e,a,m);
          return db.collection('events').doc(eid).collection('performances').doc(perfId).update({
            status:'closed', closeAt: firebase.firestore.Timestamp.fromDate(new Date()),
            outcome:outcome, counts:{encore:e, another:a, maybe:m}
          }).then(function(){ perfOutcomeCache[perfId]=outcome||null; renderSingerList(cachedSingers); });
        }).catch(function(){});
      }
      function endVotingNow(){
        if(!STATE.performanceId) return setStatus('No performance.');
        var eid=getCurrentEventId();
        db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
          status:'closed', closeAt: firebase.firestore.Timestamp.fromDate(new Date())
        }).then(function(){ finalizePerformance(eid, STATE.performanceId); setStatus('Voting closed.'); })
          .catch(function(e){ setStatus('End failed: '+((e&&e.message)||e)); });
      }

      // Host vote
      function getDeviceId(){
        var KEY='eyek_device_id', id=localStorage.getItem(KEY);
        if(!id){ var arr=new Uint8Array(16); crypto.getRandomValues(arr); id=Array.prototype.map.call(arr,b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem(KEY,id); }
        return id;
      }
      var DEVICE_ID=getDeviceId();
      function hostCastVote(category){
        if(!STATE.performanceId) return setStatus('Open voting first.');
        var eid=getCurrentEventId(), docId=STATE.performanceId+'__'+DEVICE_ID;
        db.collection('events').doc(eid).collection('votes').doc(docId).set({
          performanceId:STATE.performanceId, singerId:STATE.currentSingerId, singerName:STATE.currentSingerName||'(Unknown)',
          category:category, deviceId:DEVICE_ID, ts:Date.now()
        }).then(function(){ setStatus('Host vote submitted.'); })
        .catch(function(e){
          var msg=String((e&&e.message)||e).toLowerCase();
          if(msg.indexOf('permission')>=0 || msg.indexOf('already exists')>=0) setStatus('Already voted or window closed.');
          else setStatus('Error submitting vote.');
        });
      }

      // Expose a couple for debugging if needed
      window.hostCastVote=hostCastVote;

      // Realtime wiring
      function watchSingers(eid){
        if(unsubSingers){ unsubSingers(); unsubSingers=null; }
        loadSingersOnce(eid);
        unsubSingers = db.collection('events').doc(eid).collection('singers').onSnapshot(function(snap){
          var items=[]; snap.forEach(function(d){ var x=d.data()||{}; items.push({id:d.id, name:x.name||'', latestPerformanceId:x.latestPerformanceId||null}); });
          renderSingerList(items); singerReadNote.textContent='';
        }, function(err){ singerReadNote.textContent='Realtime singers error: '+((err&&err.message)||err); });
      }
      function watchState(eid){
        if(unsubState){ unsubState(); unsubState=null; }
        unsubState = db.collection('events').doc(eid).collection('state').doc('current').onSnapshot(function(snap){
          if(!snap.exists){ STATE.currentSingerId=null; STATE.currentSingerName=null; nowPerfLabel.textContent='None'; watchPerformance(eid,null); return; }
          var d=snap.data()||{};
          STATE.currentSingerId=d.currentSingerId||null;
          STATE.currentSingerName=d.currentSingerName||'(Unknown)';
          nowPerfLabel.textContent=STATE.currentSingerName||'None';
          watchPerformance(eid, d.performanceId || null);
        }, function(err){ setStatus('State listener error: '+((err&&err.message)||err)); });
      }
    })();
  </script>
</body>
</html>
