<script>
/** ---------- Shared keys & helpers ---------- **/
const EVENT_KEY = 'eyek:event';       // { venue, kj, pin, locked }
const NOW_KEY   = 'eyek:now';         // { singer, song, artist }
const CH        = new BroadcastChannel('eyek'); // cross-tab signalling

const $ = (sel) => document.querySelector(sel);
const byId = (id) => document.getElementById(id);

function loadEvent() {
  try { return JSON.parse(localStorage.getItem(EVENT_KEY)) || {}; }
  catch { return {}; }
}
function saveEvent(evt) {
  localStorage.setItem(EVENT_KEY, JSON.stringify(evt));
  CH.postMessage({ type:'event:update', payload: evt });
}

function loadNow() {
  try { return JSON.parse(localStorage.getItem(NOW_KEY)) || {}; }
  catch { return {}; }
}
function saveNow(now) {
  localStorage.setItem(NOW_KEY, JSON.stringify(now));
  CH.postMessage({ type:'now:update', payload: now });
}

/** ---------- UI wiring ---------- **/
const venueInput = byId('venueInput');
const kjInput    = byId('kjInput');
const pinInput   = byId('pinInput');

const singerInput = byId('singerInput');
const songInput   = byId('songInput');
const artistInput = byId('artistInput');

const lockBtn   = byId('lockBtn');
const saveBtn   = byId('saveBtn');
const resetBtn  = byId('resetBtn');
const startBtn  = byId('startBtn'); // set “Now Playing”

function renderLockState(locked) {
  // Disable venue/KJ/PIN inputs when locked
  [venueInput, kjInput, pinInput].forEach(el => el.disabled = !!locked);
  // Button style/text
  lockBtn.dataset.locked = locked ? '1' : '0';
  lockBtn.textContent = locked ? 'Unlock Event' : 'Lock Event';
  lockBtn.classList.toggle('locked', !!locked);
}

function hydrateUI() {
  const evt = loadEvent();
  venueInput.value = evt.venue || '';
  kjInput.value    = evt.kj || '';
  pinInput.value   = evt.pin || '';
  renderLockState(!!evt.locked);

  const now = loadNow();
  byId('nowWho').textContent   = now.singer || '—';
  byId('nowSong').textContent  = now.song   || '—';
  byId('nowArtist').textContent= now.artist || '—';
}

/** ---------- Handlers ---------- **/
lockBtn.addEventListener('click', () => {
  // Toggle lock immediately (no Save needed)
  const evt = loadEvent();
  const newLocked = !evt.locked;
  const next = {
    venue: venueInput.value.trim(),
    kj:    kjInput.value.trim(),
    pin:   pinInput.value.trim(),
    locked: newLocked
  };
  saveEvent(next);
  renderLockState(newLocked);
});

saveBtn.addEventListener('click', () => {
  // Save current fields without changing lock state
  const evt = loadEvent();
  const next = {
    venue: venueInput.value.trim(),
    kj:    kjInput.value.trim(),
    pin:   pinInput.value.trim(),
    locked: !!evt.locked
  };
  saveEvent(next);
  // visual nudge (optional)
  saveBtn.disabled = true;
  setTimeout(() => (saveBtn.disabled = false), 400);
});

resetBtn.addEventListener('click', () => {
  if (!confirm('Reset this event? This clears Venue/KJ/PIN and Now Playing.')) return;
  const cleared = { venue:'', kj:'', pin:'', locked:false };
  saveEvent(cleared);
  saveNow({ singer:'', song:'', artist:'' });
  hydrateUI();
});

startBtn.addEventListener('click', () => {
  const now = {
    singer: singerInput.value.trim(),
    song:   songInput.value.trim(),
    artist: artistInput.value.trim(),
  };
  saveNow(now);
  // clear add fields if you want
  // singerInput.value = songInput.value = artistInput.value = '';
});

/** ---------- Cross-tab listeners (if Screen changes) ---------- **/
CH.onmessage = (ev) => {
  const { type, payload } = ev.data || {};
  if (type === 'event:update') {
    // screen/other tabs changed it — reflect here
    venueInput.value = payload.venue || '';
    kjInput.value    = payload.kj || '';
    pinInput.value   = payload.pin || '';
    renderLockState(!!payload.locked);
  } else if (type === 'now:update') {
    byId('nowWho').textContent   = payload.singer || '—';
    byId('nowSong').textContent  = payload.song   || '—';
    byId('nowArtist').textContent= payload.artist || '—';
  }
};

// also react to Storage events (other browser window, same origin)
window.addEventListener('storage', (e) => {
  if (e.key === EVENT_KEY) {
    try { renderLockState(JSON.parse(e.newValue||'{}').locked); } catch {}
  }
  if (e.key === NOW_KEY) {
    try {
      const n = JSON.parse(e.newValue||'{}');
      byId('nowWho').textContent   = n.singer || '—';
      byId('nowSong').textContent  = n.song   || '—';
      byId('nowArtist').textContent= n.artist || '—';
    } catch {}
  }
});

/** ---------- Init ---------- **/
document.addEventListener('DOMContentLoaded', hydrateUI);
</script>
