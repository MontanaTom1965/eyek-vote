<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/assets/favicon.ico" />
<style>
  :root{
    --bg:#0b0f17; --card:#121826; --muted:#9fb0cc; --text:#e7efff;
    --green:#27d17f; --yellow:#ffcc33; --red:#ff5468; --brand:#5aa2ff;
    --border:#20304a;
  }
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:16px;padding:16px;border-bottom:1px solid var(--border);}
  header img{height:40px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  h2{margin:0 0 12px 0;font-size:18px}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
  input,button,select{font-size:15px}
  input[type=text],input[type=password]{width:100%;padding:10px 12px;background:#0f1421;color:var(--text);border:1px solid var(--border);border-radius:10px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .btn{cursor:pointer;border:none;border-radius:999px;padding:10px 14px}
  .btn.brand{background:var(--brand);color:#00122e}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.green{background:var(--green);color:#012a19}
  .btn.yellow{background:var(--yellow);color:#3a2a00}
  .btn.red{background:var(--red);color:#33040a}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.green{background:var(--green)} .dot.yellow{background:var(--yellow)} .dot.red{background:var(--red)}
  .singers{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .singer{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0e1524}
  .singer .name{font-weight:600}
  .singer .actions{display:flex;gap:6px}
  details{border:1px solid var(--border);border-radius:12px;padding:8px 12px;background:#0f1421}
  details[open]{background:#101a2f}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .big{font-size:22px;font-weight:800}
  .spacer{height:8px}
</style>
</head>
<body>
<header>
  <img src="/assets/Earn Your Encore Karaoke - Icon.png" alt="EYEK" onerror="this.style.display='none'">
  <div>
    <div class="big">Host Console</div>
    <div class="muted" id="metaLine">—</div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Singer Queue -->
  <div class="card">
    <h2>Queue</h2>
    <div class="singers" id="singerList"></div>
  </div>

  <!-- RIGHT: Controls -->
  <div class="card">
    <h2>Event</h2>

    <details id="eventBox" open>
      <summary><strong>Venue • KJ • PIN</strong> <span class="muted">(one Save handles all)</span></summary>
      <div class="spacer"></div>
      <div class="grid2">
        <div>
          <label>Venue</label>
          <input type="text" id="venue" placeholder="Venue name">
        </div>
        <div>
          <label>KJ</label>
          <input type="text" id="kj" placeholder="KJ name">
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Event PIN (enter current PIN to change settings)</label>
          <input type="password" id="pin" placeholder="Enter current PIN to save">
        </div>
        <div>
          <label>New PIN (optional)</label>
          <input type="text" id="newPin" placeholder="Change PIN">
        </div>
      </div>
      <div class="row">
        <button class="btn brand" onclick="saveMeta()">Save</button>
        <button class="btn ghost" id="lockBtn" onclick="toggleLock()">Lock</button>
        <button class="btn red" onclick="resetEvent()">Reset Event</button>
      </div>
      <div class="muted" id="saveMsg"></div>
    </details>

    <div class="spacer"></div>

    <details open>
      <summary><strong>Add Singer</strong></summary>
      <div class="spacer"></div>
      <div class="row">
        <input type="text" id="singerName" placeholder="Singer name">
        <input type="text" id="song" placeholder="Song / Artist">
      </div>
      <div class="row">
        <button class="btn brand" onclick="addSinger()">Add to Queue</button>
      </div>
    </details>

    <div class="spacer"></div>

    <div class="card" style="background:#0e1524">
      <h2>Current & Voting</h2>
      <div class="row">
        <div class="pill"><span class="muted">Current:</span> <span id="currentName">—</span></div>
        <div class="pill"><span class="muted">Voting:</span> <span id="voteStatus">closed</span></div>
        <div class="pill"><span class="muted">Ends in:</span> <span id="countdown">—</span></div>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <button class="btn green" onclick="startVoting(30)">Start 30s</button>
        <button class="btn yellow" onclick="extendVoting(15)">Extend +15s</button>
        <button class="btn red" onclick="endVoting()">End Voting</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <button class="btn green" onclick="hostVote('encore')">Host Vote: Encore!</button>
        <button class="btn yellow" onclick="hostVote('another')">Host Vote: Another Shot!</button>
        <button class="btn red" onclick="hostVote('nexttime')">Host Vote: Maybe Next Time</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="pill"><span class="dot green"></span> <span id="encoreCnt">0</span></div>
        <div class="pill"><span class="dot yellow"></span> <span id="anotherCnt">0</span></div>
        <div class="pill"><span class="dot red"></span> <span id="nextCnt">0</span></div>
      </div>
    </div>

  </div>
</div>

<script>
const API = '/assets/state.php';
let STATE = null;
let POLL;

function qs(id){return document.getElementById(id)}
function toast(msg){qs('saveMsg').textContent = msg; setTimeout(()=>qs('saveMsg').textContent='',3000)}
function fmtCountdown(ms){
  if(ms<=0) return '0s';
  const s = Math.ceil(ms/1000);
  return s+'s';
}

async function fetchState(){
  const r = await fetch(API+'?action=get',{cache:'no-store'});
  STATE = await r.json();
  render();
}
function renderMetaLine(){
  const s = STATE;
  qs('metaLine').textContent = `${s.venue || '—'} • ${s.kj || '—'}  ${s.locked?'(locked)':''}`;
  qs('venue').value = s.venue || '';
  qs('kj').value = s.kj || '';
  qs('lockBtn').textContent = s.locked ? 'Unlock' : 'Lock';
}
function renderQueue(){
  const box = qs('singerList');
  box.innerHTML = '';
  (STATE.singers||[]).forEach(s=>{
    const div = document.createElement('div');
    div.className = 'singer';
    const dotColor = s.status==='encore'?'green':(s.status==='another'?'yellow':(s.status==='nexttime'?'red':''));
    div.innerHTML = `
      <div>
        <div class="name">${s.name}</div>
        <div class="muted">${s.lastSong || ''}</div>
        ${dotColor?`<div class="row" style="margin-top:6px"><div class="pill"><span class="dot ${dotColor}"></span> ${s.status}</div></div>`:''}
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="setCurrent('${s.id}')">▶ Play</button>
        <button class="btn ghost" onclick="removeSinger('${s.id}')">Remove</button>
      </div>
    `;
    box.appendChild(div);
  });
}
function renderVoting(){
  const v = STATE.voting||{};
  qs('encoreCnt').textContent = v.encore||0;
  qs('anotherCnt').textContent= v.another||0;
  qs('nextCnt').textContent   = v.nexttime||0;
  qs('voteStatus').textContent = v.open?'open':'closed';
  const cur = (STATE.singers||[]).find(x=>x.id===STATE.currentSingerId);
  qs('currentName').textContent = cur?cur.name:'—';
  const now = Date.now();
  const msLeft = (v.endsAt||0)-now;
  qs('countdown').textContent = v.open?fmtCountdown(msLeft):'—';
}
function render(){ renderMetaLine(); renderQueue(); renderVoting(); }

async function saveMeta(){
  const fd = new FormData();
  fd.append('action','saveMeta');
  fd.append('venue', qs('venue').value.trim());
  fd.append('kj', qs('kj').value.trim());
  fd.append('pin', qs('pin').value.trim());
  fd.append('newPin', qs('newPin').value.trim());
  fd.append('locked', STATE.locked ? 'true' : 'false');
  const r = await fetch(API,{method:'POST',body:fd});
  if(!r.ok){ toast('Save failed'); return;}
  toast('Saved');
  await fetchState();
}

async function toggleLock(){
  const fd = new FormData();
  fd.append('action', STATE.locked?'unlock':'lock');
  fd.append('pin', qs('pin').value.trim());
  const r = await fetch(API,{method:'POST',body:fd});
  if(!r.ok){ toast('Lock toggle failed'); return; }
  await fetchState();
}

async function resetEvent(){
  if(!confirm('Reset event? This clears singers and voting. PIN required.')) return;
  const fd = new FormData();
  fd.append('action','resetEvent');
  fd.append('pin', qs('pin').value.trim());
  const r = await fetch(API,{method:'POST',body:fd});
  if(!r.ok){ toast('Reset failed'); return; }
  await fetchState();
}

async function addSinger(){
  const name = qs('singerName').value.trim();
  const song = qs('song').value.trim();
  if(!name){ toast('Singer name required'); return; }
  const fd = new FormData();
  fd.append('action','addSinger');
  fd.append('pin', qs('pin').value.trim());
  fd.append('name', name);
  fd.append('song', song);
  const r = await fetch(API,{method:'POST',body:fd});
  if(!r.ok){ toast('Add failed'); return; }
  qs('singerName').value=''; qs('song').value='';
  await fetchState();
}

async function removeSinger(id){
  const fd = new FormData();
  fd.append('action','removeSinger');
  fd.append('pin', qs('pin').value.trim());
  fd.append('id', id);
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function setCurrent(id){
  const fd = new FormData();
  fd.append('action','setCurrent');
  fd.append('pin', qs('pin').value.trim());
  fd.append('id', id);
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function startVoting(sec){
  const fd = new FormData();
  fd.append('action','startVoting');
  fd.append('pin', qs('pin').value.trim());
  fd.append('seconds', String(sec||30));
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function extendVoting(sec){
  const fd = new FormData();
  fd.append('action','extendVoting');
  fd.append('pin', qs('pin').value.trim());
  fd.append('seconds', String(sec||15));
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function endVoting(){
  const fd = new FormData();
  fd.append('action','endVoting');
  fd.append('pin', qs('pin').value.trim());
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function hostVote(type){
  const fd = new FormData();
  fd.append('action','hostVote');
  fd.append('pin', qs('pin').value.trim());
  fd.append('type', type);
  await fetch(API,{method:'POST',body:fd});
  await fetchState();
}

async function loop(){
  await fetchState();
  if (STATE?.voting?.open) {
    // soft live tick for countdown
    renderVoting();
  }
}
(async ()=>{
  await fetchState();
  POLL=setInterval(loop, 2000);
})();
</script>
</body>
</html>
