<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EYEK • Host</title>
  <style>
    :root{--bg:#0f031a;--card:#1b0930;--ink:#f7f2ff;--muted:#cbb3ff;--accent:#2F0658;--ok:#19c37d;--warn:#f6c34a;--bad:#ff5c5c}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#3c1181 0%,#2F0658 22%,#1b0930 52%,#0f031a 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;min-height:100dvh}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;background:#200b38;position:sticky;top:0;z-index:10;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.5px}
    .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:16px;color:#e9ddff}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#160626;color:var(--ink);font-size:14px}
    input[readonly]{opacity:.8}
    button{cursor:pointer;transition:.2s transform,.2s opacity}
    button:active{transform:translateY(1px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);background:#140423}
    .ok{background:rgba(25,195,125,.16);border-color:rgba(25,195,125,.35)}
    .warn{background:rgba(246,195,74,.16);border-color:rgba(246,195,74,.35)}
    .bad{background:rgba(255,92,92,.16);border-color:rgba(255,92,92,.35)}
    .stack{display:flex;flex-direction:column;gap:10px}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .muted{color:var(--muted);font-size:12px}

    /* singer list */
    .singers{display:flex;flex-direction:column;gap:8px;max-height:60dvh;overflow:auto;padding-right:4px}
    .singer{display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#140425}
    .singer .name{font-weight:600}
    .badge{margin-left:auto;border-radius:999px;padding:4px 8px;font-size:12px;border:1px solid rgba(255,255,255,.14)}
    .b-encore{background:rgba(25,195,125,.16);border-color:rgba(25,195,125,.4)}
    .b-another{background:rgba(246,195,74,.16);border-color:rgba(246,195,74,.4)}

    /* vote counters + mini dots */
    .score{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .counter{background:#130422;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:10px 12px}
    .counter h3{margin:0 0 2px;font-size:13px;color:#e7d7ff}
    .counter .num{font-size:36px;font-weight:800;letter-spacing:1px}
    .dots{position:relative;height:36px;margin-top:6px;background:#0c0215;border-radius:999px;border:1px dashed rgba(255,255,255,.1);overflow:hidden}
    .dot{position:absolute;width:9px;height:9px;border-radius:50%;opacity:.9;animation:bounce .8s ease-out}
    @keyframes bounce{0%{transform:translateY(-16px)}60%{transform:translateY(26px)}100%{transform:translateY(12px)}}

    .quick{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .quick button{font-weight:700}

    .timer{font-size:32px;font-weight:800}
    .status{display:flex;align-items:center;gap:8px}

    .links a{color:#7fd1ff}
  </style>
</head>
<body>
  <header>
    <h1>EYEK • Host</h1>
    <div class="links">
      <a href="/vote/" target="_blank">Vote</a> ·
      <a href="/screen/" target="_blank">Screen</a> ·
      <a href="/board/" target="_blank">Board</a>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: rotation & quick actions -->
    <aside class="card">
      <h2>Rotation</h2>
      <div class="stack">
        <div class="row">
          <input id="newSinger" placeholder="Add singer name" />
          <button id="addSingerBtn">Add</button>
        </div>
        <div class="row">
          <input id="songTitle" placeholder="Song (optional)" />
          <input id="songArtist" placeholder="Artist (optional)" />
        </div>
        <div class="flex">
          <button id="setCurrent">Set current singer</button>
          <button id="removeSinger" class="right">Remove selected</button>
        </div>
        <div class="singers" id="singerList"></div>
      </div>
    </aside>

    <!-- RIGHT: controls, status, scores -->
    <main class="stack">

      <section class="card">
        <h2>Event & KJ Setup</h2>
        <div class="stack">
          <div class="row">
            <div>
              <label>Venue (internal)</label>
              <input id="venue" list="venues" placeholder="e.g., The Blue Ox" />
              <datalist id="venues"></datalist>
            </div>
            <div>
              <label>Public Venue Name (screen)</label>
              <input id="venuePublic" placeholder="Shown on Screen/Vote" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Date</label>
              <input id="eventDate" type="date" />
            </div>
            <div>
              <label>KJ Company</label>
              <input id="kjCompany" list="kjcos" placeholder="Company" />
              <datalist id="kjcos"></datalist>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Karaoke Host Name</label>
              <input id="hostName" placeholder="Your name" />
            </div>
            <div>
              <label class="flex" style="justify-content:space-between;align-items:end;">Event PIN <span class="pill" id="pinLock">Unlocked</span></label>
              <div class="flex">
                <input id="pin" inputmode="numeric" pattern="\\d*" placeholder="4–6 digits" />
                <button id="togglePin">Show</button>
              </div>
            </div>
          </div>
          <div class="flex">
            <button id="saveEvent">Save</button>
            <button id="lockEvent" class="right">Lock</button>
            <button id="resetAll" class="bad right">Reset (singers + votes)</button>
          </div>
          <div class="muted">Sound: <a href="#" id="enableSound">Enable</a> (required once on this laptop)</div>
        </div>
      </section>

      <section class="card">
        <h2>Voting</h2>
        <div class="flex" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div class="status">
            <span class="pill" id="voteState">Closed</span>
            <span class="pill ok" id="nowUp">Now up: —</span>
          </div>
          <div class="timer" id="timer">00:00</div>
        </div>
        <div class="grid3" style="margin-top:10px">
          <button id="startBtn">Start (5s prep → 30s)</button>
          <button id="extendBtn">Extend +15s</button>
          <button id="endBtn">End</button>
        </div>
        <div class="quick">
          <button data-qv="encore" style="background:rgba(25,195,125,.2)">Encore</button>
          <button data-qv="another" style="background:rgba(246,195,74,.2)">Another Shot</button>
          <button data-qv="maybe" style="background:rgba(255,92,92,.2)">Maybe Next Time</button>
        </div>
      </section>

      <section class="card">
        <h2>Live Scores</h2>
        <div class="score">
          <div class="counter"><h3>Encore</h3><div class="num" id="encoreNum">0</div><div class="dots" id="encoreDots"></div></div>
          <div class="counter"><h3>Another Shot</h3><div class="num" id="anotherNum">0</div><div class="dots" id="anotherDots"></div></div>
          <div class="counter"><h3>Maybe Next Time</h3><div class="num" id="maybeNum">0</div><div class="dots" id="maybeDots"></div></div>
        </div>
      </section>

    </main>
  </div>

  <!-- audio (HOST ONLY) -->
  <audio id="aLoop" loop preload="auto"></audio>
  <audio id="aWin" preload="auto"></audio>
  <audio id="aLose" preload="auto"></audio>

  <script>
    const S = {
      device: (localStorage.getItem('eyek_device')||crypto.randomUUID()).slice(0,18),
      state: {phase:'closed', endsAt:0, prepUntil:0, singer:null, counts:{encore:0, another:0, maybe:0}},
      singers: [], selIndex: -1, locked:false, pinVisible:false,
      endpoints: {
        get:'/assets/get_state.php', set:'/assets/state.php', vote:'/assets/vote.php', perf:'/assets/submit_performance.php'
      }
    };
    localStorage.setItem('eyek_device', S.device);

    // DOM refs
    const el = (id)=>document.getElementById(id);
    const voteState = el('voteState'), nowUp = el('nowUp'), timer = el('timer');
    const encoreNum=el('encoreNum'), anotherNum=el('anotherNum'), maybeNum=el('maybeNum');
    const dots={encore:el('encoreDots'), another:el('anotherDots'), maybe:el('maybeDots')};

    // datalists from localStorage mirrors
    function loadDataLists(){
      const venues = JSON.parse(localStorage.getItem('eyek_venues')||'[]');
      const kjcos = JSON.parse(localStorage.getItem('eyek_kjcos')||'[]');
      const vdl = el('venues'); vdl.innerHTML = venues.map(v=>`<option value="${v}"></option>`).join('');
      const kdl = el('kjcos');  kdl.innerHTML = kjcos .map(v=>`<option value="${v}"></option>`).join('');
    }
    loadDataLists();

    // Event save + mirror datalists
    el('saveEvent').onclick = async ()=>{
      const v = el('venue').value.trim();
      const vp = el('venuePublic').value.trim();
      const d = el('eventDate').value;
      const kc = el('kjCompany').value.trim();
      const hn = el('hostName').value.trim();
      const pin = el('pin').value.trim();
      if(!/^[0-9]{4,6}$/.test(pin)){alert('PIN must be 4–6 digits');return;}
      const pushUnique=(k,val)=>{const arr=JSON.parse(localStorage.getItem(k)||'[]'); if(val && !arr.includes(val)){arr.push(val); localStorage.setItem(k, JSON.stringify(arr));}};
      pushUnique('eyek_venues', v); pushUnique('eyek_kjcos', kc); loadDataLists();
      await fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({venue:v,venuePublic:vp,date:d,kjCompany:kc,hostName:hn,pin})});
      alert('Saved. Datalists updated.');
    };

    // Lock/Unlock & Reset
    el('lockEvent').onclick = ()=>{S.locked=!S.locked; el('lockEvent').textContent=S.locked?'Unlock':'Lock'; el('pinLock').textContent=S.locked?'Locked':'Unlocked'};
    el('resetAll').onclick = async ()=>{
      if(!confirm('Reset all singers and votes?')) return;
      S.singers=[]; S.selIndex=-1; renderSingers();
      await fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reset:true})});
      setCounts(0,0,0);
    };

    // PIN show/hide
    el('togglePin').onclick = ()=>{
      S.pinVisible=!S.pinVisible; el('togglePin').textContent=S.pinVisible?'Hide':'Show';
      el('pin').type = S.pinVisible?'text':'password';
    };

    // Sound (HOST ONLY)
    const aLoop = document.getElementById('aLoop');
    const aWin  = document.getElementById('aWin');
    const aLose = document.getElementById('aLose');

    function pickSrc(){
      const a=document.createElement('audio');
      return (a.canPlayType && a.canPlayType('audio/mpeg')) ? 'mp3' : 'wav';
    }
    const ext = pickSrc();
    aLoop.src = `/assets/voting_open.${ext}`;
    aWin.src  = `/assets/encore.${ext}`;
    aLose.src = `/assets/loser.${ext}`;

    aLoop.addEventListener('error', ()=>console.warn('Voting loop failed to load', aLoop.error));
    aWin .addEventListener('error', ()=>console.warn('Encore sound failed to load', aWin.error));
    aLose.addEventListener('error', ()=>console.warn('Lose sound failed to load', aLose.error));

    el('enableSound').onclick = async (e)=>{
      e.preventDefault();
      try{ await aLoop.play(); aLoop.pause(); alert('Sound enabled on this device.'); }
      catch{ alert('Browser blocked autoplay. Click again after interacting on the page.'); }
    };

    // Rotation add/remove/select
    const list = el('singerList');
    function renderSingers(){
      list.innerHTML = S.singers.map((s,i)=>{
        const badge = s.badge?`<span class="badge ${s.badge==='encore'?'b-encore':'b-another'}">${s.badge==='encore'?'Encore':'Another'}</span>`:'';
        return `<div class="singer" data-i="${i}"><input type="radio" name="sel" ${i===S.selIndex?'checked':''} style="accent-color:#7fd1ff"/> <div class="name">${s.name}</div> ${badge}</div>`
      }).join('');
      list.querySelectorAll('.singer').forEach(div=>{
        div.onclick = ()=>{S.selIndex=Number(div.dataset.i); renderSingers();}
      })
    }
    el('addSingerBtn').onclick = ()=>{
      const nm = el('newSinger').value.trim(); if(!nm) return;
      S.singers.push({name:nm, badge:null}); el('newSinger').value=''; renderSingers();
    };
    el('removeSinger').onclick = ()=>{ if(S.selIndex<0) return; S.singers.splice(S.selIndex,1); S.selIndex=-1; renderSingers(); };

    // Set current singer (also submits optional performance meta)
    el('setCurrent').onclick = async ()=>{
      if(S.selIndex<0){alert('Select a singer from the list.');return}
      const s = S.singers[S.selIndex];
      const song = el('songTitle').value.trim();
      const artist = el('songArtist').value.trim();
      setCounts(0,0,0);
      await fetch(S.endpoints.perf,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current:s.name,song,artist})});
      await fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current:s.name})});
    };

    // Timer sync helpers
    let serverOffsetMs = 0;
    function updateOffsetFrom(st){
      if (typeof st.serverNow === 'number' && !Number.isNaN(st.serverNow)) {
        if (!window.__serverOffsetMs) window.__serverOffsetMs = st.serverNow - Date.now();
        serverOffsetMs = window.__serverOffsetMs;
      }
    }
    function nowMs(){ return Date.now() + (serverOffsetMs||0); }

    // Gentle client-only smoothing if serverNow not present
    function smoothEnds(targetKey){
      const target = S.state[targetKey]; if(!target) return;
      // If displayed left time jumps > 1500ms vs last seen, gently nudge offset
      const ideal = target - Date.now();
      const actual = target - nowMs();
      const drift = actual - ideal; // includes our offset
      if (Math.abs(drift) > 1500) serverOffsetMs -= Math.sign(drift) * 500; // nudge 0.5s per tick
    }

    function setCounts(e,a,m){encoreNum.textContent=e; anotherNum.textContent=a; maybeNum.textContent=m}

    // Polling loop
    let prev={encore:0,another:0,maybe:0, winner:null};
    setInterval(async ()=>{
      try{
        const r = await fetch(S.endpoints.get); const st = await r.json();
        updateOffsetFrom(st);
        S.state = st; // {phase, prepUntil, endsAt, counts, singer, winner, winType, rotation?}
        voteState.textContent = st.phase==='open'?'Open':(st.phase==='prep'?'Get ready…':'Closed');
        nowUp.textContent = 'Now up: ' + (st.singer||'—');

        // timer (ceil for consistency)
        const left = st.phase==='prep'
          ? Math.max(0, Math.ceil((st.prepUntil - nowMs())/1000))
          : st.phase==='open'
          ? Math.max(0, Math.ceil((st.endsAt   - nowMs())/1000))
          : 0;
        timer.textContent = new Date(left*1000).toISOString().substring(14,19);

        // counts
        setCounts(st.counts?.encore||0, st.counts?.another||0, st.counts?.maybe||0);

        // mini dots for increments
        ['encore','another','maybe'].forEach(k=>{
          const prevVal = Number(dots[k].dataset.prev||'0'); const cur = st.counts?.[k]||0;
          if(cur>prevVal){ for(let i=0;i<cur-prevVal;i++) addMiniDot(k); }
          dots[k].dataset.prev = cur;
        });

        // play one-shot winner sound (HOST ONLY)
        if(st.winner && st.winType && st.winner!==prev.winner){
          prev.winner = st.winner;
          if(st.winType==='encore'){ aWin.currentTime=0; aWin.play().catch(()=>{}); }
          else { aLose.currentTime=0; aLose.play().catch(()=>{}); }
        }

        // smooth drift a bit if serverNow not supplied
        if (!('serverNow' in st)) {
          if (st.phase==='open')  smoothEnds('endsAt');
          if (st.phase==='prep')  smoothEnds('prepUntil');
        }
      }catch(e){/* ignore transient errors */}
    }, 700);

    function addMiniDot(which){
      const d = document.createElement('div'); d.className='dot';
      d.style.left = Math.random()*96 + '%';
      d.style.background = which==='encore'? '#19c37d' : which==='another'? '#f6c34a' : '#ff5c5c';
      dots[which].appendChild(d);
      setTimeout(()=> d.remove(), 1200);
    }

    // Start/Extend/End (+ optional perf log at Start)
    el('startBtn').onclick = async ()=>{
      const song   = el('songTitle').value.trim();
      const artist = el('songArtist').value.trim();
      const current = S.singers[S.selIndex]?.name || S.state.singer;
      if (current) {
        await fetch(S.endpoints.perf,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current, song, artist, ts: Date.now()})});
      }
      fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'start', prep:5, open:30})});
    };
    el('extendBtn').onclick = ()=> fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'extend', add:15})});
    el('endBtn').onclick    = ()=> fetch(S.endpoints.set,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'end'})});

    // Host quick votes
    document.querySelectorAll('[data-qv]').forEach(b=>{
      b.onclick = ()=> fetch(S.endpoints.vote,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pick:b.dataset.qv, device:S.device, host:true})});
    });

    // Loop sound: play when phase becomes open, stop otherwise
    let loopOn=false;
    setInterval(()=>{
      const p = S.state.phase;
      if(p==='open' && !loopOn){ aLoop.currentTime=0; aLoop.play().catch(()=>{}); loopOn=true; }
      if(p!=='open' && loopOn){ aLoop.pause(); loopOn=false; }
    }, 300);

    // initial render
    renderSingers();
  </script>
  <!-- filename: /host/index.html -->
</body>
</html>
