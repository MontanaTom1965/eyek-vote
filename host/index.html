<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Earn Your Encore Karaoke — Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --scale:1;

      /* Brand purple theme */
      --bg:#2F0658;
      --card:#401073;
      --border:#7E3CC0;
      --text:#ffffff;
      --muted:#E3D6F4;
      --accent:#D9B6FF;

      /* Category colors */
      --encore:#22c55e; --another:#f59e0b; --maybe:#ef4444;

      --btn:#3d1a77; 
      --btnBorder:#a17ae0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{background:
      radial-gradient(1200px 600px at 15% -10%, #6A2BB3 0%, rgba(106,43,179,0) 60%),
      radial-gradient(1000px 520px at 85% -10%, #4E1E8E 0%, rgba(78,30,142,0) 55%),
      var(--bg)}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      font-size:calc(20px * var(--scale)); line-height:1.35;
      display:flex; flex-direction:column;
    }
    .fatal{position:sticky; top:0; z-index:9999; background:#b91c1c; color:#fff; padding:.5em .8em; font-weight:900; display:none}
    header{
      position:sticky; top:0; z-index:10; border-bottom:2px solid var(--border);
      background:linear-gradient(180deg, rgba(64,16,115,.95), rgba(64,16,115,.70)); backdrop-filter:blur(6px)
    }
    .wrap{max-width:1250px; margin:0 auto; width:100%}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px}
    .title{font-size:1.0em; font-weight:800; color:#f5eaff}
    h1#eventHeading{margin:.2em 0; font-size:1.8em; letter-spacing:.3px}
    main{padding:18px}
    .grid{display:grid; gap:16px}
    .grid-2-1{grid-template-columns:3fr 1fr}
    @media (max-width:1100px){ .grid-2-1{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--card);
      border:2px solid var(--border); border-radius:16px; padding:16px; 
      box-shadow:0 10px 34px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)
    }
    h2{margin:.1em 0 .5em; font-size:1.2em}
    label{display:block; margin:.55em 0 .25em; font-weight:800}
    input{
      width:100%; padding:.65em .8em; border-radius:12px;
      border:2px solid var(--border); background:rgba(0,0,0,.22); color:#fff; font-size:1.02em;
    }
    input:focus{outline:none; box-shadow:0 0 0 4px rgba(217,182,255,.25)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; padding:.75em 1em; border:2px solid var(--btnBorder); border-radius:12px;
      background:var(--btn); color:#fff; font-weight:900; cursor:pointer; font-size:1.02em; letter-spacing:.2px;
      min-height:52px;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.primary{background:var(--accent); color:#2f0658; border-color:#eedbff}
    .btn.good{background:var(--encore); color:#062; border-color:#6fe394}
    .btn.warn{background:var(--another); color:#231b00; border-color:#ffd28a}
    .btn.danger{background:var(--maybe); color:#2b0000; border-color:#ffb4b4}
    .btn.ghost{background:rgba(0,0,0,.22)}
    .btn.small{min-height:38px; padding:.45em .7em; font-size:.9em}
    .btn.tiny{min-height:26px; padding:.15em .45em; font-size:.7em; border-radius:10px}
    .hint{color:var(--muted); font-weight:600}

    /* Bulleted singer list */
    aside ul{list-style:disc; margin:.2em 0 0 1.2em; padding:0}
    aside li{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:.25em 0; /* no card look */
    }
    .li-removed{opacity:.55}
    .singerName{font-weight:900}
    .meta{color:var(--muted); font-size:.8em; font-weight:700}

    .smallQR{display:flex; align-items:center; gap:12px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:rgba(0,0,0,.18)}
    .smallQR img{width:90px; height:90px; object-fit:contain; border-radius:10px}
    .controls .btn{min-width:200px}

    .status{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(47,6,88,.3), rgba(47,6,88,.95)); border-top:2px solid var(--border); padding:10px 16px; font-weight:800}
    footer{margin:10px 0 20px}
    .zoomBar{display:flex; gap:10px; align-items:center; justify-content:center}
    .zoomBar .btn{min-width:0; padding:.45em .7em}
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>

  <header>
    <div class="wrap bar">
      <div class="title">Host Control</div>
      <h1 id="eventHeading">—</h1>
    </div>
  </header>

  <main class="wrap">
    <!-- Event (TOP) -->
    <section class="card">
      <h2>Event</h2>
      <div class="row" style="align-items:flex-end">
        <div style="flex:1 1 480px; min-width:260px">
          <label for="eventId">Event name (venue)</label>
          <input id="eventId" placeholder="e.g. Eagles Nest" />
        </div>
        <div class="stack">
          <label class="row" style="font-weight:800"><input type="checkbox" id="lockEvent" /> Lock Event</label>
        </div>
        <div>
          <button class="btn primary" id="setEventBtn" title="Apply event">CHANGE</button>
        </div>
      </div>
      <div class="hint" id="eventNote" style="margin-top:.45em"></div>
    </section>

    <!-- Add singer -->
    <section class="card">
      <h2>Add singer</h2>
      <div class="row">
        <div style="flex:1 1 520px; min-width:280px">
          <label for="singerName">Singer name</label>
          <input id="singerName" placeholder="Type a name, press Enter" />
        </div>
        <div>
          <button class="btn primary" id="addSingerBtn">Add</button>
        </div>
      </div>
      <div class="hint" id="addSingerStatus" style="margin-top:.35em">Ready.</div>
    </section>

    <!-- Main + Sidebar -->
    <div class="grid grid-2-1">
      <div class="grid" style="gap:16px">
        <!-- Now Performing (small QR + controls) -->
        <section class="card">
          <h2>Now Performing</h2>
          <div class="smallQR" style="margin:.4em 0 1em">
            <img id="qrImg" alt="QR" />
            <div>
              <div style="font-weight:900; font-size:1.2em" id="nowPerfLabel">None</div>
              <div class="hint" id="perfStatus">No performance yet</div>
              <div class="hint" style="margin-top:.25em">Countdown: <span id="countdown" style="font-weight:900">—</span></div>
            </div>
          </div>
          <div class="controls stack">
            <button class="btn warn" id="btnVoteNow">Vote now (30s)</button>
            <button class="btn ghost" id="btnExtend15">Extend +15s</button>
            <button class="btn danger" id="btnEndNow">End now</button>
            <button class="btn ghost" id="openPerfVote">Vote</button>
          </div>
        </section>

        <!-- Open pages + Broadcast toggle -->
        <section class="card">
          <h2>Open pages</h2>
          <div class="stack" style="margin-bottom:.4em">
            <button class="btn ghost" id="openVote">Vote</button>
            <button class="btn ghost" id="openScreen">Screen</button>
            <button class="btn ghost" id="openBoard">Board</button>
          </div>
          <label class="row" style="font-weight:800"><input type="checkbox" id="broadcastActive" /> Broadcast Active Event</label>
          <div class="hint">When ON, TVs at <code>/screen</code> and <code>/board</code> (no params) auto-follow this event.</div>
        </section>

        <!-- Host vote -->
        <section class="card">
          <h2>Host vote (optional)</h2>
          <div class="stack">
            <button class="btn" id="hostVoteEncore"  style="background:var(--encore);color:#062">Encore</button>
            <button class="btn" id="hostVoteAnother" style="background:var(--another);color:#231b00">Another</button>
            <button class="btn" id="hostVoteMaybe"   style="background:var(--maybe)">Maybe Next Time</button>
          </div>
          <div class="hint" style="margin-top:.4em">One vote per device per performance (same as audience).</div>
        </section>
      </div>

      <!-- Sidebar: Singers (bulleted list) -->
      <aside class="card">
        <h2>Singers</h2>
        <div class="row" style="margin:.25em 0 .5em">
          <label class="row"><input type="checkbox" id="showHidden" /> Show Removed!</label>
        </div>
        <ul id="singersSidebar"></ul>
        <div class="hint" id="singersNote">Shows singers still “in it” (excludes “Maybe” and Removed unless shown).</div>
      </aside>
    </div>
  </main>

  <div class="status">
    <div id="statusBar">Status: Idle…</div>
  </div>

  <footer class="wrap">
    <div class="zoomBar">
      <button class="btn ghost" id="zoomDown" title="Smaller text">A−</button>
      <span class="pill" id="zoomLabel">Text: 100%</span>
      <button class="btn ghost" id="zoomUp" title="Larger text">A+</button>
    </div>
  </footer>

  <!-- ========= CORE (no-module, compat builds) ========= -->
  <script>
    (function(){
      var fatalEl = document.getElementById('fatal');
      function showFatal(msg){ if(!msg) return; fatalEl.style.display='block'; fatalEl.textContent='Error: '+msg; }
      window.__showFatal = showFatal;
      window.addEventListener('error', e=> showFatal((e.error && e.error.message) || e.message));
      window.addEventListener('unhandledrejection', e=> showFatal((e.reason && (e.reason.message||e.reason)) || 'Unhandled rejection'));

      var Z_KEY='eyek_zoom', zoomLabel=document.getElementById('zoomLabel');
      function setZoom(v){ v=Math.min(1.8,Math.max(0.7,v)); document.documentElement.style.setProperty('--scale',v);
        try{localStorage.setItem(Z_KEY,String(v))}catch(_){}
        zoomLabel.textContent='Text: '+Math.round(v*100)+'%'; }
      document.getElementById('zoomDown').addEventListener('click', ()=> setZoom((+localStorage.getItem(Z_KEY)||1)-0.1));
      document.getElementById('zoomUp').addEventListener('click',   ()=> setZoom((+localStorage.getItem(Z_KEY)||1)+0.1));
      setZoom(+localStorage.getItem(Z_KEY)||1);
    })();
  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    (function(){
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
        authDomain: "eyek-vote.firebaseapp.com",
        projectId: "eyek-vote",
        storageBucket: "eyek-vote.firebasestorage.app",
        messagingSenderId: "954696683994",
        appId: "1:954696683994:web:21a84298a94648ff0230e3"
      };

      if (!window.firebase || !firebase.initializeApp){
        return window.__showFatal('Firebase libraries failed to load.');
      }

      firebase.initializeApp(FIREBASE_CONFIG);
      var db = firebase.firestore();
      var auth = firebase.auth();

      function $(id){ return document.getElementById(id); }
      function setStatus(t){ $('statusBar').textContent='Status: ' + t; }
      function urlRoot(){ return location.origin + '/'; }

      var eventHeading=$('eventHeading');
      var eventIdInput=$('eventId'), setBtn=$('setEventBtn');
      var broadcastEl=$('broadcastActive'), lockEventEl=$('lockEvent'), eventNote=$('eventNote');

      var singerNameInput=$('singerName'), addSingerBtn=$('addSingerBtn'), addSingerStatus=$('addSingerStatus');

      var nowPerfLabel=$('nowPerfLabel'), perfStatus=$('perfStatus'), countdownEl=$('countdown'), qrImg=$('qrImg');

      var openPerfVote=$('openPerfVote');
      var openVote=$('openVote'), openScreen=$('openScreen'), openBoard=$('openBoard');

      var showHiddenEl=$('showHidden'), singersSidebar=$('singersSidebar');

      auth.signInAnonymously().catch(function(e){ setStatus('Auth error: ' + ((e&&e.message)||e)); });

      var LS_EVENT='eyek_last_event';
      var STATE={ currentSingerId:null, currentSingerName:null, performanceId:null, performanceCloseAt:null, performanceStatus:'' };
      var perfOutcomeCache={}; // perfId -> outcome
      var singerMap={};       // singerId -> {name, latestPerformanceId, removed}
      var unsubSingersRealtime=null, unsubState=null, unsubPerf=null;

      (function(){
        var u=new URL(location.href), q=u.searchParams.get('eventId'), mem=localStorage.getItem(LS_EVENT);
        if(!q && !mem){
          var typed=(prompt('Enter event name:')||'').trim();
          if(typed){ u.searchParams.set('eventId',typed); history.replaceState({},'',u.toString()); localStorage.setItem(LS_EVENT,typed); }
        }
      })();

      broadcastEl.checked=localStorage.getItem('eyek_broadcast_event')==='1';
      lockEventEl.checked=localStorage.getItem('eyek_lock_event')==='1';
      syncSetBtnDisabled();
      if(lockEventEl.checked) eventNote.textContent='Event locked — switching disabled.';

      var START_EVENT=(new URL(location.href)).searchParams.get('eventId') || localStorage.getItem(LS_EVENT) || 'default';
      eventIdInput.value=START_EVENT;
      applyEvent(START_EVENT);

      setBtn.addEventListener('click', onClickSetEvent);
      eventIdInput.addEventListener('keydown', function(e){ if(e.key==='Enter') onClickSetEvent(); });
      lockEventEl.addEventListener('change', function(){
        localStorage.setItem('eyek_lock_event', lockEventEl.checked?'1':'0');
        eventNote.textContent=lockEventEl.checked?'Event locked — switching disabled.':'';
        syncSetBtnDisabled();
      });
      broadcastEl.addEventListener('change', function(){
        localStorage.setItem('eyek_broadcast_event', broadcastEl.checked?'1':'0');
        if(broadcastEl.checked) broadcastActiveEvent(getCurrentEventId());
      });

      addSingerBtn.addEventListener('click', addSinger);
      singerNameInput.addEventListener('keydown', function(e){ if(e.key==='Enter') addSinger(); });

      $('btnVoteNow').addEventListener('click', function(){ openVoting(30); });
      $('btnExtend15').addEventListener('click', function(){ extendVoting(15); });
      $('btnEndNow').addEventListener('click', endVotingNow);

      $('hostVoteEncore').addEventListener('click', function(){ hostCastVote('encore'); });
      $('hostVoteAnother').addEventListener('click', function(){ hostCastVote('another'); });
      $('hostVoteMaybe').addEventListener('click', function(){ hostCastVote('maybe'); });

      showHiddenEl.addEventListener('change', renderSingersSidebar);

      openPerfVote.addEventListener('click', function(){
        if(!STATE.performanceId) return setStatus('No performance.');
        var eid=getCurrentEventId();
        var url=urlRoot()+'vote/index.html?eventId='+encodeURIComponent(eid)+'&performanceId='+encodeURIComponent(STATE.performanceId);
        window.open(url,'_blank','noopener');
      });
      openVote.addEventListener('click', function(){
        var eid=getCurrentEventId();
        var base=urlRoot()+'vote/index.html?eventId='+encodeURIComponent(eid);
        if(STATE.performanceId) base+='&performanceId='+encodeURIComponent(STATE.performanceId);
        window.open(base,'_blank','noopener');
      });
      openScreen.addEventListener('click', function(){
        window.open(urlRoot()+'screen/index.html?eventId='+encodeURIComponent(getCurrentEventId()),'_blank','noopener');
      });
      openBoard.addEventListener('click', function(){
        window.open(urlRoot()+'board/index.html?eventId='+encodeURIComponent(getCurrentEventId()),'_blank','noopener');
      });

      function syncSetBtnDisabled(){ setBtn.disabled = !!lockEventEl.checked; }
      function getCurrentEventId(){
        var u=new URL(window.location.href), q=u.searchParams.get('eventId');
        if(q && q.trim()) return q.trim();
        var mem=localStorage.getItem(LS_EVENT);
        return (mem && mem.trim()) ? mem.trim() : 'default';
      }

      function onClickSetEvent(){
        var typed=(eventIdInput.value||'').trim();
        var current=getCurrentEventId();
        if(lockEventEl.checked) return setStatus('Event is locked. Uncheck “Lock Event” to switch.');
        if(!typed) return setStatus('Enter an event name.');
        if(typed===current) return setStatus('Already on “'+current+'”.');
        var ok=true; try{ ok=confirm('Switch event to “'+typed+'”? (Does not delete singers or votes)'); }catch(_){ ok=true; }
        if(!ok) return setStatus('Event switch cancelled.');
        applyEvent(typed);
      }

      function applyEvent(eid){
        var u=new URL(window.location.href); u.searchParams.set('eventId',eid); history.replaceState({},'',u.toString());
        try{ localStorage.setItem(LS_EVENT,eid); }catch(_){}
        eventHeading.textContent = eid;

        watchSingers(eid);
        watchState(eid);

        if(broadcastEl.checked) broadcastActiveEvent(eid);
        setStatus('Event set to: '+eid);
      }

      function broadcastActiveEvent(eid){
        db.collection('meta').doc('active').set({
          eventId:eid, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(){ eventNote.textContent='Broadcasting Active Event: '+eid; })
          .catch(function(e){ eventNote.textContent='Error broadcasting: '+((e&&e.message)||e); });
      }

      // QR (small)
      function qrProvider1(d){ return 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data='+encodeURIComponent(d); }
      function qrProvider2(d){ return 'https://chart.googleapis.com/chart?cht=qr&chs=160x160&chl='+encodeURIComponent(d); }
      function setQrImageForUrl(url){
        var tried=false; qrImg.onerror=function(){ if(!tried){ tried=true; qrImg.src=qrProvider2(url); } else { qrImg.alt='QR unavailable'; } };
        qrImg.src=qrProvider1(url);
      }
      function updatePerfQr(){
        if(!STATE.performanceId){ qrImg.removeAttribute('src'); qrImg.alt='No performance'; return; }
        var url = urlRoot()+'vote/index.html?eventId='+encodeURIComponent(getCurrentEventId())+'&performanceId='+encodeURIComponent(STATE.performanceId);
        setQrImageForUrl(url);
      }

      // Countdown
      function renderCountdown(){
        if(!STATE.performanceCloseAt || STATE.performanceStatus!=='open'){ countdownEl.textContent='—'; return; }
        var ms=STATE.performanceCloseAt.toMillis()-Date.now();
        var s=Math.max(0,Math.ceil(ms/1000));
        countdownEl.textContent=s+'s';
      }
      function startCountdown(){ stopCountdown(); renderCountdown(); countdownTimer=setInterval(renderCountdown,250); }
      function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } countdownEl.textContent='—'; }
      function armAutoClose(){
        if(!STATE.performanceCloseAt) return;
        var ms=Math.max(0,STATE.performanceCloseAt.toMillis()-Date.now());
        setTimeout(function(){ endVotingNow(); }, ms+300);
      }

      function watchPerformance(eid, perfId){
        if(unsubPerf){ unsubPerf(); unsubPerf=null; }
        if(!perfId){
          STATE.performanceId=null; STATE.performanceCloseAt=null; STATE.performanceStatus='';
          stopCountdown(); updatePerfQr(); perfStatus.textContent='No performance yet';
          return;
        }
        unsubPerf = db.collection('events').doc(eid).collection('performances').doc(perfId).onSnapshot(function(snap){
          if(!snap.exists){ STATE.performanceCloseAt=null; STATE.performanceStatus=''; stopCountdown(); perfStatus.textContent='(performance not found)'; return; }
          var d=snap.data()||{};
          STATE.performanceId=snap.id;
          STATE.performanceStatus=d.status||'pending';
          STATE.performanceCloseAt=d.closeAt||null;
          updatePerfQr();
          if(STATE.performanceStatus==='open'){ perfStatus.textContent='Voting OPEN'; startCountdown(); armAutoClose(); }
          else if(STATE.performanceStatus==='pending'){ perfStatus.textContent='Now singing (get ready)'; stopCountdown(); }
          else { perfStatus.textContent='Voting CLOSED'; stopCountdown(); }
        }, function(err){ setStatus('Performance listener error: '+((err&&err.message)||err)); });
      }

      function watchState(eid){
        if(unsubState){ unsubState(); unsubState=null; }
        unsubState = db.collection('events').doc(eid).collection('state').doc('current').onSnapshot(function(snap){
          if(!snap.exists){ STATE.currentSingerId=null; STATE.currentSingerName=null; nowPerfLabel.textContent='None'; watchPerformance(eid,null); return; }
          var d=snap.data()||{};
          STATE.currentSingerId=d.currentSingerId||null;
          STATE.currentSingerName=d.currentSingerName||'(Unknown)';
          nowPerfLabel.textContent=STATE.currentSingerName||'None';
          watchPerformance(eid, d.performanceId || null);
        }, function(err){ setStatus('State listener error: '+((err&&err.message)||err)); });
      }

      // ---- Singers (bulleted list) ----
      function warmOutcome(eid, perfId){
        if(!perfId) return Promise.resolve(null);
        if(perfOutcomeCache[perfId]!==undefined) return Promise.resolve(perfOutcomeCache[perfId]);
        return db.collection('events').doc(eid).collection('performances').doc(perfId).get()
          .then(function(s){ var out=s.exists?(s.data().outcome||null):null; perfOutcomeCache[perfId]=out; return out; })
          .catch(function(){ perfOutcomeCache[perfId]=null; return null; });
      }

      function loadSingersOnce(eid){
        db.collection('events').doc(eid).collection('singers').get()
          .then(async function(snap){
            singerMap = {};
            var warmPromises=[];
            snap.forEach(function(d){
              var x=d.data()||{};
              singerMap[d.id] = {name:x.name||'', latestPerformanceId:x.latestPerformanceId||null, removed: !!x.removed};
              if(x.latestPerformanceId) warmPromises.push(warmOutcome(eid, x.latestPerformanceId));
            });
            await Promise.all(warmPromises);
            renderSingersSidebar();
          })
          .catch(function(){ singerMap={}; renderSingersSidebar(); });
      }

      function watchSingers(eid){
        if(unsubSingersRealtime){ unsubSingersRealtime(); unsubSingersRealtime=null; }
        loadSingersOnce(eid);
        unsubSingersRealtime = db.collection('events').doc(eid).collection('singers').onSnapshot(function(snap){
          snap.docChanges().forEach(function(ch){
            var id=ch.doc.id, x=ch.doc.data()||{};
            if (ch.type==='removed'){
              delete singerMap[id];
            }else{
              singerMap[id] = {name:x.name||'', latestPerformanceId:x.latestPerformanceId||null, removed: !!x.removed};
              if(x.latestPerformanceId && perfOutcomeCache[x.latestPerformanceId]===undefined){
                warmOutcome(eid, x.latestPerformanceId).then(renderSingersSidebar);
              }
            }
          });
          renderSingersSidebar();
        }, function(err){ setStatus('Realtime singers error: '+((err&&err.message)||err)); });
      }

      function wantSingerInSidebar(s){
        // Include if not removed AND (no outcome yet OR outcome is encore/another).
        var out=null;
        if(s.latestPerformanceId){ out = perfOutcomeCache[s.latestPerformanceId] || null; }
        return !s.removed && (out===null || out==='encore' || out==='another');
      }

      function renderSingersSidebar(){
        var showRemoved = showHiddenEl.checked;
        var listEl = singersSidebar;
        listEl.innerHTML = '';

        var items=[];
        Object.keys(singerMap).forEach(function(sid){
          var s=singerMap[sid];
          var out=null; if(s.latestPerformanceId){ out=perfOutcomeCache[s.latestPerformanceId]||null; }
          if(s.removed){
            if(showRemoved) items.push({id:sid, name:s.name, outcome:out, removed:true});
          }else{
            if(out==='maybe' && !showRemoved) return; // hide “maybe” unless showing removed
            items.push({id:sid, name:s.name, outcome:out, removed:false});
          }
        });

        items.sort(function(a,b){ return a.name.localeCompare(b.name, undefined, {sensitivity:'base'}); });

        if (!items.length){
          var li=document.createElement('li'); li.textContent=showRemoved?'No singers.':'No singers yet.'; listEl.appendChild(li);
          return;
        }

        items.forEach(function(it){
          var li=document.createElement('li'); if (it.removed) li.classList.add('li-removed');

          var left=document.createElement('div');
          left.innerHTML='<span class="singerName">'+escapeHtml(it.name)+'</span>'
                        +'<span class="meta"> — '+(it.outcome||'—')+'</span>';

          var right=document.createElement('div'); right.className='stack';

          // Set Current (keep normal size for accessibility)
          var bSet=document.createElement('button'); bSet.className='btn small good'; bSet.textContent='Set';
          bSet.addEventListener('click', function(){ setCurrentSinger(it.id, it.name); });

          // Remove / Restore (tiny)
          var bRemove=document.createElement('button');
          if (!it.removed){
            bRemove.className='btn tiny danger'; bRemove.title='Remove'; bRemove.textContent='✕';
            bRemove.addEventListener('click', function(){
              if (!confirm('Remove singer “'+it.name+'”? They will be hidden from lists and the Board.')) return;
              updateSingerRemoved(it.id, true);
            });
          }else{
            bRemove.className='btn tiny good'; bRemove.title='Restore'; bRemove.textContent='↺';
            bRemove.addEventListener('click', function(){ updateSingerRemoved(it.id, false); });
          }

          right.appendChild(bSet);
          right.appendChild(bRemove);
          li.appendChild(left); li.appendChild(right);
          listEl.appendChild(li);
        });
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, function(m){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
        });
      }

      // Actions
      function updateSingerRemoved(singerId, removed){
        var eid=getCurrentEventId();
        db.collection('events').doc(eid).collection('singers').doc(singerId).set(
          removed ? { removed:true, removedAt: Date.now() } : { removed:false },
          { merge:true }
        ).then(function(){
          setStatus(removed ? 'Singer removed.' : 'Singer restored.');
        }).catch(function(e){
          setStatus('Error updating singer: '+((e&&e.message)||e));
        });
      }

      function addSinger(){
        var name=(singerNameInput.value||'').trim();
        if(!name){ addSingerStatus.textContent='Please enter a singer name.'; return; }
        var eid=getCurrentEventId();
        addSingerBtn.disabled=true; addSingerStatus.textContent='Adding…';
        auth.signInAnonymously().catch(function(){}).finally(function(){
          db.collection('events').doc(eid).collection('singers').add({ name:name, ts:Date.now(), removed:false })
          .then(function(ref){
            singerNameInput.value=''; addSingerStatus.textContent='Singer added. Announcing…';
            announceExisting(ref.id,name).then(function(){ addSingerStatus.textContent='Singer added & announced.'; });
          })
          .catch(function(e){
            var msg=(e&&e.message)||String(e);
            addSingerStatus.textContent = String(msg).toLowerCase().indexOf('permission')>=0
              ? 'Permissions error adding singer (check rules).'
              : 'Error adding singer: '+msg;
          })
          .finally(function(){ addSingerBtn.disabled=false; });
        });
      }

      function setCurrentSinger(singerId, singerName){
        var eid=getCurrentEventId();
        if(STATE.currentSingerId===singerId && STATE.performanceId){
          db.collection('events').doc(eid).collection('state').doc('current').set({
            currentSingerId:singerId, currentSingerName:singerName, performanceId:STATE.performanceId, ts:Date.now()
          }, {merge:true}).then(function(){ setStatus('Still current: '+singerName); });
          return;
        }
        announceExisting(singerId, singerName).then(function(){ setStatus('Now performing: '+singerName); });
      }

      function announceExisting(singerId,singerName){
        var eid=getCurrentEventId();
        return db.collection('events').doc(eid).collection('performances').add({
          singerId:singerId, singerName:singerName, status:'pending',
          openAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function(perfRef){
          return Promise.all([
            db.collection('events').doc(eid).collection('singers').doc(singerId).set({ latestPerformanceId: perfRef.id }, { merge:true }),
            db.collection('events').doc(eid).collection('state').doc('current').set({
              currentSingerId:singerId, currentSingerName:singerName, performanceId:perfRef.id, ts:Date.now()
            })
          ]).then(function(){
            setStatus('Announced: '+singerName+'. (QR shown; voting not open yet)');
          });
        }).catch(function(e){ setStatus('Announce failed: '+((e&&e.message)||e)); });
      }

      function openVoting(seconds){
        seconds=seconds||30;
        var eid=getCurrentEventId();
        var ensure=Promise.resolve();
        if(!STATE.performanceId){
          ensure = db.collection('events').doc(eid).collection('performances').add({
            singerId:STATE.currentSingerId, singerName:STATE.currentSingerName, status:'pending',
            openAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(function(perfRef){
            return Promise.all([
              db.collection('events').doc(eid).collection('singers').doc(STATE.currentSingerId).set({ latestPerformanceId: perfRef.id }, { merge:true }),
              db.collection('events').doc(eid).collection('state').doc('current').set({
                currentSingerId:STATE.currentSingerId, currentSingerName:STATE.currentSingerName, performanceId:perfRef.id, ts:Date.now()
              })
            ]);
          });
        }
        ensure.then(function(){
          var closeAt=firebase.firestore.Timestamp.fromMillis(Date.now()+seconds*1000);
          return db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
            status:'open', openAt: firebase.firestore.FieldValue.serverTimestamp(), closeAt:closeAt
          }).then(function(){ setStatus('Voting opened for '+(STATE.currentSingerName||'')+' ('+seconds+'s).'); });
        }).catch(function(e){ setStatus('Open voting error: '+((e&&e.message)||e)); });
      }

      function extendVoting(extra){
        extra=extra||15;
        if(!STATE.performanceId) return setStatus('No performance.');
        var eid=getCurrentEventId();
        var base=Date.now(); if(STATE.performanceCloseAt) base=Math.max(base, STATE.performanceCloseAt.toMillis());
        var newClose=new Date(base + extra*1000);
        db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
          closeAt: firebase.firestore.Timestamp.fromDate(newClose)
        }).then(function(){ setStatus('Extended by '+extra+'s.'); }).catch(function(e){ setStatus('Extend failed: '+((e&&e.message)||e)); });
      }

      function decideOutcome(e,a,m){
        e|=0;a|=0;m|=0;
        if(e>a && e>m) return 'encore';
        if(a>e && a>m) return 'another';
        if(m>e && m>a) return 'maybe';
        if(a===m && a>e) return 'another';
        if(e===a && e>m) return 'encore';
        if(e===m && e>a) return 'another';
        if(e===a && a===m && e>0) return 'another';
        return null;
      }
      function finalizePerformance(eid, perfId){
        var q=db.collection('events').doc(eid).collection('votes').where('performanceId','==',perfId);
        q.get().then(function(snap){
          var e=0,a=0,m=0;
          snap.forEach(function(d){
            var cat=String((d.data()||{}).category||'').toLowerCase();
            if(cat==='encore') e++; else if(cat==='another') a++; else if(cat==='maybe') m++;
          });
          var outcome=decideOutcome(e,a,m);
          return db.collection('events').doc(eid).collection('performances').doc(perfId).update({
            status:'closed', closeAt: firebase.firestore.Timestamp.fromDate(new Date()),
            outcome:outcome, counts:{encore:e, another:a, maybe:m}
          }).then(function(){ perfOutcomeCache[perfId]=outcome||null; renderSingersSidebar(); });
        }).catch(function(){});
      }
      function endVotingNow(){
        if(!STATE.performanceId) return setStatus('No performance.');
        var eid=getCurrentEventId();
        db.collection('events').doc(eid).collection('performances').doc(STATE.performanceId).update({
          status:'closed', closeAt: firebase.firestore.Timestamp.fromDate(new Date())
        }).then(function(){ finalizePerformance(eid, STATE.performanceId); setStatus('Voting closed.'); })
          .catch(function(e){ setStatus('End failed: '+((e&&e.message)||e)); });
      }

      // Host vote
      function getDeviceId(){
        var KEY='eyek_device_id', id=localStorage.getItem(KEY);
        if(!id){ var arr=new Uint8Array(16); crypto.getRandomValues(arr); id=Array.prototype.map.call(arr,b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem(KEY,id); }
        return id;
      }
      var DEVICE_ID=getDeviceId();
      function hostCastVote(category){
        if(!STATE.performanceId) return setStatus('Open voting first.');
        var eid=getCurrentEventId(), docId=STATE.performanceId+'__'+DEVICE_ID;
        db.collection('events').doc(eid).collection('votes').doc(docId).set({
          performanceId:STATE.performanceId, singerId:STATE.currentSingerId, singerName:STATE.currentSingerName||'(Unknown)',
          category:category, deviceId:DEVICE_ID, ts:Date.now()
        }).then(function(){ setStatus('Host vote submitted.'); })
        .catch(function(e){
          var msg=String((e&&e.message)||e).toLowerCase();
          if(msg.indexOf('permission')>=0 || msg.indexOf('already exists')>=0) setStatus('Already voted or window closed.');
          else setStatus('Error submitting vote.');
        });
      }
    })();
  </script>
</body>
</html>
