<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>EYEK • Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/assets/icon.png" />
<style>
  :root {
    /* Brand */
    --purple:#2F0658; /* requested background */
    --bg: var(--purple);
    --card:#12192a; --soft:#1b2540;
    --txt:#eaf2ff; --muted:#a9b6d9;
    --green:#25d366; --yellow:#f6c945; --red:#ff5e6c; --cyan:#3ad4ff; --accent:#7aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 50% -10%, #44106f 0%, var(--bg) 50%, #16042b 100%);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  .card{background:linear-gradient(180deg,var(--card),#0f1526);border:1px solid #243459;border-radius:14px;padding:14px;box-shadow:0 6px 26px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:20px}
  h2{margin:0 0 10px;font-size:16px;color:var(--muted)}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
  input,button,select{font:inherit}
  input[type=text], input[type=date], input[type=password]{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3c62;background:#0d1428;color:var(--txt)}
  .row{display:flex;gap:10px;align-items:center}
  .row > *{flex:1}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--soft);color:var(--txt);cursor:pointer}
  .btn.primary{background:var(--accent)}
  .btn.good{background:var(--green);color:#03140b}
  .btn.warn{background:var(--yellow);color:#2a2105}
  .btn.bad{background:var(--red)}
  .btn.ghost{background:transparent;border:1px solid #2b3c62}
  .stack{display:grid;gap:12px}
  .side{display:grid;gap:12px}
  .list{display:grid;gap:8px;max-height:62vh;overflow:auto;padding-right:6px}
  .pill{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;background:#0d1428;border:1px solid #203153;border-radius:12px;padding:8px 10px}
  .dot{width:10px;height:10px;border-radius:50%;background:#6f7a98;border:1px solid #5b678a}
  .dot.green{background:var(--green);border-color:#2b8f57}
  .dot.yellow{background:var(--yellow);border-color:#9c7b1d}
  .name{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .minirow{display:flex;gap:6px}
  .tiny{font-size:12px;color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .counts{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .bubble{min-width:64px;text-align:center;padding:8px 10px;border-radius:12px;font-weight:700}
  .b-green{background:rgba(37,211,102,.15);border:1px solid rgba(37,211,102,.35);color:var(--green)}
  .b-yellow{background:rgba(246,201,69,.15);border:1px solid rgba(246,201,69,.35);color:var(--yellow)}
  .b-red{background:rgba(255,94,108,.15);border:1px solid rgba(255,94,108,.35);color:var(--red)}
  .timer{font-size:34px;font-weight:800;letter-spacing:1px}
  .resultTag{padding:8px 12px;border-radius:999px;border:1px solid #2b3c62;background:#0d1428;min-width:160px;text-align:center;font-weight:700}
  .r-encore{border-color:rgba(37,211,102,.5);color:var(--green)}
  .r-another{border-color:rgba(246,201,69,.6);color:var(--yellow)}
  .r-maybe{border-color:rgba(255,94,108,.6);color:var(--red)}
  .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  .help{font-size:12px;color:var(--muted)}
  .sectionTitle{font-size:14px;font-weight:800;color:#cfe0ff;margin:4px 0 10px;letter-spacing:.4px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .bar{height:1px;background:#203153;margin:10px 0}
  details{border:1px solid #243459;border-radius:12px}
  details[open] summary{border-bottom:1px solid #243459}
  summary{list-style:none;cursor:pointer;padding:10px 14px;background:#0f1526;border-radius:12px}
  summary::-webkit-details-marker{display:none}
  .links a{color:var(--cyan);text-decoration:none}
  .links a:hover{text-decoration:underline}

  /* Login overlay */
  .gate{position:fixed;inset:0;background:rgba(14,8,22,.8);backdrop-filter:blur(5px);display:grid;place-items:center;z-index:99}
  .gate .panel{width:min(560px,92vw)}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: singers -->
  <div class="side">
    <div class="card">
      <h1>Rotation</h1>
      <div class="help">Click <b>Set</b> to make someone the current singer. Indicators: <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#6f7a98;border:1px solid #5b678a;vertical-align:middle"></span> new · <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#25d366;border:1px solid #2b8f57;vertical-align:middle"></span> Encore · <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#f6c945;border:1px solid #9c7b1d;vertical-align:middle"></span> Another Shot</div>
      <div id="singerList" class="list"></div>
    </div>

    <div class="card">
      <h2>Sound</h2>
      <label class="switch">
        <input id="soundToggle" type="checkbox">
        <span>Enable sound effects</span>
      </label>
      <div class="help">Browser requires one click to allow audio. Toggle this on once.</div>
      <audio id="sfx_open" src="/assets/voting_open.mp3" preload="auto"></audio>
      <audio id="sfx_over" src="/assets/voting_over.mp3" preload="auto"></audio>
      <audio id="sfx_encore" src="/assets/encore.mp3" preload="auto"></audio>
      <audio id="sfx_maybe" src="/assets/loser.wav" preload="auto"></audio>
      <audio id="sfx_another" src="/assets/another_shot.mp3" preload="auto"></audio>
    </div>

    <div class="card links">
      <h2>Quick Links</h2>
      <div class="stack">
        <a target="_blank" href="/host/index.html">Open Host</a>
        <a target="_blank" href="/screen/index.html">Open Screen</a>
        <a target="_blank" href="/vote/index.html">Open Vote</a>
        <a target="_blank" href="/board/index.html">Open Board</a>
      </div>
    </div>
  </div>

  <!-- RIGHT: controls -->
  <div class="stack">
    <!-- Event Setup (collapsible) -->
    <details id="eventBox" class="card" open>
      <summary><h1 style="display:inline">Event / KJ Setup</h1> <span class="tiny" id="eventSavedMsg"></span></summary>
      <div class="stack" style="padding:10px 0 0 0">
        <div class="grid2">
          <div>
            <label>Venue (type to search saved)</label>
            <input list="venues" id="venue" type="text" placeholder="Venue name">
            <datalist id="venues"></datalist>
          </div>
          <div>
            <label>Date</label>
            <input id="eventDate" type="date">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>KJ Company / Host (type to search saved)</label>
            <input list="kjs" id="kj" type="text" placeholder="KJ company or name">
            <datalist id="kjs"></datalist>
          </div>
          <div>
            <label>Event PIN</label>
            <input id="pin" type="password" placeholder="4-8 digits (for voters)">
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn primary" id="saveEvent">Save</button>
          <button class="btn ghost" id="lockEvent">Lock</button>
          <button class="btn" id="resetEvent">Reset Event</button>
        </div>
        <div class="help">Lock prevents accidental edits and collapses this section. Reset clears singers & votes for a new show (available only when unlocked).</div>
      </div>
    </details>

    <!-- Singer + Voting -->
    <div class="card">
      <h1>Show Control</h1>
      <div class="grid2">
        <div>
          <div class="sectionTitle">Add Singer</div>
          <div class="row">
            <input id="singerName" type="text" placeholder="Singer name (e.g., Lisa H.)">
            <input id="songArtist" type="text" placeholder="Song — Artist (e.g., Lovin' Every Minute — Loverboy)">
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="addSinger">Add Singer</button>
          </div>
        </div>
        <div>
          <div class="sectionTitle">Current & Voting</div>
          <div class="row">
            <div style="flex:1">
              <div class="tiny">Current Singer</div>
              <div id="currentName" style="font-weight:800;font-size:18px">—</div>
              <div class="tiny">Next Song/Artist (for records)</div>
              <input id="currentSongArtist" type="text" placeholder="Type next song for DB/report…">
            </div>
            <div style="text-align:right">
              <div class="tiny">Timer</div>
              <div id="timer" class="timer">00:00</div>
            </div>
          </div>
          <div class="counts" style="margin-top:6px">
            <div class="bubble b-green" id="c_encore">0</div>
            <div class="bubble b-yellow" id="c_another">0</div>
            <div class="bubble b-red" id="c_maybe">0</div>
            <div id="resultTag" class="resultTag">—</div>
          </div>
          <div class="grid3" style="margin-top:10px">
            <button class="btn good" id="startVote">Start (30s)</button>
            <button class="btn warn" id="extendVote">Extend (+15s)</button>
            <button class="btn bad" id="endVote">End</button>
          </div>
        </div>
      </div>
      <div class="bar"></div>
      <div>
        <div class="sectionTitle">Host Vote</div>
        <div class="grid3">
          <button class="btn good" id="hv_encore">Encore!</button>
          <button class="btn warn" id="hv_another">Another Shot!</button>
          <button class="btn bad" id="hv_maybe">Maybe Next Time</button>
        </div>
        <div class="help" style="margin-top:6px">Host vote simply adds to totals. Results announce only when the timer ends or you press <b>End</b>.</div>
      </div>
    </div>
  </div>
</div>

<!-- Login Gate -->
<div id="gate" class="gate" hidden>
  <div class="panel card">
    <h1>Host Login</h1>
    <div class="grid2">
      <div>
        <label>Host Email</label>
        <input id="hostEmail" type="text" placeholder="you@example.com">
      </div>
      <div>
        <label>Event PIN (set in Event Setup)</label>
        <input id="hostPin" type="password" placeholder="Enter PIN to unlock controls">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="loginBtn">Enter Host Panel</button>
    </div>
    <div class="help">Lightweight gate for the laptop host. Not a secure auth system—okay for demo/show use.</div>
  </div>
</div>

<script>
// ======= Config =======
const GET_URL = '/assets/get_state.php';
const POST_URL = '/assets/state.php';
const POLL_MS = 1200;

// ======= State shape =======
/*
state = {
  serverUpdatedAt: <epoch>,
  event: { venue:"", date:"YYYY-MM-DD", kj:"", pin:"", locked:false },
  singers: [{id,name,status:'new'|'encore'|'another'}],
  current: { id:null, name:"", songArtist:"" },
  voting: { open:false, endsAt:0, extendCount:0, counts:{encore:0,another:0,maybe:0}, lastResult:null }
}
*/

let state = null;
let tickTimer = null;
let allowSound = false;
let authed = false;

// ======= DOM =======
const $ = sel => document.querySelector(sel);
const singerList = $('#singerList');
const venuesDL = $('#venues');
const kjsDL = $('#kjs');
const venue = $('#venue');
const eventDate = $('#eventDate');
const kj = $('#kj');
const pin = $('#pin');
const singerName = $('#singerName');
const songArtist = $('#songArtist');
const currentName = $('#currentName');
const currentSongArtist = $('#currentSongArtist');
const timerEl = $('#timer');
const cEncore = $('#c_encore');
const cAnother = $('#c_another');
const cMaybe = $('#c_maybe');
const resultTag = $('#resultTag');
const eventBox = $('#eventBox');
const gate = $('#gate');
const hostEmail = $('#hostEmail');
const hostPin = $('#hostPin');

const sfx = {
  open: $('#sfx_open'),
  over: $('#sfx_over'),
  encore: $('#sfx_encore'),
  another: $('#sfx_another'),
  maybe: $('#sfx_maybe'),
};

function play(key){
  if(!allowSound) return;
  const a = sfx[key];
  if(a){ a.currentTime = 0; a.play().catch(()=>{}); }
}

$('#soundToggle').addEventListener('change', e=>{
  allowSound = e.target.checked;
  if(allowSound) play('open'); // unlock audio
});

// ======= Login Gate (lightweight) =======
function showGate(){ gate.hidden = false; }
function hideGate(){ gate.hidden = true; }

$('#loginBtn').addEventListener('click', ()=>{
  const email = hostEmail.value.trim();
  const pinTry = hostPin.value.trim();
  // allow if no pin set yet OR pin matches
  const setPin = (state?.event?.pin || '').trim();
  if(!email){ alert('Enter your host email.'); return; }
  if(setPin && pinTry !== setPin){ alert('PIN does not match the event PIN.'); return; }
  authed = true;
  localStorage.setItem('eyek_host_email', email);
  hideGate();
});

// ======= Event Actions =======
$('#saveEvent').addEventListener('click', async ()=>{
  state.event.venue = venue.value.trim();
  state.event.date = eventDate.value || new Date().toISOString().slice(0,10);
  state.event.kj = kj.value.trim();
  state.event.pin = pin.value.trim();
  await postState();
  rememberValue('eyek_venues', state.event.venue);
  rememberValue('eyek_kjs', state.event.kj);
  flashSaved('eventSavedMsg','Saved!');
});

$('#lockEvent').addEventListener('click', async (e)=>{
  state.event.locked = !state.event.locked;
  await postState();
  renderLockUI();
});

$('#resetEvent').addEventListener('click', async ()=>{
  if(state.event.locked){ alert('Unlock the event to reset.'); return; }
  if(!confirm('Reset this event? This clears singers and votes.')) return;
  state = {
    serverUpdatedAt: Date.now()/1000|0,
    event: {venue:"", date:new Date().toISOString().slice(0,10), kj:"", pin:"", locked:false},
    singers: [],
    current: {id:null,name:"",songArtist:""},
    voting: {
      open:false, endsAt:0, extendCount:0,
      counts:{encore:0,another:0,maybe:0},
      lastResult:null
    }
  };
  await postState();
});

function renderLockUI(){
  const btn = $('#lockEvent');
  if(state.event.locked){
    btn.textContent = 'Unlock';
    eventBox.open = false;
    $('#resetEvent').disabled = true;
    venue.disabled = kj.disabled = eventDate.disabled = pin.disabled = true;
  } else {
    btn.textContent = 'Lock';
    $('#resetEvent').disabled = false;
    venue.disabled = kj.disabled = eventDate.disabled = pin.disabled = false;
  }
}

// ======= Singer Actions =======
$('#addSinger').addEventListener('click', async ()=>{
  const name = singerName.value.trim();
  const song = songArtist.value.trim();
  if(!name){ alert('Enter a singer name.'); return; }
  const id = 's_'+Math.random().toString(36).slice(2,9);
  state.singers.push({id, name, status:'new'});
  // if none set, set current immediately but keep their next song in current field
  if(!state.current.id){
    state.current = {id, name, songArtist: song};
  }
  await postState();
  singerName.value = ""; songArtist.value="";
});

function setCurrent(id){
  const s = state.singers.find(x=>x.id===id);
  if(!s) return;
  // advance rotation: mark their next song from input box for record
  state.current = {id:s.id, name:s.name, songArtist: currentSongArtist.value.trim()};
  currentSongArtist.value = '';
  postState();
}

function removeSinger(id){
  state.singers = state.singers.filter(x=>x.id!==id);
  if(state.current.id===id){
    state.current = {id:null,name:"",songArtist:""};
  }
  postState();
}

// ======= Voting =======
$('#startVote').addEventListener('click', async ()=>{
  if(!state.current.id){ alert('Set a current singer first.'); return; }
  const ends = Date.now() + 30_000;
  state.voting.open = true;
  state.voting.endsAt = ends;
  state.voting.extendCount = 0;
  state.voting.counts = {encore:0, another:0, maybe:0};
  state.voting.lastResult = null;
  await postState();
  play('open');
});

$('#extendVote').addEventListener('click', async ()=>{
  if(!state.voting.open) return;
  state.voting.endsAt += 15_000;
  state.voting.extendCount++;
  await postState();
});

$('#endVote').addEventListener('click', async ()=>{
  await concludeVoting();
});

async function concludeVoting(){
  if(!state.voting.open){
    // already ended: re-announce last result if exists
    announce(state.voting.lastResult);
    return;
  }
  state.voting.open = false;
  state.voting.endsAt = 0;
  const {encore, another, maybe} = state.voting.counts;
  let winner = 'maybe';
  if (encore>=another && encore>=maybe) winner = 'encore';
  else if (another>=encore && another>=maybe) winner = 'another';
  else winner = 'maybe';
  state.voting.lastResult = winner;

  // apply outcome to current singer
  const cur = state.singers.find(s=>s.id===state.current.id);
  if(cur){
    if(winner==='maybe'){
      // remove from rotation
      state.singers = state.singers.filter(s=>s.id!==cur.id);
      // keep current shown until you set someone else
    } else {
      cur.status = (winner==='encore' ? 'green' : 'yellow');
      // normalize to semantic statuses for sidebar coloring
      if(cur.status==='green') cur._color='green';
      if(cur.status==='yellow') cur._color='yellow';
    }
  }

  await postState();
  play('over');
  setTimeout(()=>announce(winner), 200);
}

// Host vote buttons (add to totals only)
$('#hv_encore').addEventListener('click', ()=> addVote('encore'));
$('#hv_another').addEventListener('click', ()=> addVote('another'));
$('#hv_maybe').addEventListener('click', ()=> addVote('maybe'));

async function addVote(kind){
  if(!state.voting.open) return;
  state.voting.counts[kind] = (state.voting.counts[kind]||0)+1;
  await postState();
}

// ======= Fetch/Render =======
async function fetchState(){
  const r = await fetch(GET_URL, {cache:'no-store'});
  state = await r.json();
  // backfill shape if older file exists on server
  state.event = state.event || {venue:"", date:new Date().toISOString().slice(0,10), kj:"", pin:"", locked:false};
  state.current = state.current || {id:null,name:"",songArtist:""};
  state.voting = state.voting || {open:false, endsAt:0, extendCount:0, counts:{encore:0,another:0,maybe:0}, lastResult:null};
  state.singers = state.singers || [];
  render();
}

async function postState(){
  await fetch(POST_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(state)
  });
  await fetchState();
}

function render(){
  // form
  venue.value = state.event.venue||"";
  eventDate.value = (state.event.date || new Date().toISOString().slice(0,10));
  kj.value = state.event.kj||"";
  pin.value = state.event.pin||"";
  renderLockUI();

  // datalists
  renderDatalist('eyek_venues', venuesDL);
  renderDatalist('eyek_kjs', kjsDL);

  // list
  singerList.innerHTML = "";
  state.singers.forEach(s=>{
    const div = document.createElement('div');
    div.className="pill";
    const dot = document.createElement('div');
    dot.className = 'dot ' + (s._color||''); // ''|green|yellow
    const left = document.createElement('div');
    left.className='name';
    left.textContent = s.name;
    const right = document.createElement('div');
    right.className="minirow";
    const setBtn = document.createElement('button');
    setBtn.className="btn"; setBtn.textContent = "Set";
    setBtn.onclick = ()=>setCurrent(s.id);
    const rmBtn = document.createElement('button');
    rmBtn.className="btn ghost"; rmBtn.textContent="Remove";
    rmBtn.onclick = ()=>removeSinger(s.id);
    right.appendChild(setBtn); right.appendChild(rmBtn);

    div.appendChild(dot);
    div.appendChild(left);
    div.appendChild(right);
    singerList.appendChild(div);
  });

  // current & counts
  currentName.textContent = state.current.name || "—";
  cEncore.textContent = state.voting.counts.encore || 0;
  cAnother.textContent = state.voting.counts.another || 0;
  cMaybe.textContent = state.voting.counts.maybe || 0;

  // timer & result
  if (state.voting.open) {
    const ms = Math.max(0, state.voting.endsAt - Date.now());
    timerEl.textContent = fmt(ms);
    resultTag.textContent = "Voting…";
    resultTag.className="resultTag";
  } else {
    timerEl.textContent = "00:00";
    announce(state.voting.lastResult);
  }
}

function announce(w){
  if(!w){ resultTag.textContent = "—"; resultTag.className = "resultTag"; return; }
  if(w==="encore"){ resultTag.textContent="Encore!"; resultTag.className="resultTag r-encore"; play('encore'); }
  else if(w==="another"){ resultTag.textContent="Another Shot!"; resultTag.className="resultTag r-another"; play('another'); }
  else { resultTag.textContent="Maybe Next Time"; resultTag.className="resultTag r-maybe"; play('maybe'); }
}

function fmt(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const r = s%60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function flashSaved(id,msg){
  const el = document.getElementById(id);
  el.textContent = msg;
  setTimeout(()=>el.textContent="",1400);
}

function rememberValue(key, value){
  if(!value) return;
  const raw = localStorage.getItem(key);
  const list = raw ? JSON.parse(raw) : [];
  if(!list.includes(value)) list.unshift(value);
  localStorage.setItem(key, JSON.stringify(list.slice(0,20)));
}
function renderDatalist(key, dl){
  const raw = localStorage.getItem(key);
  const list = raw ? JSON.parse(raw) : [];
  dl.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
}

async function loop(){
  await fetchState();
  if (tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(async ()=>{
    // auto-end if timer hits
    if (state?.voting?.open && Date.now() >= state.voting.endsAt){
      await concludeVoting();
    } else {
      await fetchState();
    }
  }, POLL_MS);
}

// Boot
(function init(){
  // default date
  eventDate.value = new Date().toISOString().slice(0,10);
  // restore email
  const em = localStorage.getItem('eyek_host_email')||'';
  if(em) hostEmail.value = em;
  // simple gate behavior: show until user enters with (matching) PIN (if set)
  showGate();
  loop();
})();
</script>
</body>
</html>
