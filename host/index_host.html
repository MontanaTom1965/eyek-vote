<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke â€“ Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0f0a18;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    header{padding:10px 16px; background:linear-gradient(90deg,var(--blue),var(--purple)); text-align:center}
    header h1{margin:0;font-size:1.6rem;font-weight:700}
    main{display:flex;height:calc(100vh - 60px)}
    aside{width:260px;border-right:1px solid rgba(255,255,255,.15);overflow:auto;padding:12px}
    aside h2{margin-top:0;font-size:1.2rem}
    aside ul{list-style:none;padding:0;margin:0}
    aside li{padding:6px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1)}
    aside li:hover{background:rgba(255,255,255,.05)}
    section{flex:1;overflow:auto;padding:16px}
    label{display:block;margin-top:10px}
    input,select,button{padding:6px;margin-top:4px;font-size:1rem}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:4px;cursor:pointer}
    .btn:hover{background:var(--purple)}
    .row{margin:10px 0}
    .lock{margin-left:8px}
    .links a{color:var(--gold); margin-right:10px; text-decoration:none}
    .links a:hover{text-decoration:underline}
    .toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#333;padding:10px 16px;border-radius:6px;display:none}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Host Control Panel</h1>
  </header>
  <main>
    <aside>
      <h2>Singers</h2>
      <ul id="singerList"></ul>
    </aside>
    <section>
      <div class="row">
        <label>Venue:
          <input id="venueName" placeholder="Venue Name"/>
          <button class="btn" onclick="pickVenue()">Pick Venue</button>
          <input type="checkbox" id="lockVenue" class="lock"> Lock
        </label>
      </div>
      <div class="row">
        <label>KJ Company:
          <input id="kjName" placeholder="KJ Name"/>
          <button class="btn" onclick="pickKj()">Pick KJ</button>
          <input type="checkbox" id="lockKj" class="lock"> Lock
        </label>
      </div>
      <div class="row links">
        <a href="https://vote.earnyourencorekaraoke.com/vote/index_vote.html" target="_blank">Vote</a>
        <a href="https://vote.earnyourencorekaraoke.com/screen/index_screen.html" target="_blank">Screen</a>
        <a href="https://vote.earnyourencorekaraoke.com/board/index_board.html" target="_blank">Board</a>
      </div>
      <div class="row">
        <button class="btn" onclick="startVoting()">Start Voting!</button>
        <button class="btn" onclick="extend15()">Extend +15s</button>
        <button class="btn" onclick="endVoting()">End Voting!</button>
      </div>
    </section>
  </main>
  <div id="toast" class="toast"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const singerList = document.getElementById('singerList');
    const toastEl = document.getElementById('toast');

    let eventId = null;

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display='block';
      setTimeout(()=>toastEl.style.display='none',2000);
    }

    function eventRef(){
      if(!eventId) return null;
      return db.collection('events').doc(eventId);
    }

    async function loadCurrentEvent(){
      const snap = await db.collection('app').doc('state').get();
      eventId = (snap.data()||{}).currentEventId;
      if(!eventId){ showToast("No event selected"); return; }
      db.collection('events').doc(eventId).collection('singers')
        .onSnapshot(qs=>{
          singerList.innerHTML='';
          qs.forEach(doc=>{
            const d=doc.data();
            const li=document.createElement('li');
            li.textContent=d.singerName;
            li.onclick=()=>setCurrentSinger(doc.id,d.singerName);
            singerList.appendChild(li);
          });
        });
    }

    async function setCurrentSinger(id,name){
      const song=prompt("Enter Song Title:","");
      const artist=prompt("Enter Artist:","");
      try{
        await eventRef().set({currentSingerId:id,currentSingerName:name,currentSong:song,currentArtist:artist},{merge:true});
        showToast(`Now singing: ${name}`);
      }catch(e){showToast("Error setting singer");}
    }

    async function startVoting(){
      const ref=eventRef(); if(!ref) return;
      const closeAt=Date.now()+30000;
      await ref.set({
        isVotingOpen:true,
        voteClosesAt:closeAt,
        voteWindow:{openedAt:firebase.firestore.FieldValue.serverTimestamp(),durationSec:30,autoClose:true}
      },{merge:true});
      showToast("Voting started");
    }

    async function extend15(){
      const ref=eventRef(); if(!ref) return;
      const snap=await ref.get(); const d=snap.data()||{};
      const closeAt=(typeof d.voteClosesAt==='number'?d.voteClosesAt:Date.now())+15000;
      await ref.set({
        voteClosesAt:closeAt,
        voteWindow:{durationSec:(d.voteWindow?.durationSec||30)+15,autoClose:true}
      },{merge:true});
      showToast("Extended 15s");
    }

    async function endVoting(){
      const ref=eventRef(); if(!ref) return;
      await ref.set({isVotingOpen:false},{merge:true});
      showToast("Voting closed");
    }

    async function pickVenue(){
      if(document.getElementById('lockVenue').checked) return;
      const val=document.getElementById('venueName').value;
      if(!val) return;
      await eventRef().set({venueName:val},{merge:true});
      showToast("Venue set");
    }

    async function pickKj(){
      if(document.getElementById('lockKj').checked) return;
      const val=document.getElementById('kjName').value;
      if(!val) return;
      await eventRef().set({kjName:val},{merge:true});
      showToast("KJ set");
    }

    loadCurrentEvent();
  </script>
  <!-- FILE: index_host.html -->
</body>
</html>
