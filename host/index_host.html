<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Earn Your Encore Karaoke – Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --blue:#003e81; --gold:#eaba54; --purple:#2F0658;
      --green:#27d07d; --yellow:#f4d35e; --red:#ff5964;
      --ink:#0f0a18; --card:#1b1430; --line:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--ink);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    header{padding:10px 16px;background:linear-gradient(90deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:space-between;gap:10px}
    header h1{margin:0;font-size:1.2rem}
    .links a{color:#000;background:var(--gold);padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:900;margin-right:8px}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:0;height:calc(100vh - 56px)}
    aside{border-right:1px solid var(--line);overflow:auto;background:#120c22}
    section{overflow:auto}
    .panel{padding:14px 16px;border-bottom:1px solid var(--line)}
    .panel h2{margin:0 0 10px;font-size:1.05rem}
    .form-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#1a1230;color:#fff}
    .btn{cursor:pointer;border:0}
    .btn-blue{background:var(--blue)}
    .btn-gold{background:var(--gold);color:#000}
    .btn-red{background:#ff5964}
    .btn-ghost{background:#271c44;border:1px solid var(--line)}
    .lock{margin-left:8px}
    .hint{opacity:.8;font-size:.92rem}
    /* Singer list */
    .list{list-style:none;margin:0;padding:0}
    .list li{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:8px}
    .list li .name{font-weight:700}
    .row-actions{display:flex;gap:6px}
    .toast{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#333;padding:10px 14px;border-radius:10px;display:none;z-index:100}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Host Control Panel</h1>
    <div class="links">
      <a href="https://vote.earnyourencorekaraoke.com/vote/index_vote.html" target="_blank" rel="noopener">Vote</a>
      <a href="https://vote.earnyourencorekaraoke.com/screen/index_screen.html" target="_blank" rel="noopener">Screen</a>
      <a href="https://vote.earnyourencorekaraoke.com/board/index_board.html" target="_blank" rel="noopener">Board</a>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: singers -->
    <aside>
      <div class="panel">
        <h2>Singers (this event)</h2>
        <div class="hint">Click a singer for tools. Names only; songs are collected per performance.</div>
      </div>
      <ul id="singerList" class="list"></ul>
    </aside>

    <!-- RIGHT: controls -->
    <section>
      <!-- Venue / KJ -->
      <div class="panel">
        <h2>Event Info</h2>
        <div class="grid2">
          <div>
            <label>Venue
              <input id="venueName" placeholder="Venue Name"/>
            </label>
            <div class="hint">Change venue = new night. This will clear tonight’s singer list.</div>
            <div class="form-row" style="margin-top:6px">
              <button class="btn btn-blue" id="btnPickVenue">Save Venue</button>
              <button class="btn btn-ghost" id="btnPickVenueFromList" title="Choose from known venues">Pick…</button>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="lockVenue" class="lock"/> Lock
              </label>
            </div>
          </div>
          <div>
            <label>KJ / Company
              <input id="kjName" placeholder="KJ name or company"/>
            </label>
            <div class="hint">Saved once per night; hidden on public screens.</div>
            <div class="form-row" style="margin-top:6px">
              <button class="btn btn-blue" id="btnPickKj">Save KJ</button>
              <button class="btn btn-ghost" id="btnPickKjFromList" title="Choose from known KJs">Pick…</button>
              <label style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="lockKj" class="lock"/> Lock
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Add / Update singer -->
      <div class="panel">
        <h2>Add / Update Singer</h2>
        <div class="grid2">
          <div>
            <label>Singer Name
              <input id="singerNameInput" placeholder="e.g. Lisa H." />
            </label>
          </div>
          <div>
            <label>Notes (private)
              <input id="singerNotesInput" placeholder="optional notes, not shown publicly"/>
            </label>
          </div>
        </div>
        <div class="form-row" style="margin-top:8px;grid-template-columns:auto auto 1fr">
          <button class="btn btn-gold" id="btnAddSinger">Add Singer</button>
          <button class="btn btn-ghost" id="btnRenameSinger" disabled>Rename Selected</button>
          <div class="hint">Select a singer in the list to rename/remove or set current.</div>
        </div>
      </div>

      <!-- Current singer & voting -->
      <div class="panel">
        <h2>Now Singing & Voting</h2>
        <div class="grid2">
          <div>
            <label>Current Singer</label>
            <input id="currentSingerName" placeholder="(set from the list)" disabled />
            <div class="hint">Use the singer’s **Set Current** action to choose who’s up next.</div>
          </div>
          <div>
            <label>Voting</label>
            <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
              <button class="btn btn-gold" id="btnStartVote">Start Voting!</button>
              <button class="btn btn-blue" id="btnExtend15">Extend +15s</button>
              <button class="btn btn-red" id="btnEndVote">End Voting!</button>
            </div>
            <div class="hint" id="voteStatus">Voting Closed</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ---------------- Firebase ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDGbC08WxruYIDPhZSlDlU-7Kzq-7mHENk",
      authDomain: "eyek-vote.firebaseapp.com",
      projectId: "eyek-vote",
      storageBucket: "eyek-vote.firebasestorage.app",
      messagingSenderId: "954696683994",
      appId: "1:954696683994:web:21a84298a94648ff0230e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------------- Helpers ---------------- */
    const $ = id => document.getElementById(id);
    const singerListEl = $('singerList');
    const toastEl = $('toast');
    const voteStatus = $('voteStatus');

    function toast(msg, ms=1800){
      toastEl.textContent=msg; toastEl.style.display='block';
      setTimeout(()=> toastEl.style.display='none', ms);
    }
    function evRef(){ return eventId ? db.collection('events').doc(eventId) : null; }
    function canonicalKey(v){return String(v||'').toLowerCase().trim().replace(/[^\w]+/g,'-').replace(/(^-|-$)/g,'');}

    let eventId=null;
    let selectedSingerId=null;
    let selectedSingerName='';

    /* ---------------- Load current event & live UI ---------------- */
    async function loadCurrentEvent(){
      try{
        const s = await db.collection('app').doc('state').get();
        eventId = (s.data()||{}).currentEventId || null;
        if(!eventId){ toast("No event selected in app/state.currentEventId"); return; }

        // Live voting status/current singer
        evRef().onSnapshot(snap=>{
          const d=snap.data()||{};
          $('venueName').value = d.venueName || '';
          $('kjName').value = d.kjName || '';
          $('currentSingerName').value = d.currentSingerName || '';
          voteStatus.textContent = d.isVotingOpen ? 'Voting OPEN' : 'Voting Closed';
        });

        // Live singer list (names only)
        evRef().collection('singers').orderBy('singerName').onSnapshot(qs=>{
          singerListEl.innerHTML='';
          qs.forEach(doc=>{
            const dat=doc.data()||{};
            const li=document.createElement('li');
            const left=document.createElement('div'); left.className='name'; left.textContent = dat.singerName || doc.id;
            const right=document.createElement('div'); right.className='row-actions';
            const btnSet=document.createElement('button'); btnSet.className='btn btn-gold'; btnSet.textContent='Set Current';
            btnSet.onclick=()=> setCurrentSinger(doc.id, dat.singerName||doc.id);
            const btnRen=document.createElement('button'); btnRen.className='btn btn-ghost'; btnRen.textContent='Rename';
            btnRen.onclick=()=> renameSinger(doc.id, dat.singerName||doc.id);
            const btnDel=document.createElement('button'); btnDel.className='btn btn-red'; btnDel.textContent='Remove';
            btnDel.onclick=()=> removeSinger(doc.id, dat.singerName||doc.id);

            right.appendChild(btnSet); right.appendChild(btnRen); right.appendChild(btnDel);
            li.appendChild(left); li.appendChild(right);
            li.onclick=()=> { selectedSingerId=doc.id; selectedSingerName=dat.singerName||doc.id; $('singerNameInput').value=selectedSingerName; $('btnRenameSinger').disabled=false; };
            singerListEl.appendChild(li);
          });
        });

      }catch(e){ console.error(e); toast("Error loading event"); }
    }

    /* ---------------- Venue / KJ ---------------- */
    async function saveVenue(){
      if($('lockVenue').checked){ toast('Venue is locked'); return; }
      const name=$('venueName').value.trim();
      if(!name){ toast('Enter a venue'); return; }
      // If venue changed, clear singer list
      const ref=evRef(); if(!ref) return;
      const snap=await ref.get(); const prev=(snap.data()||{}).venueName||'';
      await ref.set({venueName:name},{merge:true});
      if(prev && prev!==name){
        await clearSingerList(ref);
        toast('Venue saved & singer list cleared');
      }else{
        toast('Venue saved');
      }
    }
    async function saveKj(){
      if($('lockKj').checked){ toast('KJ is locked'); return; }
      const name=$('kjName').value.trim();
      if(!name){ toast('Enter a KJ/company'); return; }
      await evRef().set({kjName:name},{merge:true});
      toast('KJ saved');
    }
    async function clearSingerList(ref){
      const qs=await ref.collection('singers').get();
      const batch=db.batch();
      qs.forEach(d=> batch.delete(d.ref));
      await batch.commit();
    }
    $('btnPickVenue').onclick = saveVenue;
    $('btnPickKj').onclick = saveKj;

    // Simple pickers from stored lists (optional; no modal UI—using prompt for now)
    $('btnPickVenueFromList').onclick = async ()=>{
      const qs=await db.collection('venues').limit(500).get();
      const names=qs.docs.map(d=>d.id).sort();
      const pick=prompt('Pick venue (type exact):\n'+names.join('\n'), $('venueName').value||'');
      if(pick){ $('venueName').value=pick; saveVenue(); }
    };
    $('btnPickKjFromList').onclick = async ()=>{
      const qs=await db.collection('kjs').limit(500).get();
      const names=qs.docs.map(d=> (d.data().name||d.id)).sort();
      const pick=prompt('Pick KJ/company (type exact):\n'+names.join('\n'), $('kjName').value||'');
      if(pick){ $('kjName').value=pick; saveKj(); }
    };

    /* ---------------- Singer CRUD ---------------- */
    $('btnAddSinger').onclick = async ()=>{
      const name=$('singerNameInput').value.trim();
      const notes=$('singerNotesInput').value.trim();
      if(!name){ toast('Enter a singer name'); return; }
      const id=canonicalKey(name);
      try{
        await evRef().collection('singers').doc(id).set({
          singerName:name, notes:notes||'', updatedAt:firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        $('singerNameInput').value=''; $('singerNotesInput').value='';
        toast('Singer saved');
      }catch(e){ console.error(e); toast('Error saving singer'); }
    };

    $('btnRenameSinger').onclick = async ()=>{
      if(!selectedSingerId){ toast('Select a singer in the list'); return; }
      const newName = prompt('New name for singer:', $('singerNameInput').value || selectedSingerName);
      if(!newName) return;
      const newId = canonicalKey(newName);
      const col = evRef().collection('singers');
      if(newId!==selectedSingerId){
        // move doc
        const prev = await col.doc(selectedSingerId).get();
        const data = prev.data()||{};
        await col.doc(newId).set({ ...data, singerName:newName, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
        await col.doc(selectedSingerId).delete();
        selectedSingerId=newId; selectedSingerName=newName;
      }else{
        await col.doc(selectedSingerId).set({ singerName:newName, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      }
      $('singerNameInput').value=newName;
      toast('Singer renamed');
    };

    async function removeSinger(id,name){
      if(!confirm(`Remove ${name} from tonight’s list?`)) return;
      try{ await evRef().collection('singers').doc(id).delete(); toast('Removed'); }
      catch(e){ console.error(e); toast('Error removing'); }
    }

    /* ---------------- Set current (Song then Artist) ---------------- */
    async function setCurrentSinger(id,name){
      // Do NOT auto-open voting; only set current & collect tonight’s song/artist for data
      const song = prompt("Song Title (for data only):", "");
      if(song===null) return; // cancelled
      const artist = prompt("Artist (for data only):", "");
      try{
        await evRef().set({
          currentSingerId:id,
          currentSingerName:name,
          performanceId: canonicalKey(name)+'-'+Date.now(),
          currentSong:song||'',
          currentArtist:artist||'',
          isVotingOpen:false  // stays closed until you press Start Voting!
        }, {merge:true});
        $('currentSingerName').value = name;
        toast(`Set current: ${name}`);
        // Optionally log the performance row for reports
        await evRef().collection('performances').add({
          singerName:name, title:song||'', artist:artist||'',
          startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){ console.error(e); toast('Error setting current'); }
    }

    /* ---------------- Voting controls ---------------- */
    $('btnStartVote').onclick = async ()=>{
      const ref=evRef(); if(!ref) return;
      const closeAt=Date.now()+30000;
      try{
        await ref.set({
          isVotingOpen:true,
          voteClosesAt:closeAt,
          voteWindow:{openedAt:firebase.firestore.FieldValue.serverTimestamp(),durationSec:30,autoClose:true}
        }, {merge:true});
        toast('Voting started (30s)');
      }catch(e){ console.error(e); toast('Error starting voting'); }
    };

    $('btnExtend15').onclick = async ()=>{
      const ref=evRef(); if(!ref) return;
      try{
        const s=await ref.get(); const d=s.data()||{};
        const newClose = (typeof d.voteClosesAt==='number'?d.voteClosesAt:Date.now()) + 15000;
        await ref.set({
          voteClosesAt:newClose,
          voteWindow:{durationSec:(d.voteWindow?.durationSec||30)+15,autoClose:true}
        }, {merge:true});
        toast('Extended +15s');
      }catch(e){ console.error(e); toast('Error extending'); }
    };

    $('btnEndVote').onclick = async ()=>{
      const ref=evRef(); if(!ref) return;
      try{
        await ref.set({ isVotingOpen:false }, {merge:true});
        toast('Voting ended');
        // Optionally: signal result splash to Screen page from host (choose final outcome elsewhere)
      }catch(e){ console.error(e); toast('Error ending voting'); }
    };

    /* ---------------- Init ---------------- */
    loadCurrentEvent();
  </script>

  <!-- FILE: index_host.html -->
</body>
</html>
